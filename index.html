<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ping-Restaurant</title>
    <link rel="icon" type="image/png" href="https://ui-avatars.com/api/?name=P&background=FF4757&color=fff">

    <!-- 1. Libraries & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&family=Padauk:wght@400;700&display=swap" rel="stylesheet">

    <!-- 2. Custom CSS & Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'Padauk', 'sans-serif'],
                    },
                    colors: {
                        primary: '#FF4757',  // Lucky Red
                        accent: '#34D399',   // Emerald 400
                        dark: {
                            900: '#111827', 
                            800: '#1F2937', 
                            700: '#374151', 
                            text: '#F9FAFB', 
                            muted: '#9CA3AF' 
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', 'Padauk', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #111827; color: #F9FAFB; }
        .hide { display: none !important; }
        
        /* Utility */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Sold Out Grayscale Effect */
        .sold-out-filter { filter: grayscale(100%); opacity: 0.5; pointer-events: none; }

        /* Fix for date input icon */
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; opacity: 0.8; }
        input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }

        /* Animations */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .loader { width: 40px; height: 40px; border: 4px solid #374151; border-top: 4px solid #FF4757; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Glassmorphism */
        .glass-nav { background: rgba(17, 24, 39, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* Category Buttons */
        .cat-btn-active { background-color: #FF4757; color: white; box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4); transform: scale(1.05); border: none; }
        .cat-btn-inactive { background-color: #1F2937; color: #9CA3AF; border: 1px solid #374151; }

        /* Table Map Draggable */
        .table-node { position: absolute; touch-action: none; user-select: none; transition: box-shadow 0.2s, transform 0.1s; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .table-node:active { cursor: grabbing; }
        .table-node.editing { border: 2px dashed rgba(255,255,255,0.3); cursor: move; }
        .table-node.editing:hover { border-color: white; }
        .table-node.selected { border: 2px solid #34D399; box-shadow: 0 0 15px rgba(52, 211, 153, 0.5); z-index: 50; }

        /* Print Styles */
        @media print { 
            body * { visibility: hidden; } 
            #receipt-print-area, #receipt-print-area * { visibility: visible; } 
            #receipt-print-area { position: absolute; left: 0; top: 0; width: 100% !important; display: block !important; margin: 0; padding: 0; background-color: white; color: black; } 
            .no-print { display: none !important; } 
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden selection:bg-primary selection:text-white">

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <!-- 3. Navigation Bar -->
    <header class="glass-nav h-14 flex items-center justify-between px-4 z-50 no-print sticky top-0 shrink-0">
        <div class="flex items-center gap-3">
            <img src="https://placehold.co/150x50/FF4757/FFFFFF?text=Ping+POS&font=roboto" alt="Ping-Restaurant Logo" class="h-9 w-auto object-contain rounded-md shadow-lg shadow-red-500/20">
        </div>
        
        <div class="flex items-center gap-3">
            <button onclick="toggleLanguage()" class="bg-dark-800 border border-dark-700 text-white px-2 py-1 rounded-lg text-xs font-bold hover:bg-dark-700 transition flex items-center gap-1">
                <i class="fas fa-globe text-dark-muted"></i>
                <span id="lang-display">EN</span>
            </button>

            <div id="nav-customer-controls">
                <button onclick="openLoginModal()" class="w-8 h-8 rounded-full bg-dark-800 text-dark-muted hover:text-primary hover:bg-dark-700 transition flex items-center justify-center border border-dark-700">
                    <i class="fas fa-user-lock text-xs"></i>
                </button>
            </div>

            <div id="nav-admin-controls" class="hide">
                <button onclick="switchMode('customer')" class="bg-dark-800 text-dark-muted px-3 py-1.5 rounded-full text-[10px] font-bold hover:bg-dark-700 hover:text-white transition border border-dark-700">
                    <i class="fas fa-arrow-left mr-1"></i> <span data-i18n="exit">Exit</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 4. Main Content -->
    <main id="app-container" class="flex-1 overflow-hidden relative no-print">
        
        <!-- === CUSTOMER VIEW === -->
        <div id="customer-view" class="h-full flex flex-col bg-dark-900 relative">
            
            <!-- POS MODE FLOATING HEADER -->
            <div id="pos-mode-header" class="hide absolute top-0 left-0 right-0 z-[60] bg-orange-600 text-white shadow-lg flex justify-between items-center px-4 py-2">
                <div class="flex items-center gap-2">
                    <span class="font-bold text-xs uppercase tracking-widest"><i class="fas fa-cash-register mr-1"></i> POS Mode</span>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Auto Return Toggle -->
                    <label class="flex items-center gap-2 text-xs font-bold cursor-pointer select-none bg-orange-700/50 px-2 py-1 rounded-lg hover:bg-orange-700">
                        <input type="checkbox" id="chk-auto-return" class="accent-white w-4 h-4" checked>
                        <span>Auto Return</span>
                    </label>
                    <button onclick="exitPOSMode()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-xs font-bold transition">Back to Admin</button>
                </div>
            </div>

            <!-- Hero Section -->
            <div class="px-4 pt-4 pb-2 shrink-0">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-extrabold text-white leading-tight tracking-tight">
                            <span data-i18n="hero_title">Hungry? ğŸ˜‹</span> <br>
                            <span class="text-primary text-sm font-bold tracking-wide" data-i18n="hero_subtitle">Order something good!</span>
                        </h2>
                    </div>
                    <div class="bg-dark-800 px-3 py-1.5 rounded-xl shadow-lg border border-dark-700 text-center">
                        <span class="text-[8px] text-dark-muted block font-bold uppercase tracking-widest" data-i18n="table">Table</span>
                        <span id="display-table-id" class="text-lg font-bold text-white leading-none">1</span>
                    </div>
                </div>
            </div>

            <!-- Sticky Category Bar -->
            <div class="sticky top-0 z-40 bg-dark-900/95 backdrop-blur-sm pb-3 pt-2 shrink-0">
                <div class="px-4">
                    <div class="flex gap-2 items-center" id="category-bar"></div>
                </div>
            </div>

            <!-- Product Grid -->
            <div id="main-scroll-container" class="flex-1 overflow-y-auto px-4 pb-32 pt-1 scrollbar-hide scroll-smooth">
                <div id="menu-loading" class="flex flex-col items-center justify-center py-20 opacity-60">
                    <span class="loader mb-4"></span>
                    <p class="text-dark-muted text-sm font-medium" data-i18n="loading">Loading Menu...</p>
                </div>
                
                <div id="menu-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

                <div id="empty-menu-msg" class="hide flex flex-col items-center justify-center py-20 text-dark-700">
                    <i class="fas fa-utensils text-5xl mb-4"></i>
                    <p class="text-sm font-medium" data-i18n="no_items">No items available yet.</p>
                </div>
            </div>

            <!-- SCROLL TO TOP BUTTON -->
            <button id="scroll-top-btn" onclick="scrollToTop()" class="fixed bottom-28 right-4 w-10 h-10 bg-dark-800 border border-dark-700 text-white rounded-full shadow-xl flex items-center justify-center z-40 transition-all duration-300 opacity-0 translate-y-10 pointer-events-none hover:bg-dark-700 hover:border-primary">
                <i class="fas fa-arrow-up text-sm"></i>
            </button>

            <!-- FIXED Floating Cart Button -->
            <div id="cart-bar" class="fixed bottom-10 left-4 right-4 sm:left-auto sm:right-8 sm:w-96 transform translate-y-[200%] transition-transform duration-500 z-50 safe-pb">
                <button onclick="openCheckoutModal()" class="w-full bg-white text-dark-900 p-2 pr-3 pl-3 rounded-full shadow-2xl shadow-black/50 flex items-center justify-between group active:scale-[0.98] transition overflow-hidden">
                    <div class="bg-dark-900 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm shadow-md z-10" id="cart-count">0</div>
                    <div class="flex flex-col items-start ml-3 z-10">
                        <span class="text-[10px] text-dark-700 font-bold uppercase tracking-wider" data-i18n="total">Total</span>
                        <span class="text-lg font-extrabold leading-none" id="cart-total">0 Ks</span>
                    </div>
                    <div class="flex items-center gap-2 bg-accent px-4 py-2.5 rounded-full ml-auto hover:brightness-110 transition shadow-lg shadow-green-500/20 z-10">
                        <span class="text-xs font-bold uppercase tracking-wide text-dark-900" data-i18n="view_order">View Order</span>
                        <i class="fas fa-chevron-right text-xs text-dark-900"></i>
                    </div>
                </button>
            </div>
        </div>

        <!-- === ADMIN / KITCHEN VIEW === -->
        <div id="admin-view" class="h-full flex flex-col hide bg-dark-900">
            <div class="bg-dark-800 border-b border-dark-700 px-4 py-3 flex flex-wrap gap-3 justify-between items-center shadow-md z-10 shrink-0">
                <div class="flex items-center gap-2">
                    <h2 class="font-bold text-lg text-white" data-i18n="kitchen_display">Kitchen Display</h2>
                    <span id="live-indicator" class="flex h-2 w-2 relative"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-500 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>
                </div>
                <div class="flex gap-2">
                     <button onclick="openTableMap()" class="px-3 py-1 bg-orange-600 text-white rounded-full text-xs font-bold hover:bg-orange-500 shadow-lg flex items-center gap-1 transition">
                        <i class="fas fa-th"></i> <span data-i18n="pos_mode">POS</span>
                    </button>
                    <button onclick="openChangePinModal()" class="w-9 h-9 rounded-full bg-dark-700 text-dark-muted hover:bg-dark-600 hover:text-white flex items-center justify-center transition"><i class="fas fa-key text-xs"></i></button>
                    <button onclick="openReportModal()" class="w-9 h-9 rounded-full bg-purple-900/30 text-purple-400 hover:bg-purple-900/50 flex items-center justify-center transition"><i class="fas fa-chart-bar text-xs"></i></button>
                    <button onclick="openQRModal()" class="w-9 h-9 rounded-full bg-blue-900/30 text-blue-400 hover:bg-blue-900/50 flex items-center justify-center transition"><i class="fas fa-qrcode text-xs"></i></button>
                    <button onclick="openMenuManager()" class="px-3 py-1 bg-primary text-white rounded-full text-xs font-bold hover:bg-red-600 shadow-lg flex items-center gap-1"><i class="fas fa-plus"></i> <span data-i18n="menu">Menu</span></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-dark-900">
                <div id="orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 items-start"></div>
                <div id="no-orders-msg" class="hidden h-full flex flex-col items-center justify-center text-dark-700"><i class="fas fa-check-circle text-6xl mb-4 opacity-20"></i><p data-i18n="kitchen_clear">Kitchen is clear</p></div>
            </div>
        </div>
    </main>

    <!-- === MODALS === -->
    
    <!-- Table Map Modal (POS & Edit Layout) -->
    <div id="modal-table-map" class="fixed inset-0 bg-black/90 z-[100] hide flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-dark-800 w-full max-w-5xl rounded-3xl shadow-2xl h-[90vh] flex flex-col animate-slide-up border border-dark-700 relative overflow-hidden">
             
             <!-- Header -->
             <div class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800 z-10 shrink-0">
                <div>
                    <h3 class="font-bold text-white text-xl flex items-center gap-2">
                        <i class="fas fa-store text-orange-500"></i> <span data-i18n="table_map">Table Layout</span>
                    </h3>
                    <p class="text-xs text-dark-muted mt-1" id="table-map-subtitle" data-i18n="select_table_msg">Select a table to take order</p>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Edit Mode Controls -->
                    <div id="layout-edit-controls" class="hide flex items-center gap-2 mr-2 bg-dark-900/50 p-1 rounded-lg border border-dark-700">
                         <!-- Shape Select & Add -->
                         <div class="flex items-center gap-1">
                             <select id="new-table-shape" class="bg-dark-800 text-white text-xs border border-dark-600 rounded px-2 py-1.5 focus:border-primary outline-none">
                                 <option value="round">Round âšª</option>
                                 <option value="rect">Square â¬œ</option>
                             </select>
                             <button onclick="addNewTable()" class="bg-green-600 text-white px-3 py-1.5 rounded-md text-xs font-bold hover:bg-green-500 shadow flex items-center gap-1">
                                 <i class="fas fa-plus"></i> Add
                             </button>
                         </div>
                         <div class="w-px h-6 bg-dark-600 mx-1"></div>
                        <button id="btn-save-layout" onclick="saveLayout()" class="bg-primary text-white px-3 py-1.5 rounded-md text-xs font-bold hover:bg-red-600 shadow flex items-center gap-1"><i class="fas fa-save"></i> Save</button>
                    </div>
                    
                    <!-- Toggle Edit Mode -->
                    <button id="btn-edit-layout" onclick="toggleLayoutEdit()" class="border border-dark-600 text-dark-muted hover:text-white hover:bg-dark-700 px-3 py-1.5 rounded-lg text-xs font-bold transition">
                        <i class="fas fa-pen mr-1"></i> Edit
                    </button>

                    <button onclick="closeModal('modal-table-map')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-dark-muted hover:text-white hover:bg-dark-600 transition"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <!-- Canvas Area -->
            <div onclick="deselectTable()" class="flex-1 overflow-auto bg-dark-900 relative cursor-grab active:cursor-grabbing" id="table-map-container" style="background-image: radial-gradient(#374151 1px, transparent 1px); background-size: 20px 20px;">
                <!-- Tables will be rendered here absolutely -->
            </div>
            
            <!-- Bottom Panel (Legend OR Properties) -->
            <div id="map-bottom-panel" class="p-4 bg-dark-800 border-t border-dark-700 z-10 min-h-[70px] flex justify-center items-center">
                <!-- Default Legend -->
                <div id="map-legend" class="flex gap-6 text-xs font-bold text-dark-muted">
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> Free</span>
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500"></span> Occupied</span>
                    <span id="edit-hint" class="hide text-orange-400 ml-4"><i class="fas fa-mouse-pointer"></i> Select a table to edit</span>
                </div>

                <!-- Table Properties (Shown when selected in Edit Mode) -->
                <div id="table-properties" class="hide w-full flex justify-between items-center max-w-2xl animate-slide-up">
                    <div class="flex items-center gap-4">
                        <div class="bg-dark-900 px-3 py-1 rounded-lg border border-dark-700">
                             <span class="text-[10px] text-dark-muted uppercase font-bold">Selected</span>
                             <p class="text-white font-bold text-lg" id="prop-id">T-1</p>
                        </div>
                        
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] text-dark-muted uppercase font-bold">Shape</span>
                            <div class="flex bg-dark-900 rounded-lg p-0.5 border border-dark-700">
                                <button onclick="updateTableProperty('shape', 'round')" class="px-3 py-1 rounded-md text-xs font-bold transition hover:bg-dark-700 text-dark-muted" id="btn-shape-round"><i class="fas fa-circle"></i></button>
                                <button onclick="updateTableProperty('shape', 'rect')" class="px-3 py-1 rounded-md text-xs font-bold transition hover:bg-dark-700 text-dark-muted" id="btn-shape-rect"><i class="fas fa-square"></i></button>
                            </div>
                        </div>

                        <div class="flex flex-col gap-1 w-32">
                             <span class="text-[10px] text-dark-muted uppercase font-bold">Size</span>
                             <input type="range" min="0.5" max="2" step="0.1" id="prop-size" oninput="updateTableProperty('size', this.value)" class="accent-primary h-2 bg-dark-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>

                    <button onclick="deleteSelectedTable()" class="bg-red-900/20 text-red-500 border border-red-900/50 hover:bg-red-900/40 hover:text-red-400 px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 transition">
                        <i class="fas fa-trash"></i> Delete Table
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="modal-category" class="fixed inset-0 bg-black/80 z-[100] hide flex items-end sm:items-center justify-center">
        <div class="bg-dark-800 w-full sm:w-[450px] sm:rounded-3xl rounded-t-[30px] shadow-2xl animate-slide-up overflow-hidden flex flex-col max-h-[70vh] border-t border-dark-700 sm:border">
            <div class="p-5 border-b border-dark-700 flex justify-between items-center bg-dark-800">
                <h3 class="font-bold text-lg text-white" data-i18n="select_category">Select Category</h3>
                <button onclick="closeModal('modal-category')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-dark-muted hover:text-white hover:bg-dark-600 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 grid grid-cols-2 gap-3 overflow-y-auto" id="modal-cat-grid"></div>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div id="modal-login" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hide flex items-center justify-center p-4">
        <div class="bg-dark-800 w-full max-w-xs rounded-[30px] shadow-2xl p-6 text-center animate-slide-up border border-dark-700">
            <h3 class="font-bold text-lg mb-1 text-white" data-i18n="staff_access">Staff Access</h3>
            <p class="text-xs text-dark-muted mb-6" data-i18n="staff_only">Kitchen Management Only</p>
            <input type="password" id="staff-pin" class="border-2 border-dark-700 bg-dark-900 text-white p-3 rounded-2xl w-full text-center font-bold text-2xl tracking-[0.5em] mb-6 focus:border-primary outline-none transition placeholder-dark-700" placeholder="â€¢â€¢â€¢â€¢" maxlength="4">
            <div class="flex gap-3">
                <button onclick="closeModal('modal-login')" class="flex-1 py-3 text-dark-muted font-bold text-sm hover:text-white transition" data-i18n="cancel">Cancel</button>
                <button onclick="verifyPin()" class="flex-1 bg-white text-dark-900 py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-gray-200 transition" data-i18n="login">Login</button>
            </div>
        </div>
    </div>

    <!-- Change PIN Modal -->
    <div id="modal-change-pin" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hide flex items-center justify-center p-4">
        <div class="bg-dark-800 w-full max-w-xs rounded-[30px] shadow-2xl p-6 text-center animate-slide-up border border-dark-700">
            <h3 class="font-bold text-lg mb-4 text-white" data-i18n="update_pin">Update PIN</h3>
            <input type="tel" id="new-pin-input" class="border-2 border-dark-700 bg-dark-900 text-white p-3 rounded-2xl w-full text-center font-bold text-2xl tracking-[0.5em] mb-6 outline-none focus:border-primary placeholder-dark-700" placeholder="â€¢â€¢â€¢â€¢" maxlength="4">
            <button onclick="saveNewPin()" class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-lg mb-3 hover:bg-red-600 transition" data-i18n="save_pin">Save New PIN</button>
            <button onclick="closeModal('modal-change-pin')" class="text-dark-muted text-xs font-bold py-2 hover:text-white" data-i18n="cancel">Cancel</button>
        </div>
    </div>

    <!-- Product Details -->
    <div id="modal-product" class="fixed inset-0 bg-black/80 z-[100] hide flex items-end sm:items-center justify-center">
        <div class="bg-dark-800 w-full sm:w-[450px] sm:rounded-3xl rounded-t-[30px] shadow-2xl animate-slide-up overflow-hidden max-h-[90vh] flex flex-col border-t border-dark-700 sm:border">
            <div class="h-56 relative shrink-0 group">
                <img id="mp-img" src="" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-dark-900 via-transparent to-transparent"></div>
                <button onclick="closeModal('modal-product')" class="absolute top-4 right-4 w-8 h-8 bg-black/40 text-white rounded-full flex items-center justify-center backdrop-blur-md z-10 hover:bg-black/60"><i class="fas fa-times"></i></button>
                <div class="absolute bottom-4 left-6 right-6 text-white">
                    <h3 id="mp-name" class="text-2xl font-bold leading-tight drop-shadow-md">Product</h3>
                    <span id="mp-price-display" class="inline-block mt-2 bg-primary text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">0 Ks</span>
                </div>
            </div>
            
            <div class="p-6 overflow-y-auto bg-dark-800 flex-1">
                <div class="mb-4">
                    <p class="text-[10px] font-bold text-dark-muted uppercase tracking-widest mb-3" data-i18n="customize">Customize Order</p>
                    <div id="dynamic-options" class="grid grid-cols-2 gap-3 mb-4"></div>
                    
                    <!-- NEW: Custom Remark Input -->
                    <p class="text-[10px] font-bold text-dark-muted uppercase tracking-widest mb-2" data-i18n="remarks">Special Requests</p>
                    <textarea id="prod-remark" class="w-full bg-dark-900 border border-dark-700 rounded-xl p-3 text-white text-sm focus:border-primary outline-none resize-none placeholder-dark-700 transition focus:ring-1 focus:ring-primary" rows="2" placeholder="e.g., Less oil, Allergy info..."></textarea>
                </div>
            </div>

            <div class="p-4 border-t border-dark-700 bg-dark-800 pb-8 sm:pb-4">
                <div class="flex items-center gap-3">
                    <div class="flex items-center bg-dark-900 border border-dark-700 rounded-2xl p-1 h-14">
                        <button onclick="updateQty(-1)" class="w-12 h-full flex items-center justify-center text-dark-muted font-bold active:scale-90 transition hover:text-white">-</button>
                        <span id="mp-qty" class="w-8 text-center font-bold text-xl text-white">1</span>
                        <button onclick="updateQty(1)" class="w-12 h-full flex items-center justify-center text-white font-bold active:scale-90 transition hover:text-primary">+</button>
                    </div>
                    <button onclick="addToCart()" class="flex-1 bg-white text-dark-900 h-14 rounded-2xl font-bold shadow-lg shadow-white/10 active:scale-[0.98] transition flex justify-between items-center px-6 hover:bg-gray-100">
                        <span data-i18n="add_to_order">Add to Order</span>
                        <div class="bg-dark-900 text-white w-8 h-8 rounded-full flex items-center justify-center text-xs"><i class="fas fa-plus"></i></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout -->
    <div id="modal-checkout" class="fixed inset-0 bg-black/80 z-[100] hide flex items-end sm:items-center justify-center">
        <div class="bg-dark-800 w-full sm:w-[450px] sm:rounded-3xl rounded-t-[30px] shadow-2xl animate-slide-up overflow-hidden flex flex-col max-h-[85vh] border-t border-dark-700 sm:border">
            <div class="p-5 border-b border-dark-700 flex justify-between items-center bg-dark-800">
                <div>
                    <h3 class="font-bold text-xl text-white" data-i18n="your_tray">Your Tray</h3>
                    <p class="text-xs text-dark-muted mt-0.5" data-i18n="check_items">Check your items</p>
                </div>
                <button onclick="closeModal('modal-checkout')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-dark-muted hover:text-white hover:bg-dark-600 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- NEW: Order Type Toggle -->
            <div class="px-5 pt-4 pb-0">
                <div class="bg-dark-900 p-1 rounded-xl flex border border-dark-700 relative">
                    <button onclick="setOrderType('dine_in')" id="btn-type-dine" class="flex-1 py-2.5 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 bg-primary text-white shadow-md">
                        <i class="fas fa-utensils"></i> <span data-i18n="dine_in">Dine In</span>
                    </button>
                    <button onclick="setOrderType('takeaway')" id="btn-type-take" class="flex-1 py-2.5 rounded-lg text-xs font-bold text-dark-muted hover:text-white transition flex items-center justify-center gap-2">
                        <i class="fas fa-shopping-bag"></i> <span data-i18n="takeaway">Takeaway</span>
                    </button>
                </div>
            </div>

            <div id="checkout-items" class="p-4 overflow-y-auto flex-1 space-y-3 bg-dark-900 mt-2"></div>
            <div class="p-6 bg-dark-800 border-t border-dark-700 pb-8 sm:pb-6">
                <!-- ... existing footer ... -->
                <div class="flex justify-between items-center mb-6">
                    <span class="text-xs font-bold text-dark-muted uppercase tracking-wider" data-i18n="total_amount">Total Amount</span>
                    <span id="checkout-grand-total" class="text-3xl font-bold text-white">0 Ks</span>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="closeModal('modal-checkout')" class="flex-1 bg-dark-700 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-dark-600 transition active:scale-[0.98]" data-i18n="cancel">
                        Cancel
                    </button>
                    <button onclick="submitOrder()" class="flex-[2] bg-primary text-white py-4 rounded-2xl font-bold shadow-xl shadow-primary/20 active:scale-[0.98] transition flex justify-center items-center gap-3 hover:bg-red-600">
                        <span data-i18n="confirm">Confirm</span>
                        <i class="fas fa-check-circle"></i>
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Admin Modals -->
    <div id="modal-menu" class="fixed inset-0 bg-black/80 z-[100] hide flex items-center justify-center p-4">
        <div class="bg-dark-800 w-full max-w-3xl rounded-3xl shadow-2xl h-[85vh] flex flex-col animate-slide-up border border-dark-700">
            <div class="p-5 border-b border-dark-700 flex justify-between items-center">
                <h3 class="font-bold text-white text-lg" id="menu-modal-title" data-i18n="menu_manager">Menu Manager</h3>
                <button onclick="closeModal('modal-menu')" class="text-dark-muted hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 bg-dark-900 grid grid-cols-1 md:grid-cols-4 gap-3">
                <input id="new-prod-name" placeholder="Item Name" class="p-3 rounded-xl border border-dark-700 bg-dark-800 text-white placeholder-dark-700 focus:border-primary outline-none">
                <input id="new-prod-price" type="number" placeholder="Price" class="p-3 rounded-xl border border-dark-700 bg-dark-800 text-white placeholder-dark-700 focus:border-primary outline-none">
                <select id="new-prod-category" class="p-3 rounded-xl border border-dark-700 bg-dark-800 text-white focus:border-primary outline-none"><option value="Fried">Fried</option><option value="Curry">Curry</option><option value="Soup">Soup</option><option value="Salad">Salad</option><option value="Rice">Rice</option><option value="Noodle">Noodle</option><option value="Dessert">Dessert</option><option value="Drink">Drink</option><option value="Other">Other</option></select>
                <button id="btn-save-prod" onclick="saveProduct()" class="bg-primary text-white rounded-xl font-bold shadow-lg hover:bg-red-600 transition flex items-center justify-center gap-2" data-i18n="add_item">Add Item</button>
            </div>
            <div id="edit-controls" class="px-5 pb-2 flex justify-end hide">
                <button onclick="cancelEdit()" class="text-xs font-bold text-red-400 hover:text-white underline" data-i18n="cancel_edit">Cancel Edit</button>
            </div>
            <div class="px-5 pb-5 bg-dark-900 grid grid-cols-2 gap-3"><input id="new-prod-img" placeholder="Image URL (Optional)" class="p-3 rounded-xl border border-dark-700 bg-dark-800 text-white placeholder-dark-700 focus:border-primary outline-none"><input id="new-prod-options" placeholder="Options (e.g., Spicy, No Onion)" class="p-3 rounded-xl border border-dark-700 bg-dark-800 text-white placeholder-dark-700 focus:border-primary outline-none"></div>
            <div class="flex-1 overflow-y-auto p-5"><table class="w-full text-sm text-left text-dark-muted"><tbody id="menu-table-body" class="divide-y divide-dark-700"></tbody></table></div>
        </div>
    </div>

    <!-- REPORT MODAL (ADVANCED WITH CATEGORY & PROGRESS BARS) -->
    <div id="modal-report" class="fixed inset-0 bg-black/80 z-[100] hide flex items-center justify-center p-4">
        <div class="bg-dark-800 w-full max-w-4xl rounded-3xl h-[90vh] flex flex-col animate-slide-up border border-dark-700">
            <div class="p-5 border-b border-dark-700 flex justify-between items-center">
                <h3 class="font-bold text-xl text-white" data-i18n="analytics">Analytics</h3>
                <button onclick="closeModal('modal-report')" class="text-dark-muted hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex bg-dark-900 p-1 m-5 mb-2 rounded-xl border border-dark-700">
                <button onclick="switchReportTab('overview')" id="tab-overview" class="flex-1 py-2 rounded-lg font-bold text-sm bg-dark-700 text-white shadow-sm transition" data-i18n="overview">Overview</button>
                <button onclick="switchReportTab('history')" id="tab-history" class="flex-1 py-2 rounded-lg font-bold text-sm text-dark-muted hover:text-white transition" data-i18n="history">History</button>
                <button onclick="switchReportTab('top')" id="tab-top" class="flex-1 py-2 rounded-lg font-bold text-sm text-dark-muted hover:text-white transition" data-i18n="top_items">Top Items</button>
            </div>

            <!-- Global Date Picker & Range Selector -->
            <div class="px-5 pb-2 flex flex-wrap gap-3">
                 <div class="flex items-center gap-3 bg-dark-900 p-3 rounded-xl border border-dark-700 max-w-xs">
                    <span class="text-sm font-bold text-dark-muted" data-i18n="date">Date:</span>
                    <input type="date" id="rpt-date-input" class="bg-transparent font-bold outline-none text-white invert-calendar" onchange="window.refreshReport()">
                </div>

                <!-- Range Selector -->
                <div class="flex items-center gap-2 bg-dark-900 p-1 rounded-xl border border-dark-700">
                    <select id="rpt-range-select" onchange="window.refreshReport()" class="bg-transparent text-white font-bold text-sm outline-none px-3 py-2 cursor-pointer">
                        <option value="daily" class="bg-dark-800">Daily</option>
                        <option value="weekly" class="bg-dark-800">Weekly</option>
                        <option value="monthly" class="bg-dark-800">Monthly</option>
                        <option value="yearly" class="bg-dark-800">Yearly</option>
                    </select>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 pt-2">
                <div id="rpt-view-overview">
                     <div class="grid grid-cols-2 gap-4 mt-2">
                         <div class="bg-gradient-to-br from-primary to-red-600 text-white p-6 rounded-2xl shadow-lg">
                             <p class="text-xs opacity-70 mb-1 font-bold uppercase tracking-wider" data-i18n="total_revenue">Total Revenue</p>
                             <p class="text-3xl font-extrabold" id="rpt-ov-total">0</p>
                             <p class="text-[10px] mt-1 opacity-60" id="rpt-period-label">Today</p>
                         </div>
                         <div class="border border-dark-700 bg-dark-900 p-6 rounded-2xl">
                             <p class="text-xs text-dark-muted mb-1 font-bold uppercase tracking-wider" data-i18n="total_orders">Total Orders</p>
                             <p class="text-3xl font-extrabold text-white" id="rpt-ov-count">0</p>
                         </div>
                     </div>
                     
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                         <!-- Sales Trend Chart -->
                         <div class="bg-dark-900 p-4 rounded-2xl border border-dark-700">
                             <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider" data-i18n="hourly_sales">Sales Trend</h4>
                             <div class="relative h-64 w-full">
                                 <canvas id="salesChart"></canvas>
                             </div>
                         </div>
                         <!-- Category Sales Chart (NEW) -->
                         <div class="bg-dark-900 p-4 rounded-2xl border border-dark-700">
                             <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider" data-i18n="category_sales">Category Sales</h4>
                             <div class="relative h-64 w-full flex justify-center">
                                 <canvas id="categoryChart"></canvas>
                             </div>
                         </div>
                     </div>
                </div>
                
                <div id="rpt-view-history" class="hide">
                    <div class="flex justify-between mb-4 mt-2">
                        <h4 class="font-bold text-white" data-i18n="orders_selected">Orders for Selected Period</h4>
                        <button onclick="clearAllHistory()" class="text-red-400 text-xs font-bold border border-red-900/30 bg-red-900/10 px-3 py-1 rounded-lg hover:bg-red-900/30 transition" data-i18n="clear_all">Clear All</button>
                    </div>
                    <table class="w-full text-sm text-left text-dark-muted">
                        <thead class="bg-dark-900 text-dark-700 uppercase text-xs">
                            <tr>
                                <th class="p-3 rounded-l-lg" data-i18n="time">Date/Time</th>
                                <th class="p-3" data-i18n="table">Table</th>
                                <th class="p-3" data-i18n="total">Total</th>
                                <th class="rounded-r-lg"></th>
                            </tr>
                        </thead>
                        <tbody id="rpt-history-body" class="divide-y divide-dark-700"></tbody>
                    </table>
                </div>
                
                <div id="rpt-view-top" class="hide">
                    <h4 class="font-bold text-white mb-4 mt-2" data-i18n="top_selected">Top Items for Selected Period</h4>
                    <div id="rpt-top-list" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-qr" class="fixed inset-0 bg-black/80 z-[100] hide flex items-center justify-center p-4">
        <div class="bg-dark-800 w-full max-w-sm rounded-3xl p-6 text-center animate-slide-up border border-dark-700">
            <h3 class="font-bold text-lg mb-4 text-white" data-i18n="table_qr">Table QR</h3>
            <input type="number" id="qr-table-num" value="1" class="border-2 border-dark-700 bg-dark-900 text-white p-3 rounded-xl w-full text-center font-bold text-xl mb-4 focus:border-primary outline-none">
            <button onclick="generateQR()" class="w-full bg-white text-dark-900 py-3 rounded-xl font-bold mb-4 shadow-lg hover:bg-gray-200 transition" data-i18n="generate">Generate</button>
            <div id="qr-container" class="bg-white rounded-xl p-4 flex justify-center mb-4 min-h-[150px]"></div>
            <button onclick="printQR()" class="text-primary font-bold text-sm hover:underline" data-i18n="print_qr">Print QR Code</button>
            <button onclick="closeModal('modal-qr')" class="block w-full mt-4 text-dark-muted text-xs hover:text-white" data-i18n="close">Close</button>
        </div>
    </div>

    <!-- Hidden Receipt -->
    <div id="receipt-print-area" class="hide font-mono text-sm p-4 bg-white max-w-[300px]">
        <div class="text-center mb-2"><h2 class="text-xl font-bold text-black" id="rcp-title">PingPOS</h2></div>
        <div class="text-center mb-4 border-b-2 border-black pb-2"><h3 class="text-lg font-bold text-black" id="rcp-type">RECEIPT</h3></div>
        <div class="border-b border-black pb-2 mb-2 flex justify-between text-xs font-bold text-black"><span id="rcp-id">#000</span><span id="rcp-date"></span></div>
        <div class="text-center text-lg font-bold mb-4 border-b-2 border-black pb-2 text-black">Table <span id="rcp-table"></span></div>
        <table class="w-full text-left mb-4 text-xs text-black">
            <thead><tr class="border-b border-gray-400"><th class="py-1">Item</th><th class="py-1 text-right" id="rcp-th-amt">Amt</th></tr></thead>
            <tbody id="rcp-items"></tbody>
        </table>
        <div id="rcp-footer" class="border-t-2 border-black pt-2 flex justify-between font-bold text-lg mt-4 text-black"><span>TOTAL</span><span id="rcp-total"></span></div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyB0TsIVnLIWIOukeT_ddLwA9xMki50H1yE",
            authDomain: "pingpos.firebaseapp.com",
            projectId: "pingpos",
            storageBucket: "pingpos.firebasestorage.app",
            messagingSenderId: "328655511392",
            appId: "1:328655511392:web:f6232b5a3003bef5454805",
            measurementId: "G-QP50T36M1W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'pingpos-production'; 

        // TRANSLATION DATA
        const resources = {
            en: {
                dine_in: "Dine In",
                takeaway: "Takeaway",
                hero_title: "Hungry? ğŸ˜‹",
                hero_subtitle: "Order something good!",
                table: "TABLE",
                loading: "Loading Menu...",
                no_items: "No items available yet.",
                total: "TOTAL",
                view_order: "VIEW ORDER",
                kitchen_display: "Kitchen Display",
                kitchen_clear: "Kitchen is clear",
                exit: "Exit",
                menu: "Menu",
                select_category: "Select Category",
                staff_access: "Staff Access",
                staff_only: "Kitchen Management Only",
                login: "Login",
                cancel: "Cancel",
                update_pin: "Update PIN",
                save_pin: "Save New PIN",
                customize: "Customize Order",
                add_to_order: "Add to Order",
                your_tray: "Your Tray",
                check_items: "Check your items",
                total_amount: "Total Amount",
                confirm: "Confirm",
                menu_manager: "Menu Manager",
                add_item: "Add Item",
                update_item: "Update Item",
                cancel_edit: "Cancel Edit",
                analytics: "Analytics",
                overview: "Overview",
                history: "History",
                top_items: "Top Items",
                date: "Date:",
                total_revenue: "Total Revenue",
                total_orders: "Total Orders",
                orders_selected: "Orders for Selected Date",
                clear_all: "Clear All",
                time: "Time",
                top_selected: "Top Items for Selected Date",
                table_qr: "Table QR",
                generate: "Generate",
                print_qr: "Print QR Code",
                close: "Close",
                more: "More",
                hourly_sales: "Hourly Sales",
                category_sales: "Category Sales",
                sold_out: "SOLD OUT",
                available: "Available",
                pos_mode: "POS Mode",
                table_map: "Table Layout",
                select_table_msg: "Select a table to take order",
                free: "Free",
                occupied: "Occupied",
                remarks: "Special Requests",
                daily: "Daily", weekly: "Weekly", monthly: "Monthly", yearly: "Yearly",
                Fried: "Fried", Curry: "Curry", Soup: "Soup", Salad: "Salad", Rice: "Rice", Noodle: "Noodle", Dessert: "Dessert", Drink: "Drink", Other: "Other", All: "All"
            },
            cn: {
                dine_in: "å ‚é£Ÿ",
                takeaway: "æ‰“åŒ…",
                hero_title: "é¥¿äº†å—ï¼ŸğŸ˜‹",
                hero_subtitle: "ç‚¹ä»½å¥½åƒçš„å§ï¼",
                table: "æ¡Œå·",
                loading: "èœå•åŠ è½½ä¸­...",
                no_items: "æš‚æ— å•†å“",
                total: "æ€»è®¡",
                view_order: "æŸ¥çœ‹è®¢å•",
                kitchen_display: "å¨æˆ¿è®¢å•",
                kitchen_clear: "å¨æˆ¿æš‚æ— è®¢å•",
                exit: "é€€å‡º",
                menu: "èœå•ç®¡ç†",
                select_category: "é€‰æ‹©åˆ†ç±»",
                staff_access: "å‘˜å·¥é€šé“",
                staff_only: "ä»…é™å¨æˆ¿ç®¡ç†äººå‘˜",
                login: "ç™»å½•",
                cancel: "å–æ¶ˆ",
                update_pin: "ä¿®æ”¹ PIN ç ",
                save_pin: "ä¿å­˜æ–° PIN ç ",
                customize: "å®šåˆ¶å£å‘³",
                add_to_order: "åŠ å…¥è®¢å•",
                your_tray: "æ‚¨çš„é¤ç›˜",
                check_items: "è¯·æ ¸å¯¹æ‚¨çš„å•†å“",
                total_amount: "æ€»é‡‘é¢",
                confirm: "ç¡®è®¤ä¸‹å•",
                menu_manager: "èœå•ç®¡ç†å™¨",
                add_item: "æ·»åŠ å•†å“",
                update_item: "æ›´æ–°å•†å“",
                cancel_edit: "å–æ¶ˆç¼–è¾‘",
                analytics: "æ•°æ®ç»Ÿè®¡",
                overview: "æ¦‚è§ˆ",
                history: "å†å²è®°å½•",
                top_items: "çƒ­é”€æ’è¡Œ",
                date: "æ—¥æœŸ:",
                total_revenue: "æ€»æ”¶å…¥",
                total_orders: "æ€»è®¢å•",
                orders_selected: "æ‰€é€‰æ—¥æœŸè®¢å•",
                clear_all: "æ¸…é™¤æ‰€æœ‰",
                time: "æ—¶é—´",
                top_selected: "æ‰€é€‰æ—¥æœŸçƒ­é”€æ¦œ",
                table_qr: "æ¡Œå·äºŒç»´ç ",
                generate: "ç”Ÿæˆ",
                print_qr: "æ‰“å°äºŒç»´ç ",
                close: "å…³é—­",
                more: "æ›´å¤š",
                hourly_sales: "æ¯å°æ—¶é”€å”®é¢",
                category_sales: "åˆ†ç±»é”€å”®å æ¯”",
                sold_out: "å·²å”®å®Œ",
                available: "æœ‰è´§",
                pos_mode: "POS æ¨¡å¼",
                table_map: "æ¡Œå°å¸ƒå±€",
                select_table_msg: "é€‰æ‹©æ¡Œå·è¿›è¡Œç‚¹é¤",
                free: "ç©ºé—²",
                occupied: "å ç”¨",
                remarks: "ç‰¹æ®Šè¦æ±‚",
                daily: "æ¯æ—¥", weekly: "æ¯å‘¨", monthly: "æ¯æœˆ", yearly: "æ¯å¹´",
                Fried: "ç‚¸ç‰©", Curry: "å’–å–±", Soup: "æ±¤ç±»", Salad: "æ²™æ‹‰", Rice: "ç±³é¥­", Noodle: "é¢æ¡", Dessert: "ç”œç‚¹", Drink: "é¥®æ–™", Other: "å…¶ä»–", All: "å…¨éƒ¨"
            }
        };

        // GLOBAL STATE - Declared exactly once
        let state = { 
            user: null, 
            tableId: 1, 
            products: [], 
            cart: [], 
            orders: [], 
            selectedProduct: null, 
            activeCategory: 'All', 
            editingProductId: null, 
            lang: 'en', 
            chartInstance: null, 
            categoryChartInstance: null,
            isPOSMode: false,
            tables: [], 
            isLayoutEdit: false,
            dragItem: null,
            selectedTableId: null,
            orderType: 'dine_in'
        };
        let isInitialLoad = true; 

        const categories = ["All", "Fried", "Curry", "Soup", "Salad", "Rice", "Noodle", "Dessert", "Drink", "Other"];

        async function init() {
            try {
                const result = await signInAnonymously(auth);
                state.user = result.user;
                
                // FIXED: Using 6 segments path for config_tables
                const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config_tables', 'main_layout');
                const configSnap = await getDoc(configRef);
                
                if (configSnap.exists()) {
                    state.tables = configSnap.data().tables || [];
                } else {
                    generateDefaultTables();
                }
            } catch (error) { console.error("Init Error:", error); generateDefaultTables(); } 
            
            state.lang = localStorage.getItem('pingpos_lang') || 'en';
            
            const autoRet = localStorage.getItem('pingpos_auto_return');
            if(autoRet !== null) document.getElementById('chk-auto-return').checked = (autoRet === 'true');

            updateContent();
            
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('table')) state.tableId = urlParams.get('table');
            document.getElementById('display-table-id').innerText = state.tableId;
            
            setupListeners();
            switchMode('customer');
            renderCategoryBar();
            document.getElementById('rpt-date-input').valueAsDate = new Date();

            document.getElementById('chk-auto-return').addEventListener('change', (e) => {
                localStorage.setItem('pingpos_auto_return', e.target.checked);
            });

            const scrollContainer = document.getElementById('main-scroll-container');
            const scrollBtn = document.getElementById('scroll-top-btn');
            if(scrollContainer && scrollBtn) {
                scrollContainer.addEventListener('scroll', () => {
                    if (scrollContainer.scrollTop > 300) {
                        scrollBtn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
                    } else {
                        scrollBtn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
                    }
                });
            }
        }

        function generateDefaultTables() {
            state.tables = [];
            for(let i=1; i<=12; i++) {
                const col = (i-1) % 4;
                const row = Math.floor((i-1) / 4);
                state.tables.push({
                    id: String(i),
                    x: 10 + (col * 22), // Percent
                    y: 10 + (row * 22), // Percent
                    shape: 'round',
                    size: 1
                });
            }
        }

        window.scrollToTop = () => {
            document.getElementById('main-scroll-container').scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.toggleLanguage = () => {
            state.lang = state.lang === 'en' ? 'cn' : 'en';
            localStorage.setItem('pingpos_lang', state.lang);
            updateContent();
            renderCategoryBar(); 
        };

        function updateContent() {
            document.getElementById('lang-display').innerText = state.lang.toUpperCase();
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (resources[state.lang][key]) {
                    el.innerText = resources[state.lang][key];
                }
            });
            document.getElementById('new-prod-name').placeholder = state.lang === 'cn' ? "å•†å“åç§°" : "Item Name";
            document.getElementById('new-prod-price').placeholder = state.lang === 'cn' ? "ä»·æ ¼" : "Price";
            document.getElementById('new-prod-options').placeholder = state.lang === 'cn' ? "é€‰é¡¹ (å¦‚: åŠ è¾£, å°‘ç³–)" : "Options (e.g., Spicy, No Onion)";
        }

        function setupListeners() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (snapshot) => {
                state.products = [];
                snapshot.forEach(d => state.products.push({id: d.id, ...d.data()}));
                renderMenu(); renderMenuManager();
            });
            
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (snapshot) => {
                state.orders = [];
                snapshot.forEach(d => state.orders.push({id: d.id, ...d.data()}));
                state.orders.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                if (!isInitialLoad) {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            playSound();
                        }
                    });
                }
                isInitialLoad = false;
                renderAdminOrders();
            });
        }
        
        function playSound() {
            const audio = document.getElementById('notif-sound');
            if(audio) audio.play().catch(e => console.log("Audio autoplay blocked by browser"));
        }

        function renderCategoryBar() {
            const container = document.getElementById('category-bar');
            const isMobile = window.innerWidth < 640; 
            
            if (isMobile) {
                const visibleCats = categories.slice(0, 3);
                let html = visibleCats.map(cat => generateCatBtnHTML(cat)).join('');
                
                const isHiddenActive = !visibleCats.includes(state.activeCategory);
                const moreBtnClass = isHiddenActive ? "cat-btn-active ring-2 ring-offset-2 ring-offset-dark-900 ring-primary" : "cat-btn-inactive";
                const moreText = resources[state.lang]['more'];
                
                html += `<button onclick="openCategoryModal()" class="px-4 py-2 rounded-full text-[11px] font-bold whitespace-nowrap transition-all duration-300 ${moreBtnClass} flex items-center gap-1">
                            ${moreText} <i class="fas fa-chevron-down text-[10px]"></i>
                         </button>`;
                container.innerHTML = html;
            } else {
                container.innerHTML = categories.map(cat => generateCatBtnHTML(cat)).join('');
            }
        }

        function generateCatBtnHTML(cat) {
            const isActive = state.activeCategory === cat;
            const activeClass = isActive ? "cat-btn-active" : "cat-btn-inactive";
            const label = resources[state.lang][cat] || cat;
            return `<button onclick="window.filterCategory('${cat}')" class="px-5 py-2 rounded-full text-[11px] font-bold whitespace-nowrap transition-all duration-300 ${activeClass}">${label}</button>`;
        }
        
        window.openCategoryModal = () => {
            const grid = document.getElementById('modal-cat-grid');
            grid.innerHTML = categories.map(cat => {
                const isActive = state.activeCategory === cat;
                const bgClass = isActive ? "bg-primary text-white border-primary shadow-lg shadow-primary/30" : "bg-dark-900 text-dark-muted border-dark-700 hover:border-gray-500 hover:text-white";
                const label = resources[state.lang][cat] || cat;
                return `<button onclick="selectCategoryFromModal('${cat}')" class="p-4 rounded-xl font-bold text-sm border ${bgClass} transition flex items-center justify-center">${label}</button>`;
            }).join('');
            document.getElementById('modal-category').classList.remove('hide');
        }

        window.selectCategoryFromModal = (cat) => {
            window.filterCategory(cat);
            closeModal('modal-category');
        }
        
        window.filterCategory = (cat) => { 
            state.activeCategory = cat; 
            renderCategoryBar(); 
            renderMenu(); 
        };

        function renderMenu() {
            const grid = document.getElementById('menu-grid');
            document.getElementById('menu-loading').classList.add('hide');
            grid.innerHTML = '';

            const filteredProducts = state.activeCategory === 'All' ? state.products : state.products.filter(p => p.category === state.activeCategory || (!p.category && state.activeCategory === 'Other'));

            if (filteredProducts.length === 0) return document.getElementById('empty-menu-msg').classList.remove('hide');
            document.getElementById('empty-menu-msg').classList.add('hide');

            filteredProducts.forEach(p => {
                const imgHtml = (p.image && p.image.startsWith('http')) ? 
                    `<img src="${p.image}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy">` : 
                    `<div class="w-full h-full flex items-center justify-center text-4xl text-dark-700"><i class="fas fa-utensils"></i></div>`;
                
                const isSoldOut = p.isSoldOut === true;
                const containerClass = isSoldOut ? "relative h-52 rounded-[24px] shadow-lg border border-dark-700/50 overflow-hidden bg-dark-800" : "relative h-52 rounded-[24px] shadow-lg border border-dark-700/50 cursor-pointer overflow-hidden group active:scale-[0.95] transition-all bg-dark-800";
                const contentFilter = isSoldOut ? "sold-out-filter" : "";
                const soldOutBadge = isSoldOut ? `<div class="absolute inset-0 z-20 flex items-center justify-center pointer-events-none"><span class="bg-red-600/90 text-white border-2 border-white font-black text-xl px-6 py-2 transform -rotate-12 shadow-2xl tracking-widest rounded-lg">${resources[state.lang]['sold_out']}</span></div>` : "";

                const el = document.createElement('div');
                el.className = containerClass;
                if(!isSoldOut) el.onclick = () => openProductModal(p.id);
                
                el.innerHTML = `
                    ${soldOutBadge}
                    <div class="${contentFilter} w-full h-full">
                        <div class="absolute inset-0 w-full h-full">
                            ${imgHtml}
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent opacity-90"></div>
                        <div class="absolute bottom-0 left-0 right-0 p-4 flex flex-col justify-end h-full pointer-events-none">
                            <div class="transform translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
                                <h3 class="font-bold text-white text-[15px] leading-tight mb-1 line-clamp-2 drop-shadow-md">${p.name}</h3>
                                <div class="flex justify-between items-center mt-1">
                                    <p class="text-primary font-extrabold text-sm drop-shadow-md">${p.price} Ks</p>
                                    <div class="w-8 h-8 rounded-full bg-white/20 backdrop-blur-md border border-white/10 flex items-center justify-center text-white hover:bg-primary hover:border-primary transition-colors shadow-lg">
                                        <i class="fas fa-plus text-xs"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            });
        }

        window.renderAdminOrders = () => {
            const grid = document.getElementById('orders-grid');
            grid.innerHTML = '';
            if(state.orders.length === 0) return document.getElementById('no-orders-msg').classList.remove('hidden');
            document.getElementById('no-orders-msg').classList.add('hidden');
            
            state.orders.forEach(order => {
                let statusColor, btnHtml, stText;
                
                if (order.status === 'pending') {
                    statusColor = "bg-yellow-900/20 text-yellow-400 border-yellow-900/50";
                    stText = "Pending";
                    btnHtml = `<button onclick="window.startOrder('${order.id}')" class="flex-1 bg-white text-dark-900 py-2 rounded-xl text-xs font-bold hover:bg-gray-200 transition">Start</button>`;
                } else if (order.status === 'cooking') {
                    statusColor = "bg-blue-900/20 text-blue-400 border-blue-900/50";
                    stText = "Cooking";
                    btnHtml = `<button onclick="window.updateStatus('${order.id}', 'served')" class="flex-1 bg-white text-dark-900 py-2 rounded-xl text-xs font-bold hover:bg-gray-200 transition">Serve</button>`;
                } else if (order.status === 'served') {
                    statusColor = "bg-gray-700/50 text-gray-400 border-gray-700";
                    stText = "Served";
                    btnHtml = `<button onclick="window.printTicket('${order.id}', 'customer')" class="flex-1 border border-dark-700 text-gray-300 py-2 rounded-xl text-xs font-bold hover:bg-dark-700 hover:text-white transition">Print</button>`;
                }
                
                const isTakeaway = order.orderType === 'takeaway';
                const typeBadge = isTakeaway ? `<span class="bg-purple-900/50 text-purple-300 border border-purple-500/30 px-2 py-0.5 rounded text-[10px] font-bold ml-2 animate-pulse"><i class="fas fa-shopping-bag mr-1"></i>TAKEAWAY</span>` : '';

                const div = document.createElement('div');
                div.className = "bg-dark-800 rounded-2xl shadow-lg border border-dark-700 p-4 flex flex-col gap-3";
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-dark-900 flex items-center justify-center font-bold text-white border border-dark-700 shadow-inner">${order.tableId}</div>
                            <span class="text-xs font-bold text-gray-400">#${order.id.slice(0,4)}</span>
                        </div>
                        <div class="flex items-center">
                            ${typeBadge}
                            <span class="px-2 py-1 rounded-lg text-[10px] font-bold border ${statusColor} ml-2">${stText}</span>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto max-h-32 space-y-2 py-2 border-t border-b border-dark-700 custom-scroll">
                        ${order.items.map(i=>`
                            <div class="flex flex-col text-xs">
                                <div class="flex justify-between">
                                    <span class="font-bold text-white text-sm">${i.qty}x ${i.name}</span>
                                </div>
                                <div class="pl-2">
                                     ${i.modifiers && i.modifiers.length ? `<span class="text-[10px] text-gray-400 block">â€¢ ${i.modifiers.join(', ')}</span>` : ''}
                                     ${i.remarks ? `<span class="text-[10px] text-orange-400 font-bold block italic">" ${i.remarks} "</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex gap-2 items-center pt-1">
                        <span class="font-bold text-base text-white">${order.totalPrice}</span>
                        ${btnHtml}
                    </div>`;
                grid.appendChild(div);
            });
        };

        window.startOrder = async (id) => {
             try {
                 await updateDoc(doc(db,'artifacts',appId,'public','data','orders',id),{status: 'cooking'});
                 window.printTicket(id, 'kitchen');
             } catch(e) { console.error(e); alert("Error starting order"); }
        };

        function renderMenuManager() {
            document.getElementById('menu-table-body').innerHTML = state.products.map(p => {
                const isSoldOut = p.isSoldOut === true;
                const stockBtnClass = isSoldOut ? "bg-red-500/20 text-red-400 border-red-500/30" : "bg-green-500/20 text-green-400 border-green-500/30";
                const stockIcon = isSoldOut ? "fa-toggle-off" : "fa-toggle-on";
                
                return `<tr class="hover:bg-dark-700 border-b border-dark-700 transition">
                    <td class="p-3">
                        <div class="font-bold text-white ${isSoldOut ? 'opacity-50 line-through decoration-red-500' : ''}">${p.name}</div>
                        <div class="text-[10px] text-dark-muted uppercase font-bold bg-dark-900 inline-block px-2 py-0.5 rounded border border-dark-700 mt-1">${resources[state.lang][p.category] || p.category || 'N/A'}</div>
                    </td>
                    <td class="p-3 text-right flex items-center justify-end gap-2">
                        <button onclick="window.toggleStock('${p.id}', ${isSoldOut})" class="w-10 h-8 rounded-full border ${stockBtnClass} hover:brightness-125 transition flex items-center justify-center" title="Toggle Stock">
                            <i class="fas ${stockIcon} text-lg"></i>
                        </button>
                        <button onclick="window.editProduct('${p.id}')" class="text-white hover:bg-dark-600 bg-dark-700 w-8 h-8 rounded-full transition flex items-center justify-center">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                        <button onclick="window.deleteProduct('${p.id}')" class="text-red-400 hover:text-white hover:bg-red-500/80 bg-red-900/20 w-8 h-8 rounded-full transition flex items-center justify-center">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        window.toggleStock = async (id, currentStatus) => {
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id), { isSoldOut: !currentStatus });
            } catch(e) { console.error(e); alert("Error updating stock"); }
        };

        window.editProduct = (id) => {
            const p = state.products.find(x => x.id === id);
            if (!p) return;
            state.editingProductId = id;
            document.getElementById('new-prod-name').value = p.name;
            document.getElementById('new-prod-price').value = p.price;
            document.getElementById('new-prod-img').value = (p.image === 'ğŸ½ï¸' || !p.image) ? '' : p.image;
            document.getElementById('new-prod-category').value = p.category || 'Other';
            document.getElementById('new-prod-options').value = p.options ? p.options.join(', ') : '';

            document.getElementById('btn-save-prod').innerText = resources[state.lang]['update_item'];
            document.getElementById('btn-save-prod').classList.remove('bg-primary', 'hover:bg-red-600');
            document.getElementById('btn-save-prod').classList.add('bg-green-600', 'hover:bg-green-500');
            document.getElementById('edit-controls').classList.remove('hide');
        };

        window.cancelEdit = () => {
            state.editingProductId = null;
            document.getElementById('new-prod-name').value = '';
            document.getElementById('new-prod-price').value = '';
            document.getElementById('new-prod-img').value = '';
            document.getElementById('new-prod-options').value = '';
            
            document.getElementById('btn-save-prod').innerText = resources[state.lang]['add_item'];
            document.getElementById('btn-save-prod').classList.add('bg-primary', 'hover:bg-red-600');
            document.getElementById('btn-save-prod').classList.remove('bg-green-600', 'hover:bg-green-500');
            document.getElementById('edit-controls').classList.add('hide');
        };

        window.saveProduct = async () => {
            const n = document.getElementById('new-prod-name').value;
            const p = parseInt(document.getElementById('new-prod-price').value);
            const i = document.getElementById('new-prod-img').value;
            const o = document.getElementById('new-prod-options').value;
            const c = document.getElementById('new-prod-category').value;
            
            if(!n || !p) return alert("Missing Info");
            
            const data = { name: n, price: p, image: i || 'ğŸ½ï¸', options: o ? o.split(',').map(s=>s.trim()).filter(Boolean) : [], category: c };

            try {
                if (state.editingProductId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', state.editingProductId), data);
                    alert("Updated Successfully");
                    window.cancelEdit(); 
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), data);
                    alert("Added Successfully");
                    document.getElementById('new-prod-name').value=''; 
                    document.getElementById('new-prod-price').value=''; 
                    document.getElementById('new-prod-img').value=''; 
                    document.getElementById('new-prod-options').value='';
                }
            } catch (e) { console.error(e); alert("Error saving product"); }
        };

        window.deleteProduct = async (id) => { if(confirm("Remove?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id)); };

        // ... existing POS/Cart functions ...
        window.openProductModal = (id) => {
            const p = state.products.find(x => x.id === id); if(!p) return;
            state.selectedProduct = { ...p, qty: 1 };
            document.getElementById('mp-name').innerText = p.name;
            document.getElementById('mp-price-display').innerText = p.price + ' Ks';
            document.getElementById('mp-qty').innerText = 1;
            document.getElementById('prod-remark').value = ''; 
            const img = document.getElementById('mp-img');
            img.src = (p.image && p.image.startsWith('http')) ? p.image : 'https://placehold.co/600x400/1F2937/9CA3AF?text='+(p.image||'Food');
            
            const optionsContainer = document.getElementById('dynamic-options');
            optionsContainer.innerHTML = '';
            const opts = (p.options && p.options.length > 0) ? p.options : ["Normal Spicy", "Less Spicy", "No MSG"]; 
            opts.forEach(opt => {
                const div = document.createElement('div');
                div.innerHTML = `<label class="cursor-pointer block"><input type="checkbox" name="prod_option" value="${opt}" class="peer sr-only"><div class="border border-dark-700 peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary rounded-xl py-3 px-2 text-center text-[10px] font-bold transition-all h-full bg-dark-900 text-dark-muted hover:bg-dark-700">${opt}</div></label>`;
                optionsContainer.appendChild(div);
            });
            document.getElementById('modal-product').classList.remove('hide');
        };

        window.updateQty = (c) => { let q = state.selectedProduct.qty + c; if(q>=1) { state.selectedProduct.qty = q; document.getElementById('mp-qty').innerText = q; } };
        window.addToCart = () => {
            const checkboxes = document.querySelectorAll('input[name="prod_option"]:checked');
            const remark = document.getElementById('prod-remark').value.trim(); 
            
            state.cart.push({ 
                ...state.selectedProduct, 
                modifiers: Array.from(checkboxes).map(cb=>cb.value), 
                remarks: remark, 
                lineTotal: state.selectedProduct.price * state.selectedProduct.qty 
            });
            updateCartUI(); closeModal('modal-product');
        };
        function updateCartUI() {
            const c = state.cart.reduce((a,i)=>a+i.qty,0);
            document.getElementById('cart-count').innerText = c;
            document.getElementById('cart-total').innerText = state.cart.reduce((a,i)=>a+i.lineTotal,0) + " Ks";
            const bar = document.getElementById('cart-bar');
            if(c>0) bar.classList.remove('translate-y-[200%]'); else bar.classList.add('translate-y-[200%]');
        }
        
        window.setOrderType = (type) => {
            state.orderType = type;
            const btnDine = document.getElementById('btn-type-dine');
            const btnTake = document.getElementById('btn-type-take');
            
            if(type === 'dine_in') {
                btnDine.classList.remove('text-dark-muted', 'hover:text-white');
                btnDine.classList.add('bg-primary', 'text-white', 'shadow-md');
                
                btnTake.classList.add('text-dark-muted', 'hover:text-white');
                btnTake.classList.remove('bg-purple-600', 'text-white', 'shadow-md'); 
            } else {
                btnDine.classList.add('text-dark-muted', 'hover:text-white');
                btnDine.classList.remove('bg-primary', 'text-white', 'shadow-md');
                
                btnTake.classList.remove('text-dark-muted', 'hover:text-white');
                btnTake.classList.add('bg-purple-600', 'text-white', 'shadow-md');
            }
        };

        window.openCheckoutModal = () => {
            if(state.cart.length===0) return;
            window.setOrderType('dine_in');
            document.getElementById('checkout-items').innerHTML = state.cart.map((item,i)=>`
                <div class="flex justify-between items-start bg-dark-800 p-3 rounded-2xl border border-dark-700 shadow-sm">
                    <div class="flex gap-3">
                        <div class="font-bold bg-dark-900 w-8 h-8 rounded-lg flex items-center justify-center text-white text-xs border border-dark-700">${item.qty}x</div>
                        <div>
                            <p class="font-bold text-sm text-white">${item.name}</p>
                            <p class="text-[10px] text-dark-muted mt-0.5">${item.modifiers.join(', ')}</p>
                            ${item.remarks ? `<p class="text-[10px] text-orange-400 italic mt-0.5">"${item.remarks}"</p>` : ''}
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <span class="font-bold text-sm text-white">${item.lineTotal}</span>
                        <button onclick="window.removeFromCart(${i})" class="text-red-400 text-xs bg-red-900/20 px-2 py-1 rounded-md hover:bg-red-900/40 transition"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');
            document.getElementById('checkout-grand-total').innerText = state.cart.reduce((a,i)=>a+i.lineTotal,0) + " Ks";
            document.getElementById('modal-checkout').classList.remove('hide');
        };
        window.removeFromCart = (i) => { state.cart.splice(i,1); if(state.cart.length===0) closeModal('modal-checkout'); else window.openCheckoutModal(); updateCartUI(); };
        window.submitOrder = async () => {
            if(!state.user) return alert("Not Connected");
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
                    tableId: state.tableId, 
                    items: state.cart, 
                    totalPrice: state.cart.reduce((a,i)=>a+i.lineTotal,0), 
                    status: 'pending', 
                    timestamp: serverTimestamp(), 
                    userId: state.user.uid,
                    orderType: state.orderType 
                });
                state.cart=[]; updateCartUI(); closeModal('modal-checkout'); 
                
                const div = document.createElement('div');
                div.className = "fixed top-5 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-full shadow-xl z-[200] font-bold text-sm animate-slide-up flex items-center gap-2";
                div.innerHTML = '<i class="fas fa-check-circle"></i> Order Sent Successfully!';
                document.body.appendChild(div);
                setTimeout(()=>div.remove(), 3000);

                if (state.isPOSMode) {
                    const autoReturn = document.getElementById('chk-auto-return').checked;
                    if (autoReturn) {
                        setTimeout(() => exitPOSMode(), 1000);
                    }
                }

            } catch(e){ console.error(e); alert("Failed"); }
        };
        window.updateStatus = async (id,s) => await updateDoc(doc(db,'artifacts',appId,'public','data','orders',id),{status:s});

        // UTILS
        window.openLoginModal = () => document.getElementById('modal-login').classList.remove('hide');
        window.verifyPin = () => {
            const p = document.getElementById('staff-pin').value;
            const c = localStorage.getItem('pingpos_admin_pin') || '1234';
            if(p === c) { switchMode('admin'); closeModal('modal-login'); document.getElementById('staff-pin').value=''; } else alert("Wrong PIN");
        };
        window.openChangePinModal=()=>document.getElementById('modal-change-pin').classList.remove('hide');
        window.saveNewPin=()=>{ 
            const n=document.getElementById('new-pin-input').value; 
            if(n.length>=4){ localStorage.setItem('pingpos_admin_pin', n); alert("Saved"); closeModal('modal-change-pin'); } else alert("Min 4 digits"); 
        };
        window.openMenuManager=()=>document.getElementById('modal-menu').classList.remove('hide');
        window.closeModal=(id)=>document.getElementById(id).classList.add('hide');
        window.switchMode=(m)=>{
            if(m==='customer'){
                document.getElementById('customer-view').classList.remove('hide');
                document.getElementById('admin-view').classList.add('hide');
                document.getElementById('nav-customer-controls').classList.remove('hide');
                document.getElementById('nav-admin-controls').classList.add('hide');
            } else {
                document.getElementById('customer-view').classList.add('hide');
                document.getElementById('admin-view').classList.remove('hide');
                document.getElementById('nav-customer-controls').classList.add('hide');
                document.getElementById('nav-admin-controls').classList.remove('hide');
            }
        };

        // --- ENHANCED REPORT LOGIC ---
        window.switchReportTab = (tab) => {
            document.getElementById('rpt-view-overview').classList.add('hide');
            document.getElementById('rpt-view-history').classList.add('hide');
            document.getElementById('rpt-view-top').classList.add('hide');
            
            ['overview', 'history', 'top'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if(t === tab) {
                    el.classList.remove('text-dark-muted');
                    el.classList.add('bg-dark-700', 'text-white', 'shadow-sm');
                } else {
                    el.classList.add('text-dark-muted');
                    el.classList.remove('bg-dark-700', 'text-white', 'shadow-sm');
                }
            });

            document.getElementById(`rpt-view-${tab}`).classList.remove('hide');
            if(tab === 'overview') renderReportOverview();
            if(tab === 'history') renderSalesHistory();
            if(tab === 'top') renderTopSelling();
        };

        window.openReportModal = () => { document.getElementById('modal-report').classList.remove('hide'); renderReportOverview(); };
        
        window.refreshReport = () => {
             if(!document.getElementById('rpt-view-overview').classList.contains('hide')) renderReportOverview();
             else if(!document.getElementById('rpt-view-history').classList.contains('hide')) renderSalesHistory();
             else renderTopSelling();
        };

        function isDateInRange(dateObj, range, selectedDate) {
            const d = new Date(dateObj); 
            const s = new Date(selectedDate); 
            
            d.setHours(0,0,0,0);
            const sMidnight = new Date(s);
            sMidnight.setHours(0,0,0,0);

            if (range === 'daily') {
                return d.getTime() === sMidnight.getTime();
            } 
            else if (range === 'weekly') {
                const day = sMidnight.getDay();
                const diff = sMidnight.getDate() - day + (day === 0 ? -6 : 1);
                const monday = new Date(sMidnight.setDate(diff));
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                return d >= monday && d <= sunday;
            }
            else if (range === 'monthly') {
                return d.getMonth() === s.getMonth() && d.getFullYear() === s.getFullYear();
            }
            else if (range === 'yearly') {
                return d.getFullYear() === s.getFullYear();
            }
            return false;
        }

        window.renderReportOverview = () => {
            const dateInput = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            let c=0, t=0;
            
            let chartLabels = [];
            let chartData = [];
            let categoryStats = {}; // To store category totals
            
            if(range === 'daily') {
                chartLabels = Array.from({length: 24}, (_, i) => `${i}:00`);
                chartData = new Array(24).fill(0);
                document.getElementById('rpt-period-label').innerText = new Date(dateInput).toDateString();
            } else if (range === 'weekly') {
                chartLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                chartData = new Array(7).fill(0);
                document.getElementById('rpt-period-label').innerText = "Selected Week";
            } else if (range === 'monthly') {
                const daysInMonth = new Date(new Date(dateInput).getFullYear(), new Date(dateInput).getMonth() + 1, 0).getDate();
                chartLabels = Array.from({length: daysInMonth}, (_, i) => `${i+1}`);
                chartData = new Array(daysInMonth).fill(0);
                document.getElementById('rpt-period-label').innerText = new Date(dateInput).toLocaleDateString(state.lang==='cn'?'zh-CN':'en-US', {month: 'long', year: 'numeric'});
            } else if (range === 'yearly') {
                chartLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                chartData = new Array(12).fill(0);
                document.getElementById('rpt-period-label').innerText = new Date(dateInput).getFullYear();
            }

            state.orders.forEach(o => { 
                if(o.timestamp) {
                    const dateObj = new Date(o.timestamp.seconds*1000);
                    
                    if (isDateInRange(dateObj, range, dateInput)) {
                        c++; 
                        t+=o.totalPrice;
                        
                        // Populate Chart Data
                        if(range === 'daily') {
                            chartData[dateObj.getHours()] += o.totalPrice;
                        } else if (range === 'weekly') {
                            const day = dateObj.getDay(); 
                            const index = day === 0 ? 6 : day - 1; 
                            chartData[index] += o.totalPrice;
                        } else if (range === 'monthly') {
                            chartData[dateObj.getDate() - 1] += o.totalPrice;
                        } else if (range === 'yearly') {
                            chartData[dateObj.getMonth()] += o.totalPrice;
                        }

                        // Calculate Category Sales
                        if(o.items && Array.isArray(o.items)) {
                            o.items.forEach(item => {
                                const cat = item.category || 'Other';
                                categoryStats[cat] = (categoryStats[cat] || 0) + item.lineTotal;
                            });
                        }
                    }
                }
            });
            document.getElementById('rpt-ov-total').innerText = t.toLocaleString(); 
            document.getElementById('rpt-ov-count').innerText = c;
            
            // Render Sales Trend Chart
            renderSalesChart(chartLabels, chartData);

            // Render Category Chart (FIXED)
            const catLabels = Object.keys(categoryStats);
            const catData = Object.values(categoryStats);
            if(catLabels.length > 0) {
                 renderCategoryChart(catLabels, catData);
            } else {
                 // Clear chart if no data
                 renderCategoryChart([], []); 
            }
        };

        window.renderSalesChart = (labels, data) => {
            const ctx = document.getElementById('salesChart').getContext('2d');
            let gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, '#60A5FA'); gradient.addColorStop(1, '#2563EB');

            if (state.chartInstance) state.chartInstance.destroy();

            state.chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sales (Ks)',
                        data: data,
                        backgroundColor: gradient,
                        borderRadius: 4,
                        hoverBackgroundColor: '#3B82F6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: '#9CA3AF' } },
                        x: { grid: { display: false }, ticks: { color: '#9CA3AF', maxTicksLimit: 12 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        };

        // NEW: Render Category Chart Logic
        window.renderCategoryChart = (categories, data) => {
            const ctx = document.getElementById('categoryChart').getContext('2d');

            if (state.categoryChartInstance) {
                state.categoryChartInstance.destroy();
            }

            state.categoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#FF4757', '#34D399', '#FBBF24', '#60A5FA', '#A78BFA', '#F472B6', '#9CA3AF', '#EC4899', '#6366f1'
                        ],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'right', 
                            labels: { color: '#9CA3AF', font: { size: 10 }, boxWidth: 10 } 
                        }
                    },
                    cutout: '70%'
                }
            });
        };

        window.renderSalesHistory = () => {
            const dateInput = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            const b = document.getElementById('rpt-history-body'); b.innerHTML = '';
            
            const h = state.orders.filter(o => {
                if(!o.timestamp) return false;
                const d = new Date(o.timestamp.seconds*1000);
                return ['served','cooking','pending'].includes(o.status) && isDateInRange(d, range, dateInput);
            });

            if(h.length===0) { b.innerHTML='<tr><td colspan="4" class="p-4 text-center text-xs text-dark-700">No records found for this period</td></tr>'; return; }
            h.forEach(o => {
                const d = o.timestamp ? new Date(o.timestamp.seconds*1000) : new Date();
                let dateStr = d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                if(range !== 'daily') dateStr = `${d.getDate()}/${d.getMonth()+1} ${dateStr}`;

                b.innerHTML += `<tr class="border-b border-dark-700 last:border-0 hover:bg-dark-800 transition"><td class="p-3 text-xs text-dark-muted">${dateStr}</td><td class="p-3 font-bold text-white">T-${o.tableId}</td><td class="p-3 font-bold text-primary">${o.totalPrice}</td><td class="p-3 text-right"><button onclick="deleteOrder('${o.id}')" class="text-red-500 hover:text-red-400 bg-red-500/10 p-2 rounded-lg transition"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        };

        window.renderTopSelling = () => {
            const dateInput = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            const c={}; 
            
            const filteredOrders = state.orders.filter(o => {
                 if(!o.timestamp) return false;
                 const d = new Date(o.timestamp.seconds*1000);
                 return isDateInRange(d, range, dateInput);
            });

            filteredOrders.forEach(o=>{ if(o.items) o.items.forEach(i=>{ c[i.name]=(c[i.name]||0)+i.qty; }); });
            
            const s=Object.entries(c).sort((a,b)=>b[1]-a[1]);
            const ct=document.getElementById('rpt-top-list'); ct.innerHTML='';
            if(s.length===0) ct.innerHTML='<p class="text-center text-dark-700 p-4 text-xs">No sales data for this period</p>';
            
            // Progress bar logic
            const maxVal = s.length > 0 ? s[0][1] : 1;
            
            s.forEach(([n,q],i)=>{ 
                const percent = (q / maxVal) * 100;
                ct.innerHTML+=`
                <div class="p-3 bg-dark-800 rounded-xl border border-dark-700 relative overflow-hidden group">
                    <div class="absolute top-0 left-0 bottom-0 bg-primary/10 transition-all duration-500" style="width: ${percent}%"></div>
                    <div class="relative flex justify-between items-center z-10">
                        <div class="flex gap-3 items-center">
                            <span class="font-bold text-primary w-5 text-sm">#${i+1}</span>
                            <span class="font-bold text-white text-sm">${n}</span>
                        </div>
                        <span class="text-xs font-bold text-white bg-dark-900 px-2 py-1 rounded-lg border border-dark-600">${q} sold</span>
                    </div>
                </div>`; 
            });
        };

        window.deleteOrder = async(id) => { if(confirm("Delete?")) { await deleteDoc(doc(db,'artifacts',appId,'public','data','orders',id)); renderSalesHistory(); }};
        window.clearAllHistory = async() => { if(confirm("Delete ALL?")) { const p=prompt("PIN:"); if(p===(localStorage.getItem('pingpos_admin_pin')||'1234')){ for(const o of state.orders) await deleteDoc(doc(db,'artifacts',appId,'public','data','orders',o.id)); alert("Cleared"); renderSalesHistory(); } else alert("Wrong PIN"); }};
        
        window.openQRModal=()=>document.getElementById('modal-qr').classList.remove('hide');
        window.generateQR=()=>{ const t=document.getElementById('qr-table-num').value; document.getElementById('qr-container').innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.location.href.split('?')[0]+'?table='+t)}">`; };
        window.printQR=()=>{ const w=window.open('','','height=400,width=400'); w.document.write('<html><body style="text-align:center">'+document.getElementById('qr-container').innerHTML+'</body></html>'); w.document.close(); w.print(); };
        
        window.printTicket = (id, type) => {
            const o = state.orders.find(x => x.id === id); if(!o) return;
            
            document.getElementById('rcp-id').innerText = '#' + id.slice(0,4).toUpperCase();
            document.getElementById('rcp-table').innerText = o.tableId;
            document.getElementById('rcp-date').innerText = new Date().toLocaleDateString();
            
            let headerExtra = "";
            if (o.orderType === 'takeaway') {
                headerExtra = "<br><span style='font-size: 1.2em; font-weight: 800; border: 2px solid black; padding: 2px 5px; display: inline-block; margin-top: 5px;'>[ TAKEAWAY ]</span>";
            }

            if (type === 'kitchen') {
                document.getElementById('rcp-type').innerHTML = "KITCHEN TICKET" + headerExtra;
                document.getElementById('rcp-th-amt').classList.add('hide'); 
                document.getElementById('rcp-footer').classList.add('hide'); 
                
                document.getElementById('rcp-items').innerHTML = o.items.map(i => 
                    `<tr>
                        <td class="py-1 font-bold" colspan="2" style="font-size: 1.1em">${i.name} x${i.qty}</td>
                     </tr>
                     ${i.modifiers.length ? `<tr><td colspan="2" class="text-[10px] text-gray-500 pb-2">(${i.modifiers.join(', ')})</td></tr>` : ''}
                     ${i.remarks ? `<tr><td colspan="2" class="text-xs font-bold italic pb-2">** ${i.remarks} **</td></tr>` : '<tr><td colspan="2" class="pb-2"></td></tr>'}`
                ).join('');
                
            } else {
                document.getElementById('rcp-type').innerHTML = "RECEIPT" + headerExtra;
                document.getElementById('rcp-th-amt').classList.remove('hide');
                document.getElementById('rcp-footer').classList.remove('hide');
                document.getElementById('rcp-total').innerText = o.totalPrice + ' Ks';
                
                document.getElementById('rcp-items').innerHTML = o.items.map(i => 
                    `<tr>
                        <td class="py-1">${i.name} x${i.qty}</td>
                        <td class="py-1 text-right">${i.lineTotal}</td>
                     </tr>
                     ${i.modifiers.length ? `<tr><td colspan="2" class="text-[10px] text-gray-500 pb-1">(${i.modifiers.join(', ')})</td></tr>` : ''}
                     ${i.remarks ? `<tr><td colspan="2" class="text-[10px] italic pb-1">Note: ${i.remarks}</td></tr>` : ''}`
                ).join('');
            }
            
            setTimeout(() => window.print(), 100);
        };
        
        window.printReceipt = (id) => window.printTicket(id, 'customer');

        const getOccupiedTables = () => {
            const busy = new Set();
            state.orders.forEach(o => {
                if (o.status === 'pending' || o.status === 'cooking') busy.add(String(o.tableId));
            });
            return busy;
        };

        window.openTableMap = () => {
            renderTableMap();
            document.getElementById('modal-table-map').classList.remove('hide');
        };

        window.renderTableMap = () => {
            const busyTables = getOccupiedTables();
            const container = document.getElementById('table-map-container');
            container.innerHTML = '';
            
            if(!state.isLayoutEdit && state.selectedTableId) {
                state.selectedTableId = null;
                updatePropertiesPanel();
            }

            state.tables.forEach(t => {
                const isBusy = busyTables.has(t.id);
                const isSelected = state.selectedTableId === t.id;
                
                const shapeClass = t.shape === 'rect' ? 'rounded-lg aspect-square' : 'rounded-full aspect-square';
                const colorClass = isBusy ? "bg-red-500 shadow-red-500/50" : "bg-green-500 shadow-green-500/50";
                
                let borderClass = "cursor-pointer hover:brightness-110";
                if (state.isLayoutEdit) {
                    borderClass = "cursor-move border-2 border-dashed border-white/30";
                    if(isSelected) borderClass = "selected cursor-move";
                }
                
                const sizeScale = t.size || 1;
                const baseSize = 80; 
                const sizePx = baseSize * sizeScale;

                const div = document.createElement('div');
                div.className = `table-node flex flex-col items-center justify-center text-white font-bold shadow-lg ${shapeClass} ${colorClass} ${borderClass}`;
                div.style.left = t.x + '%';
                div.style.top = t.y + '%';
                div.style.width = sizePx + 'px';
                div.style.height = sizePx + 'px';
                div.style.fontSize = (16 * sizeScale) + 'px';
                
                div.id = `table-${t.id}`;
                
                div.innerHTML = `
                    <i class="fas ${t.shape==='rect'?'fa-square':'fa-circle'} mb-1 opacity-50 pointer-events-none" style="font-size: 1.2em"></i>
                    <span class="pointer-events-none">T-${t.id}</span>
                `;

                if (state.isLayoutEdit) {
                    div.addEventListener('mousedown', (e) => startDrag(e, t.id));
                    div.addEventListener('touchstart', (e) => startDrag(e, t.id), {passive: false});
                    div.onclick = (e) => { e.stopPropagation(); selectTable(t.id); };
                } else {
                    div.onclick = () => window.startPOSMode(t.id);
                }

                container.appendChild(div);
            });
            
            updatePropertiesPanel();
        };

        window.selectTable = (id) => {
            if(!state.isLayoutEdit) return;
            state.selectedTableId = id;
            renderTableMap(); 
        };

        window.deselectTable = () => {
            if(state.selectedTableId) {
                state.selectedTableId = null;
                renderTableMap();
            }
        };

        window.updatePropertiesPanel = () => {
            const panel = document.getElementById('table-properties');
            const legend = document.getElementById('map-legend');
            
            if (state.isLayoutEdit && state.selectedTableId) {
                const t = state.tables.find(x => x.id === state.selectedTableId);
                if(t) {
                    legend.classList.add('hide');
                    panel.classList.remove('hide');
                    
                    document.getElementById('prop-id').innerText = "T-" + t.id;
                    document.getElementById('prop-size').value = t.size || 1;
                    
                    const btnRound = document.getElementById('btn-shape-round');
                    const btnRect = document.getElementById('btn-shape-rect');
                    if(t.shape === 'rect') {
                        btnRect.classList.add('bg-primary','text-white'); btnRect.classList.remove('text-dark-muted');
                        btnRound.classList.remove('bg-primary','text-white'); btnRound.classList.add('text-dark-muted');
                    } else {
                        btnRound.classList.add('bg-primary','text-white'); btnRound.classList.remove('text-dark-muted');
                        btnRect.classList.remove('bg-primary','text-white'); btnRect.classList.add('text-dark-muted');
                    }
                }
            } else {
                legend.classList.remove('hide');
                panel.classList.add('hide');
            }
        };

        window.updateTableProperty = (key, val) => {
            if(!state.selectedTableId) return;
            const t = state.tables.find(x => x.id === state.selectedTableId);
            if(t) {
                t[key] = (key === 'size') ? parseFloat(val) : val;
                renderTableMap();
            }
        };

        window.deleteSelectedTable = () => {
            if(!state.selectedTableId) return;
            if(confirm(`Delete Table ${state.selectedTableId}?`)) {
                state.tables = state.tables.filter(t => t.id !== state.selectedTableId);
                state.selectedTableId = null;
                renderTableMap();
            }
        };

        window.startDrag = (e, tId) => {
            if(!state.isLayoutEdit) return;
            e.preventDefault();
            
            if(state.selectedTableId !== tId) {
                state.selectedTableId = tId;
                renderTableMap();
            }

            const table = state.tables.find(t => t.id === tId);
            const el = document.getElementById(`table-${tId}`); 
            const container = document.getElementById('table-map-container');
            
            const startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            const startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            const rect = el.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            const offsetX = startX - rect.left;
            const offsetY = startY - rect.top;

            state.dragItem = { tId, offsetX, offsetY, containerRect };

            const moveHandler = (moveEvent) => {
                const clientX = moveEvent.type.includes('mouse') ? moveEvent.clientX : moveEvent.touches[0].clientX;
                const clientY = moveEvent.type.includes('mouse') ? moveEvent.clientY : moveEvent.touches[0].clientY;

                let newLeft = clientX - state.dragItem.containerRect.left - state.dragItem.offsetX;
                let newTop = clientY - state.dragItem.containerRect.top - state.dragItem.offsetY;

                let percentX = (newLeft / state.dragItem.containerRect.width) * 100;
                let percentY = (newTop / state.dragItem.containerRect.height) * 100;

                percentX = Math.max(0, Math.min(90, percentX));
                percentY = Math.max(0, Math.min(90, percentY));

                el.style.left = percentX + '%';
                el.style.top = percentY + '%';
                
                table.x = percentX;
                table.y = percentY;
            };

            const upHandler = () => {
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', upHandler);
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('touchend', upHandler);
                state.dragItem = null;
            };

            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', upHandler);
            document.addEventListener('touchmove', moveHandler, {passive: false});
            document.addEventListener('touchend', upHandler);
        };

        window.toggleLayoutEdit = () => {
            state.isLayoutEdit = !state.isLayoutEdit;
            const btn = document.getElementById('btn-edit-layout');
            const controls = document.getElementById('layout-edit-controls');
            
            state.selectedTableId = null;

            if(state.isLayoutEdit) {
                btn.classList.add('bg-dark-700', 'text-white');
                controls.classList.remove('hide');
                document.getElementById('table-map-subtitle').innerText = "Select table to edit properties.";
            } else {
                btn.classList.remove('bg-dark-700', 'text-white');
                controls.classList.add('hide');
                document.getElementById('table-map-subtitle').innerText = "Select a table to take order";
            }
            renderTableMap();
        };

        window.addNewTable = () => {
            const maxId = state.tables.reduce((max, t) => Math.max(max, parseInt(t.id) || 0), 0);
            const newId = String(maxId + 1);
            
            const shapeSelect = document.getElementById('new-table-shape');
            const shape = shapeSelect ? shapeSelect.value : 'round';

            state.tables.push({ id: newId, x: 45, y: 45, shape: shape, size: 1 });
            renderTableMap();
            
            state.selectedTableId = newId;
            renderTableMap();
            showToast(`Table ${newId} Added!`, "success");
        };

        window.saveLayout = async () => {
            const btn = document.getElementById('btn-save-layout');
            const targetBtn = btn || document.querySelector('#layout-edit-controls button:last-child');
            
            if(!targetBtn) return alert("Error: Save button not found. Please refresh the page.");

            const originalContent = targetBtn.innerHTML;
            targetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            targetBtn.disabled = true;
            targetBtn.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                const cleanTables = state.tables.map(t => ({
                    id: String(t.id),
                    x: Number(t.x) || 0,
                    y: Number(t.y) || 0,
                    shape: t.shape || 'round',
                    size: Number(t.size) || 1
                }));
                
                // FIXED: Used 6 segments path here as well
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config_tables', 'main_layout'), { 
                    tables: cleanTables,
                    updatedAt: serverTimestamp() 
                });
                
                showToast("Layout Saved Successfully!", "success");
                
                setTimeout(() => {
                    if(state.isLayoutEdit) window.toggleLayoutEdit(); 
                }, 500);

            } catch(e) { 
                console.error("Save failed:", e); 
                showToast("Save failed. Check console.", "error"); 
            } finally {
                if(targetBtn) {
                    targetBtn.innerHTML = originalContent;
                    targetBtn.disabled = false;
                    targetBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                }
            }
        };

        window.showToast = (msg, type='success') => {
            const div = document.createElement('div');
            const color = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
            
            div.className = `fixed top-6 left-1/2 transform -translate-x-1/2 ${color} text-white px-6 py-3 rounded-full shadow-2xl z-[200] font-bold text-sm animate-slide-up flex items-center gap-3 border border-white/20`;
            div.innerHTML = `<i class="fas ${icon} text-lg"></i> <span>${msg}</span>`;
            
            document.body.appendChild(div);
            
            if(type === 'success') {
                const audio = document.getElementById('notif-sound');
                if(audio) audio.play().catch(()=>{});
            }

            setTimeout(() => {
                div.style.transition = 'opacity 0.5s, transform 0.5s';
                div.style.opacity = '0';
                div.style.transform = 'translate(-50%, -20px)';
                setTimeout(() => div.remove(), 500);
            }, 3000);
        };
        
        window.startPOSMode = (tId) => {
            state.tableId = tId;
            state.isPOSMode = true;
            document.getElementById('display-table-id').innerText = tId;
            
            closeModal('modal-table-map');
            switchMode('customer');
            document.getElementById('pos-mode-header').classList.remove('hide');
            document.getElementById('nav-customer-controls').classList.add('hide'); 
            
            state.cart = [];
            updateCartUI();
        };

        window.exitPOSMode = () => {
            state.isPOSMode = false;
            state.tableId = "1"; 
            document.getElementById('pos-mode-header').classList.add('hide');
            switchMode('admin');
        };

        init();
    </script>
</body>
</html>
