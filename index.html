<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ping-Restaurant | Professional POS</title>
    <link rel="icon" type="image/png" href="https://ui-avatars.com/api/?name=P&background=FF4757&color=fff">

    <!-- 1. Libraries & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&family=Padauk:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'Noto Sans SC', 'Padauk', 'sans-serif'] },
                    colors: {
                        primary: '#FF4757',
                        accent: '#34D399',
                        dark: { 900: '#111827', 800: '#1F2937', 700: '#374151', text: '#F9FAFB', muted: '#9CA3AF' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', 'Padauk', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #111827; color: #F9FAFB; }
        .hide { display: none !important; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .sold-out-filter { filter: grayscale(100%); opacity: 0.5; pointer-events: none; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .loader { width: 40px; height: 40px; border: 4px solid #374151; border-top: 4px solid #FF4757; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .glass-nav { background: rgba(17, 24, 39, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .cat-btn-active { background-color: #FF4757; color: white; box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4); transform: scale(1.05); }
        .cat-btn-inactive { background-color: #1F2937; color: #9CA3AF; border: 1px solid #374151; }
        .table-node { position: absolute; touch-action: none; user-select: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .page-view { position: fixed; inset: 0; background-color: #111827; z-index: 60; overflow-y: auto; display: flex; flex-direction: column; }
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; opacity: 0.6; }
        .keypad-btn { background-color: #374151; color: white; font-size: 1.25rem; font-weight: 600; border-radius: 0.75rem; padding: 1rem; }
        .keypad-btn:active { background-color: #4B5563; }

        @media print {
            body * { visibility: hidden; }
            #receipt-print-area, #receipt-print-area * { visibility: visible; }
            #receipt-print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">
    <canvas id="bg-canvas"></canvas>
    <audio id="notif-sound" preload="auto"></audio>

    <!-- Navigation Bar -->
    <header id="main-nav" class="glass-nav h-14 flex items-center justify-between px-4 z-50 sticky top-0 shrink-0">
        <div class="flex items-center gap-3">
            <img src="https://placehold.co/150x50/FF4757/FFFFFF?text=Ping+POS&font=roboto" alt="Logo" class="h-9 w-auto rounded-md">
        </div>
        <div class="flex items-center gap-3">
            <button id="silence-btn" onclick="stopIncomingOrderAlert()" class="hide bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold animate-pulse flex items-center gap-2">
                <i class="fas fa-bell-slash"></i> <span>Silence</span>
            </button>
            <button onclick="toggleLanguage()" class="bg-dark-800 border border-dark-700 text-white px-2 py-1 rounded-lg text-xs font-bold flex items-center gap-1">
                <i class="fas fa-globe text-dark-muted"></i> <span id="lang-display">EN</span>
            </button>
            <div id="nav-customer-controls">
                <button onclick="openLoginModal()" class="w-8 h-8 rounded-full bg-dark-800 text-dark-muted flex items-center justify-center border border-dark-700">
                    <i class="fas fa-user-lock text-xs"></i>
                </button>
            </div>
            <div id="nav-admin-controls" class="hide">
                <button onclick="navigateTo('screen-customer')" class="bg-dark-800 text-dark-muted px-3 py-1.5 rounded-full text-[10px] font-bold border border-dark-700">
                    <i class="fas fa-arrow-left mr-1"></i> <span data-i18n="exit">Exit</span>
                </button>
            </div>
        </div>
    </header>

    <main id="app-container" class="flex-1 overflow-hidden relative">

        <!-- SCREEN: CUSTOMER VIEW -->
        <div id="screen-customer" class="h-full flex flex-col bg-dark-900 relative">
            <div id="pos-mode-header" class="hide absolute top-0 left-0 right-0 z-[60] bg-orange-600 text-white px-4 py-2 flex justify-between items-center">
                <span class="font-bold text-xs"><i class="fas fa-cash-register mr-1"></i> POS Mode</span>
                <button onclick="exitPOSMode()" class="bg-white/20 px-3 py-1 rounded-lg text-xs font-bold">Back to Admin</button>
            </div>

            <div class="px-4 pt-4 pb-2 shrink-0">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-extrabold text-white leading-tight">
                            <span data-i18n="hero_title">Hungry? ðŸ˜‹</span><br>
                            <span class="text-primary text-sm font-bold" data-i18n="hero_subtitle">Order something good!</span>
                        </h2>
                    </div>
                    <div class="bg-dark-800 px-3 py-1.5 rounded-xl border border-dark-700 text-center">
                        <span class="text-[8px] text-dark-muted block font-bold uppercase" data-i18n="table">Table</span>
                        <span id="display-table-id" class="text-lg font-bold text-white">1</span>
                    </div>
                </div>
            </div>

            <div class="sticky top-0 z-40 bg-dark-900/95 backdrop-blur-sm pb-3 pt-2 shrink-0">
                <div class="px-4 flex gap-2 items-center" id="category-bar"></div>
            </div>

            <div id="main-scroll-container" class="flex-1 overflow-y-auto px-4 pb-32 pt-1 scrollbar-hide">
                <div id="menu-loading" class="flex flex-col items-center justify-center py-20 opacity-60">
                    <span class="loader mb-4"></span>
                    <p class="text-dark-muted text-sm font-medium" data-i18n="loading">Loading Menu...</p>
                </div>
                <div id="menu-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <div id="cart-bar" class="fixed bottom-10 left-4 right-4 sm:left-auto sm:right-8 sm:w-96 transform translate-y-[200%] transition-transform duration-500 z-50">
                <button onclick="openCheckoutModal()" class="w-full bg-white text-dark-900 p-2 pr-3 pl-3 rounded-full shadow-2xl flex items-center justify-between">
                    <div class="bg-dark-900 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm" id="cart-count">0</div>
                    <div class="flex flex-col items-start ml-3">
                        <span class="text-[10px] text-dark-700 font-bold uppercase" data-i18n="total">Total</span>
                        <span class="text-lg font-extrabold leading-none" id="cart-total">0 Ks</span>
                    </div>
                    <div class="bg-accent px-4 py-2.5 rounded-full ml-auto flex items-center gap-2">
                        <span class="text-xs font-bold uppercase text-dark-900" data-i18n="view_order">View Order</span>
                        <i class="fas fa-chevron-right text-xs"></i>
                    </div>
                </button>
            </div>
        </div>

        <!-- SCREEN: KITCHEN / ADMIN -->
        <div id="screen-kitchen" class="h-full flex flex-col hide bg-dark-900">
            <div class="bg-dark-800 border-b border-dark-700 px-4 py-3 flex flex-wrap gap-3 justify-between items-center shadow-md z-10">
                <div class="flex items-center gap-2">
                    <h2 class="font-bold text-lg text-white" data-i18n="kitchen_display">Kitchen Display</h2>
                </div>
                <div class="flex gap-2">
                    <button onclick="navigateTo('screen-tables')" class="px-3 py-1 bg-orange-600 text-white rounded-full text-xs font-bold"><i class="fas fa-th mr-1"></i> POS</button>
                    <button onclick="navigateTo('screen-analytics')" class="w-9 h-9 rounded-full bg-purple-900/30 text-purple-400 flex items-center justify-center"><i class="fas fa-chart-bar"></i></button>
                    <button onclick="navigateTo('screen-expenses')" class="w-9 h-9 rounded-full bg-red-900/30 text-red-400 flex items-center justify-center"><i class="fas fa-file-invoice-dollar"></i></button>
                    <button onclick="navigateTo('screen-categories')" class="w-9 h-9 rounded-full bg-yellow-900/30 text-yellow-400 flex items-center justify-center"><i class="fas fa-list-alt"></i></button>
                    <button onclick="navigateTo('screen-menu')" class="px-3 py-1 bg-primary text-white rounded-full text-xs font-bold"><i class="fas fa-utensils mr-1"></i> Menu</button>
                    <button onclick="openSettingsModal()" class="w-9 h-9 rounded-full bg-dark-700 text-dark-muted flex items-center justify-center"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <div id="orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 items-start"></div>
                <div id="no-orders-msg" class="hide flex flex-col items-center justify-center py-20 text-dark-700">
                    <i class="fas fa-check-circle text-6xl mb-4 opacity-20"></i>
                    <p data-i18n="kitchen_clear">Kitchen is clear</p>
                </div>
            </div>
        </div>

        <!-- SCREEN: ANALYTICS -->
        <div id="screen-analytics" class="page-view hide">
            <div class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800">
                <button onclick="navigateTo('screen-kitchen')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-white"><i class="fas fa-arrow-left"></i></button>
                <h3 class="font-bold text-xl text-white" data-i18n="analytics">Analytics</h3>
                <div class="w-8"></div>
            </div>
            <div class="flex bg-dark-900 p-1 m-4 rounded-xl border border-dark-700">
                <button onclick="switchReportTab('overview')" id="tab-overview" class="flex-1 py-2 rounded-lg font-bold text-sm bg-dark-700 text-white">Overview</button>
                <button onclick="switchReportTab('history')" id="tab-history" class="flex-1 py-2 rounded-lg font-bold text-sm text-dark-muted">History</button>
                <button onclick="switchReportTab('cancelled')" id="tab-cancelled" class="flex-1 py-2 rounded-lg font-bold text-sm text-dark-muted">Cancelled</button>
                <button onclick="switchReportTab('top')" id="tab-top" class="flex-1 py-2 rounded-lg font-bold text-sm text-dark-muted">Top Items</button>
            </div>
            
            <div class="px-5 pb-2 flex flex-wrap gap-3">
                <input type="date" id="rpt-date-input" class="bg-dark-800 text-white p-2 rounded-xl border border-dark-700 text-sm" onchange="window.refreshReport()">
                <select id="rpt-range-select" class="bg-dark-800 text-white p-2 rounded-xl border border-dark-700 text-sm" onchange="window.refreshReport()">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
            </div>

            <div class="flex-1 overflow-y-auto p-5">
                <div id="rpt-view-overview">
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="col-span-2 bg-emerald-900/30 p-6 rounded-3xl border border-emerald-500/50">
                            <p class="text-xs font-bold text-emerald-100 uppercase">Net Profit</p>
                            <h2 class="text-4xl font-extrabold text-white" id="rpt-ov-profit">0 Ks</h2>
                        </div>
                        <div class="bg-dark-800 p-4 rounded-2xl border border-dark-700">
                            <p class="text-[10px] text-dark-muted uppercase font-bold">Revenue</p>
                            <p class="text-xl font-bold text-white" id="rpt-ov-total">0 Ks</p>
                        </div>
                        <div class="bg-dark-800 p-4 rounded-2xl border border-dark-700">
                            <p class="text-[10px] text-dark-muted uppercase font-bold">Orders</p>
                            <p class="text-xl font-bold text-white" id="rpt-ov-count">0</p>
                        </div>
                    </div>
                    <div class="bg-dark-800 p-4 rounded-2xl border border-dark-700 h-64">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>

                <div id="rpt-view-history" class="hide">
                    <input type="text" id="history-search-input" oninput="window.renderSalesHistory()" placeholder="Search Table or Order ID..." class="w-full p-3 bg-dark-800 border border-dark-700 rounded-xl text-white mb-4">
                    <div class="overflow-x-auto rounded-xl border border-dark-700">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-dark-900 text-dark-muted">
                                <tr><th class="p-3">Time</th><th class="p-3">Table</th><th class="p-3 text-right">Total</th><th class="p-3 text-center">Action</th></tr>
                            </thead>
                            <tbody id="rpt-history-body" class="divide-y divide-dark-700"></tbody>
                        </table>
                    </div>
                </div>

                <div id="rpt-view-cancelled" class="hide">
                    <div class="overflow-x-auto rounded-xl border border-dark-700">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-dark-900 text-dark-muted">
                                <tr><th class="p-3">Time</th><th class="p-3">Table</th><th class="p-3 text-right text-red-400">Voided Amount</th></tr>
                            </thead>
                            <tbody id="rpt-cancelled-body" class="divide-y divide-dark-700"></tbody>
                        </table>
                    </div>
                </div>

                <div id="rpt-view-top" class="hide">
                    <div id="rpt-top-list" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- SCREEN: CATEGORY MANAGER -->
        <div id="screen-categories" class="page-view hide">
            <div class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800">
                <button onclick="navigateTo('screen-kitchen')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-white"><i class="fas fa-arrow-left"></i></button>
                <h3 class="font-bold text-xl text-white">Categories</h3>
                <div class="w-8"></div>
            </div>
            <div class="p-5 flex gap-2">
                <input id="new-cat-name" placeholder="Category Name" class="flex-1 p-3 bg-dark-800 border border-dark-700 rounded-xl text-white">
                <button onclick="saveCategory()" class="bg-primary px-6 py-3 rounded-xl font-bold">Add</button>
            </div>
            <div class="flex-1 p-5 space-y-2" id="categories-list"></div>
        </div>

        <!-- SCREEN: TABLE MAP -->
        <div id="screen-tables" class="page-view hide">
            <div class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800">
                <button onclick="navigateTo('screen-kitchen')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-white"><i class="fas fa-arrow-left"></i></button>
                <h3 class="font-bold text-white text-lg">Table Layout</h3>
                <div class="flex gap-2">
                    <button id="btn-edit-layout" onclick="toggleLayoutEdit()" class="px-3 py-1 border border-dark-600 rounded-lg text-xs">Edit</button>
                    <button id="btn-save-layout" onclick="saveLayout()" class="hide px-3 py-1 bg-primary rounded-lg text-xs">Save</button>
                </div>
            </div>
            <div id="table-map-container" class="flex-1 relative bg-dark-900" style="background-image: radial-gradient(#374151 1px, transparent 1px); background-size: 20px 20px;"></div>
        </div>

    </main>

    <!-- Modal: Login -->
    <div id="modal-login" class="fixed inset-0 bg-black/90 z-[100] hide flex items-center justify-center p-4">
        <div class="bg-dark-800 w-full max-w-xs rounded-[30px] p-8 text-center animate-slide-up border border-dark-700">
            <h3 class="font-bold text-xl text-white mb-6">Staff Login</h3>
            <div id="pin-display" class="flex gap-4 justify-center mb-8">
                <div class="w-3 h-3 rounded-full bg-dark-700"></div><div class="w-3 h-3 rounded-full bg-dark-700"></div><div class="w-3 h-3 rounded-full bg-dark-700"></div><div class="w-3 h-3 rounded-full bg-dark-700"></div>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <script>
                    for(let i=1; i<=9; i++) document.write(`<button onclick="handlePinInput(${i})" class="keypad-btn">${i}</button>`);
                </script>
                <button onclick="closeModal('modal-login')" class="text-red-500 font-bold">X</button>
                <button onclick="handlePinInput(0)" class="keypad-btn">0</button>
                <button onclick="handlePinInput('back')" class="text-dark-muted"><i class="fas fa-backspace"></i></button>
            </div>
        </div>
    </div>

    <!-- Hidden Print Area -->
    <div id="receipt-print-area" class="hide p-4 bg-white text-black font-mono text-sm w-[300px]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, setDoc, getDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB0TsIVnLIWIOukeT_ddLwA9xMki50H1yE",
            authDomain: "pingpos.firebaseapp.com",
            projectId: "pingpos",
            storageBucket: "pingpos.firebasestorage.app",
            messagingSenderId: "328655511392",
            appId: "1:328655511392:web:f6232b5a3003bef5454805"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'pingpos-production';

        let state = {
            user: null, tableId: 1, products: [], cart: [], orders: [],
            lang: 'en', activeCategory: 'All', isLayoutEdit: false,
            tables: [], tempPin: '', currentReportTab: 'overview',
            customCategories: []
        };

        const resources = {
            en: { kitchen_display: "Kitchen Display", kitchen_clear: "Kitchen is clear", exit: "Exit", analytics: "Analytics", total: "Total", view_order: "View Order" },
            my: { kitchen_display: "á€™á€®á€¸á€–á€­á€¯á€á€»á€±á€¬á€„á€º", kitchen_clear: "á€›á€¾á€„á€ºá€¸á€œá€„á€ºá€¸á€žá€Šá€º", exit: "á€‘á€½á€€á€ºá€›á€”á€º", analytics: "á€¡á€›á€±á€¬á€„á€ºá€¸á€™á€¾á€á€ºá€á€™á€ºá€¸", total: "á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸", view_order: "á€™á€¾á€¬á€šá€°á€™á€¾á€¯á€€á€¼á€Šá€·á€ºá€›á€”á€º" }
        };

        // --- Core Functions ---
        window.navigateTo = (screenId) => {
            document.querySelectorAll('#app-container > div, .page-view').forEach(el => el.classList.add('hide'));
            document.getElementById(screenId).classList.remove('hide');
            
            const nav = document.getElementById('main-nav');
            const custNav = document.getElementById('nav-customer-controls');
            const adminNav = document.getElementById('nav-admin-controls');

            if (screenId === 'screen-customer') {
                nav.classList.remove('hide'); custNav.classList.remove('hide'); adminNav.classList.add('hide');
            } else if (screenId === 'screen-kitchen') {
                nav.classList.remove('hide'); custNav.classList.add('hide'); adminNav.classList.remove('hide');
            } else {
                nav.classList.add('hide');
            }

            if (screenId === 'screen-analytics') window.refreshReport();
            if (screenId === 'screen-tables') window.renderTableMap();
            if (screenId === 'screen-categories') window.renderCategoryManager();
        };

        window.toggleLanguage = () => {
            state.lang = state.lang === 'en' ? 'my' : 'en';
            document.getElementById('lang-display').innerText = state.lang.toUpperCase();
            renderCategoryBar();
        };

        // --- Data Loading ---
        async function init() {
            await signInAnonymously(auth);
            document.getElementById('rpt-date-input').valueAsDate = new Date();

            // Load Configs
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config_tables', 'main_layout'), (d) => {
                if (d.exists()) state.tables = d.data().tables || [];
                renderTableMap();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config_categories', 'list'), (d) => {
                state.customCategories = d.exists() ? d.data().list : ["Drink", "Food"];
                renderCategoryBar();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (s) => {
                state.products = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderMenu();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (s) => {
                state.orders = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAdminOrders();
            });

            window.navigateTo('screen-customer');
        }

        // --- Category Management ---
        window.renderCategoryBar = () => {
            const bar = document.getElementById('category-bar');
            const cats = ["All", ...state.customCategories];
            bar.innerHTML = cats.map(c => `
                <button onclick="filterCategory('${c}')" class="px-5 py-2 rounded-full text-xs font-bold transition-all ${state.activeCategory === c ? 'cat-btn-active' : 'cat-btn-inactive'}">${c}</button>
            `).join('');
        };

        window.filterCategory = (c) => { state.activeCategory = c; renderCategoryBar(); renderMenu(); };

        window.renderCategoryManager = () => {
            const list = document.getElementById('categories-list');
            list.innerHTML = state.customCategories.map(c => `
                <div class="flex justify-between items-center bg-dark-800 p-4 rounded-xl border border-dark-700">
                    <span class="text-white font-bold">${c}</span>
                    <button onclick="deleteCategory('${c}')" class="text-red-400"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        };

        window.saveCategory = async () => {
            const name = document.getElementById('new-cat-name').value.trim();
            if (!name) return;
            const newList = [...state.customCategories, name];
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config_categories', 'list'), { list: newList });
            document.getElementById('new-cat-name').value = '';
        };

        window.deleteCategory = async (name) => {
            const newList = state.customCategories.filter(c => c !== name);
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config_categories', 'list'), { list: newList });
        };

        // --- Analytics / Reports (Missing Functions) ---
        window.switchReportTab = (tab) => {
            state.currentReportTab = tab;
            ['overview', 'history', 'cancelled', 'top'].forEach(t => {
                document.getElementById(`rpt-view-${t}`).classList.add('hide');
                document.getElementById(`tab-${t}`).classList.remove('bg-dark-700', 'text-white');
                document.getElementById(`tab-${t}`).classList.add('text-dark-muted');
            });
            document.getElementById(`rpt-view-${tab}`).classList.remove('hide');
            document.getElementById(`tab-${tab}`).classList.add('bg-dark-700', 'text-white');
            window.refreshReport();
        };

        window.refreshReport = () => {
            const date = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            
            if (state.currentReportTab === 'overview') renderReportOverview(date, range);
            if (state.currentReportTab === 'history') window.renderSalesHistory();
            if (state.currentReportTab === 'cancelled') renderCancelledOrders(date, range);
            if (state.currentReportTab === 'top') renderTopSelling(date, range);
        };

        function isDateInRange(target, range, selectedDate) {
            const t = new Date(target.seconds * 1000);
            const s = new Date(selectedDate);
            if (range === 'daily') return t.toDateString() === s.toDateString();
            if (range === 'monthly') return t.getMonth() === s.getMonth() && t.getFullYear() === s.getFullYear();
            return true;
        }

        function renderReportOverview(date, range) {
            let total = 0, count = 0;
            const filtered = state.orders.filter(o => o.status !== 'cancelled' && o.timestamp && isDateInRange(o.timestamp, range, date));
            filtered.forEach(o => { total += o.totalPrice; count++; });
            
            document.getElementById('rpt-ov-total').innerText = total.toLocaleString() + ' Ks';
            document.getElementById('rpt-ov-profit').innerText = (total * 0.4).toLocaleString() + ' Ks'; // Dummy Profit
            document.getElementById('rpt-ov-count').innerText = count;

            // Chart
            const ctx = document.getElementById('salesChart').getContext('2d');
            if (window.chartObj) window.chartObj.destroy();
            window.chartObj = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['6am', '9am', '12pm', '3pm', '6pm', '9pm'],
                    datasets: [{ label: 'Sales', data: [10, 25, 45, 30, 70, 40], borderColor: '#FF4757', tension: 0.4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        window.renderSalesHistory = () => {
            const body = document.getElementById('rpt-history-body');
            const search = document.getElementById('history-search-input').value.toLowerCase();
            const date = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;

            const filtered = state.orders.filter(o => 
                o.status !== 'cancelled' && 
                o.timestamp && isDateInRange(o.timestamp, range, date) &&
                (o.id.toLowerCase().includes(search) || String(o.tableId).includes(search))
            );

            body.innerHTML = filtered.map(o => `
                <tr>
                    <td class="p-3 text-dark-muted">${new Date(o.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
                    <td class="p-3 font-bold text-white">Table ${o.tableId}</td>
                    <td class="p-3 text-right text-primary font-bold">${o.totalPrice.toLocaleString()}</td>
                    <td class="p-3 text-center"><button onclick="deleteOrder('${o.id}')" class="text-dark-muted"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        };

        function renderCancelledOrders(date, range) {
            const body = document.getElementById('rpt-cancelled-body');
            const filtered = state.orders.filter(o => o.status === 'cancelled' && o.timestamp && isDateInRange(o.timestamp, range, date));
            body.innerHTML = filtered.map(o => `
                <tr class="text-red-400">
                    <td class="p-3">${new Date(o.timestamp.seconds*1000).toLocaleTimeString()}</td>
                    <td class="p-3">Table ${o.tableId}</td>
                    <td class="p-3 text-right">${o.totalPrice.toLocaleString()} Ks</td>
                </tr>
            `).join('');
        }

        function renderTopSelling(date, range) {
            const container = document.getElementById('rpt-top-list');
            const items = {};
            state.orders.filter(o => o.status !== 'cancelled' && o.timestamp && isDateInRange(o.timestamp, range, date)).forEach(o => {
                o.items.forEach(i => {
                    items[i.name] = (items[i.name] || 0) + i.qty;
                });
            });
            const sorted = Object.entries(items).sort((a,b) => b[1] - a[1]);
            container.innerHTML = sorted.map(([name, qty]) => `
                <div class="bg-dark-800 p-4 rounded-xl border border-dark-700 flex justify-between">
                    <span class="text-white font-bold">${name}</span>
                    <span class="text-accent font-bold">${qty} Sold</span>
                </div>
            `).join('');
        }

        // --- Table Map (Missing Functions) ---
        window.renderTableMap = () => {
            const container = document.getElementById('table-map-container');
            container.innerHTML = '';
            state.tables.forEach(t => {
                const isBusy = state.orders.some(o => o.tableId == t.id && ['pending', 'cooking'].includes(o.status));
                const div = document.createElement('div');
                div.className = `table-node w-16 h-16 rounded-full font-bold shadow-lg ${isBusy ? 'bg-red-500' : 'bg-green-500'} ${state.isLayoutEdit ? 'border-2 border-white border-dashed' : ''}`;
                div.style.left = t.x + '%'; div.style.top = t.y + '%';
                div.innerText = 'T-' + t.id;
                
                if (state.isLayoutEdit) {
                    div.onmousedown = (e) => startDrag(e, t);
                } else {
                    div.onclick = () => startPOSMode(t.id);
                }
                container.appendChild(div);
            });
        };

        window.toggleLayoutEdit = () => {
            state.isLayoutEdit = !state.isLayoutEdit;
            document.getElementById('btn-edit-layout').innerText = state.isLayoutEdit ? 'Cancel' : 'Edit';
            document.getElementById('btn-save-layout').classList.toggle('hide');
            renderTableMap();
        };

        function startDrag(e, table) {
            const rect = document.getElementById('table-map-container').getBoundingClientRect();
            function onMouseMove(me) {
                table.x = ((me.clientX - rect.left) / rect.width) * 100;
                table.y = ((me.clientY - rect.top) / rect.height) * 100;
                renderTableMap();
            }
            function onMouseUp() {
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
            }
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
        }

        window.saveLayout = async () => {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config_tables', 'main_layout'), { tables: state.tables });
            toggleLayoutEdit();
        };

        // --- Other UI Helpers ---
        window.startPOSMode = (tid) => {
            state.tableId = tid;
            document.getElementById('display-table-id').innerText = tid;
            document.getElementById('pos-mode-header').classList.remove('hide');
            window.navigateTo('screen-customer');
        };

        window.exitPOSMode = () => {
            document.getElementById('pos-mode-header').classList.add('hide');
            window.navigateTo('screen-kitchen');
        };

        window.handlePinInput = (val) => {
            if (val === 'back') state.tempPin = state.tempPin.slice(0, -1);
            else if (state.tempPin.length < 4) state.tempPin += val;
            
            const dots = document.getElementById('pin-display').children;
            for(let i=0; i<4; i++) dots[i].className = i < state.tempPin.length ? 'w-3 h-3 rounded-full bg-white' : 'w-3 h-3 rounded-full bg-dark-700';
            
            if (state.tempPin === '1234') { 
                closeModal('modal-login'); navigateTo('screen-kitchen'); state.tempPin = '';
            }
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hide');
        window.openLoginModal = () => { state.tempPin = ''; document.getElementById('modal-login').classList.remove('hide'); };

        function renderMenu() {
            const grid = document.getElementById('menu-grid');
            document.getElementById('menu-loading').classList.add('hide');
            const filtered = state.activeCategory === 'All' ? state.products : state.products.filter(p => p.category === state.activeCategory);
            grid.innerHTML = filtered.map(p => `
                <div onclick="addToCart('${p.id}')" class="bg-dark-800 p-4 rounded-2xl border border-dark-700 active:scale-95 transition-all cursor-pointer">
                    <h3 class="font-bold text-white">${p.name}</h3>
                    <p class="text-primary font-bold mt-1">${p.price} Ks</p>
                </div>
            `).join('');
        }

        window.addToCart = (id) => {
            const p = state.products.find(x => x.id === id);
            state.cart.push({...p, qty: 1, lineTotal: p.price});
            updateCartUI();
        };

        function updateCartUI() {
            const count = state.cart.length;
            const total = state.cart.reduce((a,b) => a + b.lineTotal, 0);
            document.getElementById('cart-count').innerText = count;
            document.getElementById('cart-total').innerText = total.toLocaleString() + ' Ks';
            document.getElementById('cart-bar').style.transform = count > 0 ? 'translateY(0)' : 'translateY(200%)';
        }

        window.renderAdminOrders = () => {
            const grid = document.getElementById('orders-grid');
            const active = state.orders.filter(o => o.status !== 'served' && o.status !== 'cancelled');
            document.getElementById('no-orders-msg').classList.toggle('hide', active.length > 0);
            grid.innerHTML = active.map(o => `
                <div class="bg-dark-800 p-4 rounded-2xl border border-dark-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="bg-dark-900 text-white px-3 py-1 rounded-full text-xs font-bold">Table ${o.tableId}</span>
                        <span class="text-[10px] text-dark-muted">#${o.id.slice(0,4)}</span>
                    </div>
                    <div class="space-y-1 py-2 border-y border-dark-700 my-2">
                        ${o.items.map(i => `<p class="text-sm text-white">${i.qty}x ${i.name}</p>`).join('')}
                    </div>
                    <button onclick="serveOrder('${o.id}')" class="w-full bg-white text-dark-900 py-2 rounded-xl font-bold text-sm">Serve</button>
                </div>
            `).join('');
        };

        window.serveOrder = async (id) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), { status: 'served' });
        };

        init();
    </script>
</body>
</html>
