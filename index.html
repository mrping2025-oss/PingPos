<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ping-Restaurant</title>
    <link rel="icon" type="image/png" href="https://ui-avatars.com/api/?name=P&background=FF4757&color=fff">

    <!-- 1. Libraries & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&family=Padauk:wght@400;700&display=swap" rel="stylesheet">

    <!-- 2. Custom CSS & Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'Padauk', 'sans-serif'],
                    },
                    colors: {
                        primary: '#FF4757',  // Lucky Red
                        accent: '#34D399',   // Emerald 400
                        dark: {
                            900: '#111827', 
                            800: '#1F2937', 
                            700: '#374151', 
                            text: '#F9FAFB', 
                            muted: '#9CA3AF' 
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', 'Padauk', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #111827; color: #F9FAFB; }
        .hide { display: none !important; }
        
        /* Utility */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Sold Out Grayscale Effect */
        .sold-out-filter { filter: grayscale(100%); opacity: 0.5; pointer-events: none; }

        /* Fix for date input icon */
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; opacity: 0.8; }
        input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }

        /* Animations */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-slide-in { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        .loader { width: 40px; height: 40px; border: 4px solid #374151; border-top: 4px solid #FF4757; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Glassmorphism */
        .glass-nav { background: rgba(17, 24, 39, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* Category Buttons */
        .cat-btn-active { background-color: #FF4757; color: white; box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4); transform: scale(1.05); border: none; }
        .cat-btn-inactive { background-color: #1F2937; color: #9CA3AF; border: 1px solid #374151; }

        /* Table Map Draggable */
        .table-node { position: absolute; touch-action: none; user-select: none; transition: box-shadow 0.2s, transform 0.1s; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .table-node:active { cursor: grabbing; }
        .table-node.editing { border: 2px dashed rgba(255,255,255,0.3); cursor: move; }
        .table-node.editing:hover { border-color: white; }
        .table-node.selected { border: 2px solid #34D399; box-shadow: 0 0 15px rgba(52, 211, 153, 0.5); z-index: 50; }

        /* Print Styles */
        @media print { 
            body * { visibility: hidden; } 
            #receipt-print-area, #receipt-print-area * { visibility: visible; } 
            #receipt-print-area { position: absolute; left: 0; top: 0; width: 100% !important; display: block !important; margin: 0; padding: 0; background-color: white; color: black; } 
            .no-print { display: none !important; } 
        }
        
        /* Full Page View Wrapper */
        .page-view { position: fixed; inset: 0; background-color: #111827; z-index: 60; overflow-y: auto; display: flex; flex-direction: column; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden selection:bg-primary selection:text-white">

    <audio id="notif-sound" preload="auto" loop></audio>

    <!-- 3. Navigation Bar (Visible only in main views) -->
    <header id="main-nav" class="glass-nav h-14 flex items-center justify-between px-4 z-50 no-print sticky top-0 shrink-0">
        <div class="flex items-center gap-3">
            <img src="https://placehold.co/150x50/FF4757/FFFFFF?text=Ping+POS&font=roboto" alt="Ping-Restaurant Logo" class="h-9 w-auto object-contain rounded-md shadow-lg shadow-red-500/20">
        </div>
        
        <div class="flex items-center gap-3">
            <button id="silence-btn" onclick="stopIncomingOrderAlert()" class="hide bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold animate-pulse shadow-lg flex items-center gap-2 border border-red-400">
                <i class="fas fa-bell-slash"></i> <span>Silence</span>
            </button>

            <button onclick="toggleLanguage()" class="bg-dark-800 border border-dark-700 text-white px-2 py-1 rounded-lg text-xs font-bold hover:bg-dark-700 transition flex items-center gap-1">
                <i class="fas fa-globe text-dark-muted"></i>
                <span id="lang-display">EN</span>
            </button>

            <div id="nav-customer-controls">
                <button onclick="openLoginModal()" class="w-8 h-8 rounded-full bg-dark-800 text-dark-muted hover:text-primary hover:bg-dark-700 transition flex items-center justify-center border border-dark-700">
                    <i class="fas fa-user-lock text-xs"></i>
                </button>
            </div>

            <div id="nav-admin-controls" class="hide">
                <button onclick="navigateTo('screen-customer')" class="bg-dark-800 text-dark-muted px-3 py-1.5 rounded-full text-[10px] font-bold hover:bg-dark-700 hover:text-white transition border border-dark-700">
                    <i class="fas fa-arrow-left mr-1"></i> <span data-i18n="exit">Exit</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 4. Main Content -->
    <main id="app-container" class="flex-1 overflow-hidden relative no-print">
        
        <!-- === SCREEN: CUSTOMER VIEW === -->
        <div id="screen-customer" class="h-full flex flex-col bg-dark-900 relative">
            
            <!-- POS MODE FLOATING HEADER -->
            <div id="pos-mode-header" class="hide absolute top-0 left-0 right-0 z-[60] bg-orange-600 text-white shadow-lg flex justify-between items-center px-4 py-2">
                <div class="flex items-center gap-2">
                    <span class="font-bold text-xs uppercase tracking-widest"><i class="fas fa-cash-register mr-1"></i> POS Mode</span>
                </div>
                <div class="flex items-center gap-3">
                    <label class="flex items-center gap-2 text-xs font-bold cursor-pointer select-none bg-orange-700/50 px-2 py-1 rounded-lg hover:bg-orange-700">
                        <input type="checkbox" id="chk-auto-return" class="accent-white w-4 h-4" checked>
                        <span>Auto Return</span>
                    </label>
                    <button onclick="exitPOSMode()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-xs font-bold transition">Back to Admin</button>
                </div>
            </div>

            <!-- Hero Section -->
            <div class="px-4 pt-4 pb-2 shrink-0">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-extrabold text-white leading-tight tracking-tight">
                            <span data-i18n="hero_title">Hungry? üòã</span> <br>
                            <span class="text-primary text-sm font-bold tracking-wide" data-i18n="hero_subtitle">Order something good!</span>
                        </h2>
                    </div>
                    <div class="bg-dark-800 px-3 py-1.5 rounded-xl shadow-lg border border-dark-700 text-center">
                        <span class="text-[8px] text-dark-muted block font-bold uppercase tracking-widest" data-i18n="table">Table</span>
                        <span id="display-table-id" class="text-lg font-bold text-white leading-none">1</span>
                    </div>
                </div>
            </div>

            <!-- Sticky Category Bar -->
            <div class="sticky top-0 z-40 bg-dark-900/95 backdrop-blur-sm pb-3 pt-2 shrink-0">
                <div class="px-4">
                    <div class="flex gap-2 items-center" id="category-bar"></div>
                </div>
            </div>

            <!-- Product Grid -->
            <div id="main-scroll-container" class="flex-1 overflow-y-auto px-4 pb-32 pt-1 scrollbar-hide scroll-smooth">
                <div id="menu-loading" class="flex flex-col items-center justify-center py-20 opacity-60">
                    <span class="loader mb-4"></span>
                    <p class="text-dark-muted text-sm font-medium" data-i18n="loading">Loading Menu...</p>
                </div>
                
                <div id="menu-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

                <div id="empty-menu-msg" class="hide flex flex-col items-center justify-center py-20 text-dark-700">
                    <i class="fas fa-utensils text-5xl mb-4"></i>
                    <p class="text-sm font-medium" data-i18n="no_items">No items available yet.</p>
                </div>
            </div>

            <!-- SCROLL TO TOP BUTTON -->
            <button id="scroll-top-btn" onclick="scrollToTop()" class="fixed bottom-28 right-4 w-10 h-10 bg-dark-800 border border-dark-700 text-white rounded-full shadow-xl flex items-center justify-center z-40 transition-all duration-300 opacity-0 translate-y-10 pointer-events-none hover:bg-dark-700 hover:border-primary">
                <i class="fas fa-arrow-up text-sm"></i>
            </button>

            <!-- FIXED Floating Cart Button -->
            <div id="cart-bar" class="fixed bottom-10 left-4 right-4 sm:left-auto sm:right-8 sm:w-96 transform translate-y-[200%] transition-transform duration-500 z-50 safe-pb">
                <button onclick="openCheckoutModal()" class="w-full bg-white text-dark-900 p-2 pr-3 pl-3 rounded-full shadow-2xl shadow-black/50 flex items-center justify-between group active:scale-[0.98] transition overflow-hidden">
                    <div class="bg-dark-900 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm shadow-md z-10" id="cart-count">0</div>
                    <div class="flex flex-col items-start ml-3 z-10">
                        <span class="text-[10px] text-dark-700 font-bold uppercase tracking-wider" data-i18n="total">Total</span>
                        <span class="text-lg font-extrabold leading-none" id="cart-total">0 Ks</span>
                    </div>
                    <div class="flex items-center gap-2 bg-accent px-4 py-2.5 rounded-full ml-auto hover:brightness-110 transition shadow-lg shadow-green-500/20 z-10">
                        <span class="text-xs font-bold uppercase tracking-wide text-dark-900" data-i18n="view_order">View Order</span>
                        <i class="fas fa-chevron-right text-xs text-dark-900"></i>
                    </div>
                </button>
            </div>
        </div>

        <!-- === SCREEN: KITCHEN / ADMIN DASHBOARD === -->
        <div id="screen-kitchen" class="h-full flex flex-col hide bg-dark-900">
            <div class="bg-dark-800 border-b border-dark-700 px-4 py-3 flex flex-wrap gap-3 justify-between items-center shadow-md z-10 shrink-0">
                <div class="flex items-center gap-2">
                    <h2 class="font-bold text-lg text-white" data-i18n="kitchen_display">Kitchen Display</h2>
                    <span id="live-indicator" class="flex h-2 w-2 relative"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-500 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>
                </div>
                <div class="flex gap-2">
                     <button onclick="navigateTo('screen-tables')" class="px-3 py-1 bg-orange-600 text-white rounded-full text-xs font-bold hover:bg-orange-500 shadow-lg flex items-center gap-1 transition">
                        <i class="fas fa-th"></i> <span data-i18n="pos_mode">POS</span>
                    </button>
                    <button onclick="openSettingsModal()" class="w-9 h-9 rounded-full bg-dark-700 text-dark-muted hover:bg-dark-600 hover:text-white flex items-center justify-center transition">
                        <i class="fas fa-cog text-xs"></i>
                    </button>
                    <button onclick="openChangePinModal()" class="w-9 h-9 rounded-full bg-dark-700 text-dark-muted hover:bg-dark-600 hover:text-white flex items-center justify-center transition"><i class="fas fa-key text-xs"></i></button>
                    
                    <!-- Analytics Button -> Full Page -->
                    <button onclick="navigateTo('screen-analytics')" class="w-9 h-9 rounded-full bg-purple-900/30 text-purple-400 hover:bg-purple-900/50 flex items-center justify-center transition"><i class="fas fa-chart-bar text-xs"></i></button>
                    
                    <button onclick="openQRModal()" class="w-9 h-9 rounded-full bg-blue-900/30 text-blue-400 hover:bg-blue-900/50 flex items-center justify-center transition"><i class="fas fa-qrcode text-xs"></i></button>
                    
                    <!-- NEW: CATEGORY BUTTON -->
                    <button onclick="navigateTo('screen-categories')" class="px-3 py-1 bg-yellow-600/30 text-yellow-400 rounded-full text-xs font-bold hover:bg-yellow-900/50 shadow-lg flex items-center gap-1"><i class="fas fa-list-alt"></i> Categories</button>

                    <!-- Menu Button -> Full Page -->
                    <button onclick="navigateTo('screen-menu')" class="px-3 py-1 bg-primary text-white rounded-full text-xs font-bold hover:bg-red-600 shadow-lg flex items-center gap-1"><i class="fas fa-plus"></i> <span data-i18n="menu">Menu</span></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-dark-900">
                <div id="orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 items-start"></div>
                <div id="no-orders-msg" class="hidden h-full flex flex-col items-center justify-center text-dark-700"><i class="fas fa-check-circle text-6xl mb-4 opacity-20"></i><p data-i18n="kitchen_clear">Kitchen is clear</p></div>
            </div>
        </div>

        <!-- === SCREEN: ANALYTICS (FULL PAGE) === -->
        <div id="screen-analytics" class="page-view hide animate-slide-in">
             <div class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800 sticky top-0 z-20">
                <div class="flex items-center gap-3">
                    <button onclick="navigateTo('screen-kitchen')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-white hover:bg-dark-600 transition"><i class="fas fa-arrow-left"></i></button>
                    <h3 class="font-bold text-xl text-white" data-i18n="analytics">Analytics</h3>
                </div>
            </div>
            
            <div class="flex bg-dark-900 p-1 m-5 mb-2 rounded-xl border border-dark-700 shrink-0">
                <button onclick="switchReportTab('overview')" id="tab-overview" class="flex-1 py-2 rounded-lg font-bold text-sm bg-dark-700 text-white shadow-sm transition" data-i18n="overview">Overview</button>
                <button onclick="switchReportTab('history')" id="tab-history" class="flex-1 py-2 rounded-lg font-bold text-sm text-dark-muted hover:text-white transition" data-i18n="history">History</button>
                <!-- NEW CANCELLED TAB -->
                <button onclick="switchReportTab('cancelled')" id="tab-cancelled" class="flex-1 py-2 rounded-lg font-bold text-sm text-dark-muted hover:text-white transition">Cancelled</button>
                <button onclick="switchReportTab('top')" id="tab-top" class="flex-1 py-2 rounded-lg font-bold text-sm text-dark-muted hover:text-white transition" data-i18n="top_items">Top Items</button>
            </div>

            <div class="px-5 pb-2 flex flex-wrap gap-3 shrink-0">
                 <div class="flex items-center gap-3 bg-dark-900 p-3 rounded-xl border border-dark-700 max-w-xs">
                    <span class="text-sm font-bold text-dark-muted" data-i18n="date">Date:</span>
                    <input type="date" id="rpt-date-input" class="bg-transparent font-bold outline-none text-white invert-calendar" onchange="window.refreshReport()">
                </div>
                <div class="flex items-center gap-2 bg-dark-900 p-1 rounded-xl border border-dark-700">
                    <select id="rpt-range-select" onchange="window.refreshReport()" class="bg-transparent text-white font-bold text-sm outline-none px-3 py-2 cursor-pointer">
                        <option value="daily" class="bg-dark-800">Daily</option>
                        <option value="weekly" class="bg-dark-800">Weekly</option>
                        <option value="monthly" class="bg-dark-800">Monthly</option>
                        <option value="yearly" class="bg-dark-800">Yearly</option>
                    </select>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 pt-2">
                <!-- Report Content (Same as before) -->
                <div id="rpt-view-overview">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2 mb-6">
                         <div class="bg-gradient-to-br from-primary to-red-600 text-white p-6 rounded-2xl shadow-lg">
                             <p class="text-xs opacity-70 mb-1 font-bold uppercase tracking-wider" data-i18n="total_revenue">Total Revenue</p>
                             <p class="text-3xl font-extrabold" id="rpt-ov-total">0</p>
                             <p class="text-[10px] mt-1 opacity-60" id="rpt-period-label">Today</p>
                         </div>
                         <div class="border border-dark-700 bg-dark-900 p-6 rounded-2xl">
                             <p class="text-xs text-dark-muted mb-1 font-bold uppercase tracking-wider" data-i18n="total_orders">Total Orders</p>
                             <p class="text-3xl font-extrabold text-white" id="rpt-ov-count">0</p>
                         </div>
                         <div class="border border-red-900/50 bg-red-900/10 p-6 rounded-2xl">
                             <p class="text-xs text-red-400 mb-1 font-bold uppercase tracking-wider" data-i18n="cancelled">Cancelled</p>
                             <p class="text-3xl font-extrabold text-white" id="rpt-ov-cancelled">0</p>
                         </div>
                     </div>
                     
                     <div class="flex flex-wrap gap-2 mb-4 bg-dark-900 p-1.5 rounded-xl border border-dark-700">
                        <button onclick="setOverviewChart('sales')" id="btn-ov-sales" class="flex-1 py-2 rounded-lg text-xs font-bold transition bg-dark-700 text-white shadow">Sales Trend</button>
                        <button onclick="setOverviewChart('table')" id="btn-ov-table" class="flex-1 py-2 rounded-lg text-xs font-bold transition text-dark-muted hover:text-white">Tables</button>
                        <button onclick="setOverviewChart('category')" id="btn-ov-category" class="flex-1 py-2 rounded-lg text-xs font-bold transition text-dark-muted hover:text-white">Categories</button>
                        <button onclick="setOverviewChart('type')" id="btn-ov-type" class="flex-1 py-2 rounded-lg text-xs font-bold transition text-dark-muted hover:text-white">Order Types</button>
                    </div>

                     <div id="overview-chart-container" class="bg-dark-900 p-4 rounded-2xl border border-dark-700 min-h-[300px] mb-20">
                         <div id="overview-content-sales">
                             <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider" data-i18n="hourly_sales">Sales Trend</h4>
                             <div class="relative h-64 w-full"><canvas id="salesChart"></canvas></div>
                         </div>
                         
                         <!-- START: Table Content Refactor -->
                         <div id="overview-content-table" class="hide">
                             <div id="table-chart-wrapper">
                                 <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider">Table Performance - Chart</h4>
                                 <div class="relative h-64 w-full flex justify-center shrink-0"><canvas id="tableChart"></canvas></div>
                             </div>

                             <div id="table-list-wrapper" class="hide">
                                 <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider">Table Performance - List</h4>
                                 <div class="overflow-x-auto rounded-xl border border-dark-700">
                                     <div class="max-h-64 overflow-y-auto custom-scroll">
                                         <table class="w-full text-xs text-left text-dark-muted">
                                             <thead class="sticky top-0 bg-dark-900 text-dark-500 uppercase font-bold text-[9px] tracking-wider">
                                                 <tr><th class="py-2 p-3">Table</th><th class="py-2 text-right p-3">Orders</th><th class="py-2 text-right p-3">Revenue</th></tr>
                                             </thead>
                                             <tbody id="table-data-tbody" class="divide-y divide-dark-800"></tbody>
                                         </table>
                                     </div>
                                 </div>
                             </div>
                             
                             <div class="flex justify-end mt-4">
                                 <button onclick="toggleAnalyticsView('table')" id="btn-toggle-table-view" class="text-[10px] font-bold text-primary border border-primary/30 bg-primary/10 px-3 py-1.5 rounded-lg hover:bg-primary hover:text-white transition">
                                     <i class="fas fa-exchange-alt"></i> <span id="toggle-table-text" data-i18n="view_list">View List</span>
                                 </button>
                             </div>
                         </div>
                         <!-- END: Table Content Refactor -->

                         <!-- START: Category Content Refactor -->
                         <div id="overview-content-category" class="hide">
                             <div id="category-chart-wrapper">
                                 <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider" data-i18n="category_sales">Category Sales - Chart</h4>
                                 <div class="relative h-64 w-full flex justify-center mb-2"><canvas id="categoryChart"></canvas></div>
                             </div>

                             <div id="category-list-wrapper" class="hide">
                                 <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider" data-i18n="category_sales">Category Sales - List</h4>
                                 <div class="overflow-x-auto rounded-xl border border-dark-700">
                                     <div class="max-h-64 overflow-y-auto custom-scroll">
                                         <table class="w-full text-xs text-left text-dark-muted">
                                             <thead class="sticky top-0 bg-dark-900 text-dark-500 uppercase font-bold text-[9px] tracking-wider">
                                                 <tr><th class="py-2 p-3">Category</th><th class="py-2 text-right p-3">Qty</th><th class="py-2 text-right p-3">Revenue</th></tr>
                                             </thead>
                                             <tbody id="cat-data-tbody" class="divide-y divide-dark-800"></tbody>
                                         </table>
                                     </div>
                                 </div>
                             </div>

                             <div class="flex justify-end mt-4">
                                 <button onclick="toggleAnalyticsView('category')" id="btn-toggle-category-view" class="text-[10px] font-bold text-purple-400 border border-purple-500/30 bg-purple-900/20 px-3 py-1.5 rounded-lg hover:bg-purple-600 hover:text-white transition">
                                     <i class="fas fa-exchange-alt"></i> <span data-i18n="view_list" id="toggle-category-text">View List</span>
                                 </button>
                             </div>
                         </div>
                         <!-- END: Category Content Refactor -->
                         
                         <!-- START: Order Type Content Refactor -->
                         <div id="overview-content-type" class="hide">
                            <div id="type-chart-wrapper">
                                 <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider" data-i18n="order_type">Order Type Overview - Chart</h4>
                                 <div class="relative h-64 w-full flex justify-center mb-2"><canvas id="orderTypeChart"></canvas></div>
                            </div>
                            
                            <div id="type-list-wrapper" class="hide">
                                 <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider" data-i18n="order_type">Order Type Overview - List</h4>
                                 <div class="overflow-x-auto rounded-xl border border-dark-700">
                                     <div class="max-h-64 overflow-y-auto custom-scroll">
                                         <table class="w-full text-xs text-left text-dark-muted">
                                             <thead class="sticky top-0 bg-dark-900 text-dark-500 uppercase font-bold text-[9px] tracking-wider">
                                                 <tr><th class="py-2 p-3">Type</th><th class="py-2 text-right p-3">Count</th><th class="py-2 text-right p-3">Revenue</th></tr>
                                             </thead>
                                             <tbody id="type-data-tbody" class="divide-y divide-dark-800"></tbody>
                                         </table>
                                     </div>
                                 </div>
                            </div>

                            <div class="flex justify-end mt-4">
                                <button onclick="toggleAnalyticsView('type')" id="btn-toggle-type-view" class="text-[10px] font-bold text-blue-400 border border-blue-500/30 bg-blue-900/20 px-3 py-1.5 rounded-lg hover:bg-blue-600 hover:text-white transition">
                                    <i class="fas fa-exchange-alt"></i> <span data-i18n="view_list" id="toggle-type-text">View List</span>
                                </button>
                            </div>
                         </div>
                         <!-- END: Order Type Content Refactor -->
                     </div>
                </div>
                
                <div id="rpt-view-history" class="hide">
                    <div class="flex justify-between items-center mb-4 mt-2">
                        <h4 class="font-bold text-white" data-i18n="orders_selected">Orders for Selected Period</h4>
                        <button onclick="clearAllHistory()" class="text-red-400 text-xs font-bold border border-red-900/30 bg-red-900/10 px-3 py-1 rounded-lg hover:bg-red-900/30 transition" data-i18n="clear_all">Clear All</button>
                    </div>
                    <!-- NEW: Search Input for History -->
                    <div class="mb-4">
                        <input type="text" id="history-search-input" oninput="window.refreshReport()" data-i18n-placeholder="search_history_placeholder" placeholder="Search by Order ID/Table ID (e.g., #A12B or T-1)" class="w-full p-3 rounded-xl border border-dark-700 bg-dark-800 text-white placeholder-dark-700 focus:border-primary outline-none">
                    </div>
                    <div class="overflow-x-auto rounded-xl border border-dark-700 mb-20"><table class="w-full text-sm text-left text-dark-muted"><thead class="bg-dark-900 text-dark-700 uppercase text-xs"><tr><th class="p-3" data-i18n="time">Date/Time</th><th class="p-3" data-i18n="table">Table</th><th class="p-3 text-right" data-i18n="total">Total</th><th class="p-3 text-center">Action</th></tr></thead><tbody id="rpt-history-body" class="divide-y divide-dark-700 bg-dark-800"></tbody></table></div>
                </div>
                
                <!-- NEW CANCELLED VIEW -->
                <div id="rpt-view-cancelled" class="hide">
                    <h4 class="font-bold text-white mb-4 mt-2" data-i18n="cancelled_orders">Cancelled Orders</h4>
                    <div class="overflow-x-auto rounded-xl border border-dark-700 mb-20">
                        <table class="w-full text-sm text-left text-dark-muted">
                            <thead class="bg-dark-900 text-dark-700 uppercase text-xs">
                                <tr>
                                    <th class="p-3" data-i18n="time">Date/Time">Date/Time</th>
                                    <th class="p-3" data-i18n="table">Table</th>
                                    <th class="p-3 text-right" data-i18n="total">Total</th>
                                    <th class="p-3 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-cancelled-body" class="divide-y divide-dark-700 bg-dark-800">
                                <tr><td colspan="4" class="p-8 text-center text-xs text-dark-700">No cancelled records found.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="rpt-view-top" class="hide">
                    <h4 class="font-bold text-white mb-4 mt-2" data-i18n="top_selected">Top Items for Selected Period</h4>
                    <div id="rpt-top-list" class="space-y-3 mb-20"></div>
                </div>
            </div>
        </div>

        <!-- === SCREEN: MENU MANAGER (FULL PAGE) === -->
        <div id="screen-menu" class="page-view hide animate-slide-in">
             <div class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800 sticky top-0 z-20">
                 <div class="flex items-center gap-3">
                    <button onclick="navigateTo('screen-kitchen')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-white hover:bg-dark-600 transition"><i class="fas fa-arrow-left"></i></button>
                    <h3 class="font-bold text-xl text-white" data-i18n="menu_manager">Menu Manager</h3>
                </div>
            </div>
            
            <!-- Add/Edit Form -->
            <div class="p-5 bg-dark-900 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 border-b border-dark-700">
                <input id="new-prod-name" placeholder="Item Name" class="p-3 rounded-xl border border-dark-700 bg-dark-800 text-white placeholder-dark-700 focus:border-primary outline-none">
                <input id="new-prod-price" type="number" placeholder="Price" class="p-3 rounded-xl border border-dark-700 bg-dark-800 text-white placeholder-dark-700 focus:border-primary outline-none">
                <select id="new-prod-category" class="p-3 rounded-xl border border-dark-700 bg-dark-800 text-white focus:border-primary outline-none"><option value="Other">Other</option></select>
                <!-- NEW: Sizes Input -->
                <input id="new-prod-sizes" placeholder="Sizes (e.g., Small:1000, Large:2000)" class="p-3 rounded-xl border border-dark-700 bg-dark-800 text-white placeholder-dark-700 focus:border-primary outline-none">
                
                <input id="new-prod-img" placeholder="Image URL (Optional)" class="p-3 rounded-xl border border-dark-700 bg-dark-800 text-white placeholder-dark-700 focus:border-primary outline-none md:col-span-2">
                <input id="new-prod-options" placeholder="Options (e.g., Spicy, No Onion)" class="p-3 rounded-xl border border-dark-700 bg-dark-800 text-white placeholder-dark-700 focus:border-primary outline-none md:col-span-1">
                <button id="btn-save-prod" onclick="saveProduct()" class="bg-primary text-white rounded-xl font-bold shadow-lg hover:bg-red-600 transition flex items-center justify-center gap-2 md:col-span-1" data-i18n="add_item">Add Item</button>
            </div>
            
            <div id="edit-controls" class="px-5 py-2 flex justify-end bg-dark-900 hide border-b border-dark-700">
                <button onclick="cancelEdit()" class="text-xs font-bold text-red-400 hover:text-white underline" data-i18n="cancel_edit">Cancel Edit</button>
            </div>

            <div class="flex-1 overflow-y-auto p-5 pb-20">
                <table class="w-full text-sm text-left text-dark-muted">
                    <tbody id="menu-table-body" class="divide-y divide-dark-700"></tbody>
                </table>
            </div>
        </div>
        
        <!-- === SCREEN: CATEGORY MANAGER (FULL PAGE) === -->
        <div id="screen-categories" class="page-view hide animate-slide-in">
             <div class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800 sticky top-0 z-20">
                 <div class="flex items-center gap-3">
                    <button onclick="navigateTo('screen-kitchen')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-white hover:bg-dark-600 transition"><i class="fas fa-arrow-left"></i></button>
                    <h3 class="font-bold text-xl text-white" data-i18n="category_manager">Category Manager</h3>
                </div>
            </div>
            
            <!-- Add Category Form -->
            <div class="p-5 bg-dark-900 flex gap-3 border-b border-dark-700 items-center">
                <input id="new-cat-name" placeholder="New Category Name (e.g., Seafood)" class="flex-1 p-3 rounded-xl border border-dark-700 bg-dark-800 text-white placeholder-dark-700 focus:border-primary outline-none">
                <button id="btn-save-cat" onclick="saveCategory()" class="bg-primary text-white p-3 rounded-xl font-bold shadow-lg hover:bg-red-600 transition flex items-center justify-center gap-2 shrink-0">Add Category</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5 pb-20">
                 <h4 class="font-bold text-lg text-white mb-3">Current Categories (Excluding 'All')</h4>
                 <div class="space-y-2" id="categories-list">
                     <!-- Categories will be rendered here -->
                 </div>
                 <div class="mt-8 p-4 text-xs text-dark-muted border border-dark-700 rounded-xl bg-dark-900">
                     <i class="fas fa-info-circle text-primary mr-1"></i> Removing a category will set all associated items to 'Other'.
                 </div>
            </div>
        </div>

        <!-- === SCREEN: TABLE MAP (FULL PAGE) === -->
        <div id="screen-tables" class="page-view hide animate-slide-in">
             <div class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800 z-10 shrink-0 sticky top-0">
                <div class="flex items-center gap-3">
                    <button onclick="navigateTo('screen-kitchen')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-white hover:bg-dark-600 transition"><i class="fas fa-arrow-left"></i></button>
                    <div>
                        <h3 class="font-bold text-white text-xl flex items-center gap-2">
                            <i class="fas fa-store text-orange-500"></i> <span data-i18n="table_map">Table Layout</span>
                        </h3>
                        <p class="text-xs text-dark-muted mt-1" data-i18n="select_table_msg" id="table-map-subtitle">Select a table to take order</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div id="layout-edit-controls" class="hide flex items-center gap-2 mr-2 bg-dark-900/50 p-1 rounded-lg border border-dark-700">
                         <div class="flex items-center gap-1">
                             <select id="new-table-shape" class="bg-dark-800 text-white text-xs border border-dark-600 rounded px-2 py-1.5 focus:border-primary outline-none">
                                 <option value="round">Round ‚ö™</option>
                                 <option value="rect">Square ‚¨ú</option>
                             </select>
                             <button onclick="addNewTable()" class="bg-green-600 text-white px-3 py-1.5 rounded-md text-xs font-bold hover:bg-green-500 shadow flex items-center gap-1">
                                 <i class="fas fa-plus"></i> Add
                             </button>
                         </div>
                         <div class="w-px h-6 bg-dark-600 mx-1"></div>
                        <button id="btn-save-layout" onclick="saveLayout()" class="bg-primary text-white px-3 py-1.5 rounded-md text-xs font-bold hover:bg-red-600 shadow flex items-center gap-1"><i class="fas fa-save"></i> Save</button>
                    </div>
                    
                    <button onclick="toggleLayoutEdit()" id="btn-edit-layout" class="border border-dark-600 text-dark-muted hover:text-white hover:bg-dark-700 px-3 py-1.5 rounded-lg text-xs font-bold transition">
                        <i class="fas fa-pen mr-1"></i> Edit
                    </button>
                </div>
            </div>

            <div onclick="deselectTable()" class="flex-1 overflow-auto bg-dark-900 relative cursor-grab active:cursor-grabbing" id="table-map-container" style="background-image: radial-gradient(#374151 1px, transparent 1px); background-size: 20px 20px;"></div>
            
            <div id="map-bottom-panel" class="p-4 bg-dark-800 border-t border-dark-700 z-10 min-h-[70px] flex justify-center items-center">
                <div id="map-legend" class="flex gap-6 text-xs font-bold text-dark-muted">
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> Free</span>
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500"></span> Occupied</span>
                    <span class="hide text-orange-400 ml-4" id="edit-hint"><i class="fas fa-mouse-pointer"></i> Select a table to edit</span>
                </div>

                <div id="table-properties" class="hide w-full flex justify-between items-center max-w-2xl animate-slide-up">
                    <div class="flex items-center gap-4">
                        <div class="bg-dark-900 px-3 py-1 rounded-lg border border-dark-700">
                             <span class="text-[10px] text-dark-muted uppercase font-bold">Selected</span>
                             <p class="text-white font-bold text-lg" id="prop-id">T-1</p>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] text-dark-muted uppercase font-bold">Shape</span>
                            <div class="flex bg-dark-900 rounded-lg p-0.5 border border-dark-700">
                                <button onclick="updateTableProperty('shape', 'round')" class="px-3 py-1 rounded-md text-xs font-bold transition hover:bg-dark-700 text-dark-muted" id="btn-shape-round"><i class="fas fa-circle"></i></button>
                                <button onclick="updateTableProperty('shape', 'rect')" class="px-3 py-1 rounded-md text-xs font-bold transition hover:bg-dark-700 text-dark-muted" id="btn-shape-rect"><i class="fas fa-square"></i></button>
                            </div>
                        </div>
                        <div class="flex flex-col gap-1 w-32">
                             <span class="text-[10px] text-dark-muted uppercase font-bold">Size</span>
                             <input type="range" min="0.5" max="2" step="0.1" id="prop-size" oninput="updateTableProperty('size', this.value)" class="accent-primary h-2 bg-dark-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                    <button onclick="deleteSelectedTable()" class="bg-red-900/20 text-red-500 border border-red-900/50 hover:bg-red-900/40 hover:text-red-400 px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 transition">
                        <i class="fas fa-trash"></i> Delete Table
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- === MODALS (Lightweight only) === -->
    
    <!-- Custom Confirmation Modal -->
    <div id="modal-confirm" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[101] hide flex items-center justify-center p-4">
        <div class="bg-dark-800 w-full max-w-xs rounded-[30px] shadow-2xl p-6 text-center animate-slide-up border border-dark-700">
            <h3 class="font-bold text-lg mb-2 text-white" id="confirm-title" data-i18n="confirmation">Confirmation</h3>
            <p class="text-sm text-dark-muted mb-6" id="confirm-message">Are you sure?</p>
            <input type="password" id="confirm-pin-input" class="hide border-2 border-dark-700 bg-dark-900 text-white p-3 rounded-2xl w-full text-center font-bold text-2xl tracking-[0.5em] mb-6 focus:border-primary outline-none transition placeholder-dark-700" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
            <div class="flex gap-3">
                <button onclick="closeModal('modal-confirm')" class="flex-1 py-3 text-dark-muted font-bold text-sm hover:text-white transition" data-i18n="cancel">Cancel</button>
                <button id="confirm-action-btn" onclick="" class="flex-1 bg-primary text-white py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-red-600 transition" data-i18n="confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 bg-black/80 z-[100] hide flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-dark-800 w-full max-w-sm rounded-3xl shadow-2xl p-6 border border-dark-700 animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-white">System Settings</h3>
                <button onclick="closeModal('modal-settings')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-dark-muted hover:text-white transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-6">
                <div class="flex justify-between items-center p-4 bg-dark-900 rounded-xl border border-dark-700">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-dark-800 flex items-center justify-center text-primary"><i class="fas fa-volume-up"></i></div>
                        <div><p class="font-bold text-white text-sm">Notification Sound</p><p class="text-[10px] text-dark-muted">Play sound on new order</p></div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="chk-sound-enabled" class="sr-only peer" onchange="toggleSoundSetting(this.checked)">
                        <div class="w-11 h-6 bg-dark-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                </div>
                <div>
                    <p class="text-xs font-bold text-dark-muted uppercase tracking-wider mb-3">Alert Tone</p>
                    <div class="space-y-2">
                        <!-- EXISTING 3 TONES -->
                        <label class="flex items-center justify-between p-3 rounded-xl border border-dark-700 cursor-pointer bg-dark-900 hover:bg-dark-800 transition group">
                            <div class="flex items-center gap-3"><input type="radio" name="sound-choice" value="classic" class="accent-primary" onchange="selectSound('classic')"><span class="text-sm font-bold text-white">Classic Bell üîî</span></div>
                            <button onclick="event.preventDefault(); previewSound('classic')" class="text-dark-muted hover:text-white px-2"><i class="fas fa-play text-xs"></i></button>
                        </label>
                        <label class="flex items-center justify-between p-3 rounded-xl border border-dark-700 cursor-pointer bg-dark-900 hover:bg-dark-800 transition group">
                            <div class="flex items-center gap-3"><input type="radio" name="sound-choice" value="digital" class="accent-primary" onchange="selectSound('digital')"><span class="text-sm font-bold text-white">Kitchen Beep üìü</span></div>
                            <button onclick="event.preventDefault(); previewSound('digital')" class="text-dark-muted hover:text-white px-2"><i class="fas fa-play text-xs"></i></button>
                        </label>
                        <label class="flex items-center justify-between p-3 rounded-xl border border-dark-700 cursor-pointer bg-dark-900 hover:bg-dark-800 transition group">
                            <div class="flex items-center gap-3"><input type="radio" name="sound-choice" value="soft" class="accent-primary" onchange="selectSound('soft')"><span class="text-sm font-bold text-white">Soft Chime ‚ú®</span></div>
                            <button onclick="event.preventDefault(); previewSound('soft')" class="text-dark-muted hover:text-white px-2"><i class="fas fa-play text-xs"></i></button>
                        </label>
                        <!-- PREVIOUSLY ADDED 4 TONES -->
                        <label class="flex items-center justify-between p-3 rounded-xl border border-dark-700 cursor-pointer bg-dark-900 hover:bg-dark-800 transition group">
                            <div class="flex items-center gap-3"><input type="radio" name="sound-choice" value="chime_up" class="accent-primary" onchange="selectSound('chime_up')"><span class="text-sm font-bold text-white">Positive Chime üé∂</span></div>
                            <button onclick="event.preventDefault(); previewSound('chime_up')" class="text-dark-muted hover:text-white px-2"><i class="fas fa-play text-xs"></i></button>
                        </label>
                        <label class="flex items-center justify-between p-3 rounded-xl border border-dark-700 cursor-pointer bg-dark-900 hover:bg-dark-800 transition group">
                            <div class="flex items-center gap-3"><input type="radio" name="sound-choice" value="clash" class="accent-primary" onchange="selectSound('clash')"><span class="text-sm font-bold text-white">Metal Clash ‚öôÔ∏è</span></div>
                            <button onclick="event.preventDefault(); previewSound('clash')" class="text-dark-muted hover:text-white px-2"><i class="fas fa-play text-xs"></i></button>
                        </label>
                        <label class="flex items-center justify-between p-3 rounded-xl border border-dark-700 cursor-pointer bg-dark-900 hover:bg-dark-800 transition group">
                            <div class="flex items-center gap-3"><input type="radio" name="sound-choice" value="pop_alert" class="accent-primary" onchange="selectSound('pop_alert')"><span class="text-sm font-bold text-white">Pop Alert üì£</span></div>
                            <button onclick="event.preventDefault(); previewSound('pop_alert')" class="text-dark-muted hover:text-white px-2"><i class="fas fa-play text-xs"></i></button>
                        </label>
                        <label class="flex items-center justify-between p-3 rounded-xl border border-dark-700 cursor-pointer bg-dark-900 hover:bg-dark-800 transition group">
                            <div class="flex items-center gap-3"><input type="radio" name="sound-choice" value="bell_ring" class="accent-primary" onchange="selectSound('bell_ring')"><span class="text-sm font-bold text-white">Telephone Ring üìû</span></div>
                            <button onclick="event.preventDefault(); previewSound('bell_ring')" class="text-dark-muted hover:text-white px-2"><i class="fas fa-play text-xs"></i></button>
                        </label>
                        
                        <!-- NEW 3 TONES FOR THIS REQUEST -->
                        <label class="flex items-center justify-between p-3 rounded-xl border border-dark-700 cursor-pointer bg-dark-900 hover:bg-dark-800 transition group">
                            <div class="flex items-center gap-3"><input type="radio" name="sound-choice" value="fanfare" class="accent-primary" onchange="selectSound('fanfare')"><span class="text-sm font-bold text-white">Triumphal Ding üí°</span></div>
                            <button onclick="event.preventDefault(); previewSound('fanfare')" class="text-dark-muted hover:text-white px-2"><i class="fas fa-play text-xs"></i></button>
                        </label>
                        <label class="flex items-center justify-between p-3 rounded-xl border border-dark-700 cursor-pointer bg-dark-900 hover:bg-dark-800 transition group">
                            <div class="flex items-center gap-3"><input type="radio" name="sound-choice" value="cute_jingle" class="accent-primary" onchange="selectSound('cute_jingle')"><span class="text-sm font-bold text-white">Cute Jingle üéµ</span></div>
                            <button onclick="event.preventDefault(); previewSound('cute_jingle')" class="text-dark-muted hover:text-white px-2"><i class="fas fa-play text-xs"></i></button>
                        </label>
                        <label class="flex items-center justify-between p-3 rounded-xl border border-dark-700 cursor-pointer bg-dark-900 hover:bg-dark-800 transition group">
                            <div class="flex items-center gap-3"><input type="radio" name="sound-choice" value="victory_song" class="accent-primary" onchange="selectSound('victory_song')"><span class="text-sm font-bold text-white">Victory Tune üèÜ</span></div>
                            <button onclick="event.preventDefault(); previewSound('victory_song')" class="text-dark-muted hover:text-white px-2"><i class="fas fa-play text-xs"></i></button>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Category Modal (Mobile) -->
    <div id="modal-category" class="fixed inset-0 bg-black/80 z-[100] hide flex items-end sm:items-center justify-center">
        <div class="bg-dark-800 w-full sm:w-[450px] sm:rounded-3xl rounded-t-[30px] shadow-2xl animate-slide-up overflow-hidden flex flex-col max-h-[70vh] border-t border-dark-700 sm:border">
            <div class="p-5 border-b border-dark-700 flex justify-between items-center bg-dark-800">
                <h3 class="font-bold text-lg text-white" data-i18n="select_category">Select Category</h3>
                <button onclick="closeModal('modal-category')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-dark-muted hover:text-white hover:bg-dark-600 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 grid grid-cols-2 gap-3 overflow-y-auto" id="modal-cat-grid"></div>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div id="modal-login" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hide flex items-center justify-center p-4">
        <div class="bg-dark-800 w-full max-w-xs rounded-[30px] shadow-2xl p-6 text-center animate-slide-up border border-dark-700">
            <h3 class="font-bold text-lg mb-1 text-white" data-i18n="staff_access">Staff Access</h3>
            <p class="text-xs text-dark-muted mb-6" data-i18n="staff_only">Kitchen Management Only</p>
            <input type="password" id="staff-pin" class="border-2 border-dark-700 bg-dark-900 text-white p-3 rounded-2xl w-full text-center font-bold text-2xl tracking-[0.5em] mb-6 focus:border-primary outline-none transition placeholder-dark-700" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
            <div class="flex gap-3">
                <button onclick="closeModal('modal-login')" class="flex-1 py-3 text-dark-muted font-bold text-sm hover:text-white transition" data-i18n="cancel">Cancel</button>
                <button onclick="verifyPin()" class="flex-1 bg-white text-dark-900 py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-gray-200 transition" data-i18n="login">Login</button>
            </div>
        </div>
    </div>

    <!-- Change PIN Modal -->
    <div id="modal-change-pin" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hide flex items-center justify-center p-4">
        <div class="bg-dark-800 w-full max-w-xs rounded-[30px] shadow-2xl p-6 text-center animate-slide-up border border-dark-700">
            <h3 class="font-bold text-lg mb-4 text-white" data-i18n="update_pin">Update PIN</h3>
            <input type="tel" id="new-pin-input" class="border-2 border-dark-700 bg-dark-900 text-white p-3 rounded-2xl w-full text-center font-bold text-2xl tracking-[0.5em] mb-6 outline-none focus:border-primary placeholder-dark-700" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
            <button onclick="saveNewPin()" class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-lg mb-3 hover:bg-red-600 transition" data-i18n="save_pin">Save New PIN</button>
            <button onclick="closeModal('modal-change-pin')" class="text-dark-muted text-xs font-bold py-2 hover:text-white" data-i18n="cancel">Cancel</button>
        </div>
    </div>

    <!-- Product Details -->
    <div id="modal-product" class="fixed inset-0 bg-black/80 z-[100] hide flex items-end sm:items-center justify-center">
        <div class="bg-dark-800 w-full sm:w-[450px] sm:rounded-3xl rounded-t-[30px] shadow-2xl animate-slide-up overflow-hidden max-h-[90vh] flex flex-col border-t border-dark-700 sm:border">
            <div class="h-56 relative shrink-0 group">
                <img id="mp-img" src="" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-dark-900 via-transparent to-transparent"></div>
                <button onclick="closeModal('modal-product')" class="absolute top-4 right-4 w-8 h-8 bg-black/40 text-white rounded-full flex items-center justify-center backdrop-blur-md z-10 hover:bg-black/60"><i class="fas fa-times"></i></button>
                <div class="absolute bottom-4 left-6 right-6 text-white">
                    <h3 id="mp-name" class="text-2xl font-bold leading-tight drop-shadow-md">Product</h3>
                    <span id="mp-price-display" class="inline-block mt-2 bg-primary text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">0 Ks</span>
                </div>
            </div>
            
            <div class="p-6 overflow-y-auto bg-dark-800 flex-1">
                <div class="mb-4">
                    <!-- NEW: SIZES SECTION -->
                    <div id="size-selection-container" class="hide mb-4">
                        <p class="text-[10px] font-bold text-dark-muted uppercase tracking-widest mb-3">Select Size</p>
                        <div id="dynamic-sizes" class="flex flex-wrap gap-2"></div>
                    </div>

                    <p class="text-[10px] font-bold text-dark-muted uppercase tracking-widest mb-3" data-i18n="customize">Customize Order</p>
                    <div id="dynamic-options" class="grid grid-cols-2 gap-3 mb-4"></div>
                    
                    <p class="text-[10px] font-bold text-dark-muted uppercase tracking-widest mb-2" data-i18n="remarks">Special Requests</p>
                    <textarea id="prod-remark" class="w-full bg-dark-900 border border-dark-700 rounded-xl p-3 text-white text-sm focus:border-primary outline-none resize-none placeholder-dark-700 transition focus:ring-1 focus:ring-primary" rows="2" placeholder="e.g., Less oil, Allergy info..."></textarea>
                </div>
            </div>

            <div class="p-4 border-t border-dark-700 bg-dark-800 pb-8 sm:pb-4">
                <div class="flex items-center gap-3">
                    <div class="flex items-center bg-dark-900 border border-dark-700 rounded-2xl p-1 h-14">
                        <button onclick="updateQty(-1)" class="w-12 h-full flex items-center justify-center text-dark-muted font-bold active:scale-90 transition hover:text-white">-</button>
                        <span id="mp-qty" class="w-8 text-center font-bold text-xl text-white">1</span>
                        <button onclick="updateQty(1)" class="w-12 h-full flex items-center justify-center text-white font-bold active:scale-90 transition hover:text-primary">+</button>
                    </div>
                    <button onclick="addToCart()" class="flex-1 bg-white text-dark-900 h-14 rounded-2xl font-bold shadow-lg shadow-white/10 active:scale-[0.98] transition flex justify-between items-center px-6 hover:bg-gray-100">
                        <span data-i18n="add_to_order">Add to Order</span>
                        <div class="bg-dark-900 text-white w-8 h-8 rounded-full flex items-center justify-center text-xs"><i class="fas fa-plus"></i></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout -->
    <div id="modal-checkout" class="fixed inset-0 bg-black/80 z-[100] hide flex items-end sm:items-center justify-center">
        <div class="bg-dark-800 w-full sm:w-[450px] sm:rounded-3xl rounded-t-[30px] shadow-2xl animate-slide-up overflow-hidden flex flex-col max-h-[85vh] border-t border-dark-700 sm:border">
            <div class="p-5 border-b border-dark-700 flex justify-between items-center bg-dark-800">
                <div>
                    <h3 class="font-bold text-xl text-white" data-i18n="your_tray">Your Tray</h3>
                    <p class="text-xs text-dark-muted mt-0.5" data-i18n="check_items">Check your items</p>
                </div>
                <button onclick="closeModal('modal-checkout')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-dark-muted hover:text-white hover:bg-dark-600 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="px-5 pt-4 pb-0">
                <div class="bg-dark-900 p-1 rounded-xl flex border border-dark-700 relative">
                    <button onclick="setOrderType('dine_in')" id="btn-type-dine" class="flex-1 py-2.5 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 bg-primary text-white shadow-md">
                        <i class="fas fa-utensils"></i> <span data-i18n="dine_in">Dine In</span>
                    </button>
                    <button onclick="setOrderType('takeaway')" id="btn-type-take" class="flex-1 py-2.5 rounded-lg text-xs font-bold text-dark-muted hover:text-white transition flex items-center justify-center gap-2">
                        <i class="fas fa-shopping-bag"></i> <span data-i18n="takeaway">Takeaway</span>
                    </button>
                </div>
            </div>

            <div id="checkout-items" class="p-4 overflow-y-auto flex-1 space-y-3 bg-dark-900 mt-2"></div>
            <div class="p-6 bg-dark-800 border-t border-dark-700 pb-8 sm:pb-6">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-xs font-bold text-dark-muted uppercase tracking-wider" data-i18n="total_amount">Total Amount</span>
                    <span id="checkout-grand-total" class="text-3xl font-bold text-white">0 Ks</span>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="closeModal('modal-checkout')" class="flex-1 bg-dark-700 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-dark-600 transition active:scale-[0.98]" data-i18n="cancel">
                        Cancel
                    </button>
                    <button onclick="submitOrder()" class="flex-[2] bg-primary text-white py-4 rounded-2xl font-bold shadow-xl shadow-primary/20 active:scale-[0.98] transition flex justify-center items-center gap-3 hover:bg-red-600">
                        <span data-i18n="confirm">Confirm</span>
                        <i class="fas fa-check-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-qr" class="fixed inset-0 bg-black/80 z-[100] hide flex items-center justify-center p-4">
        <div class="bg-dark-800 w-full max-w-sm rounded-3xl p-6 text-center animate-slide-up border border-dark-700">
            <h3 class="font-bold text-lg mb-4 text-white" data-i18n="table_qr">Table QR</h3>
            <input type="number" id="qr-table-num" value="1" class="border-2 border-dark-700 bg-dark-900 text-white p-3 rounded-xl w-full text-center font-bold text-xl mb-4 focus:border-primary outline-none">
            <button onclick="generateQR()" class="w-full bg-white text-dark-900 py-3 rounded-xl font-bold mb-4 shadow-lg hover:bg-gray-200 transition" data-i18n="generate">Generate</button>
            <div id="qr-container" class="bg-white rounded-xl p-4 flex justify-center mb-4 min-h-[150px]"></div>
            <button onclick="printQR()" class="text-primary font-bold text-sm hover:underline" data-i18n="print_qr">Print QR Code</button>
            <button onclick="closeModal('modal-qr')" class="block w-full mt-4 text-dark-muted text-xs hover:text-white" data-i18n="close">Close</button>
        </div>
    </div>

    <!-- Hidden Receipt -->
    <div id="receipt-print-area" class="hide font-mono text-sm p-4 bg-white max-w-[300px]">
        <div class="text-center mb-2"><h2 class="text-xl font-bold text-black" id="rcp-title">PingPOS</h2></div>
        <div class="text-center mb-4 border-b-2 border-black pb-2"><h3 class="text-lg font-bold text-black" id="rcp-type">RECEIPT</h3></div>
        <div class="border-b border-black pb-2 mb-2 flex justify-between text-xs font-bold text-black"><span id="rcp-id">#000</span><span id="rcp-date"></span></div>
        <div class="text-center text-lg font-bold mb-4 border-b-2 border-black pb-2 text-black">Table <span id="rcp-table"></span></div>
        <table class="w-full text-left mb-4 text-xs text-black">
            <thead><tr class="border-b border-gray-400"><th class="py-1">Item</th><th class="py-1 text-right" id="rcp-th-amt">Amt</th></tr></thead>
            <tbody id="rcp-items"></tbody>
        </table>
        <div id="rcp-footer" class="border-t-2 border-black pt-2 flex justify-between font-bold text-lg mt-4 text-black"><span>TOTAL</span><span id="rcp-total"></span></div>
    </div>
    
    <!-- === MODAL: ANALYTICS DETAIL (New Modal) === -->
    <div id="modal-analytics-detail" class="fixed inset-0 bg-black/80 z-[100] hide flex items-end sm:items-center justify-center">
        <div class="bg-dark-800 w-full sm:w-[600px] sm:rounded-3xl rounded-t-[30px] shadow-2xl animate-slide-up overflow-hidden flex flex-col max-h-[85vh] border-t border-dark-700 sm:border">
            <div class="p-5 border-b border-dark-700 flex justify-between items-center bg-dark-800">
                <h3 class="font-bold text-xl text-white" id="detail-modal-title">Detail List</h3>
                <button onclick="closeModal('modal-analytics-detail')" class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-dark-muted hover:text-white hover:bg-dark-600 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-4 overflow-y-auto flex-1 bg-dark-900">
                <div id="detail-modal-content" class="space-y-3">
                    <!-- Detailed list items (orders or items) will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyB0TsIVnLIWIOukeT_ddLwA9xMki50H1yE",
            authDomain: "pingpos.firebaseapp.com",
            projectId: "pingpos",
            storageBucket: "pingpos.firebasestorage.app",
            messagingSenderId: "328655511392",
            appId: "1:328655511392:web:f6232b5a3003bef5454805",
            measurementId: "G-QP50T36M1W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'pingpos-production'; 
        
        // Error Handler
        window.onerror = function(msg, url, line) {
            console.error(`Error: ${msg} at ${line}`);
        };

        // AUDIO SYSTEM - UPDATED
        const sounds = {
            classic: 'https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3', // Desk Bell
            digital: 'https://assets.mixkit.co/active_storage/sfx/1862/1862-preview.mp3', // Kitchen Beep
            soft: 'https://assets.mixkit.co/active_storage/sfx/2559/2559-preview.mp3',    // Soft Chime
            // PREVIOUSLY ADDED SOUNDS
            chime_up: 'https://assets.mixkit.co/active_storage/sfx/2744/2744-preview.mp3', // Positive Chime
            clash: 'https://assets.mixkit.co/active_storage/sfx/2908/2908-preview.mp3',    // Metal Clash
            pop_alert: 'https://assets.mixkit.co/active_storage/sfx/2405/2405-preview.mp3', // Pop Alert
            bell_ring: 'https://assets.mixkit.co/active_storage/sfx/1206/1206-preview.mp3', // Telephone Ring
            // NEWLY ADDED SOUNDS (Ding idea, cute music, cute song)
            fanfare: 'https://assets.mixkit.co/active_storage/sfx/2850/2850-preview.mp3', // Triumphal Ding
            cute_jingle: 'https://assets.mixkit.co/active_storage/sfx/3506/3506-preview.mp3', // Cute Music
            victory_song: 'https://assets.mixkit.co/active_storage/sfx/1310/1310-preview.mp3' // Cute Song / Victory
        };

        let soundState = {
            enabled: localStorage.getItem('pingpos_sound_enabled') !== 'false', // Default true
            choice: localStorage.getItem('pingpos_sound_choice') || 'classic',
            isPlaying: false
        };

        const audioEl = document.getElementById('notif-sound');
        audioEl.src = sounds[soundState.choice];

        // Ensure audio loop is explicitly set
        window.startIncomingOrderAlert = () => {
            console.log("Audio: Start Alert Triggered. Looping is ON."); // Added console log
            if (!soundState.enabled || soundState.isPlaying) return;
            soundState.isPlaying = true;
            document.getElementById('silence-btn').classList.remove('hide'); 
            audioEl.currentTime = 0;
            audioEl.loop = true; // Explicitly set loop to true
            audioEl.play().catch(e => console.log("Audio play failed:", e));
        };

        window.stopIncomingOrderAlert = () => {
            console.log("Audio: Stop Alert Triggered. Looping is OFF."); // Added console log
            soundState.isPlaying = false;
            audioEl.pause();
            audioEl.currentTime = 0;
            audioEl.loop = false; // Stop loop
            document.getElementById('silence-btn').classList.add('hide'); 
        };

        window.playSingleBeep = () => {
            if (!soundState.enabled) return;
            const tempAudio = new Audio(sounds[soundState.choice]);
            tempAudio.play().catch(()=>{});
        };

        window.openSettingsModal = () => {
            document.getElementById('modal-settings').classList.remove('hide');
            document.getElementById('chk-sound-enabled').checked = soundState.enabled;
            const radio = document.querySelector(`input[name="sound-choice"][value="${soundState.choice}"]`);
            if(radio) radio.checked = true;
        };

        window.toggleSoundSetting = (val) => {
            soundState.enabled = val;
            localStorage.setItem('pingpos_sound_enabled', val);
            if (!val) window.stopIncomingOrderAlert();
        };

        window.selectSound = (val) => {
            soundState.choice = val;
            localStorage.setItem('pingpos_sound_choice', val);
            audioEl.src = sounds[val];
        };

        window.previewSound = (val) => {
            const preview = new Audio(sounds[val]);
            preview.play().catch(()=>{});
        };

        // TRANSLATION DATA
        const resources = {
            en: {
                dine_in: "Dine In", takeaway: "Takeaway", hero_title: "Hungry? üòã", hero_subtitle: "Order something good!", table: "TABLE", loading: "Loading Menu...", no_items: "No items available yet.", total: "TOTAL", view_order: "VIEW ORDER", kitchen_display: "Kitchen Display", kitchen_clear: "Kitchen is clear", exit: "Exit", menu: "Menu", select_category: "Select Category", staff_access: "Staff Access", staff_only: "Kitchen Management Only", login: "Login", cancel: "Cancel", update_pin: "Update PIN", save_pin: "Save New PIN", customize: "Customize Order", add_to_order: "Add to Order", your_tray: "Your Tray", check_items: "Check your items", total_amount: "Total Amount", confirm: "Confirm", menu_manager: "Menu Manager", add_item: "Add Item", update_item: "Update Item", cancel_edit: "Cancel Edit", analytics: "Analytics", overview: "Overview", history: "History", top_items: "Top Items", date: "Date:", total_revenue: "Total Revenue", total_orders: "Total Orders", orders_selected: "Orders for Selected Date", clear_all: "Clear All", time: "Time", top_selected: "Top Items for Selected Date", table_qr: "Table QR", generate: "Generate", print_qr: "Print QR Code", close: "Close", more: "More", hourly_sales: "Sales Trend", category_sales: "Category Sales", order_type: "Order Type", sold_out: "SOLD OUT", available: "Available", pos_mode: "POS Mode", table_map: "Table Layout", select_table_msg: "Select a table to take order", free: "Free", occupied: "Occupied", remarks: "Special Requests", cancelled: "Cancelled", daily: "Daily", weekly: "Weekly", monthly: "Monthly", yearly: "Yearly",
                Fried: "Fried", Curry: "Curry", Soup: "Soup", Salad: "Salad", Rice: "Rice", Noodle: "Noodle", Dessert: "Dessert", Drink: "Drink", Other: "Other", All: "All", view_list: "View List", view_chart: "View Chart", cancelled_orders: "Cancelled Orders", category_manager: "Category Manager", search_history_placeholder: "Search by Order ID/Table ID (e.g., #A12B or T-1)", // NEW
                
                // NEW CONFIRMATION KEYS
                confirmation: "Confirmation", admin_action: "Admin Action Required", cancel_confirm: "Cancel Order?", remove_confirm: "Remove Item?", delete_confirm: "Delete Record?", delete_all_confirm: "Delete All History?", delete_category_confirm: "Delete Category?", delete_table_confirm: "Delete Table?", pin_prompt: "Enter PIN", saved_pin_success: "New PIN Saved", wrong_pin: "Wrong PIN", min_4_digits: "Min 4 digits required", cleared_success: "History Cleared", action_failed: "Action Failed", error: "Error",
            },
            my: { // ·Äô·Äº·Äî·Ä∫·Äô·Ä¨ (Burmese)
                dine_in: "·Äë·Äô·ÄÑ·Ä∫·Ä∏·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤", takeaway: "·Äï·Ä´·ÄÜ·Äö·Ä∫", hero_title: "·Äó·Ä≠·ÄØ·ÄÄ·Ä∫·ÄÜ·Ä¨·Äî·Ä±·Äú·Ä¨·Ä∏? üòã", hero_subtitle: "·Ä°·Äõ·Äû·Ä¨·Äõ·Äæ·Ä≠·Äê·Ä¨·Äú·Ä±·Ä∏ ·Äô·Äæ·Ä¨·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´!", table: "·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤", loading: "·Äô·ÄÆ·Äî·Ä∞·Ä∏·Äô·Äª·Ä¨·Ä∏ ·Äê·ÄÑ·Ä∫·Äî·Ä±·Äû·Ää·Ä∫...", no_items: "·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏ ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´·Åã", total: "·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏", view_order: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫", kitchen_display: "·Äô·ÄÆ·Ä∏·Äñ·Ä≠·ÄØ·ÄÅ·Äª·Ä±·Ä¨·ÄÑ·Ä∫ ·Äñ·Äî·Ä∫·Äû·Ä¨·Ä∏·Äï·Äº·ÄÑ·Ä∫", kitchen_clear: "·Äô·ÄÆ·Ä∏·Äñ·Ä≠·ÄØ·ÄÅ·Äª·Ä±·Ä¨·ÄÑ·Ä∫ ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏·Äû·Ää·Ä∫", exit: "·Äë·ÄΩ·ÄÄ·Ä∫·Äõ·Äî·Ä∫", menu: "·Äô·ÄÆ·Äî·Ä∞·Ä∏", select_category: "·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏ ·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´", staff_access: "·Äù·Äî·Ä∫·Äë·Äô·Ä∫·Ä∏ ·Äù·ÄÑ·Ä∫·Äõ·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äæ·ÄØ", staff_only: "·Äô·ÄÆ·Ä∏·Äñ·Ä≠·ÄØ·ÄÅ·Äª·Ä±·Ä¨·ÄÑ·Ä∫ ·ÄÖ·ÄÆ·Äô·Ä∂·ÄÅ·Äî·Ä∑·Ä∫·ÄÅ·ÄΩ·Ä≤·Äõ·Ä±·Ä∏·Äû·Ä¨", login: "·Äù·ÄÑ·Ä∫·Äô·Ää·Ä∫", cancel: "·Äñ·Äª·ÄÄ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Ää·Ä∫", update_pin: "PIN ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äú·Ä≤·Äô·Ää·Ä∫", save_pin: "PIN ·Ä°·Äû·ÄÖ·Ä∫ ·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Ää·Ä∫", customize: "·ÄÖ·Ä≠·Äê·Ä∫·ÄÄ·Äº·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·Äô·Ää·Ä∫", add_to_order: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ·Äê·ÄΩ·ÄÑ·Ä∫ ·Äë·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫", your_tray: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨ ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏", check_items: "·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏·Äï·Ä´", total_amount: "·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ ·ÄÑ·ÄΩ·Ä±·Äï·Äô·Ä¨·Äè", confirm: "·Ä°·Äê·Ää·Ä∫·Äï·Äº·ÄØ·Äô·Ää·Ä∫", menu_manager: "·Äô·ÄÆ·Äî·Ä∞·Ä∏ ·ÄÖ·ÄÆ·Äô·Ä∂·ÄÅ·Äî·Ä∑·Ä∫·ÄÅ·ÄΩ·Ä≤·Äô·Äæ·ÄØ", add_item: "·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Ä°·Äû·ÄÖ·Ä∫ ·Äë·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫", update_item: "·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏ ·Äï·Äº·ÄÑ·Ä∫·Äô·Ää·Ä∫", cancel_edit: "·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·Äô·Äæ·ÄØ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Ää·Ä∫", analytics: "·ÄÅ·ÄΩ·Ä≤·ÄÅ·Äº·Äô·Ä∫·Ä∏·ÄÖ·Ä≠·Äê·Ä∫·Äñ·Äº·Ä¨·ÄÅ·Äª·ÄÄ·Ä∫", overview: "·Ä°·ÄÄ·Äª·Äâ·Ä∫·Ä∏·ÄÅ·Äª·ÄØ·Äï·Ä∫", history: "·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏", top_items: "·Ä°·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·ÄÜ·ÄØ·Ä∂·Ä∏ ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏", date: "·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤:", total_revenue: "·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ ·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±", total_orders: "·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ ·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ", orders_selected: "·Äõ·ÄΩ·Ä±·Ä∏·ÄÅ·Äª·Äö·Ä∫·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨ ·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ·Äô·Äª·Ä¨·Ä∏", clear_all: "·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Ää·Ä∫", time: "·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫", top_selected: "·Ä°·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·ÄÜ·ÄØ·Ä∂·Ä∏ ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏", table_qr: "·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤ QR", generate: "·Äë·ÄØ·Äê·Ä∫·Äú·ÄØ·Äï·Ä∫·Äô·Ää·Ä∫", print_qr: "QR Code ·Äï·ÄØ·Ä∂·Äî·Äæ·Ä≠·Äï·Ä∫·Äô·Ää·Ä∫", close: "·Äï·Ä≠·Äê·Ä∫·Äô·Ää·Ä∫", more: "·Äï·Ä≠·ÄØ·Äô·Ä≠·ÄØ", hourly_sales: "·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Ä°·Ä¨·Ä∏ ·Ä°·ÄÅ·Äº·Ä±·Ä°·Äî·Ä±", category_sales: "·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏·Ä°·Äú·Ä≠·ÄØ·ÄÄ·Ä∫ ·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Ä°·Ä¨·Ä∏", order_type: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏", sold_out: "·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·ÄÄ·ÄØ·Äî·Ä∫", available: "·Äõ·Äõ·Äæ·Ä≠·Äî·Ä≠·ÄØ·ÄÑ·Ä∫", pos_mode: "POS ·ÄÖ·Äî·ÄÖ·Ä∫", table_map: "·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤ Layout", select_table_msg: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äõ·Äî·Ä∫ ·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤ ·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´", free: "·Äú·ÄΩ·Äê·Ä∫", occupied: "·Äô·Ä°·Ä¨·Ä∏·Äû·Ä±·Ä∏", remarks: "·Ä°·Äë·Ä∞·Ä∏ ·Äô·Äæ·Äê·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫", cancelled: "·Äñ·Äª·ÄÄ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏", daily: "·Äî·Ä±·Ä∑·ÄÖ·Äâ·Ä∫", weekly: "·Ä°·Äï·Äê·Ä∫·ÄÖ·Äâ·Ä∫", monthly: "·Äú·ÄÖ·Äâ·Ä∫", yearly: "·Äî·Äæ·ÄÖ·Ä∫·ÄÖ·Äâ·Ä∫",
                Fried: "·ÄÄ·Äº·Ä±·Ä¨·Ä∫", Curry: "·Äü·ÄÑ·Ä∫·Ä∏", Soup: "·ÄÖ·ÄΩ·Äï·Ä∫·Äï·Äº·ÄØ·Äê·Ä∫", Salad: "·Äû·ÄØ·Äï·Ä∫", Rice: "·Äë·Äô·ÄÑ·Ä∫·Ä∏", Noodle: "·ÄÅ·Ä±·Ä´·ÄÄ·Ä∫·ÄÜ·ÄΩ·Ä≤", Dessert: "·Ä°·ÄÅ·Äª·Ä≠·ÄØ·Äï·ÄΩ·Ä≤", Drink: "·Ä°·Äñ·Äª·Ä±·Ä¨·Ä∫·Äö·Äô·ÄÄ·Ä¨", Other: "·Ä°·ÄÅ·Äº·Ä¨·Ä∏", All: "·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏", view_list: "·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫", view_chart: "·Äá·Äö·Ä¨·Ä∏·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫", cancelled_orders: "·Äñ·Äª·ÄÄ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äû·Ä±·Ä¨ ·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ·Äô·Äª·Ä¨·Ä∏", category_manager: "·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏ ·ÄÖ·ÄÆ·Äô·Ä∂·ÄÅ·Äî·Ä∑·Ä∫·ÄÅ·ÄΩ·Ä≤·Äô·Äæ·ÄØ", search_history_placeholder: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·Äî·Ä∂·Äï·Ä´·Äê·Ä∫/·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤·Äî·Ä∂·Äï·Ä´·Äê·Ä∫ ·Äñ·Äº·ÄÑ·Ä∑·Ä∫ ·Äõ·Äæ·Ä¨·Äñ·ÄΩ·Ä±·Äï·Ä´ (·Ä•·Äï·Äô·Ä¨: #A12B ·Äû·Ä≠·ÄØ·Ä∑·Äô·Äü·ÄØ·Äê·Ä∫ T-1)",
                
                // NEW CONFIRMATION KEYS
                confirmation: "·Ä°·Äê·Ää·Ä∫·Äï·Äº·ÄØ·ÄÅ·Äª·ÄÄ·Ä∫", admin_action: "·ÄÖ·ÄÆ·Äô·Ä∂·ÄÅ·Äî·Ä∑·Ä∫·ÄÅ·ÄΩ·Ä≤·Äû·Ä∞ ·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫ ·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫", cancel_confirm: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·Äñ·Äª·ÄÄ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Äú·Ä¨·Ä∏?", remove_confirm: "·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äñ·Äö·Ä∫·Äõ·Äæ·Ä¨·Ä∏·Äô·Äú·Ä¨·Ä∏?", delete_confirm: "·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äú·Ä¨·Ä∏?", delete_all_confirm: "·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äú·Ä¨·Ä∏?", delete_category_confirm: "·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äú·Ä¨·Ä∏?", delete_table_confirm: "·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äú·Ä¨·Ä∏?", pin_prompt: "PIN ·Äî·Ä∂·Äï·Ä´·Äê·Ä∫ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´", saved_pin_success: "PIN ·Ä°·Äû·ÄÖ·Ä∫ ·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏", wrong_pin: "PIN ·Äî·Ä∂·Äï·Ä´·Äê·Ä∫ ·Äô·Äæ·Ä¨·Ä∏·Äö·ÄΩ·ÄÑ·Ä∫·Ä∏", min_4_digits: "·Ä°·Äî·Ää·Ä∫·Ä∏·ÄÜ·ÄØ·Ä∂·Ä∏ ·ÄÇ·Äè·Äî·Ä∫·Ä∏ ·ÅÑ ·Äú·ÄØ·Ä∂·Ä∏ ·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫·Äû·Ää·Ä∫", cleared_success: "·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏ ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏", action_failed: "·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫ ·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´", error: "·Ä°·Äô·Äæ·Ä¨·Ä∏",
            },
            cn: {
                dine_in: "Â†ÇÈ£ü", takeaway: "Â§ñÂ∏¶", hero_title: "È•ø‰∫ÜÂêó? üòã", hero_subtitle: "ÁÇπ‰∫õÂ•ΩÂêÉÁöÑÂêß!", table: "Ê°åÂè∑", loading: "Ê≠£Âú®Âä†ËΩΩËèúÂçï...", no_items: "ÊöÇÊó†ÂïÜÂìÅ„ÄÇ", total: "ÊÄªËÆ°", view_order: "Êü•ÁúãËÆ¢Âçï", kitchen_display: "Âé®ÊàøÊòæÁ§∫Â±è", kitchen_clear: "Âé®ÊàøÊ∏ÖÁêÜÂÆåÊØï", exit: "ÈÄÄÂá∫", menu: "ËèúÂçï", select_category: "ÈÄâÊã©Á±ªÂà´", staff_access: "ÂëòÂ∑•ÈÄöÈÅì", staff_only: "‰ªÖÈôêÂé®ÊàøÁÆ°ÁêÜ", login: "ÁôªÂΩï", cancel: "ÂèñÊ∂à", update_pin: "Êõ¥Êñ∞ÂØÜÁ†Å", save_pin: "‰øùÂ≠òÊñ∞ÂØÜÁ†Å", customize: "ÂÆöÂà∂ËÆ¢Âçï", add_to_order: "Ê∑ªÂä†Âà∞ËÆ¢Âçï", your_tray: "ÊÇ®ÁöÑÈ§êÁõò", check_items: "Ê£ÄÊü•ÊÇ®ÁöÑÂïÜÂìÅ", total_amount: "ÊÄªÈáëÈ¢ù", confirm: "Á°ÆËÆ§", menu_manager: "ËèúÂçïÁÆ°ÁêÜ", add_item: "Ê∑ªÂä†ÂïÜÂìÅ", update_item: "Êõ¥Êñ∞ÂïÜÂìÅ", cancel_edit: "ÂèñÊ∂àÁºñËæë", analytics: "Êï∞ÊçÆÂàÜÊûê", overview: "ÊÄªËßà", history: "ÂéÜÂè≤ËÆ∞ÂΩï", top_items: "ÁïÖÈîÄÂïÜÂìÅ", date: "Êó•Êúü:", total_revenue: "ÊÄªÊî∂ÂÖ•", total_orders: "ÊÄªËÆ¢Âçï", orders_selected: "ÊâÄÈÄâÊúüÈó¥ÁöÑËÆ¢Âçï", clear_all: "Ê∏ÖÈô§ÊâÄÊúâ", time: "Êó∂Èó¥", top_selected: "ÊâÄÈÄâÊúüÈó¥ÁöÑÁïÖÈîÄÂïÜÂìÅ", table_qr: "Ê°åÂè∑‰∫åÁª¥Á†Å", generate: "ÁîüÊàê", print_qr: "ÊâìÂç∞‰∫åÁª¥Á†Å", close: "ÂÖ≥Èó≠", more: "Êõ¥Â§ö", hourly_sales: "ÈîÄÂîÆË∂ãÂäø", category_sales: "Á±ªÂà´ÈîÄÂîÆ", order_type: "ËÆ¢ÂçïÁ±ªÂûã", sold_out: "Â∑≤ÂîÆÁΩÑ", available: "ÊúâË¥ß", pos_mode: "POSÊ®°Âºè", table_map: "È§êÊ°åÂ∏ÉÂ±Ä", select_table_msg: "ÈÄâÊã©‰∏ÄÂº†Ê°åÂ≠êÂºÄÂßãÁÇπÈ§ê", free: "Á©∫Èó≤", occupied: "Âç†Áî®", remarks: "ÁâπÊÆäË¶ÅÊ±Ç", cancelled: "Â∑≤ÂèñÊ∂à", daily: "ÊØèÊó•", weekly: "ÊØèÂë®", monthly: "ÊØèÊúà", yearly: "ÊØèÂπ¥",
                Fried: "Ê≤πÁÇ∏", Curry: "ÂíñÂñ±", Soup: "Ê±§Á±ª", Salad: "Ê≤ôÊãâ", Rice: "Á±≥È•≠", Noodle: "Èù¢È£ü", Dessert: "ÁîúÁÇπ", Drink: "È•ÆÊñô", Other: "ÂÖ∂‰ªñ", All: "ÂÖ®ÈÉ®", view_list: "Êü•ÁúãÂàóË°®", view_chart: "Êü•ÁúãÂõæË°®", cancelled_orders: "Â∑≤ÂèñÊ∂àÁöÑËÆ¢Âçï", category_manager: "Á±ªÂà´ÁÆ°ÁêÜ", search_history_placeholder: "ÊåâËÆ¢Âçï/Ê°åÂè∑ÊêúÁ¥¢ (‰æãÂ¶Ç: #A12B Êàñ T-1)",
                
                // NEW CONFIRMATION KEYS
                confirmation: "Á°ÆËÆ§", admin_action: "ÈúÄË¶ÅÁÆ°ÁêÜÂëòÊìç‰Ωú", cancel_confirm: "ÂèñÊ∂àËÆ¢Âçï?", remove_confirm: "Âà†Èô§ÂïÜÂìÅ?", delete_confirm: "Âà†Èô§ËÆ∞ÂΩï?", delete_all_confirm: "Âà†Èô§ÊâÄÊúâËÆ∞ÂΩï?", delete_category_confirm: "Âà†Èô§Á±ªÂà´?", delete_table_confirm: "Âà†Èô§Ê°åÂ≠ê?", pin_prompt: "ËæìÂÖ•ÂØÜÁ†Å", saved_pin_success: "Êñ∞ÂØÜÁ†ÅÂ∑≤‰øùÂ≠ò", wrong_pin: "ÂØÜÁ†ÅÈîôËØØ", min_4_digits: "ÊúÄÂ∞ë 4 ‰ΩçÊï∞Â≠ó", cleared_success: "ËÆ∞ÂΩïÂ∑≤Ê∏ÖÈô§", action_failed: "Êìç‰ΩúÂ§±Ë¥•", error: "ÈîôËØØ",
            },
            ms: { // ·Äô·Äú·Ä±·Ä∏·Äõ·Äæ·Ä¨·Ä∏ (Malay)
                dine_in: "Makan Di Sini", takeaway: "Bawa Pulang", hero_title: "Lapar? üòã", hero_subtitle: "Pesanlah sesuatu yang enak!", table: "MEJA", loading: "Memuatkan Menu...", no_items: "Tiada barang tersedia.", total: "JUMLAH", view_order: "Lihat Pesanan", kitchen_display: "Paparan Dapur", kitchen_clear: "Dapur sudah sedia", exit: "Keluar", menu: "Menu", select_category: "Pilih Kategori", staff_access: "Akses Staf", staff_only: "Pengurusan Dapur Sahaja", login: "Log Masuk", cancel: "Batal", update_pin: "Kemas Kini PIN", save_pin: "Simpan PIN Baru", customize: "Sesuaikan Pesanan", add_to_order: "Tambah ke Pesanan", your_tray: "Dulang Anda", check_items: "Semak barang anda", total_amount: "Jumlah Amaun", confirm: "Sahkan", menu_manager: "Pengurus Menu", add_item: "Tambah Item", update_item: "Kemas Kini Item", cancel_edit: "Batal Suntingan", analytics: "Analitik", overview: "Gambaran Keseluruhan", history: "Sejarah", top_items: "Item Teratas", date: "Tarikh:", total_revenue: "Jumlah Hasil", total_orders: "Jumlah Pesanan", orders_selected: "Pesanan untuk Tempoh Dipilih", clear_all: "Padam Semua", time: "Masa", top_selected: "Item Teratas untuk Tempoh Dipilih", table_qr: "QR Meja", generate: "Jana", print_qr: "Cetak Kod QR", close: "Tutup", more: "Lebih Lanjut", hourly_sales: "Trend Jualan", category_sales: "Jualan Kategori", order_type: "Jenis Pesanan", sold_out: "HABIS DIJUAL", available: "Tersedia", pos_mode: "Mod POS", table_map: "Susun Atur Meja", select_table_msg: "Pilih meja untuk ambil pesanan", free: "Kosong", occupied: "Berisi", remarks: "Permintaan Khas", cancelled: "Dibatalkan", daily: "Harian", weekly: "Mingguan", monthly: "Bulanan", yearly: "Tahunan",
                Fried: "Goreng", Curry: "Kari", Soup: "Sup", Salad: "Salad", Rice: "Nasi", Noodle: "Mee", Dessert: "Pencuci Mulut", Drink: "Minuman", Other: "Lain-lain", All: "Semua", view_list: "Lihat Senarai", view_chart: "Lihat Carta", cancelled_orders: "Pesanan Dibatalkan", category_manager: "Pengurus Kategori", search_history_placeholder: "Cari dengan ID Pesanan/ID Meja (cth: #A12B atau T-1)",

                // NEW CONFIRMATION KEYS
                confirmation: "Pengesahan", admin_action: "Tindakan Admin Diperlukan", cancel_confirm: "Batal Pesanan?", remove_confirm: "Buang Item?", delete_confirm: "Padam Rekod?", delete_all_confirm: "Padam Semua Sejarah?", delete_category_confirm: "Padam Kategori?", delete_table_confirm: "Padam Meja?", pin_prompt: "Masukkan PIN", saved_pin_success: "PIN Baru Disimpan", wrong_pin: "PIN Salah", min_4_digits: "Min 4 digit diperlukan", cleared_success: "Sejarah Dikosongkan", action_failed: "Tindakan Gagal", error: "Ralat",
            }
        };

        // GLOBAL STATE
        let state = { 
            user: null, 
            tableId: 1, 
            products: [], 
            cart: [], 
            orders: [], 
            selectedProduct: null, 
            activeCategory: 'All', 
            editingProductId: null, 
            lang: localStorage.getItem('pingpos_lang') || 'en', // Initialize with stored or default
            chartInstance: null, 
            categoryChartInstance: null,
            orderTypeChartInstance: null,
            tableChartInstance: null,         
            isPOSMode: false,
            tables: [], 
            isLayoutEdit: false,
            dragItem: null,
            selectedTableId: null,
            orderType: 'dine_in',
            currentOverviewTab: 'sales',
            customCategories: [], // NEW: Stores categories loaded from Firestore
        }; 
        
        let isInitialLoad = true; 
        const defaultCategories = ["Fried", "Curry", "Soup", "Salad", "Rice", "Noodle", "Dessert", "Drink", "Other"];
        let categories = ["All", ...defaultCategories]; // Dynamic list
        
        // PAGE NAVIGATION LOGIC
        window.navigateTo = (screenId) => {
            // Hide all pages
            document.querySelectorAll('#app-container > div, .page-view').forEach(el => {
                if(!el.classList.contains('hide')) el.classList.add('hide');
            });
            
            // Show target page
            document.getElementById(screenId).classList.remove('hide');

            // Handle Nav Bar Visibility
            const nav = document.getElementById('main-nav');
            const custNav = document.getElementById('nav-customer-controls');
            const adminNav = document.getElementById('nav-admin-controls');

            if (screenId === 'screen-customer') {
                nav.classList.remove('hide');
                custNav.classList.remove('hide');
                adminNav.classList.add('hide');
                // Ensure audio alert stops if leaving kitchen
                window.stopIncomingOrderAlert();
            } else if (screenId === 'screen-kitchen') {
                nav.classList.remove('hide');
                custNav.classList.add('hide');
                adminNav.classList.remove('hide');
            } else {
                // Full pages like Analytics, Menu, Tables generally hide the main nav or keep admin nav
                // For simplicity, let's keep it visible but contextual
                nav.classList.add('hide'); // Hide main nav for full pages to give them space
            }

            if(screenId === 'screen-analytics') window.refreshReport();
            if(screenId === 'screen-tables') window.renderTableMap();
            if(screenId === 'screen-menu') window.renderMenuManager();
            if(screenId === 'screen-categories') window.renderCategoryManager(); // NEW
        };

        // Toggle Helpers
        // window.toggleChartData is replaced by toggleAnalyticsView
        window.toggleAnalyticsView = (type) => {
            const chartWrapper = document.getElementById(`${type}-chart-wrapper`);
            const listWrapper = document.getElementById(`${type}-list-wrapper`);
            const toggleBtnText = document.getElementById(`toggle-${type}-text`);

            if (chartWrapper.classList.contains('hide')) {
                // Currently showing list, switch to chart
                chartWrapper.classList.remove('hide');
                listWrapper.classList.add('hide');
                toggleBtnText.innerText = resources[state.lang]['view_list'] || 'View List';
            } else {
                // Currently showing chart, switch to list
                chartWrapper.classList.add('hide');
                listWrapper.classList.remove('hide');
                toggleBtnText.innerText = resources[state.lang]['view_chart'] || 'View Chart';
            }
        };

        window.setOverviewChart = (tab) => {
            state.currentOverviewTab = tab;
            ['sales', 'table', 'category', 'type'].forEach(t => {
                const btn = document.getElementById(`btn-ov-${t}`);
                if (t === tab) { btn.classList.remove('text-dark-muted'); btn.classList.add('bg-dark-700', 'text-white', 'shadow'); } 
                else { btn.classList.add('text-dark-muted'); btn.classList.remove('bg-dark-700', 'text-white', 'shadow'); }
                const view = document.getElementById(`overview-content-${t}`);
                if (t === tab) view.classList.remove('hide'); else view.classList.add('hide');
                
                // Reset to Chart view when switching tabs
                if (t === tab && t !== 'sales') {
                    const chartWrapper = document.getElementById(`${t}-chart-wrapper`);
                    const listWrapper = document.getElementById(`${t}-list-wrapper`);
                    const toggleBtnText = document.getElementById(`toggle-${t}-text`);
                    if(chartWrapper && listWrapper) {
                         chartWrapper.classList.remove('hide');
                         listWrapper.classList.add('hide');
                         if(toggleBtnText) toggleBtnText.innerText = resources[state.lang]['view_list'] || 'View List';
                    }
                }
            });
            window.renderReportOverview();
        };

        // FIX 2: Define startPOSMode globally
        window.startPOSMode = (tId) => {
            state.tableId = tId;
            state.isPOSMode = true;
            document.getElementById('display-table-id').innerText = tId;
            
            // Navigate to the ordering screen
            window.navigateTo('screen-customer'); 
            
            document.getElementById('pos-mode-header').classList.remove('hide');
            document.getElementById('nav-customer-controls').classList.add('hide'); 
            
            state.cart = [];
            updateCartUI();
        };


        async function init() {
            try {
                const result = await signInAnonymously(auth);
                state.user = result.user;
                
                // Load Tables
                const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config_tables', 'main_layout');
                const configSnap = await getDoc(configRef);
                if (configSnap.exists()) state.tables = configSnap.data().tables || [];
                else generateDefaultTables();
                
                // NEW: Load Categories
                const catRef = doc(db, 'artifacts', appId, 'public', 'data', 'config_categories', 'list');
                const catSnap = await getDoc(catRef);
                if (catSnap.exists()) {
                    state.customCategories = catSnap.data().list || defaultCategories;
                } else {
                    // Initialize with defaults if not exists
                    await setDoc(catRef, { list: defaultCategories, createdAt: serverTimestamp() }, { merge: true });
                    state.customCategories = defaultCategories;
                }
                categories = ["All", ...state.customCategories]; // Update global dynamic list
            } catch (error) { console.error("Init Error:", error); generateDefaultTables(); } 
            
            // state.lang initialized globally now
            const autoRet = localStorage.getItem('pingpos_auto_return');
            if(autoRet !== null) document.getElementById('chk-auto-return').checked = (autoRet === 'true');

            updateContent();
            
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('table')) state.tableId = urlParams.get('table');
            document.getElementById('display-table-id').innerText = state.tableId;
            
            setupListeners();
            window.navigateTo('screen-customer');
            renderCategoryBar();
            document.getElementById('rpt-date-input').valueAsDate = new Date();

            document.getElementById('chk-auto-return').addEventListener('change', (e) => localStorage.setItem('pingpos_auto_return', e.target.checked));

            const scrollContainer = document.getElementById('main-scroll-container');
            const scrollBtn = document.getElementById('scroll-top-btn');
            if(scrollContainer && scrollBtn) {
                scrollContainer.addEventListener('scroll', () => {
                    if (scrollContainer.scrollTop > 300) scrollBtn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
                    else scrollBtn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
                });
            }
        }

        function generateDefaultTables() {
            state.tables = [];
            for(let i=1; i<=12; i++) {
                const col = (i-1) % 4;
                const row = Math.floor((i-1) / 4);
                state.tables.push({ id: String(i), x: 10 + (col * 22), y: 10 + (row * 22), shape: 'round', size: 1 });
            }
        }

        window.scrollToTop = () => document.getElementById('main-scroll-container').scrollTo({ top: 0, behavior: 'smooth' });
        
        // UPDATED: Language cycling logic
        window.toggleLanguage = () => {
            const languages = ['en', 'my', 'cn', 'ms']; // English, Burmese, Chinese, Malay
            const currentIndex = languages.indexOf(state.lang);
            const nextIndex = (currentIndex + 1) % languages.length;
            state.lang = languages[nextIndex];
            localStorage.setItem('pingpos_lang', state.lang);
            updateContent();
            renderCategoryBar(); 
        };

        function updateContent() {
            document.getElementById('lang-display').innerText = state.lang.toUpperCase();
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (resources[state.lang] && resources[state.lang][key]) el.innerText = resources[state.lang][key];
            });
            // NEW: Handle placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (resources[state.lang] && resources[state.lang][key]) el.placeholder = resources[state.lang][key];
            });
        }

        // Custom Message and Confirmation System
        window.showMessage = (msg, type) => {
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const border = type === 'success' ? 'border-green-300' : 'border-red-300';
        
            const div = document.createElement('div');
            div.className = `fixed top-5 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-full shadow-xl z-[200] font-bold text-sm flex items-center gap-2 border ${border} animate-slide-up`;
            div.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;
        
            document.body.appendChild(div);
        
            if(type === 'success') window.playSingleBeep(); // Play sound for success/notification

            setTimeout(() => {
                div.style.transition = 'opacity 0.5s, transform 0.5s';
                div.style.opacity = '0';
                div.style.transform = 'translate(-50%, -20px)';
                setTimeout(() => div.remove(), 500);
            }, 3000);
        };
        
        window.showConfirm = (msgKey, callback, isPinRequired = false) => {
            const modal = document.getElementById('modal-confirm');
            const titleEl = document.getElementById('confirm-title');
            const msgEl = document.getElementById('confirm-message');
            const pinInput = document.getElementById('confirm-pin-input');
            const confirmBtn = document.getElementById('confirm-action-btn');

            // Set confirmation message
            msgEl.innerText = resources[state.lang][msgKey] || msgKey; 
            
            // Handle PIN visibility and title
            if (isPinRequired) {
                pinInput.classList.remove('hide');
                pinInput.placeholder = resources[state.lang]['pin_prompt'] || "Enter PIN";
                pinInput.value = '';
                titleEl.innerText = resources[state.lang]['admin_action'] || "Admin Action Required";
            } else {
                pinInput.classList.add('hide');
                titleEl.innerText = resources[state.lang]['confirmation'] || "Confirmation";
            }

            // Set confirmation button action
            confirmBtn.onclick = async () => {
                closeModal('modal-confirm');
                
                let proceed = true;
                if (isPinRequired) {
                    const enteredPin = pinInput.value;
                    const correctPin = localStorage.getItem('pingpos_admin_pin') || '1234';
                    if (enteredPin !== correctPin) {
                        window.showMessage(resources[state.lang]['wrong_pin'] || "Wrong PIN", 'error');
                        proceed = false;
                    }
                }

                if (proceed && callback) {
                    try {
                        await callback();
                    } catch (e) {
                        console.error("Confirmation callback failed:", e);
                        window.showMessage(resources[state.lang]['action_failed'] || "Action Failed", 'error');
                    }
                }
            };

            modal.classList.remove('hide');
        };

        function setupListeners() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (snapshot) => {
                state.products = [];
                snapshot.forEach(d => state.products.push({id: d.id, ...d.data()}));
                renderMenu(); renderMenuManager();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (snapshot) => {
                state.orders = [];
                snapshot.forEach(d => state.orders.push({id: d.id, ...d.data()}));
                state.orders.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                if (!isInitialLoad) {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            if(!document.getElementById('screen-kitchen').classList.contains('hide')) window.startIncomingOrderAlert();
                            else window.playSingleBeep();
                        }
                    });
                }
                isInitialLoad = false;
                renderAdminOrders();
            });
            
            // NEW: Category Listener
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config_categories', 'list'), (doc) => {
                if (doc.exists()) {
                    state.customCategories = doc.data().list || defaultCategories;
                    categories = ["All", ...state.customCategories];
                    renderCategoryBar(); 
                    renderMenuManager(); // Refresh category dropdown
                }
            });
        }
        
        function renderCategoryBar() {
            const container = document.getElementById('category-bar');
            const isMobile = window.innerWidth < 640; 
            if (isMobile) {
                const visibleCats = categories.slice(0, 3);
                let html = visibleCats.map(cat => generateCatBtnHTML(cat)).join('');
                const isHiddenActive = !visibleCats.includes(state.activeCategory);
                const moreBtnClass = isHiddenActive ? "cat-btn-active ring-2 ring-offset-2 ring-offset-dark-900 ring-primary" : "cat-btn-inactive";
                html += `<button onclick="openCategoryModal()" class="px-4 py-2 rounded-full text-[11px] font-bold whitespace-nowrap transition-all duration-300 ${moreBtnClass} flex items-center gap-1">${resources[state.lang]['more'] || 'More'} <i class="fas fa-chevron-down text-[10px]"></i></button>`;
                container.innerHTML = html;
            } else {
                container.innerHTML = categories.map(cat => generateCatBtnHTML(cat)).join('');
            }
        }

        function generateCatBtnHTML(cat) {
            const isActive = state.activeCategory === cat;
            const activeClass = isActive ? "cat-btn-active" : "cat-btn-inactive";
            // Use category name if translation exists, otherwise use category key itself
            const catName = resources[state.lang][cat] || cat; 
            return `<button onclick="window.filterCategory('${cat}')" class="px-5 py-2 rounded-full text-[11px] font-bold whitespace-nowrap transition-all duration-300 ${activeClass}">${catName}</button>`;
        }
        
        window.openCategoryModal = () => {
            const grid = document.getElementById('modal-cat-grid');
            grid.innerHTML = categories.map(cat => {
                const isActive = state.activeCategory === cat;
                const bgClass = isActive ? "bg-primary text-white border-primary shadow-lg shadow-primary/30" : "bg-dark-900 text-dark-muted border-dark-700 hover:border-gray-500 hover:text-white";
                const catName = resources[state.lang][cat] || cat; 
                return `<button onclick="selectCategoryFromModal('${cat}')" class="p-4 rounded-xl font-bold text-sm border ${bgClass} transition flex items-center justify-center">${catName}</button>`;
            }).join('');
            document.getElementById('modal-category').classList.remove('hide');
        }

        window.selectCategoryFromModal = (cat) => { window.filterCategory(cat); closeModal('modal-category'); }
        window.filterCategory = (cat) => { state.activeCategory = cat; renderCategoryBar(); renderMenu(); };

        function renderMenu() {
            const grid = document.getElementById('menu-grid');
            document.getElementById('menu-loading').classList.add('hide');
            grid.innerHTML = '';
            const filteredProducts = state.activeCategory === 'All' ? state.products : state.products.filter(p => p.category === state.activeCategory || (!p.category && state.activeCategory === 'Other'));
            if (filteredProducts.length === 0) return document.getElementById('empty-menu-msg').classList.remove('hide');
            document.getElementById('empty-menu-msg').classList.add('hide');

            filteredProducts.forEach(p => {
                const imgHtml = (p.image && p.image.startsWith('http')) ? `<img src="${p.image}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy">` : `<div class="w-full h-full flex items-center justify-center text-4xl text-dark-700"><i class="fas fa-utensils"></i></div>`;
                const isSoldOut = p.isSoldOut === true;
                const containerClass = isSoldOut ? "relative h-52 rounded-[24px] shadow-lg border border-dark-700/50 overflow-hidden bg-dark-800" : "relative h-52 rounded-[24px] shadow-lg border border-dark-700/50 cursor-pointer overflow-hidden group active:scale-[0.95] transition-all bg-dark-800";
                
                const el = document.createElement('div');
                el.className = containerClass;
                if(!isSoldOut) el.onclick = () => openProductModal(p.id);
                el.innerHTML = `
                    ${isSoldOut ? `<div class="absolute inset-0 z-20 flex items-center justify-center pointer-events-none"><span class="bg-red-600/90 text-white border-2 border-white font-black text-xl px-6 py-2 transform -rotate-12 shadow-2xl tracking-widest rounded-lg">${resources[state.lang]['sold_out'] || 'SOLD OUT'}</span></div>` : ""}
                    <div class="${isSoldOut ? 'sold-out-filter' : ''} w-full h-full">
                        <div class="absolute inset-0 w-full h-full">${imgHtml}</div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent opacity-90"></div>
                        <div class="absolute bottom-0 left-0 right-0 p-4 flex flex-col justify-end h-full pointer-events-none">
                            <div class="transform translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
                                <h3 class="font-bold text-white text-[15px] leading-tight mb-1 line-clamp-2 drop-shadow-md">${p.name}</h3>
                                <div class="flex justify-between items-center mt-1">
                                    <p class="text-primary font-extrabold text-sm drop-shadow-md">${p.price} Ks</p>
                                    <div class="w-8 h-8 rounded-full bg-white/20 backdrop-blur-md border border-white/10 flex items-center justify-center text-white hover:bg-primary hover:border-primary transition-colors shadow-lg"><i class="fas fa-plus text-xs"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            });
        }

        window.renderAdminOrders = () => {
            const grid = document.getElementById('orders-grid');
            grid.innerHTML = '';
            if(state.orders.length === 0) return document.getElementById('no-orders-msg').classList.remove('hidden');
            document.getElementById('no-orders-msg').classList.add('hidden');
            const activeOrders = state.orders.filter(o => o.status !== 'cancelled');
            if(activeOrders.length === 0) return document.getElementById('no-orders-msg').classList.remove('hidden');

            activeOrders.forEach(order => {
                let statusColor, btnHtml, stText;
                let cardClass = "bg-dark-800 rounded-2xl shadow-lg border border-dark-700 p-4 flex flex-col gap-3";
                if (order.status === 'pending') {
                    statusColor = "bg-yellow-900/20 text-yellow-400 border-yellow-900/50"; stText = "Pending";
                    if(soundState.isPlaying) cardClass += " ring-2 ring-primary animate-pulse";
                    btnHtml = `<button onclick="window.cancelKitchenOrder('${order.id}')" class="bg-red-900/20 text-red-500 border border-red-900/50 p-2 rounded-xl text-xs hover:bg-red-900/40 transition mr-2"><i class="fas fa-times"></i></button><button onclick="window.startOrder('${order.id}')" class="flex-1 bg-white text-dark-900 py-2 rounded-xl text-xs font-bold hover:bg-gray-200 transition">Start</button>`;
                } else if (order.status === 'cooking') {
                    statusColor = "bg-blue-900/20 text-blue-400 border-blue-900/50"; stText = "Cooking";
                    btnHtml = `<button onclick="window.updateStatus('${order.id}', 'served')" class="flex-1 bg-white text-dark-900 py-2 rounded-xl text-xs font-bold hover:bg-gray-200 transition">Serve</button>`;
                } else if (order.status === 'served') {
                    statusColor = "bg-gray-700/50 text-gray-400 border-gray-700"; stText = "Served";
                    btnHtml = `<button onclick="window.printTicket('${order.id}', 'customer')" class="flex-1 border border-dark-700 text-gray-300 py-2 rounded-xl text-xs font-bold hover:bg-dark-700 hover:text-white transition">Print</button>`;
                }
                const isTakeaway = order.orderType === 'takeaway';
                const typeBadge = isTakeaway ? `<span class="bg-purple-900/50 text-purple-300 border border-purple-500/30 px-2 py-0.5 rounded text-[10px] font-bold ml-2 animate-pulse"><i class="fas fa-shopping-bag mr-1"></i>TAKEAWAY</span>` : '';
                const div = document.createElement('div');
                div.className = cardClass;
                div.innerHTML = `<div class="flex justify-between items-center"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-dark-900 flex items-center justify-center font-bold text-white border border-dark-700 shadow-inner">${order.tableId}</div><span class="text-xs font-bold text-gray-400">#${order.id.slice(0,4)}</span></div><div class="flex items-center">${typeBadge}<span class="px-2 py-1 rounded-lg text-[10px] font-bold border ${statusColor} ml-2">${stText}</span></div></div><div class="flex-1 overflow-y-auto max-h-32 space-y-2 py-2 border-t border-b border-dark-700 custom-scroll">${order.items.map(i=>`<div class="flex flex-col text-xs"><div class="flex justify-between"><span class="font-bold text-white text-sm">${i.qty}x ${i.name} ${i.size ? `(${i.size})` : ''}</span></div><div class="pl-2">${i.modifiers && i.modifiers.length ? `<span class="text-[10px] text-gray-400 block">‚Ä¢ ${i.modifiers.join(', ')}</span>` : ''}${i.remarks ? `<span class="text-[10px] text-orange-400 font-bold block italic">" ${i.remarks} "</span>` : ''}</div></div>`).join('')}</div><div class="flex gap-2 items-center pt-1"><span class="font-bold text-base text-white">${order.totalPrice}</span><div class="flex-1 flex justify-end">${btnHtml}</div></div>`;
                grid.appendChild(div);
            });
        };

        window.startOrder = async (id) => { 
            window.stopIncomingOrderAlert(); // This immediately stops the sound
            try { 
                await updateDoc(doc(db,'artifacts',appId,'public','data','orders',id),{status: 'cooking'}); 
                window.printTicket(id, 'kitchen'); 
            } catch(e) { 
                console.error(e); 
            } 
        };
        
        // UPDATED: Use Custom Confirmation Modal
        window.cancelKitchenOrder = (id) => { 
            window.showConfirm('cancel_confirm', async () => {
                 window.stopIncomingOrderAlert(); 
                 try { 
                     await updateDoc(doc(db,'artifacts',appId,'public','data','orders',id),{status: 'cancelled'}); 
                     window.showMessage(resources[state.lang]['cleared_success'] || "Order Cancelled", 'success');
                 } catch(e) { 
                     console.error(e); 
                     window.showMessage(resources[state.lang]['action_failed'] || "Cancel Failed", 'error');
                 } 
            }, false); 
        };

        // ADDED: Function to update order status (used by Serve button)
        window.updateStatus = async (id, newStatus) => {
            try { 
                await updateDoc(doc(db,'artifacts',appId,'public','data','orders',id),{status: newStatus}); 
            } catch(e) { 
                console.error("Failed to update status:", e); 
            } 
        };
        
        function renderMenuManager() {
            document.getElementById('menu-table-body').innerHTML = state.products.map(p => {
                const isSoldOut = p.isSoldOut === true;
                return `<tr class="hover:bg-dark-700 border-b border-dark-700 transition">
                    <td class="p-3"><div class="font-bold text-white ${isSoldOut ? 'opacity-50 line-through decoration-red-500' : ''}">${p.name}</div><div class="text-[10px] text-dark-muted uppercase font-bold bg-dark-900 inline-block px-2 py-0.5 rounded border border-dark-700 mt-1">${p.category || 'N/A'}</div></td>
                    <td class="p-3 text-right flex items-center justify-end gap-2">
                        <button onclick="window.toggleStock('${p.id}', ${isSoldOut})" class="w-10 h-8 rounded-full border ${isSoldOut ? "bg-red-500/20 text-red-400 border-red-500/30" : "bg-green-500/20 text-green-400 border-green-500/30"} flex items-center justify-center"><i class="fas ${isSoldOut ? "fa-toggle-off" : "fa-toggle-on"} text-lg"></i></button>
                        <button onclick="window.editProduct('${p.id}')" class="text-white hover:bg-dark-600 bg-dark-700 w-8 h-8 rounded-full transition flex items-center justify-center"><i class="fas fa-pen text-xs"></i></button>
                        <button onclick="window.deleteProduct('${p.id}')" class="text-red-400 hover:text-white hover:bg-red-500/80 bg-red-900/20 w-8 h-8 rounded-full transition flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                    </td></tr>`;
            }).join('');
            
            // NEW: Update the category dropdown in Menu Manager
            const select = document.getElementById('new-prod-category');
            if (select) {
                 const options = state.customCategories.map(cat => `<option value="${cat}">${resources[state.lang][cat] || cat}</option>`).join('') + `<option value="Other">${resources[state.lang]['Other'] || 'Other'}</option>`;
                 select.innerHTML = options;
                 // Set the value to the current selection if editing
                 if (state.editingProductId) {
                     const p = state.products.find(x => x.id === state.editingProductId);
                     if (p) select.value = p.category || 'Other';
                 }
            }
            
            // NEW: If Category screen is open, refresh it.
            if (document.getElementById('screen-categories') && !document.getElementById('screen-categories').classList.contains('hide')) {
                window.renderCategoryManager();
            }
        }

        window.toggleStock = async (id, currentStatus) => { try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id), { isSoldOut: !currentStatus }); } catch(e) { console.error(e); } };

        window.editProduct = (id) => {
            const p = state.products.find(x => x.id === id); if (!p) return;
            state.editingProductId = id;
            document.getElementById('new-prod-name').value = p.name;
            document.getElementById('new-prod-price').value = p.price;
            document.getElementById('new-prod-img').value = (p.image === 'üçΩÔ∏è' || !p.image) ? '' : p.image;
            document.getElementById('new-prod-category').value = p.category || 'Other';
            document.getElementById('new-prod-options').value = p.options ? p.options.join(', ') : '';
            
            // Edit Sizes (Format: Name:Price, ...)
            let sizesStr = '';
            if(p.sizes && Array.isArray(p.sizes)) {
                sizesStr = p.sizes.map(s => `${s.name}:${s.price}`).join(', ');
            }
            document.getElementById('new-prod-sizes').value = sizesStr;

            const btn = document.getElementById('btn-save-prod');
            btn.innerText = resources[state.lang]['update_item'] || "Update Item"; // Use translation
            btn.classList.remove('bg-primary', 'hover:bg-red-600'); btn.classList.add('bg-green-600', 'hover:bg-green-500');
            document.getElementById('edit-controls').classList.remove('hide');
        };

        window.cancelEdit = () => {
            state.editingProductId = null;
            document.getElementById('new-prod-name').value = '';
            document.getElementById('new-prod-price').value = '';
            document.getElementById('new-prod-img').value = '';
            document.getElementById('new-prod-options').value = '';
            document.getElementById('new-prod-sizes').value = '';
            
            const btn = document.getElementById('btn-save-prod');
            btn.innerText = resources[state.lang]['add_item'] || "Add Item"; // Use translation
            btn.classList.add('bg-primary', 'hover:bg-red-600'); btn.classList.remove('bg-green-600', 'hover:bg-green-500');
            document.getElementById('edit-controls').classList.add('hide');
        };

        window.saveProduct = async () => {
            const n = document.getElementById('new-prod-name').value;
            const p = parseInt(document.getElementById('new-prod-price').value);
            const i = document.getElementById('new-prod-img').value;
            const o = document.getElementById('new-prod-options').value;
            const c = document.getElementById('new-prod-category').value;
            const sStr = document.getElementById('new-prod-sizes').value;
            
            if(!n || !p) return window.showMessage(resources[state.lang]['missing_name_price'] || "Missing Name or Price", 'error');
            
            // Parse Sizes
            let sizes = [];
            if(sStr && sStr.trim() !== '') {
                try {
                    sizes = sStr.split(',').map(item => {
                        const parts = item.split(':');
                        if(parts.length === 2) {
                            return { name: parts[0].trim(), price: parseInt(parts[1].trim()) };
                        }
                        return null;
                    }).filter(x => x !== null);
                } catch(e) { console.log("Size parse error", e); }
            }

            const data = { 
                name: n, 
                price: p, 
                image: i || 'üçΩÔ∏è', 
                options: o ? o.split(',').map(s=>s.trim()).filter(Boolean) : [], 
                category: c,
                sizes: sizes
            };

            try {
                if (state.editingProductId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', state.editingProductId), data);
                    window.cancelEdit(); 
                    window.showMessage(resources[state.lang]['saved'] || "Saved!", 'success');
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), data);
                    document.getElementById('new-prod-name').value=''; 
                    document.getElementById('new-prod-price').value=''; 
                    document.getElementById('new-prod-options').value='';
                    document.getElementById('new-prod-sizes').value='';
                    // FIX 1: Clear image URL field
                    document.getElementById('new-prod-img').value=''; 
                    window.showMessage(resources[state.lang]['saved'] || "Saved!", 'success');
                }
            } catch (e) { console.error(e); window.showMessage(resources[state.lang]['failed'] || "Failed", 'error'); }
        };

        // UPDATED: Use Custom Confirmation Modal
        window.deleteProduct = (id) => { 
            window.showConfirm('remove_confirm', async () => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id));
                window.showMessage(resources[state.lang]['removed'] || "Removed!", 'success');
            }, false); 
        };

        // Category Management Functions (NEW)
        window.renderCategoryManager = () => {
            const listContainer = document.getElementById('categories-list');
            listContainer.innerHTML = '';
            
            state.customCategories.forEach(cat => {
                const catName = resources[state.lang][cat] || cat;
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center p-3 bg-dark-800 rounded-xl border border-dark-700';
                el.innerHTML = `
                    <span class="font-bold text-white text-sm">${catName}</span>
                    <button onclick="deleteCategory('${cat}')" class="text-red-400 hover:text-white hover:bg-red-500/80 bg-red-900/20 w-8 h-8 rounded-full transition flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                `;
                listContainer.appendChild(el);
            });
        };
        
        window.saveCategory = async () => {
            const newCat = document.getElementById('new-cat-name').value.trim();
            if (!newCat) return window.showMessage(resources[state.lang]['cat_empty'] || "Category name cannot be empty.", 'error');
            if (state.customCategories.includes(newCat)) return window.showMessage(resources[state.lang]['cat_exists'] || "Category already exists.", 'error');
            
            const catRef = doc(db, 'artifacts', appId, 'public', 'data', 'config_categories', 'list');
            try {
                const newList = [...state.customCategories, newCat];
                await updateDoc(catRef, { list: newList, updatedAt: serverTimestamp() });
                document.getElementById('new-cat-name').value = '';
                window.showMessage(resources[state.lang]['saved'] || "Saved!", 'success');
                // The onSnapshot listener will update the state and UI automatically
            } catch(e) {
                console.error("Failed to add category:", e);
                window.showMessage(resources[state.lang]['failed'] || "Failed to add category.", 'error');
            }
        };

        // UPDATED: Use Custom Confirmation Modal with PIN
        window.deleteCategory = (catToDelete) => {
            if (catToDelete === 'All' || catToDelete === 'Other') return window.showMessage(resources[state.lang]['cannot_delete_default'] || "Cannot delete default categories.", 'error');

            window.showConfirm('delete_category_confirm', async () => {
                const catRef = doc(db, 'artifacts', appId, 'public', 'data', 'config_categories', 'list');
                try {
                    const newList = state.customCategories.filter(c => c !== catToDelete);
                    await updateDoc(catRef, { list: newList, updatedAt: serverTimestamp() });

                    // Update associated products to 'Other'
                    state.products.filter(p => p.category === catToDelete).forEach(async (p) => {
                         await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', p.id), { category: 'Other' });
                    });
                    
                    window.showMessage(resources[state.lang]['cleared_success'] || "Category deleted and items reassigned.", 'success');
                } catch(e) {
                    console.error("Failed to delete category:", e);
                    window.showMessage(resources[state.lang]['failed'] || "Failed to delete category.", 'error');
                }
            }, true); // Requires Admin PIN
        };

        // POS
        window.openProductModal = (id) => {
            const p = state.products.find(x => x.id === id); if(!p) return;
            state.selectedProduct = { ...p, qty: 1, selectedSize: null }; // Reset size
            
            // If sizes exist, set the first one as default
            if(p.sizes && p.sizes.length > 0) {
                state.selectedProduct.selectedSize = p.sizes[0];
                state.selectedProduct.price = p.sizes[0].price; // Override display price with first size
            }

            document.getElementById('mp-name').innerText = p.name;
            document.getElementById('mp-price-display').innerText = state.selectedProduct.price + ' Ks';
            document.getElementById('mp-qty').innerText = 1;
            document.getElementById('prod-remark').value = ''; 
            const img = document.getElementById('mp-img');
            img.src = (p.image && p.image.startsWith('http')) ? p.image : 'https://placehold.co/600x400/1F2937/9CA3AF?text='+(p.image||'Food');
            
            // OPTIONS
            const optionsContainer = document.getElementById('dynamic-options');
            optionsContainer.innerHTML = '';
            const opts = (p.options && p.options.length > 0) ? p.options : ["Normal Spicy", "Less Spicy", "No MSG"]; 
            opts.forEach(opt => {
                const div = document.createElement('div');
                div.innerHTML = `<label class="cursor-pointer block"><input type="checkbox" name="prod_option" value="${opt}" class="peer sr-only"><div class="border border-dark-700 peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary rounded-xl py-3 px-2 text-center text-[10px] font-bold transition-all h-full bg-dark-900 text-dark-muted hover:bg-dark-700">${opt}</div></label>`;
                optionsContainer.appendChild(div);
            });

            // SIZES RENDER
            const sizeContainer = document.getElementById('size-selection-container');
            const dynamicSizes = document.getElementById('dynamic-sizes');
            dynamicSizes.innerHTML = '';

            if (p.sizes && p.sizes.length > 0) {
                sizeContainer.classList.remove('hide');
                p.sizes.forEach((s, idx) => {
                    const isChecked = idx === 0 ? 'checked' : '';
                    const div = document.createElement('label');
                    div.className = "cursor-pointer";
                    div.innerHTML = `
                        <input type="radio" name="prod_size" value="${idx}" class="peer sr-only" ${isChecked} onchange="selectSize(${idx})">
                        <div class="border border-dark-700 bg-dark-900 text-white peer-checked:bg-primary peer-checked:border-primary peer-checked:text-white rounded-lg px-4 py-2 text-xs font-bold transition">
                            ${s.name} <span class="opacity-70 text-[10px]">(${s.price})</span>
                        </div>
                    `;
                    dynamicSizes.appendChild(div);
                });
            } else {
                sizeContainer.classList.add('hide');
            }

            document.getElementById('modal-product').classList.remove('hide');
        };

        window.selectSize = (idx) => {
            const p = state.products.find(x => x.id === state.selectedProduct.id);
            if(p && p.sizes && p.sizes[idx]) {
                state.selectedProduct.selectedSize = p.sizes[idx];
                state.selectedProduct.price = p.sizes[idx].price;
                document.getElementById('mp-price-display').innerText = state.selectedProduct.price + ' Ks';
            }
        };

        window.updateQty = (c) => { let q = state.selectedProduct.qty + c; if(q>=1) { state.selectedProduct.qty = q; document.getElementById('mp-qty').innerText = q; } };
        window.addToCart = () => {
            const checkboxes = document.querySelectorAll('input[name="prod_option"]:checked');
            const remark = document.getElementById('prod-remark').value.trim(); 
            
            // Construct cart item
            let name = state.selectedProduct.name;
            let sizeInfo = null;
            
            // If size was selected, use that price and name
            if(state.selectedProduct.selectedSize) {
                sizeInfo = state.selectedProduct.selectedSize.name;
            }

            state.cart.push({ 
                ...state.selectedProduct,
                name: name,
                size: sizeInfo,
                modifiers: Array.from(checkboxes).map(cb=>cb.value), 
                remarks: remark, 
                lineTotal: state.selectedProduct.price * state.selectedProduct.qty 
            });
            updateCartUI(); closeModal('modal-product');
        };

        function updateCartUI() {
            const c = state.cart.reduce((a,i)=>a+i.qty,0);
            document.getElementById('cart-count').innerText = c;
            document.getElementById('cart-total').innerText = state.cart.reduce((a,i)=>a+i.lineTotal,0) + " Ks";
            const bar = document.getElementById('cart-bar');
            if(c>0) bar.classList.remove('translate-y-[200%]'); else bar.classList.add('translate-y-[200%]');
        }
        
        window.setOrderType = (type) => {
            state.orderType = type;
            const btnDine = document.getElementById('btn-type-dine');
            const btnTake = document.getElementById('btn-type-take');
            if(type === 'dine_in') { btnDine.classList.remove('text-dark-muted', 'hover:text-white'); btnDine.classList.add('bg-primary', 'text-white', 'shadow-md'); btnTake.classList.add('text-dark-muted', 'hover:text-white'); btnTake.classList.remove('bg-purple-600', 'text-white', 'shadow-md'); } 
            else { btnDine.classList.add('text-dark-muted', 'hover:text-white'); btnDine.classList.remove('bg-primary', 'text-white', 'shadow-md'); btnTake.classList.remove('text-dark-muted', 'hover:text-white'); btnTake.classList.add('bg-purple-600', 'text-white', 'shadow-md'); }
        };

        window.openCheckoutModal = () => {
            if(state.cart.length===0) return;
            window.setOrderType('dine_in');
            document.getElementById('checkout-items').innerHTML = state.cart.map((item,i)=>`
                <div class="flex justify-between items-start bg-dark-800 p-3 rounded-2xl border border-dark-700 shadow-sm">
                    <div class="flex gap-3">
                        <div class="font-bold bg-dark-900 w-8 h-8 rounded-lg flex items-center justify-center text-white text-xs border border-dark-700">${item.qty}x</div>
                        <div>
                            <p class="font-bold text-sm text-white">${item.name} ${item.size ? `<span class="text-xs text-primary bg-primary/10 px-1 rounded ml-1">${item.size}</span>` : ''}</p>
                            <p class="text-[10px] text-dark-muted mt-0.5">${item.modifiers.join(', ')}</p>
                            ${item.remarks ? `<p class="text-[10px] text-orange-400 italic mt-0.5">"${item.remarks}"</p>` : ''}
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <span class="font-bold text-sm text-white">${item.lineTotal}</span>
                        <button onclick="window.removeFromCart(${i})" class="text-red-400 text-xs bg-red-900/20 px-2 py-1 rounded-md hover:bg-red-900/40 transition"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');
            document.getElementById('checkout-grand-total').innerText = state.cart.reduce((a,i)=>a+i.lineTotal,0) + " Ks";
            document.getElementById('modal-checkout').classList.remove('hide');
        };
        window.removeFromCart = (i) => { state.cart.splice(i,1); if(state.cart.length===0) closeModal('modal-checkout'); else window.openCheckoutModal(); updateCartUI(); };
        window.submitOrder = async () => {
            if(!state.user) return window.showMessage(resources[state.lang]['not_connected'] || "Not Connected", 'error');
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
                    tableId: state.tableId, items: state.cart, totalPrice: state.cart.reduce((a,i)=>a+i.lineTotal,0), status: 'pending', timestamp: serverTimestamp(), userId: state.user.uid, orderType: state.orderType 
                });
                state.cart=[]; updateCartUI(); closeModal('modal-checkout'); 
                const msg = resources[state.lang]['order_sent_success'] || 'Order Sent Successfully!';
                window.showMessage(msg, 'success');
                if (state.isPOSMode) { const autoReturn = document.getElementById('chk-auto-return').checked; if (autoReturn) setTimeout(() => exitPOSMode(), 1000); }
            } catch(e){ console.error(e); window.showMessage(resources[state.lang]['failed'] || "Failed", 'error'); }
        };

        window.openLoginModal = () => document.getElementById('modal-login').classList.remove('hide');
        window.verifyPin = () => {
            const p = document.getElementById('staff-pin').value;
            const c = localStorage.getItem('pingpos_admin_pin') || '1234';
            if(p === c) { 
                navigateTo('screen-kitchen'); 
                closeModal('modal-login'); 
                document.getElementById('staff-pin').value=''; 
                window.showMessage(resources[state.lang]['login_success'] || "Login Successful", 'success');
            } else {
                window.showMessage(resources[state.lang]['wrong_pin'] || "Wrong PIN", 'error');
            }
        };
        window.openChangePinModal=()=>document.getElementById('modal-change-pin').classList.remove('hide');
        window.saveNewPin=()=>{ 
            const n=document.getElementById('new-pin-input').value; 
            if(n.length>=4){ 
                localStorage.setItem('pingpos_admin_pin', n); 
                window.showMessage(resources[state.lang]['saved_pin_success'] || "New PIN Saved", 'success');
                closeModal('modal-change-pin'); 
            } else {
                window.showMessage(resources[state.lang]['min_4_digits'] || "Min 4 digits", 'error');
            }
        };
        
        window.closeModal=(id)=>document.getElementById(id).classList.add('hide');

        // Nav Actions
        window.exitPOSMode = () => { state.isPOSMode = false; state.tableId = "1"; document.getElementById('pos-mode-header').classList.add('hide'); navigateTo('screen-kitchen'); };
        
        // Modal / Full Page Openers
        window.openReportModal = () => navigateTo('screen-analytics');
        window.openMenuManager = () => navigateTo('screen-menu');
        window.openTableMap = () => navigateTo('screen-tables');
        window.openQRModal=()=>document.getElementById('modal-qr').classList.remove('hide');

        // --- ENHANCED REPORT LOGIC ---

        window.switchReportTab = (tab) => {
            document.getElementById('rpt-view-overview').classList.add('hide'); 
            document.getElementById('rpt-view-history').classList.add('hide'); 
            document.getElementById('rpt-view-top').classList.add('hide');
            // New view
            document.getElementById('rpt-view-cancelled').classList.add('hide'); 
            
            ['overview', 'history', 'cancelled', 'top'].forEach(t => { // Updated loop
                const el = document.getElementById(`tab-${t}`);
                if (el) {
                    if(t === tab) { el.classList.remove('text-dark-muted'); el.classList.add('bg-dark-700', 'text-white', 'shadow-sm'); } else { el.classList.add('text-dark-muted'); el.classList.remove('bg-dark-700', 'text-white', 'shadow-sm'); }
                }
            });
            document.getElementById(`rpt-view-${tab}`).classList.remove('hide');
            if(tab === 'overview') window.renderReportOverview();
            else if(tab === 'history') window.renderSalesHistory();
            else if(tab === 'cancelled') window.renderCancelledOrders(); // New call
            else window.renderTopSelling();
        };

        function isDateInRange(dateObj, range, selectedDate) {
            const d = new Date(dateObj); 
            const s = new Date(selectedDate); 
            
            d.setHours(0,0,0,0);
            const sMidnight = new Date(s);
            sMidnight.setHours(0,0,0,0);

            if (range === 'daily') {
                return d.getTime() === sMidnight.getTime();
            } 
            else if (range === 'weekly') {
                const day = sMidnight.getDay();
                const diff = sMidnight.getDate() - day + (day === 0 ? -6 : 1);
                const monday = new Date(sMidnight.setDate(diff));
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                return d >= monday && d <= sunday;
            }
            else if (range === 'monthly') {
                return d.getMonth() === s.getMonth() && d.getFullYear() === s.getFullYear();
            }
            else if (range === 'yearly') {
                return d.getFullYear() === s.getFullYear();
            }
            return false;
        }
        
        window.refreshReport = () => {
             if(!document.getElementById('rpt-view-overview').classList.contains('hide')) renderReportOverview();
             else if(!document.getElementById('rpt-view-history').classList.contains('hide')) renderSalesHistory();
             else if(!document.getElementById('rpt-view-cancelled').classList.contains('hide')) renderCancelledOrders();
             else renderTopSelling();
        };

        // --- CHART RENDERING HELPERS ---
        window.renderSalesChart = (labels, data) => {
            const ctx = document.getElementById('salesChart').getContext('2d');
            let gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, '#60A5FA'); gradient.addColorStop(1, '#2563EB');
            if (state.chartInstance) state.chartInstance.destroy();
            state.chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: resources[state.lang]['total_revenue'] + ' (Ks)', data: data, borderColor: '#3B82F6', backgroundColor: gradient, fill: true, tension: 0.4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: '#9CA3AF' } }, x: { grid: { display: false }, ticks: { color: '#9CA3AF', maxTicksLimit: 12 } } }, plugins: { legend: { display: false } } }
            });
        };

        window.renderTableChart = (labels, revenueData, countData) => {
            const ctx = document.getElementById('tableChart').getContext('2d');
            if (state.tableChartInstance) state.tableChartInstance.destroy();

            state.tableChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: resources[state.lang]['total_revenue'] + ' (Ks)',
                        data: revenueData,
                        backgroundColor: '#34D399',
                        borderRadius: 4,
                        order: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: '#9CA3AF' } },
                        x: { grid: { display: false }, ticks: { color: '#9CA3AF' } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += context.parsed.y.toLocaleString() + " Ks";
                                    return label;
                                },
                                afterLabel: function(context) {
                                    return `${resources[state.lang]['total_orders'] || 'Orders'}: ${countData[context.dataIndex]}`;
                                }
                            }
                        }
                    }
                }
            });
        };

        window.renderCategoryChart = (categories, data) => {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            if (state.categoryChartInstance) state.categoryChartInstance.destroy();
            
            // Translate labels for chart display
            const translatedLabels = categories.map(cat => resources[state.lang][cat] || cat);

            state.categoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: translatedLabels, datasets: [{ data: data, backgroundColor: ['#FF4757', '#34D399', '#FBBF24', '#60A5FA', '#A78BFA', '#F472B6', '#9CA3AF', '#EC4899', '#6366f1'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#9CA3AF', font: { size: 10 }, boxWidth: 10 } } }, cutout: '70%' }
            });
        };

        window.renderOrderTypeChart = (stats) => {
            const ctx = document.getElementById('orderTypeChart').getContext('2d');
            if (state.orderTypeChartInstance) state.orderTypeChartInstance.destroy();
            const dineInCount = state.orders.filter(o => o.orderType !== 'takeaway' && o.status !== 'cancelled').length;
            const takeawayCount = state.orders.filter(o => o.orderType === 'takeaway' && o.status !== 'cancelled').length;

            state.orderTypeChartInstance = new Chart(ctx, {
                type: 'pie',
                data: { 
                    labels: [resources[state.lang]['dine_in'], resources[state.lang]['takeaway']], 
                    datasets: [{ 
                        data: [stats.dine_in, stats.takeaway], 
                        backgroundColor: ['#3B82F6', '#A855F7'], 
                        borderWidth: 0 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'right', labels: { color: '#9CA3AF', font: { size: 10 }, boxWidth: 10 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    
                                    const revenue = context.parsed.toLocaleString();
                                    const count = context.label === resources[state.lang]['dine_in'] ? dineInCount : takeawayCount;
                                    
                                    return `${label} ${revenue} Ks (${count} ${resources[state.lang]['total_orders'] || 'orders'})`;
                                }
                            }
                        }
                    } 
                }
            });
        };

        // --- REPORT AGGREGATION AND RENDER ---
        window.renderReportOverview = () => {
            const dateInput = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            let c=0, t=0, cancelled=0;
            
            let chartLabels = [];
            let chartData = [];
            let categoryStats = {}; 
            let typeStats = { dine_in: 0, takeaway: 0 }; 
            
            let tableStats = {}; 
            
            if(range === 'daily') {
                chartLabels = Array.from({length: 24}, (_, i) => `${i}:00`);
                chartData = new Array(24).fill(0);
                document.getElementById('rpt-period-label').innerText = new Date(dateInput).toDateString();
            } else if (range === 'weekly') {
                chartLabels = [resources[state.lang]['Mon'] || 'Mon', resources[state.lang]['Tue'] || 'Tue', resources[state.lang]['Wed'] || 'Wed', resources[state.lang]['Thu'] || 'Thu', resources[state.lang]['Fri'] || 'Fri', resources[state.lang]['Sat'] || 'Sat', resources[state.lang]['Sun'] || 'Sun'];
                chartData = new Array(7).fill(0);
                document.getElementById('rpt-period-label').innerText = resources[state.lang]['selected_week'] || "Selected Week";
            } else if (range === 'monthly') {
                const daysInMonth = new Date(new Date(dateInput).getFullYear(), new Date(dateInput).getMonth() + 1, 0).getDate();
                chartLabels = Array.from({length: daysInMonth}, (_, i) => `${i+1}`);
                chartData = new Array(daysInMonth).fill(0);
                document.getElementById('rpt-period-label').innerText = new Date(dateInput).toLocaleDateString(state.lang==='cn'?'zh-CN':'en-US', {month: 'long', year: 'numeric'});
            } else if (range === 'yearly') {
                chartLabels = [resources[state.lang]['Jan'] || 'Jan', resources[state.lang]['Feb'] || 'Feb', resources[state.lang]['Mar'] || 'Mar', resources[state.lang]['Apr'] || 'Apr', resources[state.lang]['May'] || 'May', resources[state.lang]['Jun'] || 'Jun', resources[state.lang]['Jul'] || 'Jul', resources[state.lang]['Aug'] || 'Aug', resources[state.lang]['Sep'] || 'Sep', resources[state.lang]['Oct'] || 'Oct', resources[state.lang]['Nov'] || 'Nov', resources[state.lang]['Dec'] || 'Dec'];
                chartData = new Array(12).fill(0);
                document.getElementById('rpt-period-label').innerText = new Date(dateInput).getFullYear();
            }

            state.orders.forEach(o => { 
                if(o.timestamp) {
                    const dateObj = new Date(o.timestamp.seconds*1000);
                    
                    if (isDateInRange(dateObj, range, dateInput)) {
                        if (o.status === 'cancelled') {
                            cancelled++;
                        } else {
                            c++; 
                            t+=o.totalPrice;
                            
                            if(range === 'daily') chartData[dateObj.getHours()] += o.totalPrice;
                            else if (range === 'weekly') { const day = dateObj.getDay(); const index = day === 0 ? 6 : day - 1; chartData[index] += o.totalPrice; }
                            else if (range === 'monthly') chartData[dateObj.getDate() - 1] += o.totalPrice;
                            else if (range === 'yearly') chartData[dateObj.getMonth()] += o.totalPrice;

                            const tId = o.tableId || 'Unknown';
                            if(!tableStats[tId]) tableStats[tId] = { revenue: 0, count: 0 };
                            tableStats[tId].revenue += o.totalPrice;
                            tableStats[tId].count += 1;

                            if(o.items && Array.isArray(o.items)) {
                                o.items.forEach(item => {
                                    const cat = item.category || 'Other';
                                    categoryStats[cat] = (categoryStats[cat] || { qty: 0, revenue: 0 });
                                    categoryStats[cat].qty += item.qty;
                                    categoryStats[cat].revenue += item.lineTotal;
                                });
                            }
                            if(o.orderType === 'takeaway') typeStats.takeaway += o.totalPrice; else typeStats.dine_in += o.totalPrice;
                        }
                    }
                }
            });
            document.getElementById('rpt-ov-total').innerText = t.toLocaleString() + ' Ks'; // Show currency
            document.getElementById('rpt-ov-count').innerText = c;
            document.getElementById('rpt-ov-cancelled').innerText = cancelled;
            
            // Render the currently selected overview chart
            switch(state.currentOverviewTab) {
                case 'sales':
                    renderSalesChart(chartLabels, chartData);
                    break;
                case 'table':
                    const sortedTables = Object.entries(tableStats).sort((a,b) => b[1].revenue - a[1].revenue);
                    renderTableChart(sortedTables.map(x=>"T-"+x[0]), sortedTables.map(x=>x[1].revenue), sortedTables.map(x=>x[1].count));
                    
                    // Populate Table List (Now clickable)
                    const tableTbody = document.getElementById('table-data-tbody');
                    if(sortedTables.length > 0) {
                        tableTbody.innerHTML = sortedTables.map(([tId, stat], index) => {
                            const key = `T-${tId}`; // Key to pass to detail function
                            return `
                            <tr onclick="window.showDetailList('table', '${key}')" class="cursor-pointer hover:bg-dark-700 transition">
                                <td class="py-2 p-3 text-white font-bold flex items-center gap-2">${key}</td>
                                <td class="py-2 text-right p-3 text-dark-muted">${stat.count}</td>
                                <td class="py-2 text-right p-3 font-mono text-green-400 font-bold">${stat.revenue.toLocaleString()} Ks</td>
                            </tr>
                        `}).join('');
                    } else {
                        tableTbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-dark-700">No data</td></tr>';
                    }
                    break;
                case 'category':
                    const catLabels = Object.keys(categoryStats);
                    const catRevenue = catLabels.map(c => categoryStats[c].revenue);
                    renderCategoryChart(catLabels, catRevenue);
                    
                    // Populate Category List (Now clickable)
                    const catTbody = document.getElementById('cat-data-tbody');
                    if(catLabels.length > 0) {
                        catTbody.innerHTML = catLabels.map(cat => `
                            <tr onclick="window.showDetailList('category', '${cat}')" class="cursor-pointer hover:bg-dark-700 transition">
                                <td class="py-2 p-3 text-white font-bold">${resources[state.lang][cat] || cat}</td>
                                <td class="py-2 text-right p-3 text-dark-muted">${categoryStats[cat].qty}</td>
                                <td class="py-2 text-right p-3 font-mono text-green-400 font-bold">${categoryStats[cat].revenue.toLocaleString()} Ks</td>
                            </tr>
                        `).join('');
                    } else {
                        catTbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-dark-700">No data</td></tr>';
                    }
                    break;
                case 'type':
                    renderOrderTypeChart(typeStats);
                    
                    // Populate Order Type List (Now clickable)
                    const typeTbody = document.getElementById('type-data-tbody');
                    const typeData = [
                        { type: resources[state.lang]['dine_in'], key: 'dine_in', count: state.orders.filter(o => o.orderType !== 'takeaway' && o.status !== 'cancelled' && isDateInRange(new Date(o.timestamp.seconds*1000), range, dateInput)).length, revenue: typeStats.dine_in },
                        { type: resources[state.lang]['takeaway'], key: 'takeaway', count: state.orders.filter(o => o.orderType === 'takeaway' && o.status !== 'cancelled' && isDateInRange(new Date(o.timestamp.seconds*1000), range, dateInput)).length, revenue: typeStats.takeaway },
                    ];
                    
                    if(typeData.some(d => d.revenue > 0)) {
                        typeTbody.innerHTML = typeData.map(d => `
                            <tr onclick="window.showDetailList('type', '${d.key}')" class="cursor-pointer hover:bg-dark-700 transition">
                                <td class="py-2 p-3 text-white font-bold">${d.type}</td>
                                <td class="py-2 text-right p-3 text-dark-muted">${d.count}</td>
                                <td class="py-2 text-right p-3 font-mono text-green-400 font-bold">${d.revenue.toLocaleString()} Ks</td>
                            </tr>
                        `).join('');
                    } else {
                        typeTbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-dark-700">No data</td></tr>';
                    }
                    break;
            }
        };


        window.renderSalesHistory = () => {
            const dateInput = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            const search = document.getElementById('history-search-input').value.toLowerCase().trim(); // NEW: Get Search Query
            const b = document.getElementById('rpt-history-body'); b.innerHTML = '';
            
            // 1. Date and Search Filter
            const h = state.orders.filter(o => {
                if(!o.timestamp) return false;
                const d = new Date(o.timestamp.seconds*1000);
                
                // Filter by Date Range
                const isDateMatch = ['served','cooking','pending', 'cancelled'].includes(o.status) && isDateInRange(d, range, dateInput);

                // Filter by Search Query (if present)
                if (search && isDateMatch) {
                    const orderIdMatch = o.id.toLowerCase().includes(search.replace('#', ''));
                    const tableIdMatch = String(o.tableId).toLowerCase().includes(search.replace('t-', ''));
                    return orderIdMatch || tableIdMatch;
                }
                
                return isDateMatch;
            });

            if(h.length===0) { b.innerHTML='<tr><td colspan="4" class="p-8 text-center text-xs text-dark-700">No records found for this period</td></tr>'; return; }
            
            h.forEach(o => {
                const d = o.timestamp ? new Date(o.timestamp.seconds*1000) : new Date();
                let dateStr = d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                if(range !== 'daily') dateStr = `${d.getDate()}/${d.getMonth()+1} ${dateStr}`;

                const isTakeaway = o.orderType === 'takeaway';
                const typeIcon = isTakeaway ? '<i class="fas fa-shopping-bag text-purple-400" title="' + (resources[state.lang]['takeaway'] || 'Takeaway') + '"></i>' : '<i class="fas fa-utensils text-dark-muted" title="' + (resources[state.lang]['dine_in'] || 'Dine In') + '"></i>';
                let rowColor = isTakeaway ? 'bg-purple-900/10' : '';
                
                const isCancelled = o.status === 'cancelled';
                if (isCancelled) rowColor = 'bg-red-900/10 opacity-75';

                const itemsHtml = o.items.map(i => 
                    `<div class="flex justify-between text-xs py-1 border-b border-dark-700/50 last:border-0">
                        <span class="${isCancelled ? 'line-through' : ''}">${i.qty}x ${i.name} ${i.size ? `(${i.size})` : ''} <span class="text-[10px] text-dark-muted bg-dark-900 px-1 rounded ml-1 border border-dark-700">${resources[state.lang][i.category] || i.category || 'Other'}</span></span>
                        <span class="font-mono text-dark-muted">${i.lineTotal.toLocaleString()}</span>
                     </div>`
                ).join('');
                
                // Action to show in the main table row
                let mainRowAction;
                if (isCancelled) {
                    mainRowAction = `<span class="text-[10px] text-red-500 font-bold border border-red-500/50 px-1 rounded">${resources[state.lang]['cancel'].toUpperCase()}</span>`;
                } else if (o.status === 'served') {
                    mainRowAction = `<button onclick="event.stopPropagation(); window.printReceipt('${o.id}')" class="text-white hover:text-green-400 bg-green-500/20 px-2 py-1 rounded-lg text-xs font-bold transition"><i class="fas fa-receipt mr-1"></i> ${resources[state.lang]['print'] || 'Print'}</button>`;
                } else {
                    mainRowAction = `<span class="text-[10px] text-yellow-400 font-bold border border-yellow-500/50 px-1 rounded">${o.status.toUpperCase()}</span>`;
                }

                const mainRow = `
                    <tr onclick="toggleHistoryDetail('${o.id}')" class="cursor-pointer hover:bg-dark-700 transition border-b border-dark-700 last:border-0 group ${rowColor}">
                        <td class="p-3 text-xs text-white flex items-center gap-2">
                            <i class="fas fa-chevron-right text-[10px] text-dark-700 transition-transform group-hover:text-dark-muted" id="icon-${o.id}"></i>
                            ${dateStr}
                        </td>
                        <td class="p-3 font-bold text-white text-xs">
                            ${typeIcon} <span class="ml-1 ${isCancelled ? 'line-through decoration-red-500' : ''}">T-${o.tableId}</span>
                        </td>
                        <td class="p-3 font-bold ${isCancelled ? 'text-red-400 line-through' : 'text-primary'} text-right">${o.totalPrice.toLocaleString()}</td>
                        <td class="p-3 text-center">
                            ${mainRowAction}
                        </td>
                    </tr>
                `;

                const detailRow = `
                    <tr id="detail-${o.id}" class="hide bg-dark-900/50">
                        <td colspan="4" class="p-3 pl-8">
                            <div class="bg-dark-900 rounded-lg p-3 border border-dark-700 shadow-inner">
                                <h5 class="text-[10px] font-bold text-dark-muted uppercase mb-2 tracking-wider">${resources[state.lang]['order_items'] || 'Order Items'} ${isCancelled ? '(' + resources[state.lang]['cancel'].toUpperCase() + ')' : ''}</h5>
                                ${itemsHtml}
                                <div class="mt-3 pt-3 border-t border-dark-700 flex justify-between items-center">
                                    ${o.orderType === 'takeaway' ? '<div class="text-[10px] font-bold text-purple-400 uppercase tracking-widest">' + (resources[state.lang]['takeaway'] || 'Takeaway') + ' ' + (resources[state.lang]['order'] || 'Order') + '</div>' : '<div></div>'}
                                    ${!isCancelled ? `<button onclick="event.stopPropagation(); window.printReceipt('${o.id}')" class="text-green-500 hover:text-green-400 bg-green-500/10 px-3 py-1 rounded-lg text-xs font-bold transition"><i class="fas fa-receipt mr-1"></i> ${resources[state.lang]['print_receipt'] || 'Print Receipt'}</button>` : ''}
                                    <button onclick="event.stopPropagation(); deleteOrder('${o.id}')" class="text-red-500 hover:text-red-400 bg-red-500/10 px-3 py-1 rounded-lg text-xs font-bold transition ml-2"><i class="fas fa-trash text-xs"></i> ${resources[state.lang]['delete_order'] || 'Delete Order'}</button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;

                b.innerHTML += mainRow + detailRow;
            });
        };

        window.toggleHistoryDetail = (id) => {
            const row = document.getElementById(`detail-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            if(row.classList.contains('hide')) {
                row.classList.remove('hide');
                icon.style.transform = 'rotate(90deg)';
                icon.classList.add('text-primary');
            } else {
                row.classList.add('hide');
                icon.style.transform = 'rotate(0deg)';
                icon.classList.remove('text-primary');
            }
        };

        // NEW: Render Cancelled Orders List
        window.renderCancelledOrders = () => {
            const dateInput = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            const b = document.getElementById('rpt-cancelled-body'); b.innerHTML = '';
            
            const h = state.orders.filter(o => {
                if(!o.timestamp) return false;
                const d = new Date(o.timestamp.seconds*1000);
                return o.status === 'cancelled' && isDateInRange(d, range, dateInput);
            });

            if(h.length===0) { b.innerHTML='<tr><td colspan="4" class="p-8 text-center text-xs text-dark-700">No cancelled records found for this period</td></tr>'; return; }
            
            h.forEach(o => {
                const d = o.timestamp ? new Date(o.timestamp.seconds*1000) : new Date();
                let dateStr = d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                if(range !== 'daily') dateStr = `${d.getDate()}/${d.getMonth()+1} ${dateStr}`;

                const isTakeaway = o.orderType === 'takeaway';
                const typeIcon = isTakeaway ? '<i class="fas fa-shopping-bag text-purple-400" title="' + (resources[state.lang]['takeaway'] || 'Takeaway') + '"></i>' : '<i class="fas fa-utensils text-dark-muted" title="' + (resources[state.lang]['dine_in'] || 'Dine In') + '"></i>';
                
                const itemsHtml = o.items.map(i => 
                    `<div class="flex justify-between text-xs py-1 border-b border-dark-700/50 last:border-0">
                        <span class="line-through">${i.qty}x ${i.name} ${i.size ? `(${i.size})` : ''} <span class="text-[10px] text-dark-muted bg-dark-900 px-1 rounded ml-1 border border-dark-700">${resources[state.lang][i.category] || i.category || 'Other'}</span></span>
                        <span class="font-mono text-dark-muted">${i.lineTotal.toLocaleString()}</span>
                     </div>`
                ).join('');

                const mainRow = `
                    <tr onclick="toggleCancelledDetail('${o.id}')" class="cursor-pointer hover:bg-dark-700 transition border-b border-dark-700 last:border-0 group bg-red-900/10 opacity-80">
                        <td class="p-3 text-xs text-white flex items-center gap-2">
                            <i class="fas fa-chevron-right text-[10px] text-dark-700 transition-transform group-hover:text-dark-muted" id="icon-cancel-${o.id}"></i>
                            ${dateStr}
                        </td>
                        <td class="p-3 font-bold text-white text-xs">
                            ${typeIcon} <span class="ml-1 line-through decoration-red-500">T-${o.tableId}</span>
                        </td>
                        <td class="p-3 font-bold text-red-400 line-through text-right">${o.totalPrice.toLocaleString()}</td>
                        <td class="p-3 text-center">
                            <span class="text-[10px] text-red-500 font-bold border border-red-500/50 px-1 rounded">${resources[state.lang]['cancel'].toUpperCase()}</span>
                        </td>
                    </tr>
                `;

                const detailRow = `
                    <tr id="detail-cancel-${o.id}" class="hide bg-dark-900/50">
                        <td colspan="4" class="p-3 pl-8">
                            <div class="bg-dark-900 rounded-lg p-3 border border-dark-700 shadow-inner">
                                <h5 class="text-[10px] font-bold text-red-400 uppercase mb-2 tracking-wider">${resources[state.lang]['cancelled_items'] || 'CANCELLED ITEMS'}</h5>
                                ${itemsHtml}
                                ${o.orderType === 'takeaway' ? '<div class="mt-2 pt-2 border-t border-dark-700 text-[10px] font-bold text-purple-400 text-center uppercase tracking-widest">' + (resources[state.lang]['takeaway'] || 'Takeaway') + ' ' + (resources[state.lang]['order'] || 'Order') + '</div>' : ''}
                            </div>
                        </td>
                    </tr>
                `;

                b.innerHTML += mainRow + detailRow;
            });
        };

        window.toggleCancelledDetail = (id) => {
            const row = document.getElementById(`detail-cancel-${id}`);
            const icon = document.getElementById(`icon-cancel-${id}`);
            if(row.classList.contains('hide')) {
                row.classList.remove('hide');
                icon.style.transform = 'rotate(90deg)';
                icon.classList.add('text-red-400');
            } else {
                row.classList.add('hide');
                icon.style.transform = 'rotate(0deg)';
                icon.classList.remove('text-red-400');
            }
        };

        // NEW: Show Detail List function for Table/Category/Type drill-down
        window.showDetailList = (type, key) => {
            const modal = document.getElementById('modal-analytics-detail');
            const titleEl = document.getElementById('detail-modal-title');
            const contentEl = document.getElementById('detail-modal-content');
            contentEl.innerHTML = '<div class="flex justify-center py-10"><span class="loader"></span></div>';
            
            let orders = state.orders.filter(o => o.status !== 'cancelled' && o.timestamp);
            const dateInput = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            orders = orders.filter(o => isDateInRange(new Date(o.timestamp.seconds * 1000), range, dateInput));

            let titleText = `Details for ${key}`;
            let detailHtml = '';
            
            if (type === 'table') {
                const tableId = key.replace('T-', '');
                const tableOrders = orders.filter(o => String(o.tableId) === tableId);
                titleText = `${resources[state.lang]['orders_for'] || 'Orders for'} Table T-${tableId}`;
                
                detailHtml = tableOrders.map(o => {
                    const d = new Date(o.timestamp.seconds * 1000);
                    const timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    return `
                        <div class="bg-dark-800 p-3 rounded-xl border border-dark-700">
                            <div class="flex justify-between items-center mb-2 border-b border-dark-700/50 pb-2">
                                <span class="text-xs font-bold text-white">${resources[state.lang]['order'] || 'Order'} #${o.id.slice(0, 4)} (${timeStr})</span>
                                <span class="text-lg font-extrabold text-primary">${o.totalPrice.toLocaleString()} Ks</span>
                            </div>
                            <ul class="space-y-1 text-xs text-dark-muted">
                                ${o.items.map(item => 
                                    `<li class="flex justify-between">
                                        <span>${item.qty}x ${item.name} ${item.size ? `(${item.size})` : ''}</span>
                                        <span class="text-[10px] text-right bg-dark-900 px-1 rounded">${resources[state.lang][item.category] || item.category || 'Other'}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                    `;
                }).join('');

            } else if (type === 'category') {
                const category = key;
                titleText = `${resources[state.lang]['items_sold_in'] || 'Items Sold in'} ${resources[state.lang]['category'] || 'Category'}: ${resources[state.lang][category] || category}`;
                
                let itemAgg = {};
                orders.forEach(o => {
                    o.items.forEach(item => {
                        if ((item.category || 'Other') === category) {
                            const itemKey = item.name + (item.size ? ` (${item.size})` : '');
                            itemAgg[itemKey] = (itemAgg[itemKey] || { qty: 0, revenue: 0 });
                            itemAgg[itemKey].qty += item.qty;
                            itemAgg[itemKey].revenue += item.lineTotal;
                        }
                    });
                });

                const sortedItems = Object.entries(itemAgg).sort((a, b) => b[1].qty - a[1].qty);
                
                detailHtml = sortedItems.map(([name, data]) => `
                    <div class="flex justify-between items-center bg-dark-800 p-3 rounded-xl border border-dark-700">
                        <span class="text-sm font-bold text-white">${name}</span>
                        <div class="text-right">
                            <span class="text-xs font-bold text-dark-muted block">${data.qty} ${resources[state.lang]['sold'] || 'sold'}</span>
                            <span class="text-sm font-extrabold text-green-400">${data.revenue.toLocaleString()} Ks</span>
                        </div>
                    </div>
                `).join('');

            } else if (type === 'type') {
                const orderType = key; // Should be 'dine_in' or 'takeaway'
                titleText = `${resources[state.lang][key] || key} ${resources[state.lang]['orders'] || 'Orders'}`;
                
                const typeOrders = orders.filter(o => o.orderType === orderType || (orderType === 'dine_in' && o.orderType !== 'takeaway'));

                detailHtml = typeOrders.map(o => {
                    const d = new Date(o.timestamp.seconds * 1000);
                    const timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    return `
                        <div class="bg-dark-800 p-3 rounded-xl border border-dark-700">
                            <div class="flex justify-between items-center mb-2 border-b border-dark-700/50 pb-2">
                                <span class="text-xs font-bold text-white">${resources[state.lang]['order'] || 'Order'} #${o.id.slice(0, 4)} (${timeStr})</span>
                                <span class="text-lg font-extrabold text-primary">${o.totalPrice.toLocaleString()} Ks</span>
                            </div>
                            <ul class="space-y-1 text-xs text-dark-muted">
                                ${o.items.map(item => 
                                    `<li class="flex justify-between">
                                        <span>${item.qty}x ${item.name} ${item.size ? `(${item.size})` : ''}</span>
                                        <span class="text-[10px] text-right bg-dark-900 px-1 rounded">${resources[state.lang][item.category] || item.category || 'Other'}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                    `;
                }).join('');
            }

            if (detailHtml === '') detailHtml = `<p class="text-center text-dark-700 p-10">${resources[state.lang]['no_detailed_records'] || 'No detailed records found for this selection.'}</p>`;

            titleEl.innerText = titleText;
            contentEl.innerHTML = detailHtml;
            modal.classList.remove('hide');
        };


        window.renderTopSelling = () => {
            const dateInput = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            const c={}; 
            
            const filteredOrders = state.orders.filter(o => {
                 if(!o.timestamp) return false;
                 const d = new Date(o.timestamp.seconds*1000);
                 return o.status !== 'cancelled' && isDateInRange(d, range, dateInput);
            });

            filteredOrders.forEach(o=>{ 
                if(o.items) o.items.forEach(i=>{ 
                    const nameKey = i.name + (i.size ? ` (${i.size})` : '');
                    if(!c[nameKey]) c[nameKey] = { qty: 0, revenue: 0, category: i.category || 'Other' };
                    c[nameKey].qty += i.qty;
                    c[nameKey].revenue += i.lineTotal;
                }); 
            });
            
            const s = Object.entries(c).sort((a,b)=>b[1].qty - a[1].qty);
            const ct = document.getElementById('rpt-top-list'); ct.innerHTML='';
            
            if(s.length===0) ct.innerHTML='<p class="text-center text-dark-700 p-4 text-xs">' + (resources[state.lang]['no_sales_data'] || 'No sales data for this period') + '</p>';
            
            const maxVal = s.length > 0 ? s[0][1].qty : 1;
            
            s.forEach(([n, data], i) => { 
                const percent = (data.qty / maxVal) * 100;
                ct.innerHTML += `
                <div class="p-3 bg-dark-800 rounded-xl border border-dark-700 relative overflow-hidden group">
                    <div class="absolute top-0 left-0 bottom-0 bg-gradient-to-r from-primary/20 to-transparent transition-all duration-500" style="width: ${percent}%"></div>
                    <div class="relative flex justify-between items-center z-10">
                        <div class="flex gap-3 items-center">
                            <span class="font-bold text-primary w-5 text-sm">#${i+1}</span>
                            <div>
                                <p class="font-bold text-white text-sm flex items-center gap-2">
                                    ${n} 
                                    <span class="text-[9px] px-1.5 py-0.5 bg-dark-900 border border-dark-600 rounded text-dark-muted font-normal uppercase tracking-wide">${resources[state.lang][data.category] || data.category}</span>
                                </p>
                                <p class="text-[10px] text-dark-muted mt-0.5">${resources[state.lang]['revenue'] || 'Revenue'}: <span class="text-green-400 font-bold">${data.revenue.toLocaleString()} Ks</span></p>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-white bg-dark-900 px-2 py-1 rounded-lg border border-dark-600 shadow-sm">${data.qty} ${resources[state.lang]['sold'] || 'sold'}</span>
                    </div>
                </div>`; 
            });
        };

        // UPDATED: Use Custom Confirmation Modal
        window.deleteOrder = (id) => { 
            window.showConfirm('delete_confirm', async () => {
                await deleteDoc(doc(db,'artifacts',appId,'public','data','orders',id)); 
                window.showMessage(resources[state.lang]['cleared_success'] || "Record Deleted", 'success');
                renderSalesHistory(); 
            }, false);
        };
        
        // UPDATED: Use Custom Confirmation Modal with PIN
        window.clearAllHistory = () => { 
            window.showConfirm('delete_all_confirm', async () => {
                const ordersToDelete = state.orders.map(o => deleteDoc(doc(db,'artifacts',appId,'public','data','orders',o.id)));
                await Promise.all(ordersToDelete);
                window.showMessage(resources[state.lang]['cleared_success'] || "History Cleared", 'success');
                renderSalesHistory();
            }, true);
        };
        
        // ... QR & Print ...
        window.generateQR=()=>{ const t=document.getElementById('qr-table-num').value; document.getElementById('qr-container').innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.location.href.split('?')[0]+'?table='+t)}">`; };
        window.printQR=()=>{ const w=window.open('','','height=400,width=400'); w.document.write('<html><body style="text-align:center">'+document.getElementById('qr-container').innerHTML+'</body></html>'); w.document.close(); w.print(); };
        window.printTicket = (id, type) => {
            const o = state.orders.find(x => x.id === id); if(!o) return;
            
            document.getElementById('rcp-id').innerText = '#' + id.slice(0,4).toUpperCase();
            document.getElementById('rcp-table').innerText = o.tableId;
            // FIXED: Use state.lang directly for locale date string
            document.getElementById('rcp-date').innerText = new Date().toLocaleDateString(state.lang); 
            
            let headerExtra = "";
            if (o.orderType === 'takeaway') {
                headerExtra = "<br><span style='font-size: 1.2em; font-weight: 800; border: 2px solid black; padding: 2px 5px; display: inline-block; margin-top: 5px;'>[ " + (resources[state.lang]['takeaway'] || 'TAKEAWAY').toUpperCase() + " ]</span>";
            }

            if (type === 'kitchen') {
                document.getElementById('rcp-type').innerHTML = (resources[state.lang]['kitchen_ticket'] || "KITCHEN TICKET").toUpperCase() + headerExtra;
                document.getElementById('rcp-th-amt').classList.add('hide'); 
                document.getElementById('rcp-footer').classList.add('hide'); 
                
                document.getElementById('rcp-items').innerHTML = o.items.map(i => 
                    `<tr>
                        <td class="py-1 font-bold" colspan="2" style="font-size: 1.1em">${i.name} ${i.size ? `(${i.size})` : ''} x${i.qty}</td>
                     </tr>
                     ${i.modifiers.length ? `<tr><td colspan="2" class="text-[10px] text-gray-500 pb-2">(${i.modifiers.join(', ')})</td></tr>` : ''}
                     ${i.remarks ? `<tr><td colspan="2" class="text-xs font-bold italic pb-2">** ${i.remarks} **</td></tr>` : '<tr><td colspan="2" class="pb-2"></td></tr>'}`
                ).join('');
                
            } else {
                document.getElementById('rcp-type').innerHTML = (resources[state.lang]['receipt'] || "RECEIPT").toUpperCase() + headerExtra;
                document.getElementById('rcp-th-amt').classList.remove('hide');
                document.getElementById('rcp-footer').classList.remove('hide');
                document.getElementById('rcp-footer').querySelector('span:first-child').innerText = (resources[state.lang]['total'] || 'TOTAL').toUpperCase();
                document.getElementById('rcp-th-amt').innerText = (resources[state.lang]['amount'] || 'Amt').toUpperCase();
                document.getElementById('rcp-total').innerText = o.totalPrice.toLocaleString() + ' Ks';
                
                document.getElementById('rcp-items').innerHTML = o.items.map(i => 
                    `<tr>
                        <td class="py-1">${i.name} ${i.size ? `(${i.size})` : ''} x${i.qty}</td>
                        <td class="py-1 text-right">${i.lineTotal.toLocaleString()}</td>
                     </tr>
                     ${i.modifiers.length ? `<tr><td colspan="2" class="text-[10px] text-gray-500 pb-1">(${i.modifiers.join(', ')})</td></tr>` : ''}
                     ${i.remarks ? `<tr><td colspan="2" class="text-[10px] italic pb-1">Note: ${i.remarks}</td></tr>` : ''}`
                ).join('');
            }
            
            setTimeout(() => window.print(), 100);
        };
        
        window.printReceipt = (id) => window.printTicket(id, 'customer');

        // ... Map Logic ...
        const getOccupiedTables = () => { const busy = new Set(); state.orders.forEach(o => { if (o.status === 'pending' || o.status === 'cooking') busy.add(String(o.tableId)); }); return busy; };
        window.renderTableMap = () => {
             const busyTables = getOccupiedTables(); const container = document.getElementById('table-map-container'); container.innerHTML = '';
            if(!state.isLayoutEdit && state.selectedTableId) { state.selectedTableId = null; updatePropertiesPanel(); }
            state.tables.forEach(t => {
                const isBusy = busyTables.has(t.id); const isSelected = state.selectedTableId === t.id;
                const shapeClass = t.shape === 'rect' ? 'rounded-lg aspect-square' : 'rounded-full aspect-square';
                const colorClass = isBusy ? "bg-red-500 shadow-red-500/50" : "bg-green-500 shadow-green-500/50";
                let borderClass = "cursor-pointer hover:brightness-110"; if (state.isLayoutEdit) { borderClass = "cursor-move border-2 border-dashed border-white/30"; if(isSelected) borderClass = "selected cursor-move"; }
                const sizeScale = t.size || 1; const baseSize = 80; const sizePx = baseSize * sizeScale;
                const div = document.createElement('div'); div.className = `table-node flex flex-col items-center justify-center text-white font-bold shadow-lg ${shapeClass} ${colorClass} ${borderClass}`; div.style.left = t.x + '%'; div.style.top = t.y + '%'; div.style.width = sizePx + 'px'; div.style.height = sizePx + 'px'; div.style.fontSize = (16 * sizeScale) + 'px'; div.id = `table-${t.id}`;
                div.innerHTML = `<i class="fas ${t.shape==='rect'?'fa-square':'fa-circle'} mb-1 opacity-50 pointer-events-none" style="font-size: 1.2em"></i><span class="pointer-events-none">T-${t.id}</span>`;
                if (state.isLayoutEdit) { div.addEventListener('mousedown', (e) => startDrag(e, t.id)); div.addEventListener('touchstart', (e) => startDrag(e, t.id), {passive: false}); div.onclick = (e) => { e.stopPropagation(); selectTable(t.id); }; } 
                else { div.onclick = () => window.startPOSMode(t.id); }
                container.appendChild(div);
            });
            updatePropertiesPanel();
        };

        // ... Drag & Drop, Layout Editing ...
        window.selectTable=(id)=>{ if(!state.isLayoutEdit) return; state.selectedTableId = id; renderTableMap(); };
        window.deselectTable=()=>{ if(state.selectedTableId) { state.selectedTableId = null; renderTableMap(); } };
        window.updatePropertiesPanel=()=>{ const panel = document.getElementById('table-properties'); const legend = document.getElementById('map-legend'); if (state.isLayoutEdit && state.selectedTableId) { legend.classList.add('hide'); panel.classList.remove('hide'); const t = state.tables.find(x => x.id === state.selectedTableId); if(t) { document.getElementById('prop-id').innerText = "T-" + t.id; document.getElementById('prop-size').value = t.size || 1; } } else { legend.classList.remove('hide'); panel.classList.add('hide'); } };
        window.updateTableProperty=(key, val)=>{ if(!state.selectedTableId) return; const t = state.tables.find(x => x.id === state.selectedTableId); if(t) { t[key] = (key === 'size') ? parseFloat(val) : val; renderTableMap(); } };
        
        // UPDATED: Use Custom Confirmation Modal with PIN
        window.deleteSelectedTable = () => { 
            if(!state.selectedTableId) return;
            window.showConfirm('delete_table_confirm', async () => {
                state.tables = state.tables.filter(t => t.id !== state.selectedTableId); 
                state.selectedTableId = null; 
                renderTableMap();
                window.showMessage(resources[state.lang]['removed'] || "Table Deleted", 'success');
            }, true); // Requires Admin PIN
        };

        window.startDrag=(e, tId)=>{ /* ... existing drag logic ... */ };
        window.toggleLayoutEdit = () => { state.isLayoutEdit = !state.isLayoutEdit; const btn = document.getElementById('btn-edit-layout'); const controls = document.getElementById('layout-edit-controls'); state.selectedTableId = null; if(state.isLayoutEdit) { btn.classList.add('bg-dark-700', 'text-white'); controls.classList.remove('hide'); document.getElementById('table-map-subtitle').innerText = (resources[state.lang]['select_table_to_edit'] || "Select table to edit properties."); } else { btn.classList.remove('bg-dark-700', 'text-white'); controls.classList.add('hide'); document.getElementById('table-map-subtitle').innerText = (resources[state.lang]['select_table_msg'] || "Select a table to take order"); } renderTableMap(); };
        window.addNewTable=()=>{ const maxId = state.tables.reduce((max, t) => Math.max(max, parseInt(t.id) || 0), 0); const newId = String(maxId + 1); const shapeSelect = document.getElementById('new-table-shape'); state.tables.push({ id: newId, x: 45, y: 45, shape: shapeSelect ? shapeSelect.value : 'round', size: 1 }); renderTableMap(); state.selectedTableId = newId; renderTableMap(); };
        window.saveLayout=async()=>{ const btn = document.getElementById('btn-save-layout'); btn.innerHTML='Saving...'; try { const cleanTables = state.tables.map(t => ({ id: String(t.id), x: Number(t.x) || 0, y: Number(t.y) || 0, shape: t.shape || 'round', size: Number(t.size) || 1 })); await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config_tables', 'main_layout'), { tables: cleanTables, updatedAt: serverTimestamp() }); window.showMessage(resources[state.lang]['saved'] || "Saved!", 'success'); if(state.isLayoutEdit) window.toggleLayoutEdit(); } catch(e) { console.error(e); window.showMessage(resources[state.lang]['error'] || "Error", 'error'); } finally { btn.innerHTML='Save'; } };

        // Re-inject drag logic shortened for brevity in display but functional
        window.startDrag = (e, tId) => {
            if(!state.isLayoutEdit) return; e.preventDefault();
            if(state.selectedTableId !== tId) { state.selectedTableId = tId; renderTableMap(); }
            const table = state.tables.find(t => t.id === tId); const el = document.getElementById(`table-${tId}`); const container = document.getElementById('table-map-container');
            const startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; const startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            const rect = el.getBoundingClientRect(); const containerRect = container.getBoundingClientRect();
            const offsetX = startX - rect.left; const offsetY = startY - rect.top;
            state.dragItem = { tId, offsetX, offsetY, containerRect };
            const moveHandler = (moveEvent) => {
                const clientX = moveEvent.type.includes('mouse') ? moveEvent.clientX : moveEvent.touches[0].clientX; const clientY = moveEvent.type.includes('mouse') ? moveEvent.clientY : moveEvent.touches[0].clientY;
                let newLeft = clientX - state.dragItem.containerRect.left - state.dragItem.offsetX; let newTop = clientY - state.dragItem.containerRect.top - state.dragItem.offsetY;
                let percentX = (newLeft / state.dragItem.containerRect.width) * 100; let percentY = (newTop / state.dragItem.containerRect.height) * 100;
                percentX = Math.max(0, Math.min(90, percentX)); percentY = Math.max(0, Math.min(90, percentY));
                el.style.left = percentX + '%'; el.style.top = percentY + '%'; table.x = percentX; table.y = percentY;
            };
            const upHandler = () => { document.removeEventListener('mousemove', moveHandler); document.removeEventListener('mouseup', upHandler); document.removeEventListener('touchmove', moveHandler); document.removeEventListener('touchend', upHandler); state.dragItem = null; };
            document.addEventListener('mousemove', moveHandler); document.addEventListener('mouseup', upHandler); document.addEventListener('touchmove', moveHandler, {passive: false}); document.addEventListener('touchend', upHandler);
        };

        // Adding global error/success messages used by logic but not defined in translations yet
        if (!resources.en.missing_name_price) resources.en.missing_name_price = "Missing Name or Price";
        if (!resources.en.failed) resources.en.failed = "Failed";
        if (!resources.en.remove) resources.en.remove = "Remove?";
        if (!resources.en.removed) resources.en.removed = "Removed!"; // NEW
        if (!resources.en.cat_empty) resources.en.cat_empty = "Category name cannot be empty.";
        if (!resources.en.cat_exists) resources.en.cat_exists = "Category already exists.";
        if (!resources.en.not_connected) resources.en.not_connected = "Not Connected";
        if (!resources.en.order_sent_success) resources.en.order_sent_success = "Order Sent Successfully!";
        if (!resources.en.wrong_pin) resources.en.wrong_pin = "Wrong PIN";
        if (!resources.en.saved) resources.en.saved = "Saved";
        if (!resources.en.min_4_digits) resources.en.min_4_digits = "Min 4 digits required";
        if (!resources.en.print) resources.en.print = "Print";
        if (!resources.en.print_receipt) resources.en.print_receipt = "Print Receipt";
        if (!resources.en.delete_order) resources.en.delete_order = "Delete Order";
        if (!resources.en.delete_confirm) resources.en.delete_confirm = "Delete Record?";
        if (!resources.en.delete_all_confirm) resources.en.delete_all_confirm = "Delete All History?";
        if (!resources.en.pin_prompt) resources.en.pin_prompt = "Enter PIN";
        if (!resources.en.cleared) resources.en.cleared = "Cleared";
        if (!resources.en.kitchen_ticket) resources.en.kitchen_ticket = "Kitchen Ticket";
        if (!resources.en.receipt) resources.en.receipt = "Receipt";
        if (!resources.en.amount) resources.en.amount = "Amt";
        if (!resources.en.order_items) resources.en.order_items = "Order Items";
        if (!resources.en.order) resources.en.order = "Order";
        if (!resources.en.cancelled_items) resources.en.cancelled_items = "Cancelled Items";
        if (!resources.en.items_sold_in) resources.en.items_sold_in = "Items Sold In";
        if (!resources.en.category) resources.en.category = "Category";
        if (!resources.en.sold) resources.en.sold = "sold";
        if (!resources.en.revenue) resources.en.revenue = "Revenue";
        if (!resources.en.no_sales_data) resources.en.no_sales_data = "No sales data for this period";
        if (!resources.en.delete_table_confirm) resources.en.delete_table_confirm = "Delete Table?";
        if (!resources.en.error) resources.en.error = "Error";
        if (!resources.en.no_detailed_records) resources.en.no_detailed_records = "No detailed records found for this selection.";
        if (!resources.en.orders_for) resources.en.orders_for = "Orders for";
        if (!resources.en.select_table_to_edit) resources.en.select_table_to_edit = "Select table to edit properties.";
        if (!resources.en.selected_week) resources.en.selected_week = "Selected Week";
        if (!resources.en.cleared_success) resources.en.cleared_success = "Success!";
        if (!resources.en.action_failed) resources.en.action_failed = "Action Failed";
        if (!resources.en.login_success) resources.en.login_success = "Login Successful";
        if (!resources.en.saved_pin_success) resources.en.saved_pin_success = "New PIN Saved";
        if (!resources.en.cannot_delete_default) resources.en.cannot_delete_default = "Cannot delete default categories.";


        // Adding my translations for the new keys
        if (!resources.my.missing_name_price) resources.my.missing_name_price = "·Ä°·Äô·Ää·Ä∫ ·Äû·Ä≠·ÄØ·Ä∑·Äô·Äü·ÄØ·Äê·Ä∫ ·Äà·Ä±·Ä∏·Äî·Äæ·ÄØ·Äî·Ä∫·Ä∏ ·Äô·Äï·Äº·Ää·Ä∑·Ä∫·ÄÖ·ÄØ·Ä∂·Äï·Ä´·Åã";
        if (!resources.my.failed) resources.my.failed = "·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´";
        if (!resources.my.remove) resources.my.remove = "·Äñ·Äö·Ä∫·Äõ·Äæ·Ä¨·Ä∏·Äô·Äú·Ä¨·Ä∏?";
        if (!resources.my.removed) resources.my.removed = "·Äñ·Äö·Ä∫·Äõ·Äæ·Ä¨·Ä∏·Äï·Äº·ÄÆ·Ä∏";
        if (!resources.my.cat_empty) resources.my.cat_empty = "·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏·Ä°·Äô·Ää·Ä∫ ·Äë·Ää·Ä∑·Ä∫·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·Äï·Ä´·Åã";
        if (!resources.my.cat_exists) resources.my.cat_exists = "·Ä§·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏ ·Äõ·Äæ·Ä≠·Äï·Äº·ÄÆ·Ä∏·Äû·Ä¨·Ä∏·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫·Åã";
        if (!resources.my.not_connected) resources.my.not_connected = "·ÄÅ·Äª·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫·Äô·Äë·Ä¨·Ä∏·Äï·Ä´";
        if (!resources.my.order_sent_success) resources.my.order_sent_success = "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·ÄÖ·ÄΩ·Ä¨ ·Äï·Ä±·Ä∏·Äï·Ä≠·ÄØ·Ä∑·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ!";
        if (!resources.my.wrong_pin) resources.my.wrong_pin = "PIN ·Äî·Ä∂·Äï·Ä´·Äê·Ä∫ ·Äô·Äæ·Ä¨·Ä∏·Äö·ÄΩ·ÄÑ·Ä∫·Ä∏";
        if (!resources.my.saved) resources.my.saved = "·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ";
        if (!resources.my.min_4_digits) resources.my.min_4_digits = "·Ä°·Äî·Ää·Ä∫·Ä∏·ÄÜ·ÄØ·Ä∂·Ä∏ ·ÄÇ·Äè·Äî·Ä∫·Ä∏ ·ÅÑ ·Äú·ÄØ·Ä∂·Ä∏ ·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫·Äû·Ää·Ä∫";
        if (!resources.my.print) resources.my.print = "·Äï·ÄØ·Ä∂·Äî·Äæ·Ä≠·Äï·Ä∫·Äõ·Äî·Ä∫";
        if (!resources.my.print_receipt) resources.my.print_receipt = "·ÄÑ·ÄΩ·Ä±·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÅ·Ä∂·Äú·ÄΩ·Äæ·Ä¨ ·Äï·ÄØ·Ä∂·Äî·Äæ·Ä≠·Äï·Ä∫·Äô·Ää·Ä∫";
        if (!resources.my.delete_order) resources.my.delete_order = "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Ää·Ä∫";
        if (!resources.my.delete_confirm) resources.my.delete_confirm = "·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äú·Ä¨·Ä∏?";
        if (!resources.my.delete_all_confirm) resources.my.delete_all_confirm = "·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äú·Ä¨·Ä∏?";
        if (!resources.my.pin_prompt) resources.my.pin_prompt = "PIN ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´";
        if (!resources.my.cleared) resources.my.cleared = "·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ";
        if (!resources.my.kitchen_ticket) resources.my.kitchen_ticket = "·Äô·ÄÆ·Ä∏·Äñ·Ä≠·ÄØ·ÄÅ·Äª·Ä±·Ä¨·ÄÑ·Ä∫ ·Äú·ÄÄ·Ä∫·Äô·Äæ·Äê·Ä∫";
        if (!resources.my.receipt) resources.my.receipt = "·ÄÑ·ÄΩ·Ä±·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÅ·Ä∂·Äú·ÄΩ·Äæ·Ä¨";
        if (!resources.my.amount) resources.my.amount = "·Äï·Äô·Ä¨·Äè";
        if (!resources.my.order_items) resources.my.order_items = "·Äô·Äæ·Ä¨·Äö·Ä∞·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨ ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏";
        if (!resources.my.order) resources.my.order = "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ";
        if (!resources.my.cancelled_items) resources.my.cancelled_items = "·Äñ·Äª·ÄÄ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏ ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏";
        if (!resources.my.items_sold_in) resources.my.items_sold_in = "·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·Äû·Ää·Ä∑·Ä∫ ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏";
        if (!resources.my.category) resources.my.category = "·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏";
        if (!resources.my.sold) resources.my.sold = "·ÄÅ·ÄØ ·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ";
        if (!resources.my.revenue) resources.my.revenue = "·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±";
        if (!resources.my.no_sales_data) resources.my.no_sales_data = "·Ä§·ÄÄ·Ä¨·Äú·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Ä°·Ä¨·Ä∏·Äí·Ä±·Äê·Ä¨ ·Äô·Äõ·Äæ·Ä≠·Äï·Ä´·Åã";
        if (!resources.my.delete_table_confirm) resources.my.delete_table_confirm = "·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äú·Ä¨·Ä∏?";
        if (!resources.my.error) resources.my.error = "·Ä°·Äô·Äæ·Ä¨·Ä∏";
        if (!resources.my.no_detailed_records) resources.my.no_detailed_records = "·Ä°·Äû·Ä±·Ä∏·ÄÖ·Ä≠·Äê·Ä∫ ·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·Äô·Äê·ÄΩ·Ä±·Ä∑·Äõ·Äï·Ä´·Åã";
        if (!resources.my.orders_for) resources.my.orders_for = "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏";
        if (!resources.my.select_table_to_edit) resources.my.select_table_to_edit = "·Äï·Äº·ÄÑ·Ä∫·Äõ·Äî·Ä∫ ·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤ ·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´·Åã";
        if (!resources.my.selected_week) resources.my.selected_week = "·Äõ·ÄΩ·Ä±·Ä∏·ÄÅ·Äª·Äö·Ä∫·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨ ·Ä°·Äï·Äê·Ä∫";
        if (!resources.my.cleared_success) resources.my.cleared_success = "·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äû·Ää·Ä∫!";
        if (!resources.my.action_failed) resources.my.action_failed = "·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫ ·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´";
        if (!resources.my.login_success) resources.my.login_success = "Login ·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫";
        if (!resources.my.saved_pin_success) resources.my.saved_pin_success = "PIN ·Ä°·Äû·ÄÖ·Ä∫ ·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏";
        if (!resources.my.cannot_delete_default) resources.my.cannot_delete_default = "·Äï·ÄØ·Ä∂·Äû·Ä± ·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏·Äô·Äª·Ä¨·Ä∏ ·Äñ·Äª·ÄÄ·Ä∫·Åç ·Äô·Äõ·Äï·Ä´";


        init();
    </script>
</body>
</html>
