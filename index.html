<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ping-Restaurant</title>
    <link rel="icon" type="image/png" href="https://ui-avatars.com/api/?name=P&background=FF4757&color=fff">


    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&family=Padauk:wght@400;700&display=swap"
        rel="stylesheet">


    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'Padauk', 'sans-serif'],
                    },
                    colors: {
                        primary: '#FF4757',  // Lucky Red
                        accent: '#34D399',   // Emerald 400
                        dark: {
                            900: '#111827',
                            800: '#1F2937',
                            700: '#374151',
                            text: '#F9FAFB',
                            muted: '#9CA3AF'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* ·ÅÅ·Åã HTML ·Äî·Ä≤·Ä∑ Body ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·Äú·ÄØ·Ä∂·Ä∏·ÄÄ·Ä≠·ÄØ Reload ·Äô·Äñ·Äº·ÄÖ·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·Äï·Ä≠·Äê·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äê·Ä¨·Äï·Ä´ */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* ·ÄÖ·Ä¨·Äô·Äª·ÄÄ·Ä∫·Äî·Äæ·Ä¨·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·Äú·ÄØ·Ä∂·Ä∏ ·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äô·Äú·Äæ·ÄØ·Äï·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·Äï·Ä≠·Äê·Ä∫·Äë·Ä¨·Ä∏·Äô·Äö·Ä∫ */
            overscroll-behavior-y: none;
            /* ·Ä°·Äï·Ä±·Ä´·Ä∫·ÄÄ·Äî·Ä± ·ÄÜ·ÄΩ·Ä≤·ÄÅ·Äª·Äõ·ÄÑ·Ä∫ reload ·Äñ·Äº·ÄÖ·Ä∫·Äê·Ä¨·ÄÄ·Ä≠·ÄØ ·Äú·ÄØ·Ä∂·Ä∏·Äù·Äï·Ä≠·Äê·Ä∫·Äê·Ä≤·Ä∑ ·ÄÄ·ÄØ·Äí·Ä∫·Äï·Ä´ */
        }

        body {
            font-family: 'Inter', 'Noto Sans SC', 'Padauk', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #111827;
            color: #F9FAFB;
            display: flex;
            flex-direction: column;
        }

        /* ·ÅÇ·Åã ·Äô·ÄÆ·Äî·Ä∞·Ä∏·Äê·ÄΩ·Ä±·Åä ·Ä°·Ä±·Ä¨·Ä∫·Äí·Ä´·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äê·ÄΩ·Ä± scroll ·ÄÜ·ÄΩ·Ä≤·Äõ·Äô·Äö·Ä∑·Ä∫ ·Äî·Ä±·Äõ·Ä¨·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ·Äï·Ä≤ scroll ·Äï·Äº·Äî·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äï·Ä±·Ä∏·Äê·Ä¨·Äï·Ä´ */
        #main-scroll-container,
        .page-view,
        .overflow-y-auto {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            /* iPhone/iPad ·Äô·Äæ·Ä¨ scroll ·ÄÅ·Äª·Ä±·Ä¨·Äô·ÄΩ·Ä±·Ä∑·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ */
            overscroll-behavior-y: contain;
            /* ·Ä°·Äê·ÄΩ·ÄÑ·Ä∫·Ä∏·Äë·Ä≤·Äô·Äæ·Ä¨·Äï·Ä≤ scroll ·Äñ·Äº·ÄÖ·Ä∫·ÄÖ·Ä±·Äï·Äº·ÄÆ·Ä∏ ·Ä°·Äï·Äº·ÄÑ·Ä∫·ÄÄ·Ä≠·ÄØ reload ·Äô·Äõ·Ä±·Ä¨·ÄÄ·Ä∫·ÄÖ·Ä±·Äï·Ä´·Äò·Ä∞·Ä∏ */
        }

        .hide {
            display: none !important;
        }

        /* Utility */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .safe-pb {
            padding-bottom: env(safe-area-inset-bottom);
        }


        .sold-out-filter {
            filter: grayscale(100%);
            opacity: 0.5;
            pointer-events: none;
        }


        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 0.8;
        }

        input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }


        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .animate-slide-up {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .animate-slide-in {
            animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid #374151;
            border-top: 4px solid #FF4757;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }


        .glass-nav {
            background: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }


        .cat-btn-active {
            background-color: #FF4757;
            color: white;
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4);
            transform: scale(1.05);
            border: none;
        }

        .cat-btn-inactive {
            background-color: #1F2937;
            color: #9CA3AF;
            border: 1px solid #374151;
        }


        .table-node {
            position: absolute;
            touch-action: none;
            user-select: none;
            transition: box-shadow 0.2s, transform 0.1s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .table-node:active {
            cursor: grabbing;
        }

        .table-node.editing {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            cursor: move;
        }

        .table-node.editing:hover {
            border-color: white;
        }

        .table-node.selected {
            border: 2px solid #34D399;
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.5);
            z-index: 50;
        }


        @media print {
            @page {
                margin: 0;
                size: auto;
            }

            body,
            html {
                height: auto;
                background-color: white !important;
                overflow: visible !important;
            }


            body * {
                visibility: hidden;
            }

            #app-container,
            #main-nav #bg-canvas,
            .fixed,
            .page-view,
            #modal-qr,
            #modal-checkout {
                display: none !important;
            }


            #receipt-print-area {
                display: block !important;
                visibility: visible !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 10px !important;
                background-color: white !important;
                color: black !important;
                z-index: 9999;
            }

            #receipt-print-area * {
                visibility: visible !important;
                color: black !important;
            }

            .no-print {
                display: none !important;
            }
        }


        .page-view {
            position: fixed;
            inset: 0;
            background-color: #111827;
            z-index: 60;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }


        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;

            pointer-events: none;

            opacity: 0.6;
        }

        .keypad-btn {
            background-color: #374151;
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 1rem;
            transition: background-color 0.15s;
        }

        .keypad-btn:active {
            background-color: #4B5563;
        }

        /* Form Label */
        .form-label {
            display: block;
            font-size: 0.65rem;
            font-weight: 700;
            color: #9CA3AF;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
            letter-spacing: 0.05em;
        }


        aside button:hover i {
            transform: scale(1.1);
            transition: transform 0.2s;
        }

        aside {
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.2);
        }

        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Checkbox ·ÄÄ·Ä≠·ÄØ ·Äë·Ä≠·Äõ·Äú·ÄΩ·Äö·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·Äú·ÄØ·Äï·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ */
        #pos-mode-header label {
            cursor: pointer;
            position: relative;
            z-index: 70;
            /* Header ·Äë·ÄÄ·Ä∫ ·Äï·Ä≠·ÄØ·Äô·Äº·ÄÑ·Ä∑·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·Äë·Ä¨·Ä∏·Äï·Ä´ */
            padding: 10px;
            /* ·Äú·ÄÄ·Ä∫·Äî·Ä≤·Ä∑·Äî·Äæ·Ä≠·Äï·Ä∫·Äõ ·Äú·ÄΩ·Äö·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·Äß·Äõ·Ä≠·Äö·Ä¨·ÄÅ·Äª·Ä≤·Ä∑·Äï·Ä±·Ä∏·Äï·Ä´ */
            -webkit-user-select: none;
            user-select: none;
        }

        #chk-auto-return {
            transform: scale(1.5);
            /* ·ÄÅ·Äú·ÄØ·Äê·Ä∫·ÄÄ·Ä≠·ÄØ ·Äî·Ää·Ä∫·Ä∏·Äî·Ää·Ä∫·Ä∏·ÄÄ·Äº·ÄÆ·Ä∏·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·Äú·ÄØ·Äï·Ä∫·Äï·Ä±·Ä∏·Äï·Ä´ */
            margin-right: 8px;
            cursor: pointer;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden selection:bg-primary selection:text-white">

    <canvas id="bg-canvas"></canvas>

    <audio id="notif-sound" preload="auto" loop></audio>
    <header id="main-nav"
        class="glass-nav h-14 flex items-center justify-between px-4 z-50 no-print sticky top-0 shrink-0">
        <div class="flex items-center gap-3">
            <img src="https://placehold.co/150x50/FF4757/FFFFFF?text=Ping+POS&font=roboto" alt="Ping-Restaurant Logo"
                class="h-9 w-auto object-contain rounded-md shadow-lg shadow-red-500/20">
        </div>

        <div class="flex items-center gap-3">
            <button id="silence-btn" onclick="stopIncomingOrderAlert()"
                class="hide bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold animate-pulse shadow-lg flex items-center gap-2 border border-red-400">
                <i class="fas fa-bell-slash"></i> <span>Silence</span>
            </button>

            <button onclick="toggleLanguage()"
                class="bg-dark-800 border border-dark-700 text-white px-2 py-1 rounded-lg text-xs font-bold hover:bg-dark-700 transition flex items-center gap-1">
                <i class="fas fa-globe text-dark-muted"></i>
                <span id="lang-display">EN</span>
            </button>

            <div id="nav-customer-controls">
                <button onclick="openLoginModal()"
                    class="w-8 h-8 rounded-full bg-dark-800 text-dark-muted hover:text-primary hover:bg-dark-700 transition flex items-center justify-center border border-dark-700">
                    <i class="fas fa-user-lock text-xs"></i>
                </button>
            </div>

            <div id="nav-admin-controls" class="hide">
                <button onclick="navigateTo('screen-customer')"
                    class="bg-dark-800 text-dark-muted px-3 py-1.5 rounded-full text-[10px] font-bold hover:bg-dark-700 hover:text-white transition border border-dark-700">
                    <i class="fas fa-arrow-left mr-1"></i> <span data-i18n="exit">Exit</span>
                </button>
            </div>
        </div>
    </header>

    <main id="app-container" class="flex-1 overflow-hidden relative no-print">

        <div id="screen-customer" class="h-full flex flex-col bg-dark-900 relative">


            <div id="pos-mode-header"
                class="hide absolute top-0 left-0 right-0 z-[60] bg-orange-600 text-white shadow-lg flex justify-between items-center px-4 py-2">
                <div class="flex items-center gap-2">
                    <span class="font-bold text-xs uppercase tracking-widest"><i class="fas fa-cash-register mr-1"></i>
                        POS Mode</span>
                </div>
                <div class="flex items-center gap-3">
                    <label
                        class="flex items-center gap-2 text-xs font-bold cursor-pointer select-none bg-orange-700/50 px-2 py-1 rounded-lg hover:bg-orange-700">
                        <input type="checkbox" id="chk-auto-return" class="accent-white w-4 h-4" checked>
                        <span>Auto Return</span>
                    </label>
                    <button onclick="exitPOSMode()"
                        class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-xs font-bold transition">Back to
                        Admin</button>
                </div>
            </div>

            <!-- Hero Section -->
            <div class="px-4 pt-4 pb-2 shrink-0">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-extrabold text-white leading-tight tracking-tight">
                            <span data-i18n="hero_title">Hungry? üòã</span> <br>
                            <span class="text-primary text-sm font-bold tracking-wide" data-i18n="hero_subtitle">Order
                                something good!</span>
                        </h2>
                    </div>
                    <div class="bg-dark-800 px-3 py-1.5 rounded-xl shadow-lg border border-dark-700 text-center">
                        <span class="text-[8px] text-dark-muted block font-bold uppercase tracking-widest"
                            data-i18n="table">Table</span>
                        <span id="display-table-id" class="text-lg font-bold text-white leading-none">1</span>
                    </div>
                </div>
            </div>

            <!-- Sticky Category Bar -->
            <div class="sticky top-0 z-40 bg-dark-900/95 backdrop-blur-sm pb-3 pt-2 shrink-0">
                <div class="px-4">
                    <div class="flex gap-2 items-center" id="category-bar"></div>
                </div>
            </div>

            <!-- Product Grid -->
            <div id="main-scroll-container" class="flex-1 overflow-y-auto px-4 pb-32 pt-1 scrollbar-hide scroll-smooth">
                <div id="menu-loading" class="flex flex-col items-center justify-center py-20 opacity-60">
                    <span class="loader mb-4"></span>
                    <p class="text-dark-muted text-sm font-medium" data-i18n="loading">Loading Menu...</p>
                </div>

                <div id="menu-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

                <div id="empty-menu-msg" class="hide flex flex-col items-center justify-center py-20 text-dark-700">
                    <i class="fas fa-utensils text-5xl mb-4"></i>
                    <p class="text-sm font-medium" data-i18n="no_items">No items available yet.</p>
                </div>
            </div>

            <!-- SCROLL TO TOP BUTTON -->
            <button id="scroll-top-btn" onclick="scrollToTop()"
                class="fixed bottom-28 right-4 w-10 h-10 bg-dark-800 border border-dark-700 text-white rounded-full shadow-xl flex items-center justify-center z-40 transition-all duration-300 opacity-0 translate-y-10 pointer-events-none hover:bg-dark-700 hover:border-primary">
                <i class="fas fa-arrow-up text-sm"></i>
            </button>

            <!-- FIXED Floating Cart Button -->
            <div id="cart-bar"
                class="fixed bottom-10 left-4 right-4 sm:left-auto sm:right-8 sm:w-96 transform translate-y-[200%] transition-transform duration-500 z-50 safe-pb">
                <button onclick="openCheckoutModal()"
                    class="w-full bg-white text-dark-900 p-2 pr-3 pl-3 rounded-full shadow-2xl shadow-black/50 flex items-center justify-between group active:scale-[0.98] transition overflow-hidden">
                    <div class="bg-dark-900 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm shadow-md z-10"
                        id="cart-count">0</div>
                    <div class="flex flex-col items-start ml-3 z-10">
                        <span class="text-[10px] text-dark-700 font-bold uppercase tracking-wider"
                            data-i18n="total">Total</span>
                        <span class="text-lg font-extrabold leading-none" id="cart-total">0 Ks</span>
                    </div>
                    <div
                        class="flex items-center gap-2 bg-accent px-4 py-2.5 rounded-full ml-auto hover:brightness-110 transition shadow-lg shadow-green-500/20 z-10">
                        <span class="text-xs font-bold uppercase tracking-wide text-dark-900"
                            data-i18n="view_order">View Order</span>
                        <i class="fas fa-chevron-right text-xs text-dark-900"></i>
                    </div>
                </button>
            </div>
        </div>

        <!-- === SCREEN: KITCHEN / ADMIN DASHBOARD (RESPONSIVE) === -->
        <div id="screen-kitchen" class="h-full flex hide bg-dark-900 overflow-hidden relative">

            <!-- 1. DESKTOP SIDEBAR (Modified for Scrolling) -->
            <aside
                class="hidden lg:flex w-[240px] bg-dark-800/90 backdrop-blur-xl border-r border-dark-700 flex-col z-20 shrink-0">

                <!-- Logo Area (Fixed at Top) -->
                <div class="h-16 flex items-center px-6 border-b border-dark-700/50 shrink-0">
                    <div
                        class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-red-600 flex items-center justify-center shadow-lg shadow-red-500/30">
                        <i class="fas fa-utensils text-white text-lg"></i>
                    </div>
                    <span class="ml-3 font-extrabold text-xl text-white tracking-tight">Ping<span
                            class="text-primary">POS</span></span>
                </div>

                <!-- Navigation Menu + Bottom Actions (All Scrollable) -->
                <div class="flex-1 overflow-y-auto py-4 px-3 custom-scroll flex flex-col">

                    <!-- Main Menu Items -->
                    <div class="space-y-2">
                        <button onclick="navigateTo('screen-tables')"
                            class="w-full flex items-center gap-3 p-3 rounded-xl bg-orange-500/10 text-orange-500 hover:bg-orange-500 hover:text-white transition-all group">
                            <i class="fas fa-th-large text-xl"></i> <span class="font-bold text-sm">POS Mode</span>
                        </button>
                        <div class="my-2 border-t border-dark-700/50 mx-2"></div>
                        <button onclick="navigateTo('screen-menu')"
                            class="nav-item w-full flex items-center gap-3 p-3 rounded-xl text-dark-muted hover:bg-dark-700 hover:text-white transition-all"><i
                                class="fas fa-hamburger text-lg"></i> <span
                                class="font-medium text-sm">Menu</span></button>
                        <button onclick="navigateTo('screen-categories')"
                            class="nav-item w-full flex items-center gap-3 p-3 rounded-xl text-dark-muted hover:bg-dark-700 hover:text-white transition-all"><i
                                class="fas fa-list-alt text-lg"></i> <span
                                class="font-medium text-sm">Categories</span></button>
                        <button onclick="navigateTo('screen-tables')"
                            class="nav-item w-full flex items-center gap-3 p-3 rounded-xl text-dark-muted hover:bg-dark-700 hover:text-white transition-all"><i
                                class="fas fa-map-marked-alt text-lg"></i> <span
                                class="font-medium text-sm">Tables</span></button>
                        <button onclick="navigateTo('screen-members')"
                            class="nav-item w-full flex items-center gap-3 p-3 rounded-xl text-dark-muted hover:bg-dark-700 hover:text-white transition-all"><i
                                class="fas fa-users text-lg"></i> <span
                                class="font-medium text-sm">Members</span></button>
                        <div class="my-2 border-t border-dark-700/50 mx-2"></div>
                        <button onclick="navigateTo('screen-analytics')"
                            class="nav-item w-full flex items-center gap-3 p-3 rounded-xl text-dark-muted hover:bg-dark-700 hover:text-white transition-all"><i
                                class="fas fa-chart-pie text-lg"></i> <span
                                class="font-medium text-sm">Analytics</span></button>
                        <button onclick="navigateTo('screen-expenses')"
                            class="nav-item w-full flex items-center gap-3 p-3 rounded-xl text-dark-muted hover:bg-dark-700 hover:text-white transition-all"><i
                                class="fas fa-file-invoice-dollar text-lg"></i> <span
                                class="font-medium text-sm">Expenses</span></button>
                        <button onclick="openAIAnalyst()"
                            class="w-full flex items-center gap-3 p-3 rounded-xl text-indigo-400 bg-indigo-900/10 hover:bg-indigo-600 hover:text-white transition-all mt-4 border border-indigo-500/20"><i
                                class="fas fa-robot text-lg animate-pulse"></i> <span class="font-bold text-sm">Ask
                                AI</span></button>
                    </div>

                    <!-- Spacer to push buttons to bottom if space permits -->
                    <div class="mt-auto pt-6"></div>

                    <!-- Bottom Actions (Moved inside scroll area) -->
                    <div class="p-3 bg-dark-900/40 rounded-xl border border-dark-700/50 space-y-1">
                        <p class="text-[10px] text-dark-muted font-bold uppercase px-2 mb-1">System</p>
                        <button onclick="openSettingsModal()"
                            class="w-full flex items-center gap-3 p-3 rounded-xl text-dark-muted hover:bg-dark-700 hover:text-white transition-all"><i
                                class="fas fa-cog text-lg"></i> <span
                                class="font-medium text-sm">Settings</span></button>
                        <button onclick="openChangePinModal()"
                            class="w-full flex items-center gap-3 p-3 rounded-xl text-dark-muted hover:bg-dark-700 hover:text-white transition-all"><i
                                class="fas fa-key text-lg"></i> <span class="font-medium text-sm">PIN</span></button>
                        <button onclick="openQRModal()"
                            class="w-full flex items-center gap-3 p-3 rounded-xl text-blue-400 hover:bg-blue-600 hover:text-white transition-all"><i
                                class="fas fa-qrcode text-lg"></i> <span class="font-medium text-sm">Table
                                QR</span></button>
                    </div>

                </div>
            </aside>

            <!-- 2. MAIN CONTENT AREA -->
            <div class="flex-1 flex flex-col min-w-0 bg-dark-900 relative h-full">

                <!-- Header -->
                <header
                    class="h-14 bg-dark-800/90 backdrop-blur-md border-b border-dark-700 flex justify-between items-center px-4 sticky top-0 z-10 shrink-0">
                    <div class="flex items-center gap-2">
                        <!-- Mobile Logo (Only visible on mobile) -->
                        <div
                            class="lg:hidden w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-red-600 flex items-center justify-center shadow-lg">
                            <i class="fas fa-utensils text-white text-xs"></i>
                        </div>
                        <div>
                            <h2 class="font-bold text-base text-white flex items-center gap-2">
                                Kitchen
                                <span id="live-indicator" class="flex h-2 w-2 relative">
                                    <span
                                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-500 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                                </span>
                            </h2>
                        </div>
                    </div>

                    <!-- Shift Control -->
                    <button onclick="window.handleShiftClick()" id="btn-shift-control"
                        class="px-3 py-1.5 bg-dark-700 border border-dark-600 rounded-full text-[10px] font-bold text-dark-muted hover:text-white shadow-sm flex items-center gap-1.5 transition-all">
                        <i class="fas fa-clock"></i> <span id="shift-status-text">Shift</span>
                    </button>
                </header>

                <!-- Orders Grid Content (Padding bottom added for mobile nav) -->
                <div class="flex-1 overflow-y-auto p-3 pb-24 lg:p-6 lg:pb-6 custom-scroll">
                    <div id="orders-grid"
                        class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-3 items-start">
                        <!-- Orders injected via JS -->
                    </div>
                    <div id="no-orders-msg"
                        class="hidden h-full flex flex-col items-center justify-center text-dark-700 py-20">
                        <i class="fas fa-check-circle text-5xl mb-4 opacity-20"></i>
                        <p class="font-bold">All caught up!</p>
                    </div>
                </div>
            </div>

            <!-- 3. MOBILE BOTTOM NAVIGATION (Hidden on Desktop) -->
            <div
                class="lg:hidden fixed bottom-0 left-0 w-full bg-dark-800/95 backdrop-blur-lg border-t border-dark-700 pb-safe z-50">
                <div class="flex justify-around items-center h-16 px-2">
                    <!-- Kitchen (Home) -->
                    <button onclick="navigateTo('screen-kitchen')"
                        class="flex flex-col items-center justify-center w-full h-full text-primary space-y-1">
                        <i class="fas fa-th-list text-lg"></i>
                        <span class="text-[9px] font-bold">Orders</span>
                    </button>

                    <!-- Tables (POS) -->
                    <button onclick="navigateTo('screen-tables')"
                        class="flex flex-col items-center justify-center w-full h-full text-dark-muted hover:text-white transition space-y-1">
                        <i class="fas fa-th-large text-lg"></i>
                        <span class="text-[9px] font-bold">POS</span>
                    </button>

                    <!-- Menu (Manage) -->
                    <button onclick="navigateTo('screen-menu')"
                        class="flex flex-col items-center justify-center w-full h-full text-dark-muted hover:text-white transition space-y-1">
                        <i class="fas fa-hamburger text-lg"></i>
                        <span class="text-[9px] font-bold">Menu</span>
                    </button>

                    <!-- Analytics -->
                    <button onclick="navigateTo('screen-analytics')"
                        class="flex flex-col items-center justify-center w-full h-full text-dark-muted hover:text-white transition space-y-1">
                        <i class="fas fa-chart-pie text-lg"></i>
                        <span class="text-[9px] font-bold">Report</span>
                    </button>

                    <!-- More (Opens Modal) -->
                    <button onclick="document.getElementById('modal-mobile-menu').classList.remove('hide')"
                        class="flex flex-col items-center justify-center w-full h-full text-dark-muted hover:text-white transition space-y-1">
                        <div
                            class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center border border-dark-600">
                            <i class="fas fa-bars text-xs"></i>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- 4. MOBILE MORE MENU MODAL -->
        <div id="modal-mobile-menu"
            class="fixed inset-0 bg-black/80 z-[100] hide flex items-end justify-center backdrop-blur-sm lg:hidden">
            <div class="bg-dark-800 w-full rounded-t-[30px] border-t border-dark-700 p-6 pb-safe animate-slide-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl text-white">More Options</h3>
                    <button onclick="document.getElementById('modal-mobile-menu').classList.add('hide')"
                        class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-dark-muted hover:text-white"><i
                            class="fas fa-times"></i></button>
                </div>

                <div class="grid grid-cols-4 gap-4 mb-6">
                    <button
                        onclick="navigateTo('screen-categories'); document.getElementById('modal-mobile-menu').classList.add('hide')"
                        class="flex flex-col items-center gap-2">
                        <div
                            class="w-12 h-12 rounded-2xl bg-dark-700 flex items-center justify-center text-orange-400 text-xl shadow-lg border border-dark-600">
                            <i class="fas fa-list-alt"></i>
                        </div>
                        <span class="text-[10px] text-dark-muted font-bold">Category</span>
                    </button>
                    <button
                        onclick="navigateTo('screen-members'); document.getElementById('modal-mobile-menu').classList.add('hide')"
                        class="flex flex-col items-center gap-2">
                        <div
                            class="w-12 h-12 rounded-2xl bg-dark-700 flex items-center justify-center text-purple-400 text-xl shadow-lg border border-dark-600">
                            <i class="fas fa-users"></i>
                        </div>
                        <span class="text-[10px] text-dark-muted font-bold">Members</span>
                    </button>
                    <button
                        onclick="navigateTo('screen-expenses'); document.getElementById('modal-mobile-menu').classList.add('hide')"
                        class="flex flex-col items-center gap-2">
                        <div
                            class="w-12 h-12 rounded-2xl bg-dark-700 flex items-center justify-center text-red-400 text-xl shadow-lg border border-dark-600">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <span class="text-[10px] text-dark-muted font-bold">Expense</span>
                    </button>
                    <button
                        onclick="openAIAnalyst(); document.getElementById('modal-mobile-menu').classList.add('hide')"
                        class="flex flex-col items-center gap-2">
                        <div
                            class="w-12 h-12 rounded-2xl bg-indigo-900/40 flex items-center justify-center text-indigo-400 text-xl shadow-lg border border-indigo-500/30 animate-pulse">
                            <i class="fas fa-robot"></i>
                        </div>
                        <span class="text-[10px] text-dark-muted font-bold">AI Bot</span>
                    </button>
                </div>

                <div class="space-y-2">
                    <button
                        onclick="openSettingsModal(); document.getElementById('modal-mobile-menu').classList.add('hide')"
                        class="w-full p-4 rounded-xl bg-dark-900 border border-dark-700 flex items-center justify-between text-white font-bold text-sm">
                        <span class="flex items-center gap-3"><i class="fas fa-cog text-dark-muted"></i> Settings</span>
                        <i class="fas fa-chevron-right text-xs text-dark-600"></i>
                    </button>
                    <button
                        onclick="openChangePinModal(); document.getElementById('modal-mobile-menu').classList.add('hide')"
                        class="w-full p-4 rounded-xl bg-dark-900 border border-dark-700 flex items-center justify-between text-white font-bold text-sm">
                        <span class="flex items-center gap-3"><i class="fas fa-key text-dark-muted"></i> Change
                            PIN</span>
                        <i class="fas fa-chevron-right text-xs text-dark-600"></i>
                    </button>
                    <button onclick="openQRModal(); document.getElementById('modal-mobile-menu').classList.add('hide')"
                        class="w-full p-4 rounded-xl bg-dark-900 border border-dark-700 flex items-center justify-between text-white font-bold text-sm">
                        <span class="flex items-center gap-3"><i class="fas fa-qrcode text-dark-muted"></i> Table QR
                            Code</span>
                        <i class="fas fa-chevron-right text-xs text-dark-600"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- === SCREEN: MENU MANAGER (FIXED SCROLLING) === -->
        <div id="screen-menu" class="page-view hide animate-slide-in flex flex-col h-full bg-dark-900">

            <!-- 1. STICKY HEADER (·Ä°·Äê·Ää·Ä∫·Äî·Ä±·Äõ·Ä¨) -->
            <div
                class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800 sticky top-0 z-30 shadow-md shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="navigateTo('screen-kitchen')"
                        class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-white hover:bg-dark-600 transition">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h3 class="font-bold text-xl text-white" data-i18n="menu_manager">Menu Manager</h3>
                </div>
            </div>

            <!-- 2. SCROLLABLE CONTENT AREA (Form + List ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Äë·Ä¨·Ä∏·Äû·Ää·Ä∫) -->
            <div class="flex-1 overflow-y-auto custom-scroll relative bg-dark-900 pb-safe">

                <!-- Add/Edit Form Section -->
                <div
                    class="m-4 mb-6 rounded-2xl border border-dark-700 bg-dark-800 overflow-hidden transition-all duration-300 shadow-lg">

                    <!-- Form Header (Toggle) -->
                    <div onclick="toggleMenuForm()" id="menu-form-header"
                        class="p-4 flex justify-between items-center cursor-pointer hover:bg-dark-700 transition select-none bg-dark-800 border-b border-dark-700/50">
                        <h4 class="font-bold text-white text-sm uppercase tracking-wide flex items-center gap-3"
                            id="menu-form-title">
                            <span
                                class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-xs text-white shadow-md shadow-red-500/30">
                                <i class="fas fa-plus"></i>
                            </span>
                            <span data-i18n="add_item">Add New Item</span>
                        </h4>
                        <div
                            class="w-8 h-8 rounded-full bg-dark-900 flex items-center justify-center text-dark-muted border border-dark-700">
                            <i class="fas fa-chevron-down transition-transform duration-300" id="menu-form-chevron"></i>
                        </div>
                    </div>

                    <!-- Form Content -->
                    <div id="menu-form-content" class="hide p-4 bg-dark-800">
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Basic Info -->
                            <div class="col-span-2">
                                <label class="form-label text-primary">Item Name</label>
                                <input id="new-prod-name" placeholder="e.g. Shan Noodle"
                                    class="w-full p-3 rounded-xl border border-dark-600 bg-dark-900 text-white focus:border-primary outline-none focus:ring-1 focus:ring-primary/50 transition font-bold">
                            </div>

                            <div class="col-span-1">
                                <label class="form-label">Price (Ks)</label>
                                <input id="new-prod-price" type="number" placeholder="0"
                                    class="w-full p-3 rounded-xl border border-dark-600 bg-dark-900 text-white focus:border-primary outline-none font-mono">
                            </div>

                            <div class="col-span-1">
                                <label class="form-label">Category</label>
                                <div class="relative">
                                    <select id="new-prod-category"
                                        class="w-full p-3 rounded-xl border border-dark-600 bg-dark-900 text-white focus:border-primary outline-none appearance-none">
                                        <option value="Other">Other</option>
                                    </select>
                                    <i
                                        class="fas fa-chevron-down absolute right-3 top-3.5 text-dark-muted text-xs pointer-events-none"></i>
                                </div>
                            </div>

                            <!-- Image URL -->
                            <div class="col-span-2">
                                <label class="form-label">Image Link (URL)</label>
                                <input id="new-prod-img" placeholder="https://..."
                                    class="w-full p-3 rounded-xl border border-dark-600 bg-dark-900 text-white focus:border-primary outline-none text-xs">
                            </div>

                            <!-- Advanced Details (Collapsible Look) -->
                            <div
                                class="col-span-2 grid grid-cols-4 gap-2 bg-dark-900/50 p-3 rounded-xl border border-dark-700/50">
                                <div class="col-span-1">
                                    <label class="form-label text-[9px]">Stock</label>
                                    <input id="new-prod-stock" type="number" placeholder="‚àû"
                                        class="w-full p-2 rounded-lg border border-dark-600 bg-dark-800 text-white text-center text-xs focus:border-primary outline-none text-yellow-400 font-bold">
                                </div>
                                <div class="col-span-1">
                                    <label class="form-label text-[9px]">Cost</label>
                                    <input id="new-prod-cost" type="number" placeholder="0"
                                        class="w-full p-2 rounded-lg border border-dark-600 bg-dark-800 text-white text-center text-xs focus:border-primary outline-none">
                                </div>
                                <div class="col-span-1">
                                    <label class="form-label text-[9px]">Disc</label>
                                    <input id="new-prod-discount" type="number" placeholder="0"
                                        class="w-full p-2 rounded-lg border border-dark-600 bg-dark-800 text-white text-center text-xs focus:border-primary outline-none text-green-400">
                                </div>
                                <div class="col-span-1">
                                    <label class="form-label text-[9px]">Tax %</label>
                                    <input id="new-prod-tax" type="number" placeholder="0"
                                        class="w-full p-2 rounded-lg border border-dark-600 bg-dark-800 text-white text-center text-xs focus:border-primary outline-none text-red-400">
                                </div>
                            </div>

                            <!-- Options & Sizes -->
                            <div class="col-span-2">
                                <label class="form-label">Options (Example: Spicy, No Spicy)</label>
                                <input id="new-prod-options" placeholder="Comma separated..."
                                    class="w-full p-3 rounded-xl border border-dark-600 bg-dark-900 text-white focus:border-primary outline-none text-sm">
                            </div>
                            <div class="col-span-2">
                                <label class="form-label">Sizes (Format -> Name:Price)</label>
                                <input id="new-prod-sizes" placeholder="Small:1000, Large:2000"
                                    class="w-full p-3 rounded-xl border border-dark-600 bg-dark-900 text-white focus:border-primary outline-none text-sm">
                            </div>

                            <!-- Action Buttons -->
                            <div class="col-span-2 pt-4 flex gap-3 flex-col sm:flex-row">
                                <button id="btn-save-prod" onclick="saveProduct()"
                                    class="flex-1 bg-gradient-to-r from-primary to-red-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-red-500/20 hover:scale-[1.02] transition active:scale-95 flex items-center justify-center gap-2">
                                    <i class="fas fa-save"></i> <span>Save Item</span>
                                </button>
                                <button id="btn-cancel-edit" onclick="cancelEdit()"
                                    class="hide flex-1 bg-dark-700 text-white py-3.5 rounded-xl font-bold hover:bg-dark-600 transition active:scale-95">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product List Section -->
                <div class="px-4 pb-24">
                    <h4 class="font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-list text-dark-muted"></i> All Items
                    </h4>

                    <!-- Grid Container -->
                    <div id="menu-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- JS Will Inject Items Here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- === SCREEN: ANALYTICS (FULL PAGE) === -->
        <div id="screen-analytics" class="page-view hide animate-slide-in">
            <div class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800 sticky top-0 z-20">
                <div class="flex items-center gap-3">
                    <button onclick="navigateTo('screen-kitchen')"
                        class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-white hover:bg-dark-600 transition"><i
                            class="fas fa-arrow-left"></i></button>
                    <h3 class="font-bold text-xl text-white" data-i18n="analytics">Analytics</h3>
                </div>
            </div>

            <!-- Analytics Tab Navigation (Scrollable Pill Design) -->
            <div class="flex items-center gap-3 overflow-x-auto p-1 mx-4 mb-2 no-scrollbar pb-2">
                <button onclick="switchReportTab('overview')" id="tab-overview"
                    class="whitespace-nowrap flex-shrink-0 px-4 py-2 rounded-full font-bold text-xs bg-dark-700 text-white shadow-sm transition border border-dark-600">
                    Overview
                </button>
                <button onclick="switchReportTab('history')" id="tab-history"
                    class="whitespace-nowrap flex-shrink-0 px-4 py-2 rounded-full font-bold text-xs text-dark-muted border border-transparent hover:bg-dark-800 hover:text-white transition">
                    History
                </button>
                <button onclick="switchReportTab('cancelled')" id="tab-cancelled"
                    class="whitespace-nowrap flex-shrink-0 px-4 py-2 rounded-full font-bold text-xs text-dark-muted border border-transparent hover:bg-dark-800 hover:text-white transition">
                    Cancelled
                </button>
                <button onclick="switchReportTab('top')" id="tab-top"
                    class="whitespace-nowrap flex-shrink-0 px-4 py-2 rounded-full font-bold text-xs text-dark-muted border border-transparent hover:bg-dark-800 hover:text-white transition">
                    Top Items
                </button>
                <button onclick="switchReportTab('shifts')" id="tab-shifts"
                    class="whitespace-nowrap flex-shrink-0 px-4 py-2 rounded-full font-bold text-xs text-dark-muted border border-transparent hover:bg-dark-800 hover:text-white transition">
                    Z-Reports
                </button>
            </div>

            <div class="px-5 pb-2 flex flex-wrap gap-3 shrink-0">
                <div class="flex items-center gap-3 bg-dark-900 p-3 rounded-xl border border-dark-700 max-w-xs">
                    <span class="text-sm font-bold text-dark-muted" data-i18n="date">Date:</span>
                    <input type="date" id="rpt-date-input"
                        class="bg-transparent font-bold outline-none text-white invert-calendar"
                        onchange="window.refreshReport()">
                </div>
                <div class="flex items-center gap-2 bg-dark-900 p-1 rounded-xl border border-dark-700">
                    <select id="rpt-range-select" onchange="window.refreshReport()"
                        class="bg-transparent text-white font-bold text-sm outline-none px-3 py-2 cursor-pointer">
                        <option value="daily" class="bg-dark-800">Daily</option>
                        <option value="weekly" class="bg-dark-800">Weekly</option>
                        <option value="monthly" class="bg-dark-800">Monthly</option>
                        <option value="yearly" class="bg-dark-800">Yearly</option>
                    </select>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 pt-2">
                <!-- ANALYTICS OVERVIEW -->
                <div id="rpt-view-overview">
                    <p class="text-[10px] uppercase font-bold text-dark-muted mb-4 tracking-widest"><i
                            class="fas fa-calendar-alt mr-1"></i> <span id="rpt-period-label">Today</span></p>

                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <!-- Net Profit (Hero Card) - Transparent & Glowing -->
                        <div
                            class="col-span-2 bg-emerald-900/30 backdrop-blur-md rounded-[2rem] p-6 shadow-[0_0_20px_rgba(16,185,129,0.4)] border border-emerald-500/50 relative overflow-hidden group transition-all hover:shadow-[0_0_30px_rgba(16,185,129,0.6)]">
                            <div
                                class="absolute right-[-20px] bottom-[-20px] opacity-20 transform rotate-12 transition group-hover:scale-110 duration-700">
                                <i class="fas fa-wallet text-9xl text-emerald-400"></i>
                            </div>
                            <p class="text-emerald-100 text-xs font-bold uppercase tracking-widest mb-1 shadow-black drop-shadow-md"
                                data-i18n="net_profit">Net Profit</p>
                            <h2 class="text-4xl font-extrabold text-white mb-2 drop-shadow-lg" id="rpt-ov-profit">0 Ks
                            </h2>
                            <div
                                class="inline-flex items-center gap-2 bg-emerald-500/20 px-3 py-1 rounded-full backdrop-blur-md border border-emerald-500/30">
                                <div
                                    class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse shadow-[0_0_10px_#34D399]">
                                </div>
                                <span class="text-[10px] text-emerald-100 font-bold">After Expenses & Cost</span>
                            </div>
                        </div>

                        <!-- Total Revenue - Transparent & Glowing -->
                        <div
                            class="col-span-2 lg:col-span-2 bg-indigo-900/30 backdrop-blur-md rounded-[2rem] p-6 shadow-[0_0_20px_rgba(99,102,241,0.4)] border border-indigo-500/50 relative overflow-hidden group transition-all hover:shadow-[0_0_30px_rgba(99,102,241,0.6)]">
                            <div
                                class="absolute right-[-10px] bottom-[-10px] opacity-20 transform rotate-12 transition group-hover:scale-110 duration-700">
                                <i class="fas fa-chart-line text-8xl text-indigo-400"></i>
                            </div>
                            <p class="text-indigo-100 text-xs font-bold uppercase tracking-widest mb-1 shadow-black drop-shadow-md"
                                data-i18n="total_revenue">Total Revenue</p>
                            <h2 class="text-3xl font-extrabold text-white drop-shadow-lg" id="rpt-ov-total">0 Ks</h2>
                        </div>

                        <!-- Small Stat Cards -->
                        <div
                            class="bg-dark-800 rounded-[1.5rem] p-5 border border-dark-700 shadow-lg flex flex-col justify-between hover:bg-dark-700 transition group">
                            <div class="flex justify-between items-start mb-2">
                                <div class="p-2 rounded-xl bg-orange-500/10 text-orange-500"><i
                                        class="fas fa-boxes"></i></div>
                                <span class="text-[10px] text-dark-muted font-bold">COGS</span>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white group-hover:text-orange-400 transition"
                                    id="rpt-ov-cogs">0 Ks</h3>
                                <p class="text-[10px] text-dark-muted">Product Cost</p>
                            </div>
                        </div>

                        <div
                            class="bg-dark-800 rounded-[1.5rem] p-5 border border-dark-700 shadow-lg flex flex-col justify-between hover:bg-dark-700 transition group">
                            <div class="flex justify-between items-start mb-2">
                                <div class="p-2 rounded-xl bg-red-500/10 text-red-500"><i
                                        class="fas fa-file-invoice-dollar"></i></div>
                                <span class="text-[10px] text-dark-muted font-bold" data-i18n="expenses">Expenses</span>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white group-hover:text-red-400 transition"
                                    id="rpt-ov-expenses">0 Ks</h3>
                                <p class="text-[10px] text-dark-muted">Operational</p>
                            </div>
                        </div>

                        <div
                            class="bg-dark-800 rounded-[1.5rem] p-5 border border-dark-700 shadow-lg flex flex-col justify-between hover:bg-dark-700 transition group">
                            <div class="flex justify-between items-start mb-2">
                                <div class="p-2 rounded-xl bg-purple-500/10 text-purple-500"><i
                                        class="fas fa-receipt"></i></div>
                                <span class="text-[10px] text-dark-muted font-bold"
                                    data-i18n="total_orders">Orders</span>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white group-hover:text-purple-400 transition"
                                    id="rpt-ov-count">0</h3>
                                <p class="text-[10px] text-dark-muted">Completed</p>
                            </div>
                        </div>

                        <div
                            class="bg-dark-800 rounded-[1.5rem] p-5 border border-red-900/30 shadow-lg flex flex-col justify-between hover:bg-dark-700 transition group relative overflow-hidden">
                            <div class="absolute inset-0 bg-red-900/5 pointer-events-none"></div>
                            <div class="flex justify-between items-start mb-2">
                                <div class="p-2 rounded-xl bg-gray-700/50 text-gray-400"><i class="fas fa-ban"></i>
                                </div>
                                <span class="text-[10px] text-dark-muted font-bold"
                                    data-i18n="cancelled">Cancelled</span>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white group-hover:text-red-400 transition"
                                    id="rpt-ov-cancelled">0</h3>
                                <p class="text-[10px] text-dark-muted">Voided</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2 mb-4 bg-dark-900 p-1.5 rounded-xl border border-dark-700">
                        <button onclick="setOverviewChart('sales')" id="btn-ov-sales"
                            class="flex-1 py-2 rounded-lg text-xs font-bold transition bg-dark-700 text-white shadow">Sales
                            Trend</button>
                        <button onclick="setOverviewChart('table')" id="btn-ov-table"
                            class="flex-1 py-2 rounded-lg text-xs font-bold transition text-dark-muted hover:text-white">Tables</button>
                        <button onclick="setOverviewChart('category')" id="btn-ov-category"
                            class="flex-1 py-2 rounded-lg text-xs font-bold transition text-dark-muted hover:text-white">Categories</button>
                        <button onclick="setOverviewChart('type')" id="btn-ov-type"
                            class="flex-1 py-2 rounded-lg text-xs font-bold transition text-dark-muted hover:text-white">Order
                            Types</button>
                    </div>

                    <div id="overview-chart-container"
                        class="bg-dark-900 p-4 rounded-2xl border border-dark-700 min-h-[300px] mb-20">
                        <div id="overview-content-sales">
                            <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider"
                                data-i18n="hourly_sales">Sales Trend</h4>
                            <div class="relative h-64 w-full"><canvas id="salesChart"></canvas></div>
                        </div>

                        <!-- Table Content -->
                        <div id="overview-content-table" class="hide">
                            <div id="table-chart-wrapper">
                                <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider">Table
                                    Performance - Chart</h4>
                                <div class="relative h-64 w-full flex justify-center shrink-0"><canvas
                                        id="tableChart"></canvas></div>
                            </div>
                            <div id="table-list-wrapper" class="hide">
                                <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider">Table
                                    Performance - List</h4>
                                <div class="overflow-x-auto rounded-xl border border-dark-700">
                                    <div class="max-h-64 overflow-y-auto custom-scroll">
                                        <table class="w-full text-xs text-left text-dark-muted">
                                            <thead
                                                class="sticky top-0 bg-dark-900 text-dark-500 uppercase font-bold text-[9px] tracking-wider">
                                                <tr>
                                                    <th class="py-2 p-3">Table</th>
                                                    <th class="py-2 text-right p-3">Orders</th>
                                                    <th class="py-2 text-right p-3">Revenue</th>
                                                </tr>
                                            </thead>
                                            <tbody id="table-data-tbody" class="divide-y divide-dark-800"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-4">
                                <button onclick="toggleAnalyticsView('table')" id="btn-toggle-table-view"
                                    class="text-[10px] font-bold text-primary border border-primary/30 bg-primary/10 px-3 py-1.5 rounded-lg hover:bg-primary hover:text-white transition">
                                    <i class="fas fa-exchange-alt"></i> <span id="toggle-table-text"
                                        data-i18n="view_list">View List</span>
                                </button>
                            </div>
                        </div>

                        <!-- Category Content -->
                        <div id="overview-content-category" class="hide">
                            <div id="category-chart-wrapper">
                                <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider"
                                    data-i18n="category_sales">Category Sales - Chart</h4>
                                <div class="relative h-64 w-full flex justify-center mb-2"><canvas
                                        id="categoryChart"></canvas></div>
                            </div>
                            <div id="category-list-wrapper" class="hide">
                                <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider"
                                    data-i18n="category_sales">Category Sales - List</h4>
                                <div class="overflow-x-auto rounded-xl border border-dark-700">
                                    <div class="max-h-64 overflow-y-auto custom-scroll">
                                        <table class="w-full text-xs text-left text-dark-muted">
                                            <thead
                                                class="sticky top-0 bg-dark-900 text-dark-500 uppercase font-bold text-[9px] tracking-wider">
                                                <tr>
                                                    <th class="py-2 p-3">Category</th>
                                                    <th class="py-2 text-right p-3">Qty</th>
                                                    <th class="py-2 text-right p-3">Revenue</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cat-data-tbody" class="divide-y divide-dark-800"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-4">
                                <button onclick="toggleAnalyticsView('category')" id="btn-toggle-category-view"
                                    class="text-[10px] font-bold text-purple-400 border border-purple-500/30 bg-purple-900/20 px-3 py-1.5 rounded-lg hover:bg-purple-600 hover:text-white transition">
                                    <i class="fas fa-exchange-alt"></i> <span data-i18n="view_list"
                                        id="toggle-category-text">View List</span>
                                </button>
                            </div>
                        </div>

                        <!-- Order Type Content -->
                        <div id="overview-content-type" class="hide">
                            <div id="type-chart-wrapper">
                                <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider"
                                    data-i18n="order_type">Order Type Overview - Chart</h4>
                                <div class="relative h-64 w-full flex justify-center mb-2"><canvas
                                        id="orderTypeChart"></canvas></div>
                            </div>
                            <div id="type-list-wrapper" class="hide">
                                <h4 class="text-sm font-bold text-dark-muted mb-4 uppercase tracking-wider"
                                    data-i18n="order_type">Order Type Overview - List</h4>
                                <div class="overflow-x-auto rounded-xl border border-dark-700">
                                    <div class="max-h-64 overflow-y-auto custom-scroll">
                                        <table class="w-full text-xs text-left text-dark-muted">
                                            <thead
                                                class="sticky top-0 bg-dark-900 text-dark-500 uppercase font-bold text-[9px] tracking-wider">
                                                <tr>
                                                    <th class="py-2 p-3">Type</th>
                                                    <th class="py-2 text-right p-3">Count</th>
                                                    <th class="py-2 text-right p-3">Revenue</th>
                                                </tr>
                                            </thead>
                                            <tbody id="type-data-tbody" class="divide-y divide-dark-800"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-4">
                                <button onclick="toggleAnalyticsView('type')" id="btn-toggle-type-view"
                                    class="text-[10px] font-bold text-blue-400 border border-blue-500/30 bg-blue-900/20 px-3 py-1.5 rounded-lg hover:bg-blue-600 hover:text-white transition">
                                    <i class="fas fa-exchange-alt"></i> <span data-i18n="view_list"
                                        id="toggle-type-text">View List</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="rpt-view-history" class="hide">
                    <div class="flex justify-between items-center mb-4 mt-2">
                        <h4 class="font-bold text-white" data-i18n="orders_selected">Orders for Selected Period</h4>
                        <button onclick="clearAllHistory()"
                            class="text-red-400 text-xs font-bold border border-red-900/30 bg-red-900/10 px-3 py-1 rounded-lg hover:bg-red-900/30 transition"
                            data-i18n="clear_all">Clear All</button>
                    </div>
                    <!-- Search Input for History -->
                    <div class="mb-4">
                        <input type="text" id="history-search-input" oninput="window.refreshReport()"
                            data-i18n-placeholder="search_history_placeholder"
                            placeholder="Search by Order ID/Table ID (e.g., #A12B or T-1)"
                            class="w-full p-3 rounded-xl border border-dark-700 bg-dark-800 text-white placeholder-dark-700 focus:border-primary outline-none">
                    </div>
                    <div class="overflow-x-auto rounded-xl border border-dark-700 mb-20">
                        <table class="w-full text-sm text-left text-dark-muted">
                            <thead class="bg-dark-900 text-dark-700 uppercase text-xs">
                                <tr>
                                    <th class="p-3" data-i18n="time">Date/Time</th>
                                    <th class="p-3" data-i18n="table">Table</th>
                                    <th class="p-3 text-right" data-i18n="total">Total</th>
                                    <th class="p-3 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-history-body" class="divide-y divide-dark-700 bg-dark-800"></tbody>
                        </table>
                    </div>
                </div>

                <!-- CANCELLED VIEW -->
                <div id="rpt-view-cancelled" class="hide">
                    <h4 class="font-bold text-white mb-4 mt-2" data-i18n="cancelled_orders">Cancelled Orders</h4>
                    <div class="overflow-x-auto rounded-xl border border-dark-700 mb-20">
                        <table class="w-full text-sm text-left text-dark-muted">
                            <thead class="bg-dark-900 text-dark-700 uppercase text-xs">
                                <tr>
                                    <th class="p-3" data-i18n="time">Date/Time</th>
                                    <th class="p-3" data-i18n="table">Table</th>
                                    <th class="p-3 text-right" data-i18n="total">Total</th>
                                    <th class="p-3 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-cancelled-body" class="divide-y divide-dark-700 bg-dark-800">
                                <tr>
                                    <td colspan="4" class="p-8 text-center text-xs text-dark-700">No cancelled records
                                        found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="rpt-view-top" class="hide">
                    <h4 class="font-bold text-white mb-4 mt-2" data-i18n="top_selected">Top Items for Selected Period
                    </h4>
                    <div id="rpt-top-list" class="space-y-3 mb-20"></div>
                </div>
                <!-- SHIFT HISTORY VIEW -->
                <div id="rpt-view-shifts" class="hide">
                    <h4 class="font-bold text-white mb-4 mt-2">Past Shift Reports (Z-Readings)</h4>
                    <div class="overflow-x-auto rounded-xl border border-dark-700 mb-20">
                        <table class="w-full text-sm text-left text-dark-muted">
                            <thead class="bg-dark-900 text-dark-700 uppercase text-xs">
                                <tr>
                                    <th class="p-3">Date/Time</th>
                                    <th class="p-3">Staff</th>
                                    <th class="p-3 text-right">Expected</th>
                                    <th class="p-3 text-right">Actual</th>
                                    <th class="p-3 text-right">Diff</th>
                                    <th class="p-3 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-shifts-body" class="divide-y divide-dark-700 bg-dark-800">
                                <!-- Data will load here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- === SCREEN: EXPENSES (FULL PAGE) === -->
        <div id="screen-expenses" class="page-view hide animate-slide-in">
            <div class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800 sticky top-0 z-20">
                <div class="flex items-center gap-3">
                    <button onclick="navigateTo('screen-kitchen')"
                        class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-white hover:bg-dark-600 transition"><i
                            class="fas fa-arrow-left"></i></button>
                    <h3 class="font-bold text-xl text-white" data-i18n="expenses">Expenses</h3>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="clearAllExpenses()"
                        class="bg-dark-900 border border-red-500/50 text-red-400 hover:bg-red-600 hover:text-white px-3 py-1.5 rounded-full text-[10px] font-bold transition">Clear
                        All</button>
                    <button onclick="openAddExpenseModal()"
                        class="bg-red-600 hover:bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg transition"><i
                            class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-5 pb-20">
                <table class="w-full text-sm text-left text-dark-muted">
                    <thead class="bg-dark-900 text-dark-500 uppercase font-bold text-[10px]">
                        <tr>
                            <th class="py-2 p-3">Date</th>
                            <th class="py-2 p-3">Description</th>
                            <th class="py-2 p-3">Note</th>
                            <th class="py-2 text-right p-3">Amount</th>
                            <th class="py-2 text-center p-3">Action</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-table-body" class="divide-y divide-dark-700"></tbody>
                </table>
            </div>
        </div>

        <!-- === SCREEN: CATEGORY MANAGER (REDESIGNED) === -->
        <div id="screen-categories" class="page-view hide animate-slide-in flex flex-col h-full bg-dark-900">

            <!-- 1. STICKY HEADER -->
            <div
                class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800 sticky top-0 z-30 shadow-md shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="navigateTo('screen-kitchen')"
                        class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-white hover:bg-dark-600 transition">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h3 class="font-bold text-xl text-white" data-i18n="category_manager">Category Manager</h3>
                </div>
            </div>

            <!-- 2. SCROLLABLE CONTENT -->
            <div class="flex-1 overflow-y-auto custom-scroll pb-safe">

                <!-- Add Category Form (Card Style) -->
                <div class="m-4 p-5 bg-dark-800 rounded-2xl border border-dark-700 shadow-lg">
                    <h4 class="font-bold text-white text-sm mb-3 flex items-center gap-2">
                        <span
                            class="w-6 h-6 rounded-lg bg-orange-500/20 text-orange-500 flex items-center justify-center text-xs"><i
                                class="fas fa-plus"></i></span>
                        Create New Category
                    </h4>

                    <!-- Mobile: Flex-Col (Stack), Desktop: Flex-Row -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input id="new-cat-name" placeholder="Category Name (e.g., Seafood)"
                            class="flex-1 p-3.5 rounded-xl border border-dark-600 bg-dark-900 text-white placeholder-dark-600 focus:border-primary outline-none focus:ring-1 focus:ring-primary/50 transition font-bold">

                        <button id="btn-save-cat" onclick="saveCategory()"
                            class="w-full sm:w-auto px-6 py-3.5 bg-gradient-to-r from-primary to-red-600 text-white rounded-xl font-bold shadow-lg hover:shadow-red-500/30 transition active:scale-95 flex items-center justify-center gap-2 whitespace-nowrap">
                            <i class="fas fa-save"></i> <span>Add</span>
                        </button>
                    </div>
                </div>

                <!-- Category List -->
                <div class="px-4 pb-24">
                    <h4 class="font-bold text-dark-muted text-xs uppercase tracking-widest mb-3 ml-1">Existing
                        Categories</h4>

                    <!-- Grid Container -->
                    <div id="categories-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <!-- Items injected via JS -->
                    </div>

                    <div class="mt-6 p-4 rounded-xl bg-blue-900/10 border border-blue-500/20 flex gap-3 items-start">
                        <i class="fas fa-info-circle text-blue-400 mt-0.5"></i>
                        <p class="text-xs text-blue-200/80 leading-relaxed">
                            Deleting a category will NOT delete the items inside it. Instead, those items will be moved
                            to <span class="font-bold text-white">'Other'</span> automatically.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- === SCREEN: TABLE MAP (UPDATED WITH GRID VIEW) === -->
        <div id="screen-tables" class="page-view hide animate-slide-in flex flex-col h-full bg-dark-900">

            <!-- Header -->
            <div
                class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800 z-10 shrink-0 sticky top-0">
                <div class="flex items-center gap-3">
                    <button onclick="navigateTo('screen-kitchen')"
                        class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-white hover:bg-dark-600 transition">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <h3 class="font-bold text-white text-lg flex items-center gap-2">
                            <span data-i18n="table_map">Tables</span>
                        </h3>
                        <!-- ·Äí·ÄÆ·ÄÖ·Ä¨·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äú·Ä±·Ä∏ ·Äú·Ä≠·ÄØ·Äî·Ä±·Äú·Ä≠·ÄØ·Ä∑ Error ·Äê·ÄÄ·Ä∫·Äî·Ä±·Äê·Ä¨·Äï·Ä´ -->
                        <p id="table-map-subtitle" class="text-[10px] text-dark-muted">Select a table to take order</p>
                    </div>
                </div>

                <!-- View Toggle (Map vs Grid) -->
                <div class="flex bg-dark-900 rounded-lg p-1 border border-dark-700">
                    <button onclick="toggleTableView('map')" id="btn-view-map"
                        class="px-3 py-1.5 rounded-md text-xs font-bold bg-primary text-white shadow transition">
                        <i class="fas fa-map-marked-alt mr-1"></i> Map
                    </button>
                    <button onclick="toggleTableView('grid')" id="btn-view-grid"
                        class="px-3 py-1.5 rounded-md text-xs font-bold text-dark-muted hover:text-white transition">
                        <i class="fas fa-th mr-1"></i> Grid
                    </button>
                </div>

                <div id="layout-edit-controls"
                    class="hide absolute top-16 right-4 flex items-center gap-2 bg-dark-800 p-2 rounded-xl border border-dark-600 shadow-xl z-50">

                    <!-- Add Button -->
                    <button onclick="addNewTable()"
                        class="bg-green-600 text-white px-3 py-1.5 rounded-md text-xs font-bold hover:bg-green-500 transition">
                        <i class="fas fa-plus"></i>
                    </button>

                    <!-- Save Button (ID ·Äë·Ää·Ä∑·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´·Äï·Äº·ÄÆ) -->
                    <button id="btn-save-layout" onclick="saveLayout()"
                        class="bg-primary text-white px-3 py-1.5 rounded-md text-xs font-bold hover:bg-red-600 transition flex items-center gap-1">
                        <i class="fas fa-save"></i> <span>Save</span>
                    </button>
                </div>
                <button onclick="toggleLayoutEdit()" id="btn-edit-layout"
                    class="ml-2 border border-dark-600 text-dark-muted hover:text-white hover:bg-dark-700 px-3 py-1.5 rounded-lg text-xs font-bold transition">
                    <i class="fas fa-pen"></i>
                </button>
            </div>

            <!-- VIEW 1: MAP CONTAINER (Original) -->
            <div onclick="deselectTable()"
                class="flex-1 overflow-auto bg-dark-900 relative cursor-grab active:cursor-grabbing"
                id="table-map-container"
                style="background-image: radial-gradient(#374151 1px, transparent 1px); background-size: 20px 20px;">
                <!-- Tables will be injected here -->
            </div>

            <!-- VIEW 2: GRID CONTAINER (New for Mobile) -->
            <div id="table-grid-container" class="hide flex-1 overflow-y-auto p-4 bg-dark-900">
                <div id="table-grid-content" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                    <!-- Grid items injected here -->
                </div>
            </div>

            <div id="map-bottom-panel"
                class="p-4 bg-dark-800 border-t border-dark-700 z-10 min-h-[80px] flex justify-center items-center shrink-0 safe-pb">

                <!-- Legend (·Äï·ÄØ·Ä∂·Äô·Äæ·Äî·Ä∫·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫·Äô·Äæ·Ä¨ ·Äï·Äº·Äô·Äö·Ä∫) -->
                <div id="map-legend" class="flex gap-6 text-xs font-bold text-dark-muted">
                    <span class="flex items-center gap-2"><span
                            class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></span> Free</span>
                    <span class="flex items-center gap-2"><span
                            class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_#ef4444]"></span> Occupied</span>
                </div>

                <!-- Properties Panel (Edit Mode ·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äï·Äº·ÄÆ·Ä∏ ·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤·Äõ·ÄΩ·Ä±·Ä∏·Äô·Äæ ·Äï·Äº·Äô·Äö·Ä∫) -->
                <div id="table-properties"
                    class="hide w-full flex justify-between items-center max-w-3xl animate-slide-up gap-4">

                    <!-- Table Name Display -->
                    <div class="bg-dark-900 px-4 py-2 rounded-lg border border-dark-600">
                        <span class="text-[10px] text-dark-muted uppercase font-bold block">Selected</span>
                        <span id="prop-id" class="text-lg font-bold text-primary">T-1</span>
                    </div>

                    <!-- Controls Container -->
                    <div
                        class="flex-1 flex items-center gap-4 bg-dark-900 p-2 rounded-xl border border-dark-600 overflow-x-auto">

                        <!-- Shape Selector -->
                        <div class="flex flex-col min-w-[80px]">
                            <label class="text-[9px] text-dark-muted font-bold uppercase mb-1">Shape</label>
                            <select onchange="window.updateTableProperty('shape', this.value)"
                                class="bg-dark-800 text-white text-xs border border-dark-600 rounded p-1 outline-none focus:border-primary">
                                <option value="round">Round ‚óè</option>
                                <option value="rect">Square ‚ñ†</option>
                            </select>
                        </div>

                        <!-- Size Slider -->
                        <div class="flex flex-col flex-1 min-w-[120px]">
                            <div class="flex justify-between">
                                <label class="text-[9px] text-dark-muted font-bold uppercase mb-1">Size</label>
                                <span class="text-[9px] text-white" id="size-val-display">1.0x</span>
                            </div>
                            <input type="range" id="prop-size" min="0.5" max="2" step="0.1"
                                oninput="document.getElementById('size-val-display').innerText=this.value+'x'; window.updateTableProperty('size', this.value)"
                                class="w-full h-1 bg-dark-700 rounded-lg appearance-none cursor-pointer accent-primary">
                        </div>
                    </div>

                    <!-- Delete Button -->
                    <button onclick="deleteSelectedTable()"
                        class="bg-red-900/20 text-red-500 border border-red-900/50 px-4 py-3 rounded-xl text-xs font-bold flex items-center gap-2 hover:bg-red-600 hover:text-white transition whitespace-nowrap">
                        <i class="fas fa-trash"></i> <span class="hidden sm:inline">Delete</span>
                    </button>
                </div>
            </div>

        </div>
        <!-- === SCREEN: MEMBER MANAGER (NEW) === -->
        <div id="screen-members" class="page-view hide animate-slide-in">
            <div class="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-800 sticky top-0 z-20">
                <div class="flex items-center gap-3">
                    <button onclick="navigateTo('screen-kitchen')"
                        class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-white hover:bg-dark-600 transition"><i
                            class="fas fa-arrow-left"></i></button>
                    <h3 class="font-bold text-xl text-white">Member List</h3>
                </div>
                <div class="text-xs text-dark-muted font-mono" id="total-members-count">0 Members</div>
            </div>

            <!-- Search Bar -->
            <div class="p-4 bg-dark-900 border-b border-dark-700 sticky top-16 z-10">
                <input type="text" id="member-manager-search" oninput="window.renderMemberList()"
                    placeholder="Search by Name or Phone..."
                    class="w-full p-3 rounded-xl border border-dark-700 bg-dark-800 text-white outline-none focus:border-primary">
            </div>

            <div class="flex-1 overflow-y-auto p-5 pb-20">
                <table class="w-full text-sm text-left text-dark-muted">
                    <thead class="bg-dark-900 text-dark-500 uppercase font-bold text-[10px]">
                        <tr>
                            <th class="py-2 p-3">Name</th>
                            <th class="py-2 p-3">Phone</th>
                            <th class="py-2 text-right p-3">Points</th>
                            <th class="py-2 text-right p-3">Visits</th>
                            <th class="py-2 text-center p-3">Action</th>
                        </tr>
                    </thead>
                    <tbody id="members-table-body" class="divide-y divide-dark-700">
                        <!-- Data will load here -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- === MODALS (Lightweight only) === -->

    <!-- Custom Confirmation Modal -->
    <div id="modal-confirm"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[101] hide flex items-center justify-center p-4">
        <div
            class="bg-dark-800 w-full max-w-xs rounded-[30px] shadow-2xl p-6 text-center animate-slide-up border border-dark-700">
            <h3 class="font-bold text-lg mb-2 text-white" id="confirm-title" data-i18n="confirmation">Confirmation</h3>
            <p class="text-sm text-dark-muted mb-6" id="confirm-message">Are you sure?</p>
            <input type="password" id="confirm-pin-input"
                class="hide border-2 border-dark-700 bg-dark-900 text-white p-3 rounded-2xl w-full text-center font-bold text-2xl tracking-[0.5em] mb-6 focus:border-primary outline-none transition placeholder-dark-700"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
            <div class="flex gap-3">
                <button onclick="closeModal('modal-confirm')"
                    class="flex-1 py-3 text-dark-muted font-bold text-sm hover:text-white transition"
                    data-i18n="cancel">Cancel</button>
                <button id="confirm-action-btn" onclick=""
                    class="flex-1 bg-primary text-white py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-red-600 transition"
                    data-i18n="confirm">Confirm</button>
            </div>
        </div>
    </div>
    <!-- === MODAL: AI BUSINESS ANALYST === -->
    <div id="modal-ai-analyst"
        class="fixed inset-0 bg-black/80 z-[150] hide flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-dark-800 w-full max-w-lg rounded-[30px] shadow-2xl border border-dark-700 animate-slide-up flex flex-col max-h-[85vh]">
            <!-- Header -->
            <div
                class="p-5 border-b border-dark-700 flex justify-between items-center bg-gradient-to-r from-indigo-900 to-dark-800 rounded-t-[30px]">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center backdrop-blur-md border border-white/20">
                        <i class="fas fa-robot text-indigo-300 text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-white">Ping AI Analyst</h3>
                        <p class="text-[10px] text-indigo-300">Ask about your sales & business insights</p>
                    </div>
                </div>
                <button onclick="closeModal('modal-ai-analyst')" class="text-white/70 hover:text-white transition"><i
                        class="fas fa-times text-xl"></i></button>
            </div>

            <!-- Chat Area -->
            <div id="ai-chat-history" class="flex-1 overflow-y-auto p-5 space-y-4 bg-dark-900 custom-scroll">
                <!-- Messages will appear here -->
                <div class="flex gap-3">
                    <div
                        class="w-8 h-8 rounded-full bg-indigo-900/50 flex items-center justify-center shrink-0 border border-indigo-500/30">
                        <i class="fas fa-robot text-xs text-indigo-300"></i>
                    </div>
                    <div
                        class="bg-dark-800 p-3 rounded-2xl rounded-tl-none border border-dark-700 text-sm text-gray-300">
                        Hello! I've analyzed your sales data. Ask me anything like "What is the best selling item
                        today?" or "How can I improve profit?".
                    </div>
                </div>
            </div>

            <!-- Input Area (Fixed for All Mobile Screens) -->
            <div class="p-3 bg-dark-800 border-t border-dark-700 rounded-b-[30px] w-full box-border">
                <div class="flex items-center gap-2 w-full">

                    <!-- Text Input -->
                    <!-- min-w-0 is added to prevent overflow on small screens -->
                    <input type="text" id="ai-user-input" placeholder="Ask AI something..."
                        class="flex-1 min-w-0 bg-dark-900 border border-dark-600 text-white rounded-full px-4 h-11 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition shadow-inner placeholder-gray-500"
                        onkeypress="handleAiEnter(event)">

                    <!-- Send Button -->
                    <button onclick="sendToAI()" id="btn-send-ai"
                        class="w-11 h-11 rounded-full bg-gradient-to-r from-indigo-600 to-indigo-500 text-white flex items-center justify-center shadow-lg shadow-indigo-500/30 active:scale-90 transition-all hover:brightness-110 shrink-0">
                        <i class="fas fa-paper-plane text-sm ml-0.5"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- === MODAL: OPEN SHIFT === -->
    <div id="modal-shift-open"
        class="fixed inset-0 bg-black/80 z-[130] hide flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-dark-800 w-full max-w-xs rounded-[30px] shadow-2xl p-6 border border-dark-700 animate-slide-up">
            <div class="text-center mb-6">
                <div
                    class="w-12 h-12 rounded-full bg-indigo-900/30 text-indigo-400 flex items-center justify-center mx-auto mb-3 border border-indigo-500/30">
                    <i class="fas fa-sun text-xl"></i>
                </div>
                <h3 class="font-bold text-lg text-white">Open Shift</h3>
                <p class="text-xs text-dark-muted">Start a new working period</p>
            </div>

            <label class="form-label">Starting Cash (Float)</label>
            <input type="number" id="shift-start-cash" placeholder="0"
                class="w-full p-3 rounded-xl border border-dark-700 bg-dark-900 text-white placeholder-dark-600 focus:border-indigo-500 outline-none text-center font-bold text-lg mb-6">

            <button onclick="window.startShift()"
                class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-500 transition">
                Start Shift
            </button>
            <button onclick="closeModal('modal-shift-open')"
                class="w-full mt-3 text-dark-muted text-xs font-bold hover:text-white">Cancel</button>
        </div>
    </div>

    <!-- === MODAL: CLOSE SHIFT (Z-REPORT) === -->
    <div id="modal-shift-close"
        class="fixed inset-0 bg-black/80 z-[130] hide flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-dark-800 w-full max-w-sm rounded-[30px] shadow-2xl p-6 border border-dark-700 animate-slide-up flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-dark-700">
                <div>
                    <h3 class="font-bold text-lg text-white">Close Shift</h3>
                    <p class="text-[10px] text-dark-muted uppercase tracking-wider">Z-Reading Report</p>
                </div>
                <button onclick="closeModal('modal-shift-close')" class="text-dark-muted hover:text-white"><i
                        class="fas fa-times"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll pr-1">
                <!-- Calculated Stats -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-dark-900 p-3 rounded-xl border border-dark-700/50">
                        <p class="text-[10px] text-dark-muted uppercase font-bold">Opening Cash</p>
                        <p class="text-white font-bold" id="z-start-cash">0 Ks</p>
                    </div>
                    <div class="bg-dark-900 p-3 rounded-xl border border-dark-700/50">
                        <p class="text-[10px] text-dark-muted uppercase font-bold">Cash Sales</p>
                        <p class="text-green-400 font-bold" id="z-cash-sales">0 Ks</p>
                    </div>
                    <div class="bg-dark-900 p-3 rounded-xl border border-dark-700/50">
                        <p class="text-[10px] text-dark-muted uppercase font-bold">Card/Online</p>
                        <p class="text-blue-400 font-bold" id="z-card-sales">0 Ks</p>
                    </div>
                    <div class="bg-dark-900 p-3 rounded-xl border border-dark-700/50">
                        <p class="text-[10px] text-dark-muted uppercase font-bold">Expenses (Cash)</p>
                        <p class="text-red-400 font-bold" id="z-expenses">0 Ks</p>
                    </div>
                </div>

                <div class="bg-indigo-900/20 p-4 rounded-xl border border-indigo-500/30 mb-6 text-center">
                    <p class="text-indigo-300 text-xs font-bold uppercase mb-1">Expected Cash in Drawer</p>
                    <h2 class="text-3xl font-extrabold text-white" id="z-expected-cash">0 Ks</h2>
                    <p class="text-[9px] text-indigo-300/60 mt-1">(Start + Cash Sales - Expenses)</p>
                </div>

                <label class="form-label text-center">Actual Cash Count (Enter Amount)</label>
                <input type="number" id="z-actual-cash" placeholder="0" oninput="window.calcShiftVariance()"
                    class="w-full p-4 rounded-xl border-2 border-dark-600 bg-dark-900 text-white placeholder-dark-600 focus:border-primary outline-none text-center font-bold text-2xl mb-2">

                <p id="z-variance-display" class="text-center text-xs font-bold text-dark-muted mb-4">Difference: 0 Ks
                </p>
            </div>

            <button onclick="window.executeCloseShift()"
                class="w-full py-4 bg-red-600 text-white rounded-xl font-bold shadow-lg hover:bg-red-500 transition flex items-center justify-center gap-2">
                <i class="fas fa-file-invoice"></i> Close Shift & Print Z
            </button>
        </div>
    </div>

    <!-- Settings Modal (Redesigned for Mobile Scrolling) -->
    <div id="modal-settings"
        class="fixed inset-0 bg-black/80 z-[100] hide flex items-end sm:items-center justify-center backdrop-blur-sm sm:p-4">

        <!-- Modal Container: Mobile ·Äô·Äæ·Ä¨ ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·ÄÄ·Äï·Ä∫·Äô·Äö·Ä∫, Desktop ·Äô·Äæ·Ä¨ ·Ä°·Äú·Äö·Ä∫·Äõ·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äö·Ä∫ -->
        <div
            class="bg-dark-800 w-full sm:max-w-md rounded-t-[30px] sm:rounded-3xl shadow-2xl border-t sm:border border-dark-700 animate-slide-up flex flex-col max-h-[90vh] sm:max-h-[85vh]">

            <!-- 1. STICKY HEADER (·Ä°·Äï·Ä≠·Äê·Ä∫·ÄÅ·Äú·ÄØ·Äê·Ä∫ ·Äí·ÄÆ·Äô·Äæ·Ä¨·Äï·Ä´) -->
            <div
                class="flex justify-between items-center p-5 border-b border-dark-700 bg-dark-800 rounded-t-[30px] sm:rounded-t-3xl sticky top-0 z-10 shrink-0">
                <h3 class="font-bold text-xl text-white">System Settings</h3>
                <button onclick="closeModal('modal-settings')"
                    class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-dark-muted hover:text-white transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- 2. SCROLLABLE CONTENT AREA -->
            <div class="flex-1 overflow-y-auto p-5 space-y-5 custom-scroll">

                <!-- Notification Sound -->
                <div class="flex justify-between items-center p-4 bg-dark-900 rounded-xl border border-dark-700">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-dark-800 flex items-center justify-center text-primary border border-dark-700">
                            <i class="fas fa-volume-up"></i>
                        </div>
                        <div>
                            <p class="font-bold text-white text-sm">Notification Sound</p>
                            <p class="text-[10px] text-dark-muted">Play sound on new order</p>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="chk-sound-enabled" class="sr-only peer"
                            onchange="toggleSoundSetting(this.checked)">
                        <div
                            class="w-11 h-6 bg-dark-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                        </div>
                    </label>
                </div>

                <!-- BILLING SETTINGS -->
                <div class="p-4 bg-dark-900 rounded-xl border border-dark-700 space-y-4">
                    <h4
                        class="font-bold text-white text-sm uppercase tracking-wider border-b border-dark-700 pb-2 mb-2 flex items-center gap-2">
                        <i class="fas fa-file-invoice-dollar text-green-400"></i> Billing Settings
                    </h4>

                    <!-- Tax Type Toggle -->
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-dark-muted">Tax Type</label>
                        <div class="flex bg-dark-800 rounded-lg p-1 border border-dark-600">
                            <button onclick="setTaxType('exclusive')" id="btn-tax-excl"
                                class="px-3 py-1.5 rounded text-[10px] font-bold transition bg-primary text-white">Exclusive
                                (+)</button>
                            <button onclick="setTaxType('inclusive')" id="btn-tax-incl"
                                class="px-3 py-1.5 rounded text-[10px] font-bold transition text-dark-muted hover:text-white">Inclusive
                                (in)</button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-dark-muted">Service Charge (%)</label>
                        <input type="number" id="setting-svc" value="0" onchange="saveGlobalSettings()"
                            class="w-20 bg-dark-800 text-white text-right font-bold border border-dark-600 rounded-lg p-2 outline-none focus:border-primary text-sm">
                    </div>

                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-dark-muted">Global Tax (%)</label>
                        <input type="number" id="setting-tax" value="0" onchange="saveGlobalSettings()"
                            class="w-20 bg-dark-800 text-white text-right font-bold border border-dark-600 rounded-lg p-2 outline-none focus:border-primary text-sm">
                    </div>
                </div>

                <!-- PRINTING SETTINGS -->
                <div class="p-4 bg-dark-900 rounded-xl border border-dark-700 space-y-3">
                    <h4
                        class="font-bold text-white text-sm uppercase tracking-wider border-b border-dark-700 pb-2 mb-2 flex items-center gap-2">
                        <i class="fas fa-print text-blue-400"></i> Printing Settings
                    </h4>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xs font-bold text-white">Ticket Mode</p>
                            <p class="text-[10px] text-dark-muted" id="print-mode-desc">Separate Food & Drink</p>
                        </div>
                        <div class="flex bg-dark-800 rounded-lg p-1 border border-dark-600">
                            <button onclick="setPrintMode('split')" id="btn-print-split"
                                class="px-3 py-1.5 rounded text-[10px] font-bold transition bg-primary text-white">Split</button>
                            <button onclick="setPrintMode('combined')" id="btn-print-combined"
                                class="px-3 py-1.5 rounded text-[10px] font-bold transition text-dark-muted hover:text-white">Combined</button>
                        </div>
                    </div>
                </div>

                <!-- AI SETTINGS -->
                <div class="p-4 bg-dark-900 rounded-xl border border-dark-700 space-y-3">
                    <h4
                        class="font-bold text-white text-sm uppercase tracking-wider border-b border-dark-700 pb-2 mb-2 flex items-center gap-2">
                        <i class="fas fa-robot text-indigo-400"></i> AI Configuration
                    </h4>
                    <div>
                        <label class="text-xs font-bold text-dark-muted block mb-2">Gemini API Key</label>
                        <input type="password" id="setting-ai-key" placeholder="Paste your API Key here"
                            onchange="saveAiSettings()"
                            class="w-full bg-dark-800 text-white text-sm border border-dark-600 rounded-xl p-3 outline-none focus:border-indigo-500 transition">
                        <p class="text-[10px] text-dark-muted mt-2">Get free key from <a
                                href="https://aistudio.google.com/" target="_blank"
                                class="text-indigo-400 underline">Google AI Studio</a></p>
                    </div>
                </div>

                <!-- ALERT TONE SECTION -->
                <div class="pb-6">
                    <p class="text-xs font-bold text-dark-muted uppercase tracking-wider mb-2 ml-1">Alert Tone</p>
                    <div onclick="toggleSoundList()"
                        class="w-full p-4 bg-dark-900 rounded-xl border border-dark-700 flex justify-between items-center cursor-pointer hover:bg-dark-700 transition select-none">
                        <span id="selected-sound-name" class="font-bold text-white text-sm">Select Tone...</span>
                        <i id="sound-chevron"
                            class="fas fa-chevron-down text-dark-muted transition-transform duration-300"></i>
                    </div>

                    <!-- Dropdown List -->
                    <div id="sound-list-container"
                        class="hide mt-2 space-y-2 bg-dark-900 p-2 rounded-xl border border-dark-700">
                        <label
                            class="flex items-center justify-between p-3 rounded-lg cursor-pointer hover:bg-dark-800 transition">
                            <div class="flex items-center gap-3">
                                <input type="radio" name="sound-choice" value="classic" class="accent-primary"
                                    onchange="selectSound('classic', 'Classic Bell üîî')">
                                <span class="text-sm font-bold text-white">Classic Bell üîî</span>
                            </div>
                            <button onclick="event.stopPropagation(); previewSound('classic')"
                                class="text-dark-muted hover:text-white px-2"><i
                                    class="fas fa-play text-xs"></i></button>
                        </label>
                        <label
                            class="flex items-center justify-between p-3 rounded-lg cursor-pointer hover:bg-dark-800 transition">
                            <div class="flex items-center gap-3">
                                <input type="radio" name="sound-choice" value="digital" class="accent-primary"
                                    onchange="selectSound('digital', 'Kitchen Beep üìü')">
                                <span class="text-sm font-bold text-white">Kitchen Beep üìü</span>
                            </div>
                            <button onclick="event.stopPropagation(); previewSound('digital')"
                                class="text-dark-muted hover:text-white px-2"><i
                                    class="fas fa-play text-xs"></i></button>
                        </label>
                        <label
                            class="flex items-center justify-between p-3 rounded-lg cursor-pointer hover:bg-dark-800 transition">
                            <div class="flex items-center gap-3">
                                <input type="radio" name="sound-choice" value="bell_ring" class="accent-primary"
                                    onchange="selectSound('bell_ring', 'Telephone üìû')">
                                <span class="text-sm font-bold text-white">Telephone üìû</span>
                            </div>
                            <button onclick="event.stopPropagation(); previewSound('bell_ring')"
                                class="text-dark-muted hover:text-white px-2"><i
                                    class="fas fa-play text-xs"></i></button>
                        </label>
                        <!-- Add more sounds as needed -->
                    </div>
                </div>
            </div>

            <!-- Footer for Mobile Safe Area -->
            <div class="p-4 bg-dark-800 border-t border-dark-700 pb-safe sm:hidden">
                <button onclick="closeModal('modal-settings')"
                    class="w-full bg-dark-700 text-white py-3 rounded-xl font-bold">Done</button>
            </div>
        </div>
    </div>
    <!-- Category Modal (Mobile) -->
    <div id="modal-category"
        class="fixed inset-0 bg-black/80 z-[100] hide flex items-end sm:items-center justify-center">
        <div
            class="bg-dark-800 w-full sm:w-[450px] sm:rounded-3xl rounded-t-[30px] shadow-2xl animate-slide-up overflow-hidden flex flex-col max-h-[70vh] border-t border-dark-700 sm:border">
            <div class="p-5 border-b border-dark-700 flex justify-between items-center bg-dark-800">
                <h3 class="font-bold text-lg text-white" data-i18n="select_category">Select Category</h3>
                <button onclick="closeModal('modal-category')"
                    class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-dark-muted hover:text-white hover:bg-dark-600 transition"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="p-5 grid grid-cols-2 gap-3 overflow-y-auto" id="modal-cat-grid"></div>
        </div>
    </div>

    <!-- REDESIGNED Login Modal (Keypad) -->
    <div id="modal-login"
        class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[100] hide flex items-center justify-center p-4">
        <div
            class="bg-dark-800 w-full max-w-xs rounded-[30px] shadow-2xl p-8 text-center animate-slide-up border border-dark-700 flex flex-col items-center">
            <!-- Lock Icon -->
            <div
                class="w-16 h-16 rounded-full bg-dark-700 flex items-center justify-center text-dark-muted mb-4 shadow-inner">
                <i class="fas fa-lock text-2xl"></i>
            </div>

            <h3 class="font-bold text-xl mb-1 text-white" data-i18n="staff_access">Admin Access</h3>
            <p class="text-xs text-dark-muted mb-6">Enter PIN to access kitchen display</p>

            <!-- Hidden Input for Logic -->
            <input type="password" id="staff-pin" class="hidden">

            <!-- Visual PIN Display -->
            <div id="pin-display" class="flex gap-4 justify-center mb-8">
                <div class="w-3 h-3 rounded-full bg-dark-700 transition-colors duration-200"></div>
                <div class="w-3 h-3 rounded-full bg-dark-700 transition-colors duration-200"></div>
                <div class="w-3 h-3 rounded-full bg-dark-700 transition-colors duration-200"></div>
                <div class="w-3 h-3 rounded-full bg-dark-700 transition-colors duration-200"></div>
            </div>

            <!-- Keypad Grid -->
            <div class="grid grid-cols-3 gap-3 w-full mb-4">
                <button onclick="handlePinInput(1)" class="keypad-btn">1</button>
                <button onclick="handlePinInput(2)" class="keypad-btn">2</button>
                <button onclick="handlePinInput(3)" class="keypad-btn">3</button>
                <button onclick="handlePinInput(4)" class="keypad-btn">4</button>
                <button onclick="handlePinInput(5)" class="keypad-btn">5</button>
                <button onclick="handlePinInput(6)" class="keypad-btn">6</button>
                <button onclick="handlePinInput(7)" class="keypad-btn">7</button>
                <button onclick="handlePinInput(8)" class="keypad-btn">8</button>
                <button onclick="handlePinInput(9)" class="keypad-btn">9</button>
                <button onclick="closeModal('modal-login')"
                    class="text-red-500 font-bold text-xs uppercase hover:text-red-400">Cancel</button>
                <button onclick="handlePinInput(0)" class="keypad-btn">0</button>
                <button onclick="handlePinInput('back')"
                    class="text-dark-muted hover:text-white flex items-center justify-center"><i
                        class="fas fa-backspace"></i></button>
            </div>
        </div>
    </div>

    <!-- Change PIN Modal -->
    <div id="modal-change-pin"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hide flex items-center justify-center p-4">
        <div
            class="bg-dark-800 w-full max-w-xs rounded-[30px] shadow-2xl p-6 text-center animate-slide-up border border-dark-700">
            <h3 class="font-bold text-lg mb-4 text-white" data-i18n="update_pin">Update PIN</h3>
            <input type="tel" id="new-pin-input"
                class="border-2 border-dark-700 bg-dark-900 text-white p-3 rounded-2xl w-full text-center font-bold text-2xl tracking-[0.5em] mb-6 outline-none focus:border-primary placeholder-dark-700"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
            <button onclick="saveNewPin()"
                class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-lg mb-3 hover:bg-red-600 transition"
                data-i18n="save_pin">Save New PIN</button>
            <button onclick="closeModal('modal-change-pin')"
                class="text-dark-muted text-xs font-bold py-2 hover:text-white" data-i18n="cancel">Cancel</button>
        </div>
    </div>

    <!-- NEW Add Expense Modal -->
    <div id="modal-add-expense"
        class="fixed inset-0 bg-black/80 z-[100] hide flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-dark-800 w-full max-w-xs rounded-3xl shadow-2xl p-6 border border-dark-700 animate-slide-up">
            <h3 class="font-bold text-xl text-white mb-6">Add Expense</h3>

            <div class="space-y-4">
                <div>
                    <label class="form-label">Title</label>
                    <input id="modal-exp-title" placeholder="e.g., Market Shopping"
                        class="w-full p-3 rounded-xl border border-dark-700 bg-dark-900 text-white placeholder-dark-600 focus:border-primary outline-none transition">
                </div>
                <div>
                    <label class="form-label">Amount</label>
                    <input id="modal-exp-amount" type="number" placeholder="0"
                        class="w-full p-3 rounded-xl border border-dark-700 bg-dark-900 text-white placeholder-dark-600 focus:border-primary outline-none transition">
                </div>
                <div>
                    <label class="form-label">Note (Optional)</label>
                    <textarea id="modal-exp-note" rows="3"
                        class="w-full p-3 rounded-xl border border-dark-700 bg-dark-900 text-white placeholder-dark-600 focus:border-primary outline-none resize-none transition"></textarea>
                </div>

                <button onclick="saveExpenseFromModal()"
                    class="w-full bg-red-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-red-500 transition active:scale-[0.98]">Save
                    Expense</button>
                <button onclick="closeModal('modal-add-expense')"
                    class="w-full text-dark-muted text-xs font-bold py-2 hover:text-white">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Product Details -->
    <div id="modal-product"
        class="fixed inset-0 bg-black/80 z-[100] hide flex items-end sm:items-center justify-center">
        <div
            class="bg-dark-800 w-full sm:w-[450px] sm:rounded-3xl rounded-t-[30px] shadow-2xl animate-slide-up overflow-hidden max-h-[90vh] flex flex-col border-t border-dark-700 sm:border">
            <div class="h-56 relative shrink-0 group">
                <img id="mp-img" src="" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-dark-900 via-transparent to-transparent"></div>
                <button onclick="closeModal('modal-product')"
                    class="absolute top-4 right-4 w-8 h-8 bg-black/40 text-white rounded-full flex items-center justify-center backdrop-blur-md z-10 hover:bg-black/60"><i
                        class="fas fa-times"></i></button>
                <div class="absolute bottom-4 left-6 right-6 text-white">
                    <h3 id="mp-name" class="text-2xl font-bold leading-tight drop-shadow-md">Product</h3>
                    <span id="mp-price-display"
                        class="inline-block mt-2 bg-primary text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">0
                        Ks</span>
                </div>
            </div>

            <div class="p-6 overflow-y-auto bg-dark-800 flex-1">
                <div class="mb-4">
                    <!-- SIZES SECTION -->
                    <div id="size-selection-container" class="hide mb-4">
                        <p class="text-[10px] font-bold text-dark-muted uppercase tracking-widest mb-3">Select Size</p>
                        <div id="dynamic-sizes" class="flex flex-wrap gap-2"></div>
                    </div>

                    <p class="text-[10px] font-bold text-dark-muted uppercase tracking-widest mb-3"
                        data-i18n="customize">Customize Order</p>
                    <div id="dynamic-options" class="grid grid-cols-2 gap-3 mb-4"></div>

                    <p class="text-[10px] font-bold text-dark-muted uppercase tracking-widest mb-2" data-i18n="remarks">
                        Special Requests</p>
                    <textarea id="prod-remark"
                        class="w-full bg-dark-900 border border-dark-700 rounded-xl p-3 text-white text-sm focus:border-primary outline-none resize-none placeholder-dark-700 transition focus:ring-1 focus:ring-primary"
                        rows="2" placeholder="e.g., Less oil, Allergy info..."></textarea>
                </div>
            </div>

            <div class="p-4 border-t border-dark-700 bg-dark-800 pb-8 sm:pb-4">
                <div class="flex items-center gap-3">
                    <div class="flex items-center bg-dark-900 border border-dark-700 rounded-2xl p-1 h-14">
                        <button onclick="updateQty(-1)"
                            class="w-12 h-full flex items-center justify-center text-dark-muted font-bold active:scale-90 transition hover:text-white">-</button>
                        <span id="mp-qty" class="w-8 text-center font-bold text-xl text-white">1</span>
                        <button onclick="updateQty(1)"
                            class="w-12 h-full flex items-center justify-center text-white font-bold active:scale-90 transition hover:text-primary">+</button>
                    </div>
                    <button onclick="addToCart()"
                        class="flex-1 bg-white text-dark-900 h-14 rounded-2xl font-bold shadow-lg shadow-white/10 active:scale-[0.98] transition flex justify-between items-center px-6 hover:bg-gray-100">
                        <span data-i18n="add_to_order">Add to Order</span>
                        <div
                            class="bg-dark-900 text-white w-8 h-8 rounded-full flex items-center justify-center text-xs">
                            <i class="fas fa-plus"></i>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Modal (Redesigned) -->
    <div id="modal-checkout"
        class="fixed inset-0 bg-black/80 z-[100] hide flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div
            class="bg-dark-800 w-full sm:w-[450px] sm:rounded-3xl rounded-t-[30px] shadow-2xl animate-slide-up overflow-hidden flex flex-col max-h-[90vh] border-t border-dark-700 sm:border relative">

            <!-- Header Area -->
            <div class="px-5 py-4 border-b border-dark-700 bg-dark-800 shrink-0 z-20 relative">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <h3 class="font-bold text-xl text-white" data-i18n="your_tray">Your Tray</h3>
                        <!-- Member Name will appear here -->
                        <p id="checkout-subtitle" class="text-xs text-dark-muted mt-0.5">Check your items</p>
                    </div>
                    <button onclick="closeModal('modal-checkout')"
                        class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-dark-muted hover:text-white transition"><i
                            class="fas fa-times"></i></button>
                </div>

                <!-- Control Row: Order Type + Member Button -->
                <div class="flex gap-2">
                    <!-- Order Type Toggle -->
                    <div class="flex-1 bg-dark-900 p-1 rounded-xl flex border border-dark-700">
                        <button onclick="setOrderType('dine_in')" id="btn-type-dine"
                            class="flex-1 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 bg-primary text-white shadow-md">
                            <i class="fas fa-utensils"></i> <span data-i18n="dine_in">Dine In</span>
                        </button>
                        <button onclick="setOrderType('takeaway')" id="btn-type-take"
                            class="flex-1 py-2 rounded-lg text-xs font-bold text-dark-muted hover:text-white transition flex items-center justify-center gap-2">
                            <i class="fas fa-shopping-bag"></i> <span data-i18n="takeaway">Takeaway</span>
                        </button>
                    </div>

                    <!-- Member Button (Compact) -->
                    <button id="btn-member-toggle" onclick="window.openMemberModal()"
                        class="w-[42px] rounded-xl bg-dark-900 border border-dark-700 text-dark-muted flex items-center justify-center hover:bg-dark-700 hover:text-white transition relative group"
                        title="Add Member">
                        <i class="fas fa-user-plus"></i>
                        <!-- Active Indicator Dot -->
                        <div id="mem-active-dot"
                            class="hide absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full shadow-lg shadow-green-500/50">
                        </div>
                    </button>
                </div>
            </div>

            <!-- Item List (Expanded Space) -->
            <div id="checkout-items"
                class="p-4 overflow-y-auto flex-1 space-y-3 bg-dark-900 custom-scroll pb-24 relative">
                <!-- Items injected via JS -->
            </div>

            <!-- FLOATING AI SUGGESTION (Moved Up) -->
            <div id="ai-upsell-container" class="hide absolute bottom-[160px] right-4 z-40 animate-slide-up">

                <!-- Main Bubble Container -->
                <div
                    class="cursor-move flex items-center gap-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-1.5 pr-3 rounded-full shadow-[0_8px_25px_rgba(79,70,229,0.6)] border border-indigo-400/50 backdrop-blur-md hover:scale-105 transition-transform duration-300">

                    <!-- 1. Icon Circle -->
                    <div
                        class="w-10 h-10 rounded-full bg-white text-indigo-600 flex items-center justify-center shrink-0 shadow-sm">
                        <i class="fas fa-sparkles animate-pulse text-sm"></i>
                    </div>

                    <!-- 2. Text Area -->
                    <div class="flex flex-col leading-none mr-1">
                        <span class="text-[8px] text-indigo-200 font-bold uppercase tracking-wider mb-0.5">AI
                            Suggests</span>
                        <span id="ai-upsell-text" class="text-xs font-bold truncate max-w-[120px]">Thinking...</span>
                    </div>

                    <!-- 3. Add Button -->
                    <button id="btn-add-upsell"
                        class="w-8 h-8 rounded-full bg-white/20 hover:bg-white hover:text-indigo-600 flex items-center justify-center transition active:scale-90 border border-white/30 backdrop-blur-sm"
                        title="Add Item">
                        <i class="fas fa-plus text-xs"></i>
                    </button>

                    <!-- 4. Close Button -->
                    <button onclick="document.getElementById('ai-upsell-container').classList.add('hide')"
                        class="absolute -top-1.5 -right-1 w-5 h-5 bg-dark-900 text-dark-muted hover:text-white rounded-full flex items-center justify-center text-[10px] border border-dark-600 shadow-md transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <!-- Footer Area (Totals) -->
            <div class="p-4 bg-dark-800 border-t border-dark-700 z-20 shadow-[0_-4px_20px_rgba(0,0,0,0.3)]">

                <!-- Compact Discount Row -->
                <div id="checkout-discount-container"
                    class="flex items-center gap-2 mb-3 bg-dark-900/50 p-1.5 rounded-lg border border-dark-700">
                    <div class="flex items-center gap-2 mr-auto px-1">
                        <i class="fas fa-percent text-xs text-red-400"></i>
                        <span class="text-[10px] font-bold text-dark-muted uppercase">Bill Discount</span>
                    </div>
                    <div class="flex bg-dark-800 rounded-md p-0.5 border border-dark-600 scale-90">
                        <button onclick="window.setBillDiscType('percent')" id="btn-bd-percent"
                            class="px-2 py-1 rounded text-[10px] font-bold transition bg-primary text-white shadow">%</button>
                        <button onclick="window.setBillDiscType('fixed')" id="btn-bd-fixed"
                            class="px-2 py-1 rounded text-[10px] font-bold transition text-dark-muted hover:text-white">Amt</button>
                    </div>
                    <input type="number" id="input-bill-disc" placeholder="0" oninput="window.updateCheckoutTotals()"
                        class="w-16 bg-dark-800 border border-dark-600 rounded text-right text-white font-bold p-1 focus:border-primary outline-none text-xs">
                </div>

                <!-- Totals Grid -->
                <div class="grid grid-cols-2 gap-x-4 gap-y-1 mb-4 text-xs">
                    <div class="flex justify-between items-center text-dark-muted"><span>Subtotal</span><span
                            id="checkout-subtotal" class="font-bold text-white">0 Ks</span></div>
                    <div class="flex justify-between items-center text-green-400/80"><span>Item Disc</span><span
                            id="checkout-item-disc">-0 Ks</span></div>
                    <div class="flex justify-between items-center text-green-500 font-bold"><span>Bill Disc</span><span
                            id="checkout-bill-disc">-0 Ks</span></div>
                    <div id="row-checkout-svc" class="flex justify-between items-center text-orange-400 hide"><span
                            id="label-checkout-svc">Service</span><span id="checkout-svc-val">+0 Ks</span></div>
                    <div
                        class="flex justify-between items-center text-red-400 col-span-2 border-t border-dashed border-dark-700 pt-1 mt-1">
                        <span id="label-checkout-tax">Tax</span><span id="checkout-tax-val">+0 Ks</span>
                    </div>
                </div>

                <!-- Grand Total & Confirm -->
                <div class="flex gap-3 items-center">
                    <div class="flex-1">
                        <p class="text-[10px] text-dark-muted font-bold uppercase">Total Amount</p>
                        <p id="checkout-grand-total" class="text-2xl font-extrabold text-white leading-none">0 Ks</p>
                    </div>
                    <button onclick="submitOrder()"
                        class="flex-[1.5] bg-gradient-to-r from-primary to-red-600 text-white h-12 rounded-xl font-bold shadow-lg shadow-red-500/30 active:scale-[0.98] transition flex justify-center items-center gap-2 hover:brightness-110">
                        <span data-i18n="confirm">Confirm</span> <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- === MODAL: CRM / MEMBER SYSTEM === -->
    <div id="modal-member"
        class="fixed inset-0 bg-black/80 z-[140] hide flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-dark-800 w-full max-w-sm rounded-[30px] shadow-2xl p-6 border border-dark-700 animate-slide-up">

            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 id="mem-modal-title" class="font-bold text-lg text-white">Member Lookup</h3>
                    <p id="mem-modal-desc" class="text-xs text-dark-muted">Search or Register Customer</p>
                </div>
                <button onclick="closeModal('modal-member')" class="text-dark-muted hover:text-white"><i
                        class="fas fa-times"></i></button>
            </div>

            <!-- Search Input -->
            <div class="flex gap-2 mb-6">
                <input type="tel" id="mem-search-phone" placeholder="Phone (e.g. 09...)"
                    class="flex-1 p-3 rounded-xl border border-dark-700 bg-dark-900 text-white placeholder-dark-600 focus:border-primary outline-none font-mono font-bold text-lg tracking-wide">
                <button onclick="window.searchMember()"
                    class="bg-primary text-white w-12 rounded-xl flex items-center justify-center shadow-lg hover:bg-red-600 transition active:scale-95">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <!-- Result Area (·Äê·ÄΩ·Ä±·Ä∑·Äõ·ÄÑ·Ä∫ ·Äï·Ä±·Ä´·Ä∫·Äô·Äö·Ä∫) -->
            <div id="mem-result-area"
                class="hide bg-dark-900/50 p-4 rounded-xl border border-dark-700 mb-4 text-center animate-slide-up">
                <div
                    class="w-12 h-12 rounded-full bg-green-900/30 text-green-400 mx-auto flex items-center justify-center mb-2 border border-green-500/30">
                    <i class="fas fa-user-check text-xl"></i>
                </div>
                <h3 class="font-bold text-white text-lg" id="mem-res-name">User Name</h3>
                <p class="text-xs text-dark-muted font-mono mb-3" id="mem-res-phone">09xxxxxxxxx</p>

                <div class="flex justify-center gap-2 mb-4">
                    <div class="bg-dark-800 px-3 py-1.5 rounded-lg border border-dark-600 flex items-center gap-2">
                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                        <span class="text-sm font-bold text-white"><span id="mem-res-points">0</span> Pts</span>
                    </div>
                    <div class="bg-dark-800 px-3 py-1.5 rounded-lg border border-dark-600">
                        <span class="text-xs font-bold text-dark-muted" id="mem-res-visits">0 Visits</span>
                    </div>
                </div>

                <button onclick="window.selectMemberForOrder()"
                    class="w-full py-3 bg-green-600 text-white rounded-xl text-sm font-bold hover:bg-green-500 transition shadow-lg">
                    Use This Member
                </button>
            </div>

            <!-- Register Form (·Äô·Äê·ÄΩ·Ä±·Ä∑·Äõ·ÄÑ·Ä∫ ·Äï·Ä±·Ä´·Ä∫·Äô·Äö·Ä∫) -->
            <div id="mem-register-form" class="hide animate-slide-up">
                <div class="text-center mb-4">
                    <p class="text-xs text-red-400 font-bold bg-red-900/10 py-1 px-2 rounded-lg inline-block">User not
                        found</p>
                </div>
                <div class="space-y-3">
                    <label class="form-label">Register New Name</label>
                    <input id="new-mem-name" placeholder="Enter Customer Name"
                        class="w-full p-3 rounded-xl border border-dark-700 bg-dark-900 text-white outline-none focus:border-primary transition">
                    <button onclick="window.registerMember()"
                        class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-500 transition shadow-lg">
                        Register & Select
                    </button>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-qr" class="fixed inset-0 bg-black/80 z-[100] hide flex items-center justify-center p-4">
        <div class="bg-dark-800 w-full max-w-sm rounded-3xl p-6 text-center animate-slide-up border border-dark-700">
            <h3 class="font-bold text-lg mb-4 text-white" data-i18n="table_qr">Table QR</h3>
            <input type="number" id="qr-table-num" value="1"
                class="border-2 border-dark-700 bg-dark-900 text-white p-3 rounded-xl w-full text-center font-bold text-xl mb-4 focus:border-primary outline-none">
            <button onclick="generateQR()"
                class="w-full bg-white text-dark-900 py-3 rounded-xl font-bold mb-4 shadow-lg hover:bg-gray-200 transition"
                data-i18n="generate">Generate</button>
            <div id="qr-container" class="bg-white rounded-xl p-4 flex justify-center mb-4 min-h-[150px]"></div>
            <button onclick="printQR()" class="text-primary font-bold text-sm hover:underline"
                data-i18n="print_qr">Print QR Code</button>
            <button onclick="closeModal('modal-qr')" class="block w-full mt-4 text-dark-muted text-xs hover:text-white"
                data-i18n="close">Close</button>
        </div>
    </div>

    <!-- Hidden Receipt -->
    <div id="receipt-print-area" class="hide font-mono text-sm p-4 bg-white max-w-[300px]">
        <!-- Receipt Content Injected via JS -->
    </div>

    <!-- === MODAL: ANALYTICS DETAIL === -->
    <div id="modal-analytics-detail"
        class="fixed inset-0 bg-black/80 z-[100] hide flex items-end sm:items-center justify-center">
        <div
            class="bg-dark-800 w-full sm:w-[600px] sm:rounded-3xl rounded-t-[30px] shadow-2xl animate-slide-up overflow-hidden flex flex-col max-h-[85vh] border-t border-dark-700 sm:border">
            <div class="p-5 border-b border-dark-700 flex justify-between items-center bg-dark-800">
                <h3 class="font-bold text-xl text-white" id="detail-modal-title">Detail List</h3>
                <button onclick="closeModal('modal-analytics-detail')"
                    class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-dark-muted hover:text-white hover:bg-dark-600 transition"><i
                        class="fas fa-times"></i></button>
            </div>

            <div class="p-4 overflow-y-auto flex-1 bg-dark-900">
                <div id="detail-modal-content" class="space-y-3">
                    <!-- Detailed list items (orders or items) will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- === NEW MODAL: TRANSFER TABLE (UPDATED) === -->
    <!-- === NEW MODAL: TRANSFER / MERGE TABLE (UPDATED) === -->
    <div id="modal-transfer"
        class="fixed inset-0 bg-black/80 z-[110] hide flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-dark-800 w-full max-w-sm rounded-[30px] shadow-2xl p-6 border border-dark-700 animate-slide-up">
            <h3 class="font-bold text-lg text-white mb-1" data-i18n="transfer_table">Update Order</h3>
            <p class="text-[10px] text-dark-muted mb-4 uppercase tracking-widest">Transfer or Merge Order</p>

            <div class="mb-4">
                <label class="form-label">Update Type</label>
                <div class="flex bg-dark-900 p-1 rounded-xl border border-dark-700">
                    <button id="update-mode-transfer" onclick="window.setUpdateMode('transfer')"
                        class="flex-1 py-2 rounded-lg text-[10px] font-bold bg-dark-700 text-white shadow-sm transition uppercase">Transfer
                        (T-X)</button>
                    <button id="update-mode-merge" onclick="window.setUpdateMode('merge')"
                        class="flex-1 py-2 rounded-lg text-[10px] font-bold text-dark-muted hover:text-white transition uppercase">Merge
                        Into</button>
                </div>
            </div>

            <label class="form-label">Order Type</label>
            <div class="flex bg-dark-900 p-1 rounded-xl border border-dark-700 mb-4">
                <button id="tfr-type-dine" onclick="window.selectTransferType('dine_in')"
                    class="flex-1 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2">
                    <i class="fas fa-utensils"></i> <span data-i18n="dine_in">Dine In</span>
                </button>
                <button id="tfr-type-take" onclick="window.selectTransferType('takeaway')"
                    class="flex-1 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2">
                    <i class="fas fa-shopping-bag"></i> <span data-i18n="takeaway">Takeaway</span>
                </button>
            </div>

            <label class="form-label">Select Target Table</label>
            <div class="max-h-48 overflow-y-auto grid grid-cols-4 gap-2 mb-6 p-1 scrollbar-hide border border-dark-700/50 rounded-xl bg-dark-900/50"
                id="transfer-tables-grid">
            </div>

            <div class="flex gap-3 pt-2">
                <button onclick="closeModal('modal-transfer')"
                    class="flex-1 py-3 bg-dark-700 text-white rounded-xl font-bold text-sm"
                    data-i18n="cancel">Cancel</button>
                <button id="btn-confirm-transfer" onclick="window.executeTransfer()"
                    class="flex-1 py-3 bg-primary text-white rounded-xl font-bold text-sm shadow-lg hover:bg-red-600 transition"
                    data-i18n="confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- NEW MODAL: PAYMENT SELECTION (NEW FEATURE) -->
    <div id="modal-payment-selection"
        class="fixed inset-0 bg-black/80 z-[110] hide flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-dark-800 w-full max-w-xs rounded-[30px] shadow-2xl p-6 border border-dark-700 animate-slide-up">
            <h3 class="font-bold text-lg text-white mb-1">Confirm Payment</h3>
            <p class="text-[10px] text-dark-muted mb-4 uppercase tracking-widest">Select payment method to finish</p>

            <div class="space-y-2 mb-6">
                <button onclick="window.confirmServedWithPayment('Cash')"
                    class="w-full py-3 bg-green-600/20 text-green-400 border border-green-500/30 rounded-xl font-bold text-sm hover:bg-green-600 hover:text-white transition flex items-center justify-center gap-2"><i
                        class="fas fa-money-bill-wave"></i> Cash</button>
                <button onclick="window.confirmServedWithPayment('Bank Transfer')"
                    class="w-full py-3 bg-blue-600/20 text-blue-400 border border-blue-500/30 rounded-xl font-bold text-sm hover:bg-blue-600 hover:text-white transition flex items-center justify-center gap-2"><i
                        class="fas fa-university"></i> Bank Transfer</button>
                <button onclick="window.confirmServedWithPayment('Visa / Card')"
                    class="w-full py-3 bg-indigo-600/20 text-indigo-400 border border-indigo-500/30 rounded-xl font-bold text-sm hover:bg-indigo-600 hover:text-white transition flex items-center justify-center gap-2"><i
                        class="fas fa-credit-card"></i> Visa / Card</button>
                <button onclick="window.confirmServedWithPayment('Other')"
                    class="w-full py-3 bg-gray-700/50 text-gray-300 border border-gray-600 rounded-xl font-bold text-sm hover:bg-gray-600 hover:text-white transition flex items-center justify-center gap-2"><i
                        class="fas fa-wallet"></i> Other</button>
            </div>

            <button onclick="closeModal('modal-payment-selection')"
                class="w-full text-dark-muted text-xs font-bold py-2 hover:text-white">Cancel</button>
        </div>
    </div>

    <!-- === UPDATED MODAL: ADVANCED BILLING (SPLIT ITEMS & EVEN SPLIT) === -->
    <div id="modal-advanced-billing"
        class="fixed inset-0 bg-black/80 z-[120] hide flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-dark-800 w-full max-w-md rounded-[30px] shadow-2xl p-6 border border-dark-700 animate-slide-up flex flex-col max-h-[90vh]">

            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-white" id="adv-billing-title">Split Bill</h3>
                <button onclick="closeModal('modal-advanced-billing')" class="text-dark-muted hover:text-white"><i
                        class="fas fa-times"></i></button>
            </div>

            <!-- TAB NAVIGATION -->
            <div class="flex bg-dark-900 p-1 rounded-xl border border-dark-700 mb-4 shrink-0">
                <button onclick="window.switchSplitTab('items')" id="tab-split-items"
                    class="flex-1 py-2 rounded-lg text-xs font-bold bg-dark-700 text-white shadow-sm transition">
                    By Items
                </button>
                <button onclick="window.switchSplitTab('even')" id="tab-split-even"
                    class="flex-1 py-2 rounded-lg text-xs font-bold text-dark-muted hover:text-white transition">
                    Even Split (By Pax)
                </button>
            </div>

            <!-- VIEW 1: SPLIT BY ITEMS (Existing Logic) -->
            <div id="view-split-items" class="flex-1 flex flex-col overflow-hidden">
                <p class="text-[10px] text-dark-muted mb-2 uppercase tracking-widest">Select items to move</p>
                <div id="split-items-list" class="flex-1 overflow-y-auto space-y-2 mb-4 pr-2 custom-scroll">
                    <!-- Items injected via JS -->
                </div>

                <div class="border-t border-dark-700 pt-4 space-y-4 shrink-0">
                    <div>
                        <label class="form-label">Target Table</label>
                        <div id="adv-target-tables"
                            class="grid grid-cols-5 gap-2 max-h-24 overflow-y-auto p-1 bg-dark-900/50 rounded-xl border border-dark-700/50">
                            <!-- Tables injected via JS -->
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="window.executeSplitBill('split')"
                            class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold text-xs hover:bg-indigo-500 shadow-lg transition">
                            <i class="fas fa-columns mr-1"></i> Split to New Bill
                        </button>
                        <button onclick="window.executeSplitBill('transfer')"
                            class="flex-1 py-3 bg-orange-600 text-white rounded-xl font-bold text-xs hover:bg-orange-500 shadow-lg transition">
                            <i class="fas fa-exchange-alt mr-1"></i> Transfer
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: EVEN SPLIT (New Logic) -->
            <div id="view-split-even" class="flex-1 flex flex-col hide">
                <div class="flex-1 flex flex-col items-center justify-center p-4">
                    <div class="w-full bg-dark-900 rounded-2xl p-5 border border-dark-700 mb-6 text-center">
                        <p class="text-dark-muted text-xs font-bold uppercase mb-2">Total Amount</p>
                        <h2 class="text-3xl font-extrabold text-white mb-1" id="even-split-total">0 Ks</h2>
                    </div>

                    <div class="flex items-center gap-4 mb-6">
                        <button onclick="window.updatePax(-1)"
                            class="w-12 h-12 rounded-full bg-dark-700 text-white text-xl font-bold border border-dark-600 hover:bg-dark-600 transition">-</button>
                        <div class="text-center">
                            <span class="text-4xl font-bold text-primary" id="even-split-pax">2</span>
                            <p class="text-[10px] text-dark-muted uppercase font-bold tracking-widest">People</p>
                        </div>
                        <button onclick="window.updatePax(1)"
                            class="w-12 h-12 rounded-full bg-dark-700 text-white text-xl font-bold border border-dark-600 hover:bg-dark-600 transition">+</button>
                    </div>

                    <div
                        class="w-full bg-indigo-900/20 rounded-2xl p-5 border border-indigo-500/30 text-center animate-pulse">
                        <p class="text-indigo-300 text-xs font-bold uppercase mb-1">Amount Per Person</p>
                        <h2 class="text-2xl font-extrabold text-indigo-400" id="even-split-per-person">0 Ks</h2>
                    </div>
                </div>

                <div class="border-t border-dark-700 pt-4 shrink-0">
                    <p class="text-[10px] text-center text-dark-muted mb-3 italic">This will create separate bills for
                        separate payments.</p>
                    <button onclick="window.executeEvenSplit()"
                        class="w-full py-4 bg-primary text-white rounded-xl font-bold text-sm shadow-lg hover:bg-red-600 transition flex items-center justify-center gap-2">
                        <i class="fas fa-check-circle"></i> Confirm Even Split
                    </button>
                </div>
            </div>

        </div>
    </div>
    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, setDoc, getDoc, serverTimestamp, writeBatch, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Canvas Animation Script (Injected)
        (function () {
            const canvas = document.getElementById('bg-canvas');
            const ctx = canvas.getContext('2d');
            let width, height;
            let particles = [];

            function resize() {
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;
            }

            class Particle {
                constructor() {
                    this.x = Math.random() * width;
                    this.y = Math.random() * height;
                    this.vx = (Math.random() - 0.5) * 1.5;
                    this.vy = (Math.random() - 0.5) * 1.5;
                    this.size = Math.random() * 1.5;
                }
                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    if (this.x < 0) this.x = width;
                    if (this.x > width) this.x = 0;
                    if (this.y < 0) this.y = height;
                    if (this.y > height) this.y = 0;
                }
                draw() {
                    ctx.fillStyle = 'rgba(255, 71, 87, 0.4)';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            function initParticles() {
                resize();
                for (let i = 0; i < 60; i++) particles.push(new Particle());
                animate();
            }

            function animate() {
                ctx.clearRect(0, 0, width, height);
                particles.forEach(p => { p.update(); p.draw(); });

                // Draw connections
                particles.forEach((p, i) => {
                    for (let j = i + 1; j < particles.length; j++) {
                        const dx = p.x - particles[j].x;
                        const dy = p.y - particles[j].y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < 120) {
                            ctx.strokeStyle = `rgba(255, 255, 255, ${0.05 - dist / 2400})`;
                            ctx.lineWidth = 0.5;
                            ctx.beginPath();
                            ctx.moveTo(p.x, p.y);
                            ctx.lineTo(particles[j].x, particles[j].y);
                            ctx.stroke();
                        }
                    }
                });
                requestAnimationFrame(animate);
            }

            window.addEventListener('resize', resize);
            initParticles();
        })();

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyB0TsIVnLIWIOukeT_ddLwA9xMki50H1yE",
            authDomain: "pingpos.firebaseapp.com",
            projectId: "pingpos",
            storageBucket: "pingpos.firebasestorage.app",
            messagingSenderId: "328655511392",
            appId: "1:328655511392:web:f6232b5a3003bef5454805",
            measurementId: "G-QP50T36M1W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'pingpos-production';

        // Error Handler
        window.onerror = function (msg, url, line) {
            console.error(`Error: ${msg} at ${line}`);
        };

        // AUDIO SYSTEM - UPDATED
        const sounds = {
            classic: 'https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3', // Desk Bell
            digital: 'https://assets.mixkit.co/active_storage/sfx/1862/1862-preview.mp3', // Kitchen Beep
            soft: 'https://assets.mixkit.co/active_storage/sfx/2559/2559-preview.mp3',    // Soft Chime
            chime_up: 'https://assets.mixkit.co/active_storage/sfx/2744/2744-preview.mp3', // Positive Chime
            clash: 'https://assets.mixkit.co/active_storage/sfx/2908/2908-preview.mp3',    // Metal Clash
            pop_alert: 'https://assets.mixkit.co/active_storage/sfx/2405/2405-preview.mp3', // Pop Alert
            bell_ring: 'https://assets.mixkit.co/active_storage/sfx/1206/1206-preview.mp3', // Telephone Ring
            fanfare: 'https://assets.mixkit.co/active_storage/sfx/2850/2850-preview.mp3', // Triumphal Ding
            cute_jingle: 'https://assets.mixkit.co/active_storage/sfx/3506/3506-preview.mp3', // Cute Music
            victory_song: 'https://assets.mixkit.co/active_storage/sfx/1310/1310-preview.mp3' // Cute Song / Victory
        };

        let soundState = {
            enabled: localStorage.getItem('pingpos_sound_enabled') !== 'false',
            choice: localStorage.getItem('pingpos_sound_choice') || 'classic',
            isPlaying: false
        };

        const audioEl = document.getElementById('notif-sound');
        audioEl.src = sounds[soundState.choice];

        window.startIncomingOrderAlert = () => {
            if (!soundState.enabled || soundState.isPlaying) return;
            soundState.isPlaying = true;
            document.getElementById('silence-btn').classList.remove('hide');
            audioEl.currentTime = 0;
            audioEl.loop = true;
            audioEl.play().catch(e => console.log("Audio play failed:", e));
        };

        window.stopIncomingOrderAlert = () => {
            soundState.isPlaying = false;
            audioEl.pause();
            audioEl.currentTime = 0;
            audioEl.loop = false;
            document.getElementById('silence-btn').classList.add('hide');
        };

        // playSingleBeep disabled for non-essential actions as requested
        window.playSingleBeep = () => { };

        // Settings Modal ·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äê·Ä≤·Ä∑·Ä°·ÄÅ·Ä´ ·Ä°·Äú·ÄØ·Äï·Ä∫·Äú·ÄØ·Äï·Ä∫·Äô·Ää·Ä∑·Ä∫ Function
        window.openSettingsModal = () => {
            // ·ÅÅ. Modal ·ÄÄ·Ä≠·ÄØ ·Äñ·Ä±·Ä¨·Ä∫·Äô·Äö·Ä∫
            document.getElementById('modal-settings').classList.remove('hide');

            // ·ÅÇ. ·Ä°·Äû·Ä∂·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫/·Äï·Ä≠·Äê·Ä∫ ·ÄÅ·Äú·ÄØ·Äê·Ä∫·ÄÄ·Ä≠·ÄØ ·ÄÅ·Äª·Ä≠·Äî·Ä∫·Ää·Äæ·Ä≠·Äô·Äö·Ä∫
            document.getElementById('chk-sound-enabled').checked = soundState.enabled;

            // ·ÅÉ. ·Äú·ÄÄ·Ä∫·Äõ·Äæ·Ä≠ ·Äõ·ÄΩ·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äê·Ä≤·Ä∑ ·Ä°·Äû·Ä∂ (soundState.choice) ·Äî·Ä≤·Ä∑ ·Äê·Ä∞·Äê·Ä≤·Ä∑ Radio Button ·ÄÄ·Ä≠·ÄØ ·Äõ·Äæ·Ä¨·Äô·Äö·Ä∫
            const radio = document.querySelector(`input[name="sound-choice"][value="${soundState.choice}"]`);

            if (radio) {
                // Radio ·ÄÄ·Ä≠·ÄØ checked ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
                radio.checked = true;

                // ·Ä°·Äõ·Ä±·Ä∏·ÄÄ·Äº·ÄÆ·Ä∏·Äû·Ää·Ä∫ - Radio ·Äò·Ä±·Ä∏·Äî·Ä¨·Ä∏·ÄÄ ·ÄÖ·Ä¨·Äû·Ä¨·Ä∏ (span tag) ·ÄÄ·Ä≠·ÄØ ·Äö·Ä∞·Äï·Äº·ÄÆ·Ä∏ Header ·Äô·Äæ·Ä¨ ·Äï·Äº·Äô·Äö·Ä∫
                // HTML ·Äô·Äæ·Ä¨ <input> ·Äï·Äº·ÄÆ·Ä∏·Äõ·ÄÑ·Ä∫ <span> ·Äú·Ä¨·Äê·Ä¨·Äô·Ä≠·ÄØ·Ä∑ nextElementSibling ·ÄÄ·Ä≠·ÄØ ·Äû·ÄØ·Ä∂·Ä∏·Äï·Ä´·Äê·Äö·Ä∫
                const soundLabelName = radio.nextElementSibling.innerText;
                document.getElementById('selected-sound-name').innerText = soundLabelName;
            }

            // ·ÅÑ. Modal ·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äê·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ Dropdown ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ ·Äï·Ä≠·Äê·Ä∫·Äë·Ä¨·Ä∏·Äô·Äö·Ä∫ (·Äô·Äï·ÄΩ·ÄÑ·Ä∑·Ä∫·Äî·Ä±·ÄÖ·Ä±·ÄÅ·Äª·ÄÑ·Ä∫·Äú·Ä≠·ÄØ·Ä∑·Äï·Ä´)
            document.getElementById('sound-list-container').classList.add('hide');
            document.getElementById('sound-chevron').style.transform = 'rotate(0deg)';
        };
        window.toggleSoundSetting = (val) => {
            soundState.enabled = val;
            localStorage.setItem('pingpos_sound_enabled', val);
            if (!val) window.stopIncomingOrderAlert();
        };

        // 1. Load Settings
        function loadGlobalSettings() {
            const savedTax = localStorage.getItem('pingpos_tax');
            const savedSvc = localStorage.getItem('pingpos_svc');
            const savedType = localStorage.getItem('pingpos_tax_type'); // New

            state.globalSettings.tax = savedTax ? parseFloat(savedTax) : 0;
            state.globalSettings.serviceCharge = savedSvc ? parseFloat(savedSvc) : 0;
            state.globalSettings.taxType = savedType || 'exclusive'; // New

            // UI Update
            const taxInput = document.getElementById('setting-tax');
            const svcInput = document.getElementById('setting-svc');
            if (taxInput) taxInput.value = state.globalSettings.tax;
            if (svcInput) svcInput.value = state.globalSettings.serviceCharge;

            // Update Toggle Button UI
            updateTaxTypeUI();

            // loadGlobalSettings function ·Äõ·Ä≤·Ä∑ ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏·Äî·Ä¨·Ä∏·Äô·Äæ·Ä¨ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´
            const savedPrintMode = localStorage.getItem('pingpos_print_mode');
            state.globalSettings.printMode = savedPrintMode || 'split';
            updatePrintModeUI();
        }
        // Function ·Ä°·Äû·ÄÖ·Ä∫·Äô·Äª·Ä¨·Ä∏ (Settings Load/Save ·Äî·Ä±·Äõ·Ä¨·Äî·Ä¨·Ä∏·Äô·Äæ·Ä¨ ·Äë·Ä¨·Ä∏·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫)
        window.setPrintMode = (mode) => {
            state.globalSettings.printMode = mode;
            localStorage.setItem('pingpos_print_mode', mode);
            updatePrintModeUI();
            window.renderAdminOrders(); // ·ÄÅ·Äú·ÄØ·Äê·Ä∫·Äî·Äæ·Ä≠·Äï·Ä∫·Äê·Ä¨·Äî·Ä≤·Ä∑ Order ·Äê·ÄΩ·Ä±·Äõ·Ä≤·Ä∑ ·Äï·ÄØ·Ä∂·ÄÖ·Ä∂·Äï·Ä´ ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äû·ÄΩ·Ä¨·Ä∏·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·Äú·ÄØ·Äï·Ä∫·Äê·Ä¨·Äï·Ä´
        };

        function updatePrintModeUI() {
            const mode = state.globalSettings.printMode;
            const btnSplit = document.getElementById('btn-print-split');
            const btnComb = document.getElementById('btn-print-combined');
            const desc = document.getElementById('print-mode-desc');

            if (mode === 'combined') {
                btnComb.className = "px-3 py-1.5 rounded text-[10px] font-bold transition bg-primary text-white shadow";
                btnSplit.className = "px-3 py-1.5 rounded text-[10px] font-bold transition text-dark-muted hover:text-white";
                desc.innerText = "All items in one ticket";
            } else {
                btnSplit.className = "px-3 py-1.5 rounded text-[10px] font-bold transition bg-primary text-white shadow";
                btnComb.className = "px-3 py-1.5 rounded text-[10px] font-bold transition text-dark-muted hover:text-white";
                desc.innerText = "Separate Food & Drink";
            }
        }

        // Helper to switch tax type
        window.setTaxType = (type) => {
            state.globalSettings.taxType = type;
            updateTaxTypeUI();
            saveGlobalSettings();
        };

        function updateTaxTypeUI() {
            const btnExcl = document.getElementById('btn-tax-excl');
            const btnIncl = document.getElementById('btn-tax-incl');
            if (state.globalSettings.taxType === 'inclusive') {
                btnIncl.className = "px-2 py-1 rounded text-[10px] font-bold transition bg-primary text-white shadow";
                btnExcl.className = "px-2 py-1 rounded text-[10px] font-bold transition text-dark-muted hover:text-white";
            } else {
                btnExcl.className = "px-2 py-1 rounded text-[10px] font-bold transition bg-primary text-white shadow";
                btnIncl.className = "px-2 py-1 rounded text-[10px] font-bold transition text-dark-muted hover:text-white";
            }
        }

        // 2. Save Settings
        window.saveGlobalSettings = () => {
            const taxVal = document.getElementById('setting-tax').value;
            const svcVal = document.getElementById('setting-svc').value;

            state.globalSettings.tax = parseFloat(taxVal) || 0;
            state.globalSettings.serviceCharge = parseFloat(svcVal) || 0;
            // taxType is already updated by setTaxType, but we save everything now

            localStorage.setItem('pingpos_tax', state.globalSettings.tax);
            localStorage.setItem('pingpos_svc', state.globalSettings.serviceCharge);
            localStorage.setItem('pingpos_tax_type', state.globalSettings.taxType);

            window.showMessage("Billing Settings Saved", "success");
        };
        // init() function ·Äë·Ä≤·Äô·Äæ·Ä¨ loadGlobalSettings(); ·ÄÄ·Ä≠·ÄØ ·ÄÅ·Ä±·Ä´·Ä∫·Äï·Ä±·Ä∏·Äõ·Äï·Ä´·Äô·Äö·Ä∫·Åã
        // async function init() { ... } ·Äë·Ä≤·ÄÄ updateContent(); ·Äõ·Ä≤·Ä∑ ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·Äî·Ä¨·Ä∏·Äô·Äæ·Ä¨ ·Äë·Ää·Ä∑·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´·Åã

        // ·Ä°·Äû·Ä∂·Äõ·ÄΩ·Ä±·Ä∏·ÄÅ·Äª·Äö·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äê·Ä≤·Ä∑·Ä°·ÄÅ·Ä´ ·Ä°·Äú·ÄØ·Äï·Ä∫·Äú·ÄØ·Äï·Ä∫·Äô·Ää·Ä∑·Ä∫ Function
        window.selectSound = (val, name) => {
            // ·ÅÅ. State ·Äë·Ä≤·Äô·Äæ·Ä¨ ·Äê·Äî·Ä∫·Äñ·Ä≠·ÄØ·Ä∏·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äô·Äö·Ä∫
            soundState.choice = val;
            localStorage.setItem('pingpos_sound_choice', val);

            // ·ÅÇ. Audio Source ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äô·Äö·Ä∫
            audioEl.src = sounds[val];

            // ·ÅÉ. Dropdown ·ÄÅ·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·ÄÖ·Äâ·Ä∫ (Header) ·Äô·Äæ·Ä¨ ·Äõ·ÄΩ·Ä±·Ä∏·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äê·Ä≤·Ä∑ ·Äî·Ä¨·Äô·Ää·Ä∫·ÄÄ·Ä≠·ÄØ ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äô·Äö·Ä∫
            // HTML ·Äë·Ä≤·Äô·Äæ·Ä¨ onchange="selectSound('classic', 'Classic Bell üîî')" ·Äú·Ä≠·ÄØ·Ä∑ ·Äõ·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äú·Ä≠·ÄØ·Ä∑ name ·Äï·Ä´·Äú·Ä¨·Äï·Ä´·Äú·Ä≠·Äô·Ä∑·Ä∫·Äô·Äö·Ä∫
            if (name) {
                document.getElementById('selected-sound-name').innerText = name;
            }

            // ·ÅÑ. (·ÄÖ·Ä≠·Äê·Ä∫·ÄÄ·Äº·Ä≠·ÄØ·ÄÄ·Ä∫) ·Äõ·ÄΩ·Ä±·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äê·Ä¨·Äî·Ä≤·Ä∑ List ·ÄÄ·Ä≠·ÄØ ·Äï·Äº·Äî·Ä∫·Äï·Ä≠·Äê·Ä∫·ÄÅ·Äª·ÄÑ·Ä∫·Äõ·ÄÑ·Ä∫ ·Äí·ÄÆ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·ÄÄ ·ÅÇ ·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ Comment ·Äï·Äº·Äî·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äï·Ä´
            // document.getElementById('sound-list-container').classList.add('hide');
            // document.getElementById('sound-chevron').style.transform = 'rotate(0deg)';
        };
        // Dropdown ·Ä°·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫/·Ä°·Äï·Ä≠·Äê·Ä∫ ·Äú·ÄØ·Äï·Ä∫·Äô·Ää·Ä∑·Ä∫ Function
        window.toggleSoundList = () => {
            const list = document.getElementById('sound-list-container');
            const chevron = document.getElementById('sound-chevron'); // ·Äô·Äº·Äæ·Ä¨·Ä∏ Icon

            if (list.classList.contains('hide')) {
                // ·Äï·Ä≠·Äê·Ä∫·Äî·Ä±·Äõ·ÄÑ·Ä∫ ·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äô·Äö·Ä∫
                list.classList.remove('hide');
                list.classList.add('animate-slide-up'); // Animation ·Äë·Ää·Ä∑·Ä∫·Äô·Äö·Ä∫
                chevron.style.transform = 'rotate(180deg)'; // ·Äô·Äº·Äæ·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·Ä°·Äï·Ä±·Ä´·Ä∫·Äú·Äæ·Äî·Ä∫·Äô·Äö·Ä∫
            } else {
                // ·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äî·Ä±·Äõ·ÄÑ·Ä∫ ·Äï·Ä≠·Äê·Ä∫·Äô·Äö·Ä∫
                list.classList.add('hide');
                chevron.style.transform = 'rotate(0deg)'; // ·Äô·Äº·Äæ·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·Äï·Äº·Äî·Ä∫·Äú·Äæ·Ää·Ä∑·Ä∫·Äô·Äö·Ä∫
            }
        };
        window.previewSound = (val) => {
            const preview = new Audio(sounds[val]);
            preview.play().catch(() => { });
        };

        // TRANSLATION DATA
        const resources = {
            en: {
                dine_in: "Dine In", takeaway: "Takeaway", hero_title: "Hungry? üòã", hero_subtitle: "Order something good!", table: "TABLE", loading: "Loading Menu...", no_items: "No items available yet.", total: "TOTAL", view_order: "VIEW ORDER", kitchen_display: "Kitchen Display", kitchen_clear: "Kitchen is clear", exit: "Exit", menu: "Menu", select_category: "Select Category", staff_access: "Staff Access", staff_only: "Kitchen Management Only", login: "Login", cancel: "Cancel", update_pin: "Update PIN", save_pin: "Save New PIN", customize: "Customize Order", add_to_order: "Add to Order", your_tray: "Your Tray", check_items: "Check your items", total_amount: "Total Amount", confirm: "Confirm", menu_manager: "Menu Manager", add_item: "Add Item", update_item: "Update Item", cancel_edit: "Cancel Edit", analytics: "Analytics", overview: "Overview", history: "History", top_items: "Top Items", date: "Date:", total_revenue: "Total Revenue", total_orders: "Total Orders", orders_selected: "Orders for Selected Date", clear_all: "Clear All", time: "Time", top_selected: "Top Items for Selected Date", table_qr: "Table QR", generate: "Generate", print_qr: "Print QR Code", close: "Close", more: "More", hourly_sales: "Sales Trend", category_sales: "Category Sales", order_type: "Order Type", sold_out: "SOLD OUT", available: "Available", pos_mode: "POS Mode", table_map: "Table Layout", select_table_msg: "Select a table to take order", free: "Free", occupied: "Occupied", remarks: "Special Requests", cancelled: "Cancelled", daily: "Daily", weekly: "Weekly", monthly: "Monthly", yearly: "Yearly",
                Fried: "Fried", Curry: "Curry", Soup: "Soup", Salad: "Salad", Rice: "Rice", Noodle: "Noodle", Dessert: "Dessert", Drink: "Drink", Other: "Other", All: "All", view_list: "View List", view_chart: "View Chart", cancelled_orders: "Cancelled Orders", category_manager: "Category Manager", search_history_placeholder: "Search by Order ID/Table ID (e.g., #A12B or T-1)",
                expenses: "Expenses", add_expense: "Add Expense", net_profit: "Net Profit", cogs: "COGS",
                confirmation: "Confirmation", admin_action: "Admin Action Required", cancel_confirm: "Cancel Order?", remove_confirm: "Remove Item?", delete_confirm: "Delete Record?", delete_all_confirm: "Delete All History?", delete_category_confirm: "Delete Category?", delete_table_confirm: "Delete Table?", pin_prompt: "Enter PIN", saved_pin_success: "New PIN Saved", wrong_pin: "Wrong PIN", min_4_digits: "Min 4 digits required", cleared_success: "History Cleared", action_failed: "Action Failed", error: "Error",
                transfer_table: "Transfer Order", select_target_table: "Select Target Table"
            },
            my: {
                dine_in: "·Äë·Äô·ÄÑ·Ä∫·Ä∏·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤", takeaway: "·Äï·Ä´·ÄÜ·Äö·Ä∫", hero_title: "·Äó·Ä≠·ÄØ·ÄÄ·Ä∫·ÄÜ·Ä¨·Äî·Ä±·Äú·Ä¨·Ä∏? üòã", hero_subtitle: "·Ä°·Äõ·Äû·Ä¨·Äõ·Äæ·Ä≠·Äê·Ä¨·Äú·Ä±·Ä∏ ·Äô·Äæ·Ä¨·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´!", table: "·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤", loading: "·Äô·ÄÆ·Äî·Ä∞·Ä∏·Äô·Äª·Ä¨·Ä∏ ·Äê·ÄÑ·Ä∫·Äî·Ä±·Äû·Ää·Ä∫...", no_items: "·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏ ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´·Åã", total: "·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏", view_order: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫", kitchen_display: "·Äô·ÄÆ·Ä∏·Äñ·Ä≠·ÄØ·ÄÅ·Äª·Ä±·Ä¨·ÄÑ·Ä∫ ·Äñ·Äî·Ä∫·Äû·Ä¨·Ä∏·Äï·Äº·ÄÑ·Ä∫", kitchen_clear: "·Äô·ÄÆ·Ä∏·Äñ·Ä≠·ÄØ·ÄÅ·Äª·Ä±·Ä¨·ÄÑ·Ä∫ ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏·Äû·Ää·Ä∫", exit: "·Äë·ÄΩ·ÄÄ·Ä∫·Äõ·Äî·Ä∫", menu: "·Äô·ÄÆ·Äî·Ä∞·Ä∏", select_category: "·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏ ·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´", staff_access: "·Äù·Äî·Ä∫·Äë·Äô·Ä∫·Ä∏ ·Äù·ÄÑ·Ä∫·Äõ·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äæ·ÄØ", staff_only: "·Äô·ÄÆ·Ä∏·Äñ·Ä≠·ÄØ·ÄÅ·Äª·Ä±·Ä¨·ÄÑ·Ä∫ ·ÄÖ·ÄÆ·Äô·Ä∂·ÄÅ·Äî·Ä∑·Ä∫·ÄÅ·ÄΩ·Ä≤·Äõ·Ä±·Ä∏·Äû·Ä¨", login: "·Äù·ÄÑ·Ä∫·Äô·Ää·Ä∫", cancel: "·Äñ·Äª·ÄÄ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Ää·Ä∫", update_pin: "PIN ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äú·Ä≤·Äô·Ää·Ä∫", save_pin: "PIN ·Ä°·Äû·ÄÖ·Ä∫ ·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Ää·Ä∫", customize: "·ÄÖ·Ä≠·Äê·Ä∫·ÄÄ·Äº·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·Äô·Ää·Ä∫", add_to_order: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ·Äê·ÄΩ·ÄÑ·Ä∫ ·Äë·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫", your_tray: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨ ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏", check_items: "·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏·Äï·Ä´", total_amount: "·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ ·ÄÑ·ÄΩ·Ä±·Äï·Äô·Ä¨·Äè", confirm: "·Ä°·Äê·Ää·Ä∫·Äï·Äº·ÄØ·Äô·Ää·Ä∫", menu_manager: "·Äô·ÄÆ·Äî·Ä∞·Ä∏ ·ÄÖ·ÄÆ·Äô·Ä∂·ÄÅ·Äî·Ä∑·Ä∫·ÄÅ·ÄΩ·Ä≤·Äô·Äæ·ÄØ", add_item: "·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Ä°·Äû·ÄÖ·Ä∫ ·Äë·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫", update_item: "·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏ ·Äï·Äº·ÄÑ·Ä∫·Äô·Ää·Ä∫", cancel_edit: "·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·Äô·Äæ·ÄØ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Ää·Ä∫", analytics: "·ÄÅ·ÄΩ·Ä≤·ÄÅ·Äº·Äô·Ä∫·Ä∏·ÄÖ·Ä≠·Äê·Ä∫·Äñ·Äº·Ä¨·ÄÅ·Äª·ÄÄ·Ä∫", overview: "·Ä°·ÄÄ·Äª·Äâ·Ä∫·Ä∏·ÄÅ·Äª·ÄØ·Äï·Ä∫", history: "·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏", top_items: "·Ä°·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·ÄÜ·ÄØ·Ä∂·Ä∏ ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏", date: "·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤:", total_revenue: "·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ ·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±", total_orders: "·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ ·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ", orders_selected: "·Äõ·ÄΩ·Ä±·Ä∏·ÄÅ·Äª·Äö·Ä∫·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨ ·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ·Äô·Äª·Ä¨·Ä∏", clear_all: "·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Ää·Ä∫", time: "·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫", top_selected: "·Ä°·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·ÄÜ·ÄØ·Ä∂·Ä∏ ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏", table_qr: "·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤ QR", generate: "·Äë·ÄØ·Äê·Ä∫·Äú·ÄØ·Äï·Ä∫·Äô·Ää·Ä∫", print_qr: "QR Code ·Äï·ÄØ·Ä∂·Äî·Äæ·Ä≠·Äï·Ä∫·Äô·Ää·Ä∫", close: "·Äï·Ä≠·Äê·Ä∫·Äô·Ää·Ä∫", more: "·Äï·Ä≠·ÄØ·Äô·Ä≠·ÄØ", hourly_sales: "·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Ä°·Ä¨·Ä∏ ·Ä°·ÄÅ·Äº·Ä±·Ä°·Äî·Ä±", category_sales: "·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏·Ä°·Äú·Ä≠·ÄØ·ÄÄ·Ä∫ ·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Ä°·Ä¨·Ä∏", order_type: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏", sold_out: "·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·ÄÄ·ÄØ·Äî·Ä∫", available: "·Äõ·Äõ·Äæ·Ä≠·Äî·Ä≠·ÄØ·ÄÑ·Ä∫", pos_mode: "POS ·ÄÖ·Äî·ÄÖ·Ä∫", table_map: "·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤ Layout", select_table_msg: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äõ·Äî·Ä∫ ·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤ ·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´", free: "·Äú·ÄΩ·Äê·Ä∫", occupied: "·Äô·Ä°·Ä¨·Ä∏·Äû·Ä±·Ä∏", remarks: "·Ä°·Äë·Ä∞·Ä∏ ·Äô·Äæ·Äê·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫", cancelled: "·Äñ·Äª·ÄÄ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏", daily: "·Äî·Ä±·Ä∑·ÄÖ·Äâ·Ä∫", weekly: "·Ä°·Äï·Äê·Ä∫·ÄÖ·Äâ·Ä∫", monthly: "·Äú·ÄÖ·Äâ·Ä∫", yearly: "·Äî·Äæ·ÄÖ·Ä∫·ÄÖ·Äâ·Ä∫",
                Fried: "·ÄÄ·Äº·Ä±·Ä¨·Ä∫", Curry: "·Äü·ÄÑ·Ä∫·Ä∏", Soup: "·ÄÖ·ÄΩ·Äï·Ä∫·Äï·Äº·ÄØ·Äê·Ä∫", Salad: "·Äû·ÄØ·Äï·Ä∫", Rice: "·Äë·Äô·ÄÑ·Ä∫·Ä∏", Noodle: "·ÄÅ·Ä±·Ä´·ÄÄ·Ä∫·ÄÜ·ÄΩ·Ä≤", Dessert: "·Ä°·ÄÅ·Äª·Ä≠·ÄØ·Äï·ÄΩ·Ä≤", Drink: "·Ä°·Äñ·Äª·Ä±·Ä¨·Ä∫·Äö·Äô·ÄÄ·Ä¨", Other: "·Ä°·ÄÅ·Äº·Ä¨·Ä∏", All: "·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏", view_list: "·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫", view_chart: "·Äá·Äö·Ä¨·Ä∏·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫", cancelled_orders: "·Äñ·Äª·ÄÄ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äû·Ä±·Ä¨ ·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ·Äô·Äª·Ä¨·Ä∏", category_manager: "·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏ ·ÄÖ·ÄÆ·Äô·Ä∂·ÄÅ·Äî·Ä∑·Ä∫·ÄÅ·ÄΩ·Ä≤·Äô·Äæ·ÄØ", search_history_placeholder: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·Äî·Ä∂·Äï·Ä´·Äê·Ä∫/·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤·Äî·Ä∂·Äï·Ä´·Äê·Ä∫ ·Äñ·Äº·ÄÑ·Ä∑·Ä∫ ·Äõ·Äæ·Ä¨·Äñ·ÄΩ·Ä±·Äï·Ä´ (·Ä•·Äï·Äô·Ä¨: #A12B ·Äû·Ä≠·ÄØ·Ä∑·Äô·Äü·ÄØ·Äê·Ä∫ T-1)",
                expenses: "·Ä°·Äû·ÄØ·Ä∂·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫·Äô·Äª·Ä¨·Ä∏", add_expense: "·Ä°·Äû·ÄØ·Ä∂·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫ ·Äë·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫", net_profit: "·Ä°·Äû·Ä¨·Ä∏·Äê·ÄÑ·Ä∫ ·Ä°·Äô·Äº·Äê·Ä∫", cogs: "·Ä°·Äõ·ÄÑ·Ä∫·Ä∏",
                confirmation: "·Ä°·Äê·Ää·Ä∫·Äï·Äº·ÄØ·ÄÅ·Äª·ÄÄ·Ä∫", admin_action: "·ÄÖ·ÄÆ·Äô·Ä∂·ÄÅ·Äî·Ä∑·Ä∫·ÄÅ·ÄΩ·Ä≤·Äû·Ä∞ ·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫ ·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫", cancel_confirm: "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·Äñ·Äª·ÄÄ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Äú·Ä¨·Ä∏?", remove_confirm: "·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äñ·Äö·Ä∫·Äõ·Äæ·Ä¨·Ä∏·Äô·Äú·Ä¨·Ä∏?", delete_confirm: "·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äú·Ä¨·Ä∏?", delete_all_confirm: "·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äú·Ä¨·Ä∏?", delete_category_confirm: "·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äú·Ä¨·Ä∏?", delete_table_confirm: "·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äú·Ä¨·Ä∏?", pin_prompt: "PIN ·Äî·Ä∂·Äï·Ä´·Äê·Ä∫ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´", saved_pin_success: "PIN ·Ä°·Äû·ÄÖ·Ä∫ ·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏", wrong_pin: "PIN ·Äî·Ä∂·Äï·Ä´·Äê·Ä∫ ·Äô·Äæ·Ä¨·Ä∏·Äö·ÄΩ·ÄÑ·Ä∫·Ä∏", min_4_digits: "·Ä°·Äî·Ää·Ä∫·Ä∏·ÄÜ·ÄØ·Ä∂·Ä∏ ·ÄÇ·Äè·Äî·Ä∫·Ä∏ ·ÅÑ ·Äú·ÄØ·Ä∂·Ä∏ ·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫·Äû·Ää·Ä∫", cleared_success: "·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏ ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏", action_failed: "·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫ ·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´", error: "·Ä°·Äô·Äæ·Ä¨·Ä∏",
                transfer_table: "·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤/·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏ ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äô·Ää·Ä∫", select_target_table: "·Äõ·ÄΩ·Äæ·Ä±·Ä∑·Äô·Ää·Ä∑·Ä∫·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´"
            },
            cn: {
                dine_in: "Â†ÇÈ£ü", takeaway: "Â§ñÂ∏¶", hero_title: "È•ø‰∫ÜÂêó? üòã", hero_subtitle: "ÁÇπ‰∫õÂ•ΩÂêÉÁöÑÂêß!", table: "Ê°åÂè∑", loading: "Ê≠£Âú®Âä†ËΩΩËèúÂçï...", no_items: "ÊöÇÊó†ÂïÜÂìÅ„ÄÇ", total: "ÊÄªËÆ°", view_order: "Êü•ÁúãËÆ¢Âçï", kitchen_display: "Âé®ÊàøÊòæÁ§∫Â±è", kitchen_clear: "Âé®ÊàøÊ∏ÖÁêÜÂÆåÊØï", exit: "ÈÄÄÂá∫", menu: "ËèúÂçï", select_category: "ÈÄâÊã©Á±ªÂà´", staff_access: "ÂëòÂ∑•ÈÄöÈÅì", staff_only: "‰ªÖÈôêÂé®ÊàøÁÆ°ÁêÜ", login: "ÁôªÂΩï", cancel: "ÂèñÊ∂à", update_pin: "Êõ¥Êñ∞ÂØÜÁ†Å", save_pin: "‰øùÂ≠òÊñ∞ÂØÜÁ†Å", customize: "ÂÆöÂà∂ËÆ¢Âçï", add_to_order: "Ê∑ªÂä†Âà∞ËÆ¢Âçï", your_tray: "ÊÇ®ÁöÑÈ§êÁõò", check_items: "Ê£ÄÊü•ÊÇ®ÁöÑÂïÜÂìÅ", total_amount: "ÊÄªÈáëÈ¢ù", confirm: "Á°ÆËÆ§", menu_manager: "ËèúÂçïÁÆ°ÁêÜ", add_item: "Ê∑ªÂä†ÂïÜÂìÅ", update_item: "Êõ¥Êñ∞ÂïÜÂìÅ", cancel_edit: "ÂèñÊ∂àÁºñËæë", analytics: "Êï∞ÊçÆÂàÜÊûê", overview: "ÊÄªËßà", history: "ÂéÜÂè≤ËÆ∞ÂΩï", top_items: "ÁïÖÈîÄÂïÜÂìÅ", date: "Êó•Êúü:", total_revenue: "ÊÄªÊî∂ÂÖ•", total_orders: "ÊÄªËÆ¢Âçï", orders_selected: "ÊâÄÈÄâÊúüÈó¥ÁöÑËÆ¢Âçï", clear_all: "Ê∏ÖÈô§ÊâÄÊúâ", time: "Êó∂Èó¥", top_selected: "ÊâÄÈÄâÊúüÈó¥ÁöÑÁïÖÈîÄÂïÜÂìÅ", table_qr: "Ê°åÂè∑‰∫åÁª¥Á†Å", generate: "ÁîüÊàê", print_qr: "ÊâìÂç∞‰∫åÁª¥Á†Å", close: "ÂÖ≥Èó≠", more: "Êõ¥Â§ö", hourly_sales: "ÈîÄÂîÆË∂ãÂäø", category_sales: "Á±ªÂà´ÈîÄÂîÆ", order_type: "ËÆ¢ÂçïÁ±ªÂûã", sold_out: "Â∑≤ÂîÆÁΩÑ", available: "ÊúâË¥ß", pos_mode: "POSÊ®°Âºè", table_map: "È§êÊ°åÂ∏ÉÂ±Ä", select_table_msg: "ÈÄâÊã©‰∏ÄÂº†Ê°åÂ≠êÂºÄÂßãÁÇπÈ§ê", free: "Á©∫Èó≤", occupied: "Âç†Áî®", remarks: "ÁâπÊÆäË¶ÅÊ±Ç", cancelled: "Â∑≤ÂèñÊ∂à", daily: "ÊØèÊó•", weekly: "ÊØèÂë®", monthly: "ÊØèÊúà", yearly: "ÊØèÂπ¥",
                Fried: "Ê≤πÁÇ∏", Curry: "ÂíñÂñ±", Soup: "Ê±§Á±ª", Salad: "Ê≤ôÊãâ", Rice: "Á±≥È•≠", Noodle: "Èù¢È£ü", Dessert: "ÁîúÁÇπ", Drink: "È•ÆÊñô", Other: "ÂÖ∂‰ªñ", All: "ÂÖ®ÈÉ®", view_list: "Êü•ÁúãÂàóË°®", view_chart: "Êü•ÁúãÂõæË°®", cancelled_orders: "Â∑≤ÂèñÊ∂àÁöÑËÆ¢Âçï", category_manager: "Á±ªÂà´ÁÆ°ÁêÜ", search_history_placeholder: "ÊåâËÆ¢Âçï/Ê°åÂè∑ÊêúÁ¥¢ (‰æãÂ¶Ç: #A12B Êàñ T-1)",
                expenses: "ÂºÄÊîØ", add_expense: "Ê∑ªÂä†Ë¥πÁî®", net_profit: "ÂáÄÂà©Ê∂¶", cogs: "ÊàêÊú¨",
                confirmation: "Á°ÆËÆ§", admin_action: "ÈúÄË¶ÅÁÆ°ÁêÜÂëòÊìç‰Ωú", cancel_confirm: "ÂèñÊ∂àËÆ¢Âçï?", remove_confirm: "Âà†Èô§ÂïÜÂìÅ?", delete_confirm: "Âà†Èô§ËÆ∞ÂΩï?", delete_all_confirm: "Âà†Èô§ÊâÄÊúâËÆ∞ÂΩï?", delete_category_confirm: "Âà†Èô§Á±ªÂà´?", delete_table_confirm: "Âà†Èô§Ê°åÂ≠ê?", pin_prompt: "ËæìÂÖ•ÂØÜÁ†Å", saved_pin_success: "Êñ∞ÂØÜÁ†ÅÂ∑≤‰øùÂ≠ò", wrong_pin: "ÂØÜÁ†ÅÈîôËØØ", min_4_digits: "ÊúÄÂ∞ë 4 ‰ΩçÊï∞Â≠ó", cleared_success: "ËÆ∞ÂΩïÂ∑≤Ê∏ÖÈô§", action_failed: "Êìç‰ΩúÂ§±Ë¥•", error: "ÈîôËØØ",
                transfer_table: "ËΩ¨Âçï", select_target_table: "ÈÄâÊã©ÁõÆÊ†áÊ°åÂè∑"
            },
            ms: {
                dine_in: "Makan Di Sini", takeaway: "Bawa Pulang", hero_title: "Lapar? üòã", hero_subtitle: "Pesanlah sesuatu yang enak!", table: "MEJA", loading: "Memuatkan Menu...", no_items: "Tiada barang tersedia.", total: "JUMLAH", view_order: "Lihat Pesanan", kitchen_display: "Paparan Dapur", kitchen_clear: "Dapur sudah sedia", exit: "Keluar", menu: "Menu", select_category: "Pilih Kategori", staff_access: "Akses Staf", staff_only: "Pengurusan Dapur Sahaja", login: "Log Masuk", cancel: "Batal", update_pin: "Kemas Kini PIN", save_pin: "Simpan PIN Baru", customize: "Sesuaikan Pesanan", add_to_order: "Tambah ke Pesanan", your_tray: "Dulang Anda", check_items: "Semak barang anda", total_amount: "Jumlah Amaun", confirm: "Sahkan", menu_manager: "Pengurus Menu", add_item: "Tambah Item", update_item: "Kemas Kini Item", cancel_edit: "Batal Suntingan", analytics: "Analitik", overview: "Gambaran Keseluruhan", history: "Sejarah", top_items: "Item Teratas", date: "Tarikh:", total_revenue: "Jumlah Hasil", total_orders: "Jumlah Pesanan", orders_selected: "Pesanan untuk Tempoh Dipilih", clear_all: "Padam Semua", time: "Masa", top_selected: "Item Teratas untuk Tempoh Dipilih", table_qr: "QR Meja", generate: "Jana", print_qr: "Cetak Kod QR", close: "Tutup", more: "Lebih Lanjut", hourly_sales: "Trend Jualan", category_sales: "Jualan Kategori", order_type: "Jenis Pesanan", sold_out: "HABIS DIJUAL", available: "Tersedia", pos_mode: "Mod POS", table_map: "Susun Atur Meja", select_table_msg: "Pilih meja untuk ambil pesanan", free: "Kosong", occupied: "Berisi", remarks: "Permintaan Khas", cancelled: "Dibatalkan", daily: "Harian", weekly: "Mingguan", monthly: "Bulanan", yearly: "Tahunan",
                Fried: "Goreng", Curry: "Kari", Soup: "Sup", Salad: "Salad", Rice: "Nasi", Noodle: "Mee", Dessert: "Pencuci Mulut", Drink: "Minuman", Other: "Lain-lain", All: "Semua", view_list: "Lihat Senarai", view_chart: "Lihat Carta", cancelled_orders: "Pesanan Dibatalkan", category_manager: "Pengurus Kategori", search_history_placeholder: "Cari dengan ID Pesanan/ID Meja (cth: #A12B atau T-1)",
                expenses: "Perbelanjaan", add_expense: "Tambah Perbelanjaan", net_profit: "Untung Bersih", cogs: "Kos Barangan",
                confirmation: "Pengesahan", admin_action: "Tindakan Admin Diperlukan", cancel_confirm: "Batal Pesanan?", remove_confirm: "Buang Item?", delete_confirm: "Padam Rekod?", delete_all_confirm: "Padam Semua Sejarah?", delete_category_confirm: "Padam Kategori?", delete_table_confirm: "Padam Meja?", pin_prompt: "Masukkan PIN", saved_pin_success: "PIN Baru Disimpan", wrong_pin: "PIN Salah", min_4_digits: "Min 4 digit diperlukan", cleared_success: "Sejarah Dikosongkan", action_failed: "Tindakan Gagal", error: "Ralat",
                transfer_table: "Pindah Pesanan", select_target_table: "Pilih Meja Sasaran"
            }
        };

        if (!resources.en.missing_name_price) resources.en.missing_name_price = "Missing Name or Price";
        if (!resources.en.failed) resources.en.failed = "Failed";
        if (!resources.en.removed) resources.en.removed = "Removed!";
        if (!resources.en.cat_empty) resources.en.cat_empty = "Category name cannot be empty.";
        if (!resources.en.cat_exists) resources.en.cat_exists = "Category already exists.";
        if (!resources.en.not_connected) resources.en.not_connected = "Not Connected";
        if (!resources.en.order_sent_success) resources.en.order_sent_success = "Order Sent Successfully!";
        if (!resources.en.wrong_pin) resources.en.wrong_pin = "Wrong PIN";
        if (!resources.en.saved) resources.en.saved = "Saved";
        if (!resources.en.min_4_digits) resources.en.min_4_digits = "Min 4 digits required";
        if (!resources.en.print) resources.en.print = "Print";
        if (!resources.en.print_receipt) resources.en.print_receipt = "Print Receipt";
        if (!resources.en.delete_order) resources.en.delete_order = "Delete Order";
        if (!resources.en.cleared) resources.en.cleared = "Cleared";
        if (!resources.en.kitchen_ticket) resources.en.kitchen_ticket = "Kitchen Ticket";
        if (!resources.en.receipt) resources.en.receipt = "Receipt";
        if (!resources.en.amount) resources.en.amount = "Amt";
        if (!resources.en.order_items) resources.en.order_items = "Order Items";
        if (!resources.en.order) resources.en.order = "Order";
        if (!resources.en.cancelled_items) resources.en.cancelled_items = "Cancelled Items";
        if (!resources.en.items_sold_in) resources.en.items_sold_in = "Items Sold In";
        if (!resources.en.category) resources.en.category = "Category";
        if (!resources.en.sold) resources.en.sold = "sold";
        if (!resources.en.revenue) resources.en.revenue = "Revenue";
        if (!resources.en.no_sales_data) resources.en.no_sales_data = "No sales data for this period";
        if (!resources.en.select_table_to_edit) resources.en.select_table_to_edit = "Select table to edit properties.";
        if (!resources.en.selected_week) resources.en.selected_week = "Selected Week";
        if (!resources.en.cleared_success) resources.en.cleared_success = "Success!";
        if (!resources.en.action_failed) resources.en.action_failed = "Action Failed";
        if (!resources.en.login_success) resources.en.login_success = "Login Successful";
        if (!resources.en.saved_pin_success) resources.en.saved_pin_success = "New PIN Saved";
        if (!resources.en.cannot_delete_default) resources.en.cannot_delete_default = "Cannot delete default categories.";
        if (!resources.en.orders_for) resources.en.orders_for = "Orders for";
        if (!resources.en.no_detailed_records) resources.en.no_detailed_records = "No detailed records found.";

        if (!resources.my.missing_name_price) resources.my.missing_name_price = "·Ä°·Äô·Ää·Ä∫ ·Äû·Ä≠·ÄØ·Ä∑·Äô·Äü·ÄØ·Äê·Ä∫ ·Äà·Ä±·Ä∏·Äî·Äæ·ÄØ·Äî·Ä∫·Ä∏ ·Äô·Äï·Äº·Ää·Ä∑·Ä∫·ÄÖ·ÄØ·Ä∂·Äï·Ä´·Åã";
        if (!resources.my.failed) resources.my.failed = "·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´";
        if (!resources.my.removed) resources.my.removed = "·Äñ·Äö·Ä∫·Äõ·Äæ·Ä¨·Ä∏·Äï·Äº·ÄÆ·Ä∏";
        if (!resources.my.cat_empty) resources.my.cat_empty = "·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏·Ä°·Äô·Ää·Ä∫ ·Äë·Ää·Ä∑·Ä∫·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·Äï·Ä´·Åã";
        if (!resources.my.cat_exists) resources.my.cat_exists = "·Ä§·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏ ·Äõ·Äæ·Ä≠·Äï·Äº·ÄÆ·Ä∏·Äû·Ä¨·Ä∏·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫·Åã";
        if (!resources.my.not_connected) resources.my.not_connected = "·ÄÅ·Äª·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫·Äô·Äë·Ä¨·Ä∏·Äï·Ä´";
        if (!resources.my.order_sent_success) resources.my.order_sent_success = "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·ÄÖ·ÄΩ·Ä¨ ·Äï·Ä±·Ä∏·Äï·Ä≠·ÄØ·Ä∑·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ!";
        if (!resources.my.wrong_pin) resources.my.wrong_pin = "PIN ·Äî·Ä∂·Äï·Ä´·Äê·Ä∫ ·Äô·Äæ·Ä¨·Ä∏·Äö·ÄΩ·ÄÑ·Ä∫·Ä∏";
        if (!resources.my.saved) resources.my.saved = "·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ";
        if (!resources.my.min_4_digits) resources.my.min_4_digits = "·Ä°·Äî·Ää·Ä∫·Ä∏·ÄÜ·ÄØ·Ä∂·Ä∏ ·ÄÇ·Äè·Äî·Ä∫·Ä∏ ·ÅÑ ·Äú·ÄØ·Ä∂·Ä∏ ·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫·Äû·Ää·Ä∫";
        if (!resources.my.print) resources.my.print = "·Äï·ÄØ·Ä∂·Äî·Äæ·Ä≠·Äï·Ä∫·Äõ·Äî·Ä∫";
        if (!resources.my.print_receipt) resources.my.print_receipt = "·ÄÑ·ÄΩ·Ä±·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÅ·Ä∂·Äú·ÄΩ·Äæ·Ä¨ ·Äï·ÄØ·Ä∂·Äî·Äæ·Ä≠·Äï·Ä∫·Äô·Ää·Ä∫";
        if (!resources.my.delete_order) resources.my.delete_order = "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Ää·Ä∫";
        if (!resources.my.cleared) resources.my.cleared = "·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ";
        if (!resources.my.kitchen_ticket) resources.my.kitchen_ticket = "·Äô·ÄÆ·Ä∏·Äñ·Ä≠·ÄØ·ÄÅ·Äª·Ä±·Ä¨·ÄÑ·Ä∫ ·Äú·ÄÄ·Ä∫·Äô·Äæ·Äê·Ä∫";
        if (!resources.my.receipt) resources.my.receipt = "·ÄÑ·ÄΩ·Ä±·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÅ·Ä∂·Äú·ÄΩ·Äæ·Ä¨";
        if (!resources.my.amount) resources.my.amount = "·Äï·Äô·Ä¨·Äè";
        if (!resources.my.order_items) resources.my.order_items = "·Äô·Äæ·Ä¨·Äö·Ä∞·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨ ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏";
        if (!resources.my.order) resources.my.order = "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ";
        if (!resources.my.cancelled_items) resources.my.cancelled_items = "·Äñ·Äª·ÄÄ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏ ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏";
        if (!resources.my.items_sold_in) resources.my.items_sold_in = "·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·Äû·Ää·Ä∑·Ä∫ ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏";
        if (!resources.my.category) resources.my.category = "·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏";
        if (!resources.my.sold) resources.my.sold = "·ÄÅ·ÄØ ·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ";
        if (!resources.my.revenue) resources.my.revenue = "·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±";
        if (!resources.my.no_sales_data) resources.my.no_sales_data = "·Ä§·ÄÄ·Ä¨·Äú·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Ä°·Ä¨·Ä∏·Äí·Ä±·Äê·Ä¨ ·Äô·Äõ·Äæ·Ä≠·Äï·Ä´·Åã";
        if (!resources.my.select_table_to_edit) resources.my.select_table_to_edit = "·Äï·Äº·ÄÑ·Ä∫·Äõ·Äî·Ä∫ ·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤ ·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´·Åã";
        if (!resources.my.selected_week) resources.my.selected_week = "·Äõ·ÄΩ·Ä±·Ä∏·ÄÅ·Äª·Äö·Ä∫·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨ ·Ä°·Äï·Äê·Ä∫";
        if (!resources.my.cleared_success) resources.my.cleared_success = "·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äû·Ää·Ä∫!";
        if (!resources.my.action_failed) resources.my.action_failed = "·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫ ·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´";
        if (!resources.my.login_success) resources.my.login_success = "Login ·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫";
        if (!resources.my.saved_pin_success) resources.my.saved_pin_success = "PIN ·Ä°·Äû·ÄÖ·Ä∫ ·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏";
        if (!resources.my.cannot_delete_default) resources.my.cannot_delete_default = "·Äï·ÄØ·Ä∂·Äû·Ä± ·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏·Äô·Äª·Ä¨·Ä∏ ·Äñ·Äª·ÄÄ·Ä∫·Åç ·Äô·Äõ·Äï·Ä´";
        if (!resources.my.orders_for) resources.my.orders_for = "·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏";
        if (!resources.my.no_detailed_records) resources.my.no_detailed_records = "·Ä°·Äû·Ä±·Ä∏·ÄÖ·Ä≠·Äê·Ä∫ ·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·Äô·Äê·ÄΩ·Ä±·Ä∑·Äõ·Äï·Ä´·Åã";

        // GLOBAL STATE
        let state = {
            user: null,
            currentShift: null,
            billDiscount: { type: 'percent', value: 0 },
            tableId: 1,
            products: [],
            cart: [],
            orders: [],
            expenses: [],
            selectedProduct: null,
            activeCategory: 'All',
            editingProductId: null,
            lang: localStorage.getItem('pingpos_lang') || 'en',
            chartInstance: null,
            categoryChartInstance: null,
            orderTypeChartInstance: null,
            tableChartInstance: null,
            isPOSMode: false,
            tables: [],
            isLayoutEdit: false,
            dragItem: null,
            selectedTableId: null,
            orderType: 'dine_in',
            currentOverviewTab: 'sales',
            customCategories: [],
            tempPin: '',// NEW for PIN pad logic
            // New states for Transfer/Merge/Payment
            transferOrderId: null,
            transferTargetId: null,
            transferMode: 'transfer', // 'transfer' or 'merge'
            paymentOrderId: null,
            globalSettings: { tax: 0, serviceCharge: 0 },
            globalSettings: { tax: 0, serviceCharge: 0, taxType: 'exclusive', printMode: 'split' },

        };
        let stateSplit = {
            sourceOrderId: null,
            selectedItems: [], // ·Äò·Äö·Ä∫ item ·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ ·Äõ·ÄΩ·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äû·Äú·Ä≤ ·Äû·Ä≠·Äô·Ä∫·Ä∏·Äõ·Äî·Ä∫
            targetTableId: null
        };

        let isInitialLoad = true;
        const defaultCategories = ["Fried", "Curry", "Soup", "Salad", "Rice", "Noodle", "Dessert", "Drink", "Other"];
        let categories = ["All", ...defaultCategories];

        window.navigateTo = (screenId) => {
            document.querySelectorAll('#app-container > div, .page-view').forEach(el => {
                if (!el.classList.contains('hide')) el.classList.add('hide');
            });
            document.getElementById(screenId).classList.remove('hide');

            const nav = document.getElementById('main-nav');
            const custNav = document.getElementById('nav-customer-controls');
            const adminNav = document.getElementById('nav-admin-controls');

            if (screenId === 'screen-customer') {
                nav.classList.remove('hide');
                custNav.classList.remove('hide');
                adminNav.classList.add('hide');
                window.stopIncomingOrderAlert();
            } else if (screenId === 'screen-kitchen') {
                nav.classList.remove('hide');
                custNav.classList.add('hide');
                adminNav.classList.remove('hide');
            } else {
                nav.classList.add('hide');
            }

            if (screenId === 'screen-analytics') window.refreshReport();
            if (screenId === 'screen-tables') window.renderTableMap();
            if (screenId === 'screen-menu') window.renderMenuManager();
            if (screenId === 'screen-categories') window.renderCategoryManager();
            if (screenId === 'screen-expenses') window.renderExpenses();
            if (screenId === 'screen-members') window.renderMemberList();
        };

        window.toggleAnalyticsView = (type) => {
            const chartWrapper = document.getElementById(`${type}-chart-wrapper`);
            const listWrapper = document.getElementById(`${type}-list-wrapper`);
            const toggleBtnText = document.getElementById(`toggle-${type}-text`);

            if (chartWrapper.classList.contains('hide')) {
                chartWrapper.classList.remove('hide');
                listWrapper.classList.add('hide');
                toggleBtnText.innerText = resources[state.lang]['view_list'] || 'View List';
            } else {
                chartWrapper.classList.add('hide');
                listWrapper.classList.remove('hide');
                toggleBtnText.innerText = resources[state.lang]['view_chart'] || 'View Chart';
            }
        };

        window.setOverviewChart = (tab) => {
            state.currentOverviewTab = tab;
            ['sales', 'table', 'category', 'type'].forEach(t => {
                const btn = document.getElementById(`btn-ov-${t}`);
                if (t === tab) { btn.classList.remove('text-dark-muted'); btn.classList.add('bg-dark-700', 'text-white', 'shadow'); }
                else { btn.classList.add('text-dark-muted'); btn.classList.remove('bg-dark-700', 'text-white', 'shadow'); }
                const view = document.getElementById(`overview-content-${t}`);
                if (t === tab) view.classList.remove('hide'); else view.classList.add('hide');

                if (t === tab && t !== 'sales') {
                    const chartWrapper = document.getElementById(`${t}-chart-wrapper`);
                    const listWrapper = document.getElementById(`${t}-list-wrapper`);
                    const toggleBtnText = document.getElementById(`toggle-${t}-text`);
                    if (chartWrapper && listWrapper) {
                        chartWrapper.classList.remove('hide');
                        listWrapper.classList.add('hide');
                        if (toggleBtnText) toggleBtnText.innerText = resources[state.lang]['view_list'] || 'View List';
                    }
                }
            });
            window.renderReportOverview();
        };

        window.startPOSMode = (tId) => {
            state.tableId = tId;
            state.isPOSMode = true;
            document.getElementById('display-table-id').innerText = tId;
            window.navigateTo('screen-customer');
            document.getElementById('pos-mode-header').classList.remove('hide');
            document.getElementById('nav-customer-controls').classList.add('hide');
            state.cart = [];
            updateCartUI();
        };

        async function init() {
            try {
                const result = await signInAnonymously(auth);
                state.user = result.user;

                const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config_tables', 'main_layout');
                const configSnap = await getDoc(configRef);
                if (configSnap.exists()) state.tables = configSnap.data().tables || [];
                else generateDefaultTables();

                const catRef = doc(db, 'artifacts', appId, 'public', 'data', 'config_categories', 'list');
                const catSnap = await getDoc(catRef);
                if (catSnap.exists()) {
                    state.customCategories = catSnap.data().list || defaultCategories;
                } else {
                    await setDoc(catRef, { list: defaultCategories, createdAt: serverTimestamp() }, { merge: true });
                    state.customCategories = defaultCategories;
                }
                categories = ["All", ...state.customCategories];

            } catch (error) { console.error("Init Error:", error); generateDefaultTables(); }

            const autoRet = localStorage.getItem('pingpos_auto_return');
            if (autoRet !== null) document.getElementById('chk-auto-return').checked = (autoRet === 'true');

            updateContent();
            loadGlobalSettings();
            await window.checkActiveShift();

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('table')) state.tableId = urlParams.get('table');
            document.getElementById('display-table-id').innerText = state.tableId;

            setupListeners();
            window.navigateTo('screen-customer');
            renderCategoryBar();
            document.getElementById('rpt-date-input').valueAsDate = new Date();

            document.getElementById('chk-auto-return').addEventListener('change', (e) => localStorage.setItem('pingpos_auto_return', e.target.checked));

            const scrollContainer = document.getElementById('main-scroll-container');
            const scrollBtn = document.getElementById('scroll-top-btn');
            if (scrollContainer && scrollBtn) {
                scrollContainer.addEventListener('scroll', () => {
                    if (scrollContainer.scrollTop > 300) scrollBtn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
                    else scrollBtn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
                });
            }
        }

        function generateDefaultTables() {
            state.tables = [];
            for (let i = 1; i <= 12; i++) {
                const col = (i - 1) % 4;
                const row = Math.floor((i - 1) / 4);
                state.tables.push({ id: String(i), x: 10 + (col * 22), y: 10 + (row * 22), shape: 'round', size: 1 });
            }
        }

        window.scrollToTop = () => document.getElementById('main-scroll-container').scrollTo({ top: 0, behavior: 'smooth' });

        window.toggleLanguage = () => {
            const languages = ['en', 'my', 'cn', 'ms'];
            const currentIndex = languages.indexOf(state.lang);
            const nextIndex = (currentIndex + 1) % languages.length;
            state.lang = languages[nextIndex];
            localStorage.setItem('pingpos_lang', state.lang);
            updateContent();
            renderCategoryBar();
        };

        function updateContent() {
            document.getElementById('lang-display').innerText = state.lang.toUpperCase();
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (resources[state.lang] && resources[state.lang][key]) el.innerText = resources[state.lang][key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (resources[state.lang] && resources[state.lang][key]) el.placeholder = resources[state.lang][key];
            });
        }

        window.showMessage = (msg, type) => {
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const border = type === 'success' ? 'border-green-300' : 'border-red-300';

            const div = document.createElement('div');
            div.className = `fixed top-5 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-full shadow-xl z-[200] font-bold text-sm flex items-center gap-2 border ${border} animate-slide-up`;
            div.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;

            document.body.appendChild(div);

            if (type === 'success') window.playSingleBeep();

            setTimeout(() => {
                div.style.transition = 'opacity 0.5s, transform 0.5s';
                div.style.opacity = '0';
                div.style.transform = 'translate(-50%, -20px)';
                setTimeout(() => div.remove(), 500);
            }, 3000);
        };

        window.showConfirm = (msgKey, callback, isPinRequired = false) => {
            const modal = document.getElementById('modal-confirm');
            const titleEl = document.getElementById('confirm-title');
            const msgEl = document.getElementById('confirm-message');
            const pinInput = document.getElementById('confirm-pin-input');
            const confirmBtn = document.getElementById('confirm-action-btn');

            msgEl.innerText = resources[state.lang][msgKey] || msgKey;

            if (isPinRequired) {
                pinInput.classList.remove('hide');
                pinInput.placeholder = resources[state.lang]['pin_prompt'] || "Enter PIN";
                pinInput.value = '';
                titleEl.innerText = resources[state.lang]['admin_action'] || "Admin Action Required";
            } else {
                pinInput.classList.add('hide');
                titleEl.innerText = resources[state.lang]['confirmation'] || "Confirmation";
            }

            confirmBtn.onclick = async () => {
                closeModal('modal-confirm');

                let proceed = true;
                if (isPinRequired) {
                    const enteredPin = pinInput.value;
                    const correctPin = localStorage.getItem('pingpos_admin_pin') || '1234';
                    if (enteredPin !== correctPin) {
                        window.showMessage(resources[state.lang]['wrong_pin'] || "Wrong PIN", 'error');
                        proceed = false;
                    }
                }

                if (proceed && callback) {
                    try {
                        await callback();
                    } catch (e) {
                        console.error("Confirmation callback failed:", e);
                        window.showMessage(resources[state.lang]['action_failed'] || "Action Failed", 'error');
                    }
                }
            };

            modal.classList.remove('hide');
        };

        function setupListeners() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (snapshot) => {
                state.products = [];
                snapshot.forEach(d => state.products.push({ id: d.id, ...d.data() }));
                renderMenu(); renderMenuManager();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (snapshot) => {
                state.orders = [];
                snapshot.forEach(d => state.orders.push({ id: d.id, ...d.data() }));
                state.orders.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                if (!isInitialLoad) {
                    // setupListeners function ·Äë·Ä≤·Äô·Äæ·Ä¨ ·Äí·ÄÆ·Äî·Ä±·Äõ·Ä¨·ÄÄ·Ä≠·ÄØ ·Äõ·Äæ·Ä¨·Äï·Äº·ÄÑ·Ä∫·Äï·Ä´
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const orderData = change.doc.data(); // order data ·ÄÄ·Ä≠·ÄØ ·Äö·Ä∞·Äô·Äö·Ä∫

                            // ·Ä°·ÄÄ·Äö·Ä∫·Åç ·Äí·Ä´·Äü·Ä¨ ·Äò·Ä±·Äú·Ä∫·ÄÅ·ÄΩ·Ä≤·Äë·Ä¨·Ä∏·Äê·Ä≤·Ä∑ order (isSplitOrder) ·Äô·Äü·ÄØ·Äê·Ä∫·Äô·Äæ·Äû·Ä¨ ·Ä°·Äû·Ä∂·Äô·Äº·Ää·Ä∫·ÄÖ·Ä±·Äô·Äö·Ä∫
                            if (!orderData.isSplitOrder) {
                                if (!document.getElementById('screen-kitchen').classList.contains('hide')) {
                                    window.startIncomingOrderAlert();
                                } else {
                                    const tempAudio = new Audio(sounds[soundState.choice]);
                                    tempAudio.play().catch(() => { });
                                }
                            }
                        }
                    });
                }
                isInitialLoad = false;
                renderAdminOrders();

                if (!document.getElementById('screen-tables').classList.contains('hide')) window.renderTableMap();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), (snapshot) => {
                state.expenses = [];
                snapshot.forEach(d => state.expenses.push({ id: d.id, ...d.data() }));
                state.expenses.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                if (!document.getElementById('screen-expenses').classList.contains('hide')) renderExpenses();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config_categories', 'list'), (doc) => {
                if (doc.exists()) {
                    state.customCategories = doc.data().list || defaultCategories;
                    categories = ["All", ...state.customCategories];
                    renderCategoryBar();
                    renderMenuManager();
                }
            });
        }

        function renderCategoryBar() {
            const container = document.getElementById('category-bar');
            const isMobile = window.innerWidth < 640;
            if (isMobile) {
                const visibleCats = categories.slice(0, 3);
                let html = visibleCats.map(cat => generateCatBtnHTML(cat)).join('');
                const isHiddenActive = !visibleCats.includes(state.activeCategory);
                const moreBtnClass = isHiddenActive ? "cat-btn-active ring-2 ring-offset-2 ring-offset-dark-900 ring-primary" : "cat-btn-inactive";
                html += `<button onclick="openCategoryModal()" class="px-4 py-2 rounded-full text-[11px] font-bold whitespace-nowrap transition-all duration-300 ${moreBtnClass} flex items-center gap-1">${resources[state.lang]['more'] || 'More'} <i class="fas fa-chevron-down text-[10px]"></i></button>`;
                container.innerHTML = html;
            } else {
                container.innerHTML = categories.map(cat => generateCatBtnHTML(cat)).join('');
            }
        }

        function generateCatBtnHTML(cat) {
            const isActive = state.activeCategory === cat;
            const activeClass = isActive ? "cat-btn-active" : "cat-btn-inactive";
            const catName = resources[state.lang][cat] || cat;
            return `<button onclick="window.filterCategory('${cat}')" class="px-5 py-2 rounded-full text-[11px] font-bold whitespace-nowrap transition-all duration-300 ${activeClass}">${catName}</button>`;
        }

        window.openCategoryModal = () => {
            const grid = document.getElementById('modal-cat-grid');
            grid.innerHTML = categories.map(cat => {
                const isActive = state.activeCategory === cat;
                const bgClass = isActive ? "bg-primary text-white border-primary shadow-lg shadow-primary/30" : "bg-dark-900 text-dark-muted border-dark-700 hover:border-gray-500 hover:text-white";
                const catName = resources[state.lang][cat] || cat;
                return `<button onclick="selectCategoryFromModal('${cat}')" class="p-4 rounded-xl font-bold text-sm border ${bgClass} transition flex items-center justify-center">${catName}</button>`;
            }).join('');
            document.getElementById('modal-category').classList.remove('hide');
        }

        window.selectCategoryFromModal = (cat) => { window.filterCategory(cat); closeModal('modal-category'); }
        window.filterCategory = (cat) => { state.activeCategory = cat; renderCategoryBar(); renderMenu(); };

        function renderMenu() {
            const grid = document.getElementById('menu-grid');
            document.getElementById('menu-loading').classList.add('hide');
            grid.innerHTML = '';
            const filteredProducts = state.activeCategory === 'All' ? state.products : state.products.filter(p => p.category === state.activeCategory || (!p.category && state.activeCategory === 'Other'));
            if (filteredProducts.length === 0) return document.getElementById('empty-menu-msg').classList.remove('hide');
            document.getElementById('empty-menu-msg').classList.add('hide');

            filteredProducts.forEach(p => {
                const imgHtml = (p.image && p.image.startsWith('http')) ? `<img src="${p.image}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy">` : `<div class="w-full h-full flex items-center justify-center text-4xl text-dark-700"><i class="fas fa-utensils"></i></div>`;
                const isSoldOut = p.isSoldOut === true || (p.stock !== null && p.stock !== undefined && p.stock <= 0);
                const discountAmt = p.discount || 0;
                // Tax is separate calculation, here we just show base price minus discount
                const effectiveBasePrice = p.price - discountAmt;

                const containerClass = isSoldOut ? "relative h-52 rounded-[24px] shadow-lg border border-dark-700/50 overflow-hidden bg-dark-800" : "relative h-52 rounded-[24px] shadow-lg border border-dark-700/50 cursor-pointer overflow-hidden group active:scale-[0.95] transition-all bg-dark-800";

                const el = document.createElement('div');
                el.className = containerClass;
                if (!isSoldOut) el.onclick = () => openProductModal(p.id);
                el.innerHTML = `
                    ${isSoldOut ? `<div class="absolute inset-0 z-20 flex items-center justify-center pointer-events-none"><span class="bg-red-600/90 text-white border-2 border-white font-black text-xl px-6 py-2 transform -rotate-12 shadow-2xl tracking-widest rounded-lg">${resources[state.lang]['sold_out'] || 'SOLD OUT'}</span></div>` : ""}
                    ${discountAmt > 0 && !isSoldOut ? `<div class="absolute top-2 left-2 z-20 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-lg flex items-center gap-1"><i class="fas fa-tag"></i> Save -${discountAmt}</div>` : ''}
                    ${(p.stock !== null && p.stock !== undefined && p.stock <= 10 && !isSoldOut)
                        ? `<div class="absolute top-2 right-2 z-20 bg-orange-600 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-lg animate-pulse">Only ${p.stock} left!</div>`
                        : ''}
                    <div class="${isSoldOut ? 'sold-out-filter' : ''} w-full h-full">
                        <div class="absolute inset-0 w-full h-full">${imgHtml}</div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent opacity-90"></div>
                        <div class="absolute bottom-0 left-0 right-0 p-4 flex flex-col justify-end h-full pointer-events-none">
                            <div class="transform translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
                                <h3 class="font-bold text-white text-[15px] leading-tight mb-1 line-clamp-2 drop-shadow-md">${p.name}</h3>
                                <div class="flex justify-between items-center mt-1">
                                    <div class="flex flex-col items-start leading-none">
                                        ${discountAmt > 0 ? `<span class="text-[10px] text-gray-400 line-through decoration-red-500 mb-0.5">${p.price} Ks</span>` : ''}
                                        <p class="${discountAmt > 0 ? 'text-red-400' : 'text-primary'} font-extrabold text-sm drop-shadow-md">${effectiveBasePrice} Ks ${p.tax ? `<span class="text-[9px] text-gray-400 font-normal ml-1">(+${p.tax}% Tax)</span>` : ''}</p>
                                    </div>
                                    <div class="w-8 h-8 rounded-full bg-white/20 backdrop-blur-md border border-white/10 flex items-center justify-center text-white hover:bg-primary hover:border-primary transition-colors shadow-lg"><i class="fas fa-plus text-xs"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            });
        }
        // renderAdminOrders ·Ä°·Äü·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ ·Äñ·Äª·ÄÄ·Ä∫·Äï·Äº·ÄÆ·Ä∏ ·Äí·ÄÆ·Ä°·Äû·ÄÖ·Ä∫·ÄÄ·Ä≠·ÄØ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´
        window.renderAdminOrders = () => {
            const grid = document.getElementById('orders-grid');
            grid.innerHTML = '';
            const activeOrders = state.orders.filter(o => o.status !== 'cancelled');

            if (activeOrders.length === 0) return document.getElementById('no-orders-msg').classList.remove('hidden');
            document.getElementById('no-orders-msg').classList.add('hidden');

            // Setting ·ÄÄ·Ä≠·ÄØ ·ÄÖ·ÄÖ·Ä∫·Äô·Äö·Ä∫ (Combined ·Äú·Ä¨·Ä∏ Split ·Äú·Ä¨·Ä∏)
            const isCombined = state.globalSettings.printMode === 'combined';

            activeOrders.forEach(order => {
                let statusColor, stText, actionBtn;
                let cardClass = "bg-dark-800 rounded-2xl shadow-lg border border-dark-700 p-4 flex flex-col gap-3";

                // (·ÄÄ) PRINT BUTTONS (·Äï·ÄØ·Ä∂·ÄÖ·Ä∂ ·ÅÇ ·Äô·Äª·Ä≠·ÄØ·Ä∏ ·ÄÅ·ÄΩ·Ä≤·Äõ·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äû·Ää·Ä∫)
                let printBtnGroup = '';
                if (isCombined) {
                    // Combined Mode ·ÄÜ·Ä≠·ÄØ·Äõ·ÄÑ·Ä∫ ·ÄÅ·Äú·ÄØ·Äê·Ä∫·Ä°·ÄÄ·Äº·ÄÆ·Ä∏ ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·Äê·Ää·Ä∫·Ä∏·Äï·Äº·Äô·Äö·Ä∫
                    printBtnGroup = `
                <div class="mt-2">
                    <button onclick="window.printTicket('${order.id}', 'kitchen', 'all')" class="w-full bg-dark-700 text-white border border-dark-600 py-2 rounded-lg text-xs font-bold hover:bg-dark-600 hover:border-gray-400 transition flex items-center justify-center gap-2">
                        <i class="fas fa-print text-white"></i> Print Kitchen Ticket (All)
                    </button>
                </div>`;
                } else {
                    // Split Mode ·ÄÜ·Ä≠·ÄØ·Äõ·ÄÑ·Ä∫ Food ·Äî·Ä≤·Ä∑ Bar ·ÄÅ·Äú·ÄØ·Äê·Ä∫ ·ÅÇ ·ÄÅ·ÄØ ·ÄÅ·ÄΩ·Ä≤·Äï·Äº·Äô·Äö·Ä∫ (·Äô·Ä∞·Äõ·ÄÑ·Ä∫·Ä∏·Ä°·Äê·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏)
                    printBtnGroup = `
                <div class="flex gap-1 mt-2">
                    <button onclick="window.printTicket('${order.id}', 'kitchen', 'kitchen')" class="flex-1 bg-dark-700 text-white border border-dark-600 py-1.5 rounded-lg text-[10px] font-bold hover:bg-dark-600 hover:border-gray-400 transition flex items-center justify-center gap-1" title="Print Food Only">
                        <i class="fas fa-utensils text-orange-400"></i> Food
                    </button>
                    <button onclick="window.printTicket('${order.id}', 'kitchen', 'bar')" class="flex-1 bg-dark-700 text-white border border-dark-600 py-1.5 rounded-lg text-[10px] font-bold hover:bg-dark-600 hover:border-gray-400 transition flex items-center justify-center gap-1" title="Print Drinks Only">
                        <i class="fas fa-cocktail text-blue-400"></i> Bar
                    </button>
                </div>`;
                }

                // (·ÄÅ) START BUTTON LOGIC
                if (order.status === 'pending') {
                    statusColor = "bg-yellow-900/20 text-yellow-400 border-yellow-900/50";
                    stText = "Pending";
                    // Start ·ÄÅ·Äú·ÄØ·Äê·Ä∫·Äï·Ä±·Ä´·Ä∫·ÄÄ ·ÄÖ·Ä¨·Äû·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ Setting ·Ä°·Äú·Ä≠·ÄØ·ÄÄ·Ä∫ ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äô·Äö·Ä∫
                    let btnLabel = isCombined ? "Start & Print All" : "Start & Print Food";
                    actionBtn = `<button onclick="window.startOrder('${order.id}')" class="flex-1 bg-white text-dark-900 py-2.5 rounded-xl text-xs font-bold hover:bg-gray-200 transition">${btnLabel}</button>`;
                } else if (order.status === 'cooking') {
                    statusColor = "bg-blue-900/20 text-blue-400 border-blue-900/50";
                    stText = "Cooking";
                    actionBtn = `<button onclick="window.confirmServedPaymentModal('${order.id}')" class="flex-1 bg-green-500 text-white py-2.5 rounded-xl text-xs font-bold hover:bg-green-600 transition">Serve</button>`;
                } else if (order.status === 'served') {
                    statusColor = "bg-gray-700/50 text-gray-400 border-gray-700";
                    stText = "Served";
                }

                let mainControls = '';
                if (order.status !== 'served') {
                    mainControls = `
                <div class="flex w-full gap-2 mt-1">
                    <button onclick="window.openTransferModal('${order.id}', '${order.tableId}', '${order.orderType}')" class="w-10 bg-indigo-900/20 text-indigo-400 border border-indigo-900/50 py-2.5 rounded-xl text-xs font-bold hover:bg-indigo-900/40 transition flex items-center justify-center"><i class="fas fa-object-group"></i></button>
                    <button onclick="window.cancelKitchenOrder('${order.id}')" class="w-10 bg-red-900/20 text-red-500 border border-red-900/50 py-2.5 rounded-xl text-xs font-bold hover:bg-red-900/40 transition flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
                    ${actionBtn}
                    <button onclick="window.openAdvancedBillingModal('${order.id}')" class="w-10 bg-blue-900/20 text-blue-400 border border-blue-900/50 py-2.5 rounded-xl text-xs font-bold hover:bg-blue-900/40 transition flex items-center justify-center"><i class="fas fa-scissors"></i></button>
                </div>`;
                } else {
                    mainControls = `<button onclick="window.printTicket('${order.id}', 'customer')" class="w-full border border-dark-700 text-gray-300 py-2 rounded-xl text-xs font-bold hover:bg-dark-700 transition">Print Full Receipt</button>`;
                }

                const isTakeaway = order.orderType === 'takeaway';
                const typeBadge = isTakeaway ? `<span class="bg-purple-900/50 text-purple-300 border border-purple-500/30 px-2 py-0.5 rounded text-[10px] font-bold ml-2 animate-pulse"><i class="fas fa-shopping-bag mr-1"></i>TAKEAWAY</span>` : '';
                const pMethodBadge = order.paymentMethod ? `<span class="bg-green-900/30 text-green-400 border border-green-500/20 px-1.5 py-0.5 rounded text-[9px] font-bold ml-2 italic">${order.paymentMethod}</span>` : '';

                const div = document.createElement('div');
                div.className = cardClass;
                div.innerHTML = `
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-dark-900 flex items-center justify-center font-bold text-white border border-dark-700 shadow-inner">${order.tableId}</div>
                    <span class="text-xs font-bold text-gray-400">#${order.id.slice(0, 4)}</span>
                </div>
                <div class="flex items-center">
                    ${typeBadge}${pMethodBadge}
                    <span class="px-2 py-1 rounded-lg text-[10px] font-bold border ${statusColor} ml-2">${stText}</span>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto max-h-32 space-y-2 py-2 border-t border-b border-dark-700 custom-scroll">
                ${order.items.map(i => {
                    const isBarItem = ['Drink', 'Dessert', 'Beverage'].includes(i.category);
                    const textColor = isBarItem ? "text-blue-300" : "text-white";
                    return `<div class="flex justify-between font-bold ${textColor} text-sm"><span>${i.qty}x ${i.name} ${i.size ? `(${i.size})` : ''}</span></div>`
                }).join('')}
            </div>
            <div class="flex flex-col gap-2">
                <div class="flex justify-between items-center px-1">
                    <span class="text-[10px] text-dark-muted font-bold uppercase tracking-wider">Total</span>
                    <span class="font-bold text-base text-white">${order.totalPrice.toLocaleString()} Ks</span>
                </div>
                ${order.status !== 'served' ? printBtnGroup : ''}
                ${mainControls}
            </div>`;
                grid.appendChild(div);
            });
        };
        window.startOrder = async (id) => {
            window.stopIncomingOrderAlert();
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), { status: 'cooking' });

                // Setting ·ÄÄ·Ä≠·ÄØ ·ÄÖ·ÄÖ·Ä∫·Äô·Äö·Ä∫
                const isCombined = state.globalSettings.printMode === 'combined';

                if (isCombined) {
                    // Combined ·ÄÜ·Ä≠·ÄØ·Äõ·ÄÑ·Ä∫ ·Ä°·ÄÄ·ÄØ·Äî·Ä∫·Äë·ÄØ·Äê·Ä∫·Äô·Äö·Ä∫ ('all')
                    window.printTicket(id, 'kitchen', 'all');
                } else {
                    // Split ·ÄÜ·Ä≠·ÄØ·Äõ·ÄÑ·Ä∫ Food ·Äï·Ä≤ ·Ä°·Äõ·ÄÑ·Ä∫·Äë·ÄØ·Äê·Ä∫·Äô·Äö·Ä∫ ('kitchen') - (·Äô·Ä∞·Äõ·ÄÑ·Ä∫·Ä∏·Ä°·Äê·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏)
                    window.printTicket(id, 'kitchen', 'kitchen');
                }
            } catch (e) {
                console.error(e);
            }
        };
        // NEW FEATURE: served with payment selection
        window.confirmServedPaymentModal = (id) => {
            state.paymentOrderId = id;
            document.getElementById('modal-payment-selection').classList.remove('hide');
        };

        window.confirmServedWithPayment = async (method) => {
            if (!state.paymentOrderId) return;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', state.paymentOrderId), {
                    status: 'served',
                    paymentMethod: method
                });
                const id = state.paymentOrderId;
                closeModal('modal-payment-selection');
                window.printTicket(id, 'customer');
            } catch (e) { console.error(e); }
        };

        window.cancelKitchenOrder = (id) => {
            window.showConfirm('cancel_confirm', async () => {
                window.stopIncomingOrderAlert();
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), { status: 'cancelled' });
                    window.showMessage(resources[state.lang]['cleared_success'] || "Order Cancelled", 'success');
                } catch (e) {
                    console.error(e);
                    window.showMessage(resources[state.lang]['action_failed'] || "Cancel Failed", 'error');
                }
            }, false);
        };

        window.updateStatus = async (id, newStatus) => {
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), { status: newStatus });
            } catch (e) {
                console.error("Failed to update status:", e);
            }
        };

        window.renderMenuManager = () => {
            const listContainer = document.getElementById('menu-list-container');

            // ·Äí·ÄÆ·Äî·Ä±·Äõ·Ä¨·Äô·Äæ·Ä¨ Stock ·Äï·Äº·Äê·Ä≤·Ä∑ Logic ·Äê·ÄΩ·Ä±·Äï·Ä´ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Äõ·Ä±·Ä∏·Äï·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äï·Ä´·Äê·Äö·Ä∫
            listContainer.innerHTML = state.products.map(p => {
                // Stock 0 ·Äñ·Äº·ÄÖ·Ä∫·Äõ·ÄÑ·Ä∫ Sold Out ·Äï·Äº·Äô·Äö·Ä∑·Ä∫ Logic
                const isSoldOut = p.isSoldOut === true || (p.stock !== null && p.stock !== undefined && p.stock <= 0);
                const disc = p.discount || 0;
                const tax = p.tax || 0;
                const imageSrc = (p.image && p.image.startsWith('http')) ? p.image : 'https://placehold.co/100x100/1F2937/9CA3AF?text=Food';

                return `
        <div class="bg-dark-800 rounded-xl p-3 flex gap-3 items-center border border-dark-700 shadow-sm relative overflow-hidden group">
            ${isSoldOut ? '<div class="absolute inset-0 bg-dark-900/60 z-10 flex items-center justify-center backdrop-blur-[1px]"><span class="text-red-500 font-black -rotate-12 border-2 border-red-500 px-2 py-1 rounded text-xs tracking-widest uppercase shadow-lg bg-dark-900/80">Sold Out</span></div>' : ''}

            <div class="w-16 h-16 shrink-0 rounded-lg bg-dark-900 overflow-hidden border border-dark-600">
                <img src="${imageSrc}" class="w-full h-full object-cover">
            </div>

            <div class="flex-1 min-w-0">
                <h4 class="text-white font-bold text-sm truncate">${p.name}</h4>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-[10px] bg-dark-700 text-dark-muted px-1.5 py-0.5 rounded border border-dark-600 uppercase font-bold tracking-wide">${p.category || 'Other'}</span>
                    
                    <!-- Stock ·Äú·ÄÄ·Ä∫·ÄÄ·Äª·Äî·Ä∫·Äï·Äº·Äô·Äö·Ä∑·Ä∫·Äî·Ä±·Äõ·Ä¨ -->
                    ${(p.stock !== null && p.stock !== undefined)
                        ? `<span class="text-[10px] ${p.stock > 5 ? 'text-yellow-400 bg-yellow-900/20' : 'text-red-400 bg-red-900/20'} font-bold px-1.5 py-0.5 rounded border border-white/10">Stock: ${p.stock}</span>`
                        : ''}

                    ${disc > 0 ? `<span class="text-[10px] text-green-400 font-bold bg-green-900/20 px-1 rounded">-${disc}</span>` : ''}
                </div>
                <div class="font-bold text-primary text-sm mt-1 font-mono flex items-center gap-2">
                    ${p.price.toLocaleString()} Ks
                    ${tax > 0 ? `<span class="text-[9px] text-blue-400 border border-blue-500/30 px-1 rounded bg-blue-900/10">+${tax}% Tax</span>` : ''}
                </div>
            </div>

            <div class="flex flex-col gap-2 z-20 shrink-0 border-l border-dark-700 pl-3">
                <button onclick="window.toggleStock('${p.id}', ${isSoldOut})" class="w-8 h-8 rounded-lg flex items-center justify-center transition-colors ${isSoldOut ? 'bg-red-900/20 text-red-400 border border-red-900/50' : 'bg-green-900/20 text-green-400 border border-green-900/50 hover:bg-green-900/30'}" title="Toggle Stock">
                    <i class="fas ${isSoldOut ? 'fa-toggle-off' : 'fa-toggle-on'}"></i>
                </button>
                <div class="flex gap-2">
                    <button onclick="window.editProduct('${p.id}')" class="w-8 h-8 rounded-lg bg-dark-700 text-white hover:bg-primary hover:shadow-lg transition-all flex items-center justify-center border border-dark-600">
                        <i class="fas fa-pen text-xs"></i>
                    </button>
                    <button onclick="window.deleteProduct('${p.id}')" class="w-8 h-8 rounded-lg bg-dark-700 text-red-400 hover:bg-red-900/30 hover:text-red-300 hover:border-red-900/50 transition-all flex items-center justify-center border border-dark-600">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            </div>
        </div>`;
            }).join(''); // <--- ·Äí·ÄÆ·Äî·Ä±·Äõ·Ä¨·Äô·Äæ·Ä¨ .join('') ·Äï·Ä´·Äô·Äæ ·Äò·Äö·Ä∫/·Ää·Ä¨ ·ÄÄ·ÄΩ·ÄÄ·Ä∫·Äê·Ä≠ ·Äù·ÄÑ·Ä∫·Äô·Äæ·Ä¨·Äï·Ä´

            // Dropdown ·Äï·Äº·Äî·Ä∫ update ·Äú·ÄØ·Äï·Ä∫·Äê·Ä≤·Ä∑ ·Ä°·Äï·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏
            const select = document.getElementById('new-prod-category');
            if (select) {
                const options = state.customCategories.map(cat => `<option value="${cat}">${resources[state.lang][cat] || cat}</option>`).join('') + `<option value="Other">${resources[state.lang]['Other'] || 'Other'}</option>`;
                select.innerHTML = options;
                if (state.editingProductId) {
                    const p = state.products.find(x => x.id === state.editingProductId);
                    if (p) select.value = p.category || 'Other';
                }
            }
        };
        window.toggleStock = async (id, currentStatus) => { try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id), { isSoldOut: !currentStatus }); } catch (e) { console.error(e); } };

        window.toggleMenuForm = (forceState = null) => {
            const content = document.getElementById('menu-form-content');
            const chevron = document.getElementById('menu-form-chevron');
            const header = document.getElementById('menu-form-header');

            const isCurrentlyHidden = content.classList.contains('hide');
            const shouldShow = forceState !== null ? forceState : isCurrentlyHidden;

            if (shouldShow) {
                content.classList.remove('hide');
                chevron.style.transform = 'rotate(180deg)';
                header.classList.add('bg-dark-700');
            } else {
                content.classList.add('hide');
                chevron.style.transform = 'rotate(0deg)';
                header.classList.remove('bg-dark-700');
            }
        };

        window.editProduct = (id) => {
            const p = state.products.find(x => x.id === id); if (!p) return;
            state.editingProductId = id;

            // Open the form
            window.toggleMenuForm(true);

            document.getElementById('new-prod-name').value = p.name;
            document.getElementById('new-prod-price').value = p.price;
            document.getElementById('new-prod-stock').value = (p.stock !== undefined && p.stock !== null) ? p.stock : '';
            document.getElementById('new-prod-cost').value = p.cost || '';
            document.getElementById('new-prod-discount').value = p.discount || '';
            document.getElementById('new-prod-tax').value = p.tax || '';

            document.getElementById('new-prod-img').value = (p.image === 'üçΩÔ∏è' || !p.image) ? '' : p.image;
            document.getElementById('new-prod-category').value = p.category || 'Other';
            document.getElementById('new-prod-options').value = p.options ? p.options.join(', ') : '';

            let sizesStr = '';
            if (p.sizes && Array.isArray(p.sizes)) {
                sizesStr = p.sizes.map(s => `${s.name}:${s.price}`).join(', ');
            }
            document.getElementById('new-prod-sizes').value = sizesStr;

            const btn = document.getElementById('btn-save-prod');
            btn.innerText = "Update Item";

            document.getElementById('menu-form-title').innerHTML = `<span class="w-6 h-6 rounded-full bg-yellow-500 flex items-center justify-center text-[10px] text-white shadow-md"><i class="fas fa-pen"></i></span> Edit Item`;
            document.getElementById('btn-cancel-edit').classList.remove('hide');
            window.scrollToTop();
        };

        window.cancelEdit = () => {
            state.editingProductId = null;
            document.getElementById('new-prod-name').value = '';
            document.getElementById('new-prod-price').value = '';
            document.getElementById('new-prod-cost').value = '';
            document.getElementById('new-prod-discount').value = '';
            document.getElementById('new-prod-tax').value = '';
            document.getElementById('new-prod-img').value = '';
            document.getElementById('new-prod-options').value = '';
            document.getElementById('new-prod-sizes').value = '';

            const btn = document.getElementById('btn-save-prod');
            btn.innerText = "Save Item";

            document.getElementById('menu-form-title').innerHTML = `<span class="w-6 h-6 rounded-full bg-primary flex items-center justify-center text-[10px] text-white shadow-md"><i class="fas fa-plus"></i></span> <span data-i18n="add_item">Add New Item</span>`;
            document.getElementById('btn-cancel-edit').classList.add('hide');
        };

        window.saveProduct = async () => {
            const stockVal = document.getElementById('new-prod-stock').value;
            const stock = stockVal === '' ? null : parseInt(stockVal); // ·Äò·Ä¨·Äô·Äæ·Äô·Äõ·Ä±·Ä∏·Äõ·ÄÑ·Ä∫ Unlimited (null) ·Äú·Ä≠·ÄØ·Ä∑ ·Äû·Äê·Ä∫·Äô·Äæ·Äê·Ä∫·Äô·Äö·Ä∫

            const n = document.getElementById('new-prod-name').value;
            const p = parseInt(document.getElementById('new-prod-price').value);
            const cost = parseInt(document.getElementById('new-prod-cost').value) || 0;
            const disc = parseInt(document.getElementById('new-prod-discount').value) || 0;
            const tax = parseFloat(document.getElementById('new-prod-tax').value) || 0;
            const i = document.getElementById('new-prod-img').value;
            const o = document.getElementById('new-prod-options').value;
            const c = document.getElementById('new-prod-category').value;
            const sStr = document.getElementById('new-prod-sizes').value;

            if (!n || !p) return window.showMessage(resources[state.lang]['missing_name_price'] || "Missing Name or Price", 'error');

            let sizes = [];
            if (sStr && sStr.trim() !== '') {
                try {
                    sizes = sStr.split(',').map(item => {
                        const parts = item.split(':');
                        if (parts.length === 2) {
                            return { name: parts[0].trim(), price: parseInt(parts[1].trim()) };
                        }
                        return null;
                    }).filter(x => x !== null);
                } catch (e) { console.log("Size parse error", e); }
            }

            const data = {
                name: n,
                price: p,
                stock: stock,
                cost: cost,
                discount: disc,
                tax: tax,
                image: i || 'üçΩÔ∏è',
                options: o ? o.split(',').map(s => s.trim()).filter(Boolean) : [],
                category: c,
                sizes: sizes
            };

            try {
                if (state.editingProductId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', state.editingProductId), data);
                    window.cancelEdit();
                    window.showMessage(resources[state.lang]['saved'] || "Saved!", 'success');
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), data);
                    window.cancelEdit(); // Clears form
                    window.showMessage(resources[state.lang]['saved'] || "Saved!", 'success');
                }
            } catch (e) { console.error(e); window.showMessage(resources[state.lang]['failed'] || "Failed", 'error'); }
        };

        window.deleteProduct = (id) => {
            window.showConfirm('remove_confirm', async () => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id));
                window.showMessage(resources[state.lang]['removed'] || "Removed!", 'success');
            }, false);
        };

        window.renderCategoryManager = () => {
            const listContainer = document.getElementById('categories-list');
            listContainer.innerHTML = '';

            state.customCategories.forEach(cat => {
                const catName = resources[state.lang][cat] || cat;
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center p-3 bg-dark-800 rounded-xl border border-dark-700';
                el.innerHTML = `
                    <span class="font-bold text-white text-sm">${catName}</span>
                    <button onclick="deleteCategory('${cat}')" class="text-red-400 hover:text-white hover:bg-red-500/80 bg-red-900/20 w-8 h-8 rounded-full transition flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                `;
                listContainer.appendChild(el);
            });
        };

        window.saveCategory = async () => {
            const newCat = document.getElementById('new-cat-name').value.trim();
            if (!newCat) return window.showMessage(resources[state.lang]['cat_empty'] || "Category name cannot be empty.", 'error');
            if (state.customCategories.includes(newCat)) return window.showMessage(resources[state.lang]['cat_exists'] || "Category already exists.", 'error');

            const catRef = doc(db, 'artifacts', appId, 'public', 'data', 'config_categories', 'list');
            try {
                const newList = [...state.customCategories, newCat];
                await updateDoc(catRef, { list: newList, updatedAt: serverTimestamp() });
                document.getElementById('new-cat-name').value = '';
                window.showMessage(resources[state.lang]['saved'] || "Saved!", 'success');
            } catch (e) {
                console.error("Failed to add category:", e);
                window.showMessage(resources[state.lang]['failed'] || "Failed to add category.", 'error');
            }
        };

        window.deleteCategory = (catToDelete) => {
            if (catToDelete === 'All' || catToDelete === 'Other') return window.showMessage(resources[state.lang]['cannot_delete_default'] || "Cannot delete default categories.", 'error');

            window.showConfirm('delete_category_confirm', async () => {
                const catRef = doc(db, 'artifacts', appId, 'public', 'data', 'config_categories', 'list');
                try {
                    const newList = state.customCategories.filter(c => c !== catToDelete);
                    await updateDoc(catRef, { list: newList, updatedAt: serverTimestamp() });

                    state.products.filter(p => p.category === catToDelete).forEach(async (p) => {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', p.id), { category: 'Other' });
                    });

                    window.showMessage(resources[state.lang]['cleared_success'] || "Category deleted and items reassigned.", 'success');
                } catch (e) {
                    console.error("Failed to delete category:", e);
                    window.showMessage(resources[state.lang]['failed'] || "Failed to delete category.", 'error');
                }
            }, true);
        };

        window.renderExpenses = () => {
            const b = document.getElementById('expenses-table-body');
            b.innerHTML = '';
            if (state.expenses.length === 0) { b.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-dark-muted">No expenses recorded</td></tr>'; return; }
            state.expenses.forEach(e => {
                const d = e.timestamp ? new Date(e.timestamp.seconds * 1000).toLocaleDateString() : '-';
                b.innerHTML += `
                <tr class="border-b border-dark-700 hover:bg-dark-800 transition">
                    <td class="p-3 text-dark-muted text-xs">${d}</td>
                    <td class="p-3 text-white font-bold">${e.description}</td>
                    <td class="p-3 text-dark-muted italic text-[10px]">${e.note || '-'}</td>
                    <td class="p-3 text-right text-red-400 font-mono font-bold">-${e.amount.toLocaleString()}</td>
                    <td class="p-3 text-center">
                        <button onclick="deleteExpense('${e.id}')" class="text-dark-muted hover:text-white"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        };

        window.clearAllExpenses = async () => {
            window.showConfirm('delete_all_confirm', async () => {
                const batch = writeBatch(db);
                state.expenses.forEach(e => {
                    batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', e.id));
                });
                await batch.commit();
                window.showMessage("Expenses Cleared", "success");
            }, true);
        }

        window.openAddExpenseModal = () => document.getElementById('modal-add-expense').classList.remove('hide');

        window.saveExpenseFromModal = async () => {
            const d = document.getElementById('modal-exp-title').value;
            const a = parseInt(document.getElementById('modal-exp-amount').value);
            const n = document.getElementById('modal-exp-note').value;
            if (!d || !a) return window.showMessage("Missing title or amount", "error");
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), {
                    description: d, amount: a, note: n, timestamp: serverTimestamp()
                });
                document.getElementById('modal-exp-title').value = '';
                document.getElementById('modal-exp-amount').value = '';
                document.getElementById('modal-exp-note').value = '';
                closeModal('modal-add-expense');
                window.showMessage("Expense Added", "success");
            } catch (e) { console.error(e); }
        };

        window.deleteExpense = (id) => {
            window.showConfirm('delete_confirm', async () => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id));
                window.showMessage("Expense Deleted", "success");
            }, true);
        };

        window.openProductModal = (id) => {
            const p = state.products.find(x => x.id === id); if (!p) return;
            state.selectedProduct = { ...p, qty: 1, selectedSize: null };

            if (p.sizes && p.sizes.length > 0) {
                state.selectedProduct.selectedSize = p.sizes[0];
                state.selectedProduct.price = p.sizes[0].price;
            }

            const effectiveBasePrice = state.selectedProduct.price - (p.discount || 0);

            document.getElementById('mp-name').innerText = p.name;
            document.getElementById('mp-price-display').innerText = effectiveBasePrice + ' Ks';
            document.getElementById('mp-qty').innerText = 1;
            document.getElementById('prod-remark').value = '';
            const img = document.getElementById('mp-img');
            img.src = (p.image && p.image.startsWith('http')) ? p.image : 'https://placehold.co/600x400/1F2937/9CA3AF?text=' + (p.image || 'Food');

            const optionsContainer = document.getElementById('dynamic-options');
            optionsContainer.innerHTML = '';
            const opts = (p.options && p.options.length > 0) ? p.options : ["Normal Spicy", "Less Spicy", "No MSG"];
            opts.forEach(opt => {
                const div = document.createElement('div');
                div.innerHTML = `<label class="cursor-pointer block"><input type="checkbox" name="prod_option" value="${opt}" class="peer sr-only"><div class="border border-dark-700 peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary rounded-xl py-3 px-2 text-center text-[10px] font-bold transition-all h-full bg-dark-900 text-dark-muted hover:bg-dark-700">${opt}</div></label>`;
                optionsContainer.appendChild(div);
            });

            const sizeContainer = document.getElementById('size-selection-container');
            const dynamicSizes = document.getElementById('dynamic-sizes');
            dynamicSizes.innerHTML = '';

            if (p.sizes && p.sizes.length > 0) {
                sizeContainer.classList.remove('hide');
                p.sizes.forEach((s, idx) => {
                    const isChecked = idx === 0 ? 'checked' : '';
                    const effSizePrice = s.price - (p.discount || 0);
                    const div = document.createElement('label');
                    div.className = "cursor-pointer";
                    div.innerHTML = `
                        <input type="radio" name="prod_size" value="${idx}" class="peer sr-only" ${isChecked} onchange="selectSize(${idx})">
                        <div class="border border-dark-700 bg-dark-900 text-white peer-checked:bg-primary peer-checked:border-primary peer-checked:text-white rounded-lg px-4 py-2 text-xs font-bold transition">
                            ${s.name} <span class="opacity-70 text-[10px]">(${effSizePrice})</span>
                        </div>
                    `;
                    dynamicSizes.appendChild(div);
                });
            } else {
                sizeContainer.classList.add('hide');
            }

            document.getElementById('modal-product').classList.remove('hide');
        };

        window.selectSize = (idx) => {
            const p = state.products.find(x => x.id === state.selectedProduct.id);
            if (p && p.sizes && p.sizes[idx]) {
                state.selectedProduct.selectedSize = p.sizes[idx];
                state.selectedProduct.price = p.sizes[idx].price;
                const effPrice = state.selectedProduct.price - (p.discount || 0);
                document.getElementById('mp-price-display').innerText = effPrice + ' Ks';
            }
        };

        window.updateQty = (c) => { let q = state.selectedProduct.qty + c; if (q >= 1) { state.selectedProduct.qty = q; document.getElementById('mp-qty').innerText = q; } };

        window.addToCart = () => {
            const currentStock = state.selectedProduct.stock;
            if (currentStock !== null && currentStock !== undefined) {
                // Cart ·Äë·Ä≤·Äô·Äæ·Ä¨ ·Äõ·Äæ·Ä≠·Äï·Äº·ÄÆ·Ä∏·Äû·Ä¨·Ä∏ ·Ä°·Äõ·Ä±·Ä°·Äê·ÄΩ·ÄÄ·Ä∫·ÄÄ·Ä≠·ÄØ·Äï·Ä´ ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·ÄÖ·ÄÖ·Ä∫·Äõ·Äô·Äö·Ä∫
                const existingItem = state.cart.find(i => i.id === state.selectedProduct.id);
                const existingQty = existingItem ? existingItem.qty : 0;
                const requestedQty = state.selectedProduct.qty;

                if (existingQty + requestedQty > currentStock) {
                    window.showMessage(`Sorry, only ${currentStock} item(s) available.`, 'error');
                    return; // Stock ·Äô·Äú·Ä±·Ä¨·ÄÄ·Ä∫·Äõ·ÄÑ·Ä∫ ·ÄÜ·ÄÄ·Ä∫·Äô·Äú·ÄØ·Äï·Ä∫·Äê·Ä±·Ä¨·Ä∑·Äò·Ä∞·Ä∏
                }
            }
            const checkboxes = document.querySelectorAll('input[name="prod_option"]:checked');
            const remark = document.getElementById('prod-remark').value.trim();

            let name = state.selectedProduct.name;
            let sizeInfo = null;
            if (state.selectedProduct.selectedSize) {
                sizeInfo = state.selectedProduct.selectedSize.name;
            }

            const unitCost = state.selectedProduct.cost || 0;

            const basePrice = state.selectedProduct.price;
            const discountAmt = state.selectedProduct.discount || 0;
            const taxRate = parseFloat(state.selectedProduct.tax) || 0;

            const taxableAmount = basePrice - discountAmt;
            const taxAmount = Math.round(taxableAmount * (taxRate / 100));
            const finalUnitPrice = taxableAmount + taxAmount;

            state.cart.push({
                ...state.selectedProduct,
                name: name,
                size: sizeInfo,
                cost: unitCost,
                discount: discountAmt,
                taxRate: taxRate,
                taxAmount: taxAmount,
                effectivePrice: finalUnitPrice,
                modifiers: Array.from(checkboxes).map(cb => cb.value),
                remarks: remark,
                lineTotal: finalUnitPrice * state.selectedProduct.qty,
                lineCost: unitCost * state.selectedProduct.qty
            });
            updateCartUI(); closeModal('modal-product');
        };

        function updateCartUI() {
            const c = state.cart.reduce((a, i) => a + i.qty, 0);
            document.getElementById('cart-count').innerText = c;
            const rawTotal = state.cart.reduce((a, i) => a + i.lineTotal, 0);
            document.getElementById('cart-total').innerText = rawTotal.toLocaleString() + " Ks";
            const bar = document.getElementById('cart-bar');
            if (c > 0) bar.classList.remove('translate-y-[200%]'); else bar.classList.add('translate-y-[200%]');
        }

        window.setOrderType = (type) => {
            state.orderType = type;
            const btnDine = document.getElementById('btn-type-dine');
            const btnTake = document.getElementById('btn-type-take');
            if (type === 'dine_in') { btnDine.classList.remove('text-dark-muted', 'hover:text-white'); btnDine.classList.add('bg-primary', 'text-white', 'shadow-md'); btnTake.classList.add('text-dark-muted', 'hover:text-white'); btnTake.classList.remove('bg-purple-600', 'text-white', 'shadow-md'); }
            else { btnDine.classList.add('text-dark-muted', 'hover:text-white'); btnDine.classList.remove('bg-primary', 'text-white', 'shadow-md'); btnTake.classList.remove('text-dark-muted', 'hover:text-white'); btnTake.classList.add('bg-purple-600', 'text-white', 'shadow-md'); }
        };
        window.openCheckoutModal = () => {
            if (state.cart.length === 0) return;

            // Discount State Reset
            state.billDiscount = { type: 'percent', value: 0 };
            document.getElementById('input-bill-disc').value = '';
            window.setBillDiscType('percent');

            // POS Mode Check
            const discContainer = document.getElementById('checkout-discount-container');
            if (state.isPOSMode) {
                discContainer.classList.remove('hide');
            } else {
                discContainer.classList.add('hide');
            }

            window.setOrderType('dine_in');

            // --- ULTRA COMPACT LIST STYLE (Horizontal Price & Icon) ---
            document.getElementById('checkout-items').innerHTML = state.cart.map((item, i) => `
                <div class="flex justify-between items-center border-b border-dark-700 py-1.5 last:border-0 relative group">
                    <div class="flex gap-2 items-center overflow-hidden">
                        
                        <!-- QTY Box (Smaller) -->
                        <div class="font-bold bg-dark-900 w-5 h-5 rounded flex items-center justify-center text-primary text-[10px] border border-dark-700 shrink-0">
                            ${item.qty}
                        </div>

                        <div class="flex-1 min-w-0">
                            <!-- Name & Size -->
                            <div class="flex items-center gap-1">
                                <p class="font-bold text-xs text-white truncate">${item.name}</p>
                                ${item.size ? `<span class="text-[9px] text-primary border border-primary/30 px-1 rounded">${item.size}</span>` : ''}
                            </div>

                            <!-- Modifiers (Subtext) -->
                            ${item.modifiers.length > 0 ? `<p class="text-[9px] text-dark-muted truncate leading-tight">${item.modifiers.join(', ')}</p>` : ''}
                        </div>
                    </div>

                    <!-- Right Side: Price & Delete (Horizontal) -->
                    <div class="flex items-center gap-2 pl-2 shrink-0">
                        
                        <!-- Price Details -->
                        <div class="flex flex-col items-end leading-none">
                            ${item.discount > 0 ? `<span class="text-[9px] text-gray-500 line-through">${(item.price * item.qty).toLocaleString()}</span>` : ''}
                            <span class="font-bold text-xs text-white font-mono">${item.lineTotal.toLocaleString()}</span>
                        </div>
                        
                        <!-- Delete Button -->
                        <button onclick="window.removeFromCart(${i})" class="text-dark-muted hover:text-red-400 transition p-1.5 bg-dark-900/50 rounded-full">
                            <i class="fas fa-trash text-[10px]"></i>
                        </button>
                    </div>
                </div>`).join('');
            // ----------------------------------------------------

            updateCheckoutTotals();
            document.getElementById('modal-checkout').classList.remove('hide');

            window.triggerAIUpsell();
        };
        // Updated Checkout Calculation (Compact Grid Layout)
        window.updateCheckoutTotals = () => {
            // 1. Get Discount Input
            const inputVal = parseFloat(document.getElementById('input-bill-disc').value) || 0;
            state.billDiscount.value = inputVal;

            // 2. Basic Calculations
            const totalSubtotal = state.cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            const totalItemDiscount = state.cart.reduce((acc, item) => acc + ((item.discount || 0) * item.qty), 0);

            // Amount after Item Discounts
            let baseAmount = totalSubtotal - totalItemDiscount;
            if (baseAmount < 0) baseAmount = 0;

            // 3. Calculate Bill Discount
            let billDiscAmount = 0;
            if (state.billDiscount.type === 'percent') {
                billDiscAmount = baseAmount * (state.billDiscount.value / 100);
            } else {
                billDiscAmount = state.billDiscount.value;
            }
            if (billDiscAmount > baseAmount) billDiscAmount = baseAmount;

            // New Base Amount after Bill Discount
            const amountAfterAllDisc = baseAmount - billDiscAmount;

            // 4. Tax & Service Charge Calculation
            const scRate = state.globalSettings.serviceCharge || 0;
            const taxRate = state.globalSettings.tax || 0;
            const isInclusive = state.globalSettings.taxType === 'inclusive';

            let totalServiceCharge = 0;
            let totalTax = 0;
            let grandTotal = 0;

            if (isInclusive) {
                // INCLUSIVE
                totalServiceCharge = amountAfterAllDisc * (scRate / 100);
                grandTotal = amountAfterAllDisc + totalServiceCharge;
                totalTax = grandTotal - (grandTotal / (1 + (taxRate / 100)));
            } else {
                // EXCLUSIVE
                totalServiceCharge = amountAfterAllDisc * (scRate / 100);
                totalTax = (amountAfterAllDisc + totalServiceCharge) * (taxRate / 100);
                grandTotal = amountAfterAllDisc + totalServiceCharge + totalTax;
            }

            // 5. UI Updates
            document.getElementById('checkout-subtotal').innerText = totalSubtotal.toLocaleString() + ' Ks';
            document.getElementById('checkout-item-disc').innerText = '-' + totalItemDiscount.toLocaleString() + ' Ks';
            document.getElementById('checkout-bill-disc').innerText = '-' + Math.round(billDiscAmount).toLocaleString() + ' Ks';

            // Tax UI
            let taxLabel = isInclusive ? `Tax (Incl. ${taxRate}%)` : `Tax (${taxRate}%)`;
            document.getElementById('label-checkout-tax').innerText = taxLabel;
            document.getElementById('checkout-tax-val').innerText = (isInclusive ? '' : '+') + Math.round(totalTax).toLocaleString() + ' Ks';

            // Service Charge UI (Toggle visibility instead of creating rows)
            const scRow = document.getElementById('row-checkout-svc');
            if (scRate > 0 && totalServiceCharge > 0) {
                scRow.classList.remove('hide');
                document.getElementById('label-checkout-svc').innerText = `Service Chg (${scRate}%)`;
                document.getElementById('checkout-svc-val').innerText = '+' + Math.round(totalServiceCharge).toLocaleString() + ' Ks';
            } else {
                scRow.classList.add('hide');
            }

            document.getElementById('checkout-grand-total').innerText = Math.round(grandTotal).toLocaleString() + ' Ks';
        };

        window.removeFromCart = (i) => { state.cart.splice(i, 1); if (state.cart.length === 0) closeModal('modal-checkout'); else window.openCheckoutModal(); updateCartUI(); };

        // Submit Order (UPDATED with Bill Discount Logic)
        window.submitOrder = async () => {
            // ·ÅÅ. Login ·Äù·ÄÑ·Ä∫·Äë·Ä¨·Ä∏·Äú·Ä¨·Ä∏ ·ÄÖ·ÄÖ·Ä∫·Äô·Äö·Ä∫
            if (!state.user) return window.showMessage("Not Connected", 'error');

            // ·ÅÇ. ·Ä°·ÄÅ·Äº·Ä±·ÄÅ·Ä∂ ·Äï·Äô·Ä¨·Äè·Äô·Äª·Ä¨·Ä∏ ·Äê·ÄΩ·ÄÄ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            const totalSubtotal = state.cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            const totalItemDiscount = state.cart.reduce((acc, item) => acc + ((item.discount || 0) * item.qty), 0);

            // Base Amount (Item Discount ·Äî·Äæ·ÄØ·Äê·Ä∫·Äï·Äº·ÄÆ·Ä∏)
            let baseAmount = totalSubtotal - totalItemDiscount;
            if (baseAmount < 0) baseAmount = 0;

            // üî• (·Ä°·Äû·ÄÖ·Ä∫) Bill Discount ·Äê·ÄΩ·ÄÄ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            let billDiscAmount = 0;
            const bdValue = state.billDiscount.value || 0;
            if (state.billDiscount.type === 'percent') {
                billDiscAmount = baseAmount * (bdValue / 100);
            } else {
                billDiscAmount = bdValue;
            }
            // Discount ·ÄÄ ·ÄÄ·Äª·Äû·ÄÑ·Ä∑·Ä∫·ÄÑ·ÄΩ·Ä±·Äë·ÄÄ·Ä∫ ·Äô·Äô·Äª·Ä¨·Ä∏·Äõ
            if (billDiscAmount > baseAmount) billDiscAmount = baseAmount;

            // Discount ·Äî·Äæ·ÄØ·Äê·Ä∫·Äï·Äº·ÄÆ·Ä∏·ÄÄ·Äª·Äî·Ä∫·ÄÑ·ÄΩ·Ä± (Tax ·Äî·Ä≤·Ä∑ Service Charge ·Äô·Äê·ÄΩ·ÄÄ·Ä∫·ÄÅ·ÄÑ·Ä∫)
            const amountAfterAllDisc = baseAmount - billDiscAmount;

            // ·ÅÉ. Tax & Service Charge ·Äê·ÄΩ·ÄÄ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            const scRate = state.globalSettings.serviceCharge || 0;
            const taxRate = state.globalSettings.tax || 0;
            const isInclusive = state.globalSettings.taxType === 'inclusive';

            let totalServiceCharge = 0;
            let totalTax = 0;
            let grandTotal = 0;

            // Inclusive / Exclusive ·Äê·ÄΩ·ÄÄ·Ä∫·Äî·Ää·Ä∫·Ä∏
            if (isInclusive) {
                // INCLUSIVE
                totalServiceCharge = amountAfterAllDisc * (scRate / 100);
                grandTotal = amountAfterAllDisc + totalServiceCharge;
                // Back-calculate Tax
                totalTax = grandTotal - (grandTotal / (1 + (taxRate / 100)));
            } else {
                // EXCLUSIVE
                totalServiceCharge = amountAfterAllDisc * (scRate / 100);
                // Tax is calculated on (Amount + SVC)
                totalTax = (amountAfterAllDisc + totalServiceCharge) * (taxRate / 100);
                grandTotal = amountAfterAllDisc + totalServiceCharge + totalTax;
            }

            const totalCost = state.cart.reduce((acc, item) => acc + (item.lineCost || 0), 0);

            // ·ÅÑ. Database ·Äë·Ä≤ ·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            try {
                const { addDoc, collection, serverTimestamp, doc, updateDoc, increment } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                // ·Ä°·ÄÜ·ÄÑ·Ä∑·Ä∫ (·ÄÄ) - Order ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ Database ·Äë·Ä≤ ·Ä°·Äõ·ÄÑ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Äö·Ä∫
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
                    tableId: state.tableId,
                    items: state.cart,

                    // ·ÄÑ·ÄΩ·Ä±·ÄÄ·Äº·Ä±·Ä∏·ÄÜ·Ä≠·ÄØ·ÄÑ·Ä∫·Äõ·Ä¨ ·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫·Äô·Äª·Ä¨·Ä∏
                    subtotal: totalSubtotal,
                    discount: totalItemDiscount, // Item Discount ‡∏£‡∏ß‡∏°

                    // üî• (·Ä°·Äû·ÄÖ·Ä∫) Bill Discount Fields
                    billDiscount: Math.round(billDiscAmount),
                    billDiscountType: state.billDiscount.type,
                    billDiscountVal: state.billDiscount.value,

                    serviceCharge: Math.round(totalServiceCharge),
                    tax: Math.round(totalTax),
                    taxRate: taxRate,
                    scRate: scRate,
                    taxType: state.globalSettings.taxType,

                    totalPrice: Math.round(grandTotal),
                    totalCost: totalCost,

                    status: 'pending',
                    timestamp: serverTimestamp(),
                    userId: state.user.uid,
                    orderType: state.orderType
                });

                // ·Ä°·ÄÜ·ÄÑ·Ä∑·Ä∫ (·ÄÅ) - Stock ·Äú·Äª·Äæ·Ä±·Ä¨·Ä∑·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ (·Äô·Ä∞·Äõ·ÄÑ·Ä∫·Ä∏·Ä°·Äê·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏)
                state.cart.forEach(async (item) => {
                    if (item.stock !== null && item.stock !== undefined) {
                        const productRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', item.id);
                        await updateDoc(productRef, {
                            stock: increment(-item.qty)
                        });
                    }
                });

                // ·ÅÖ. ·Äï·Äº·ÄÆ·Ä∏·Äû·ÄΩ·Ä¨·Ä∏·Äõ·ÄÑ·Ä∫ ·Äú·ÄÄ·Ä∫·ÄÄ·Äª·Äî·Ä∫·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏·Äõ·Ä±·Ä∏ ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
                state.cart = [];

                // üî• Discount State ·ÄÄ·Ä≠·ÄØ·Äú·Ää·Ä∫·Ä∏ Reset ·Äï·Äº·Äî·Ä∫·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
                state.billDiscount = { type: 'percent', value: 0 };
                document.getElementById('input-bill-disc').value = '';
                window.setBillDiscType('percent');

                updateCartUI();
                closeModal('modal-checkout');

                // --- INSERT THIS INSIDE submitOrder FUNCTION ---

                // Member ·Äõ·ÄΩ·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äõ·ÄÑ·Ä∫ ·Ä°·Äô·Äæ·Äê·Ä∫·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Äô·Äö·Ä∫
                if (state.currentMember) {
                    // ·ÅÅ·ÅÄ·ÅÄ·ÅÄ ·ÄÄ·Äª·Äï·Ä∫ = ·ÅÅ ·Äô·Äæ·Äê·Ä∫
                    const earnedPoints = Math.floor(grandTotal / 1000);

                    // Firebase Update
                    const custRef = doc(db, 'artifacts', appId, 'public', 'data', 'customers', state.currentMember.id);
                    await updateDoc(custRef, {
                        points: increment(earnedPoints),
                        visits: increment(1),
                        lastVisit: serverTimestamp()
                    });

                    // State Reset ·Äï·Äº·Äî·Ä∫·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
                    state.currentMember = null;
                    document.getElementById('checkout-mem-name').innerText = "Tap to Add Member";
                    document.getElementById('checkout-mem-name').className = "text-sm font-bold text-white group-hover:text-indigo-300 transition";
                }

                // -----------------------------------------------
                window.showMessage("Order Sent Successfully!", 'success');

                if (state.isPOSMode) {
                    const autoReturn = document.getElementById('chk-auto-return').checked;
                    if (autoReturn) setTimeout(() => exitPOSMode(), 1000);
                }

            } catch (e) {
                console.error(e);
                window.showMessage("Failed to submit order", 'error');
            }
        };
        // LOGIN MODAL LOGIC (KEYPAD)
        window.openLoginModal = () => {
            state.tempPin = '';
            updatePinDisplay();
            document.getElementById('modal-login').classList.remove('hide');
        };

        window.handlePinInput = (key) => {
            if (key === 'back') {
                state.tempPin = state.tempPin.slice(0, -1);
            } else {
                if (state.tempPin.length < 4) {
                    state.tempPin += key;
                }
            }
            updatePinDisplay();

            if (state.tempPin.length === 4) {
                // Short delay to see the last dot
                setTimeout(() => verifyPin(), 300);
            }
        };

        window.updatePinDisplay = () => {
            const pinContainer = document.getElementById('pin-display');
            const dots = pinContainer.children;
            for (let i = 0; i < 4; i++) {
                if (i < state.tempPin.length) {
                    dots[i].classList.remove('bg-dark-700');
                    dots[i].classList.add('bg-white');
                } else {
                    dots[i].classList.remove('bg-white');
                    dots[i].classList.add('bg-dark-700');
                }
            }
        };

        window.verifyPin = () => {
            const correctPin = localStorage.getItem('pingpos_admin_pin') || '1234';
            if (state.tempPin === correctPin) {
                navigateTo('screen-kitchen');
                closeModal('modal-login');
                state.tempPin = '';
                updatePinDisplay();
                window.showMessage(resources[state.lang]['login_success'] || "Login Successful", 'success');
            } else {
                // Incorrect PIN Animation
                const pinContainer = document.getElementById('pin-display');
                pinContainer.classList.add('animate-pulse');
                setTimeout(() => pinContainer.classList.remove('animate-pulse'), 500);

                state.tempPin = '';
                updatePinDisplay();
                window.showMessage(resources[state.lang]['wrong_pin'] || "Wrong PIN", 'error');
            }
        };

        window.openChangePinModal = () => document.getElementById('modal-change-pin').classList.remove('hide');
        window.saveNewPin = () => {
            const n = document.getElementById('new-pin-input').value;
            if (n.length >= 4) {
                localStorage.setItem('pingpos_admin_pin', n);
                window.showMessage(resources[state.lang]['saved_pin_success'] || "New PIN Saved", 'success');
                closeModal('modal-change-pin');
            } else {
                window.showMessage(resources[state.lang]['min_4_digits'] || "Min 4 digits", 'error');
            }
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hide');

        window.exitPOSMode = () => { state.isPOSMode = false; state.tableId = "1"; document.getElementById('pos-mode-header').classList.add('hide'); navigateTo('screen-kitchen'); };

        window.openReportModal = () => navigateTo('screen-analytics');
        window.openMenuManager = () => navigateTo('screen-menu');
        window.openTableMap = () => navigateTo('screen-tables');
        window.openQRModal = () => document.getElementById('modal-qr').classList.remove('hide');

        window.switchReportTab = (tab) => {
            // ·Ä°·Äü·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äê·ÄΩ·Ä± ·Äñ·Äª·Ä±·Ä¨·ÄÄ·Ä∫
            ['overview', 'history', 'cancelled', 'top', 'shifts'].forEach(t => {
                const view = document.getElementById(`rpt-view-${t}`);
                const btn = document.getElementById(`tab-${t}`);
                if (view) view.classList.add('hide');
                if (btn) {
                    if (t === tab) {
                        btn.classList.remove('text-dark-muted');
                        btn.classList.add('bg-dark-700', 'text-white', 'shadow-sm');
                    } else {
                        btn.classList.add('text-dark-muted');
                        btn.classList.remove('bg-dark-700', 'text-white', 'shadow-sm');
                    }
                }
            });

            // ·Äõ·ÄΩ·Ä±·Ä∏·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äê·Ä¨·ÄÄ·Ä≠·ÄØ ·Äñ·Ä±·Ä¨·Ä∫
            const targetView = document.getElementById(`rpt-view-${tab}`);
            if (targetView) targetView.classList.remove('hide');

            // Data ·ÄÜ·ÄΩ·Ä≤·Äõ·Äî·Ä∫ Function ·ÄÅ·Ä±·Ä´·Ä∫
            if (tab === 'overview') window.renderReportOverview();
            else if (tab === 'history') window.renderSalesHistory();
            else if (tab === 'cancelled') window.renderCancelledOrders();
            else if (tab === 'top') window.renderTopSelling();
            else if (tab === 'shifts') window.renderShiftHistory(); // <--- ·Äí·ÄÆ·Äê·ÄÖ·Ä∫·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏ ·Äï·Ä≠·ÄØ·Äú·Ä¨·Äú·Ä≠·ÄØ·Ä∑ ·Ä°·ÄÖ·Ä¨·Ä∏·Äë·Ä≠·ÄØ·Ä∏·ÄÅ·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·Äê·Ä¨·Äï·Ä´
        };
        function isDateInRange(dateObj, range, selectedDate) {
            const d = new Date(dateObj);
            const s = new Date(selectedDate);
            d.setHours(0, 0, 0, 0);
            const sMidnight = new Date(s);
            sMidnight.setHours(0, 0, 0, 0);

            if (range === 'daily') return d.getTime() === sMidnight.getTime();
            else if (range === 'weekly') {
                const day = sMidnight.getDay();
                const diff = sMidnight.getDate() - day + (day === 0 ? -6 : 1);
                const monday = new Date(sMidnight.setDate(diff));
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                return d >= monday && d <= sunday;
            }
            else if (range === 'monthly') return d.getMonth() === s.getMonth() && d.getFullYear() === s.getFullYear();
            else if (range === 'yearly') return d.getFullYear() === s.getFullYear();
            return false;
        }

        window.refreshReport = () => {
            if (!document.getElementById('rpt-view-overview').classList.contains('hide')) renderReportOverview();
            else if (!document.getElementById('rpt-view-history').classList.contains('hide')) renderSalesHistory();
            else if (!document.getElementById('rpt-view-cancelled').classList.contains('hide')) renderCancelledOrders();
            else renderTopSelling();
        };

        window.renderSalesChart = (labels, data) => {
            const ctx = document.getElementById('salesChart').getContext('2d');
            let gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, '#60A5FA'); gradient.addColorStop(1, '#2563EB');
            if (state.chartInstance) state.chartInstance.destroy();
            state.chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: resources[state.lang]['total_revenue'] + ' (Ks)', data: data, borderColor: '#3B82F6', backgroundColor: gradient, fill: true, tension: 0.4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: '#9CA3AF' } }, x: { grid: { display: false }, ticks: { color: '#9CA3AF', maxTicksLimit: 12 } } }, plugins: { legend: { display: false } } }
            });
        };

        window.renderTableChart = (labels, revenueData, countData) => {
            const ctx = document.getElementById('tableChart').getContext('2d');
            if (state.tableChartInstance) state.tableChartInstance.destroy();

            state.tableChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: resources[state.lang]['total_revenue'] + ' (Ks)',
                        data: revenueData,
                        backgroundColor: '#34D399',
                        borderRadius: 4,
                        order: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: '#9CA3AF' } },
                        x: { grid: { display: false }, ticks: { color: '#9CA3AF' } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += context.parsed.y.toLocaleString() + " Ks";
                                    return label;
                                },
                                afterLabel: function (context) {
                                    return `${resources[state.lang]['total_orders'] || 'Orders'}: ${countData[context.dataIndex]}`;
                                }
                            }
                        }
                    }
                }
            });
        };

        window.renderCategoryChart = (categories, data) => {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            if (state.categoryChartInstance) state.categoryChartInstance.destroy();
            const translatedLabels = categories.map(cat => resources[state.lang][cat] || cat);
            state.categoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: translatedLabels, datasets: [{ data: data, backgroundColor: ['#FF4757', '#34D399', '#FBBF24', '#60A5FA', '#A78BFA', '#F472B6', '#9CA3AF', '#EC4899', '#6366f1'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#9CA3AF', font: { size: 10 }, boxWidth: 10 } } }, cutout: '70%' }
            });
        };

        window.renderOrderTypeChart = (stats) => {
            const ctx = document.getElementById('orderTypeChart').getContext('2d');
            if (state.orderTypeChartInstance) state.orderTypeChartInstance.destroy();
            const dineInCount = state.orders.filter(o => o.orderType !== 'takeaway' && o.status !== 'cancelled').length;
            const takeawayCount = state.orders.filter(o => o.orderType === 'takeaway' && o.status !== 'cancelled').length;

            state.orderTypeChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: [resources[state.lang]['dine_in'], resources[state.lang]['takeaway']],
                    datasets: [{
                        data: [stats.dine_in, stats.takeaway],
                        backgroundColor: ['#3B82F6', '#A855F7'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#9CA3AF', font: { size: 10 }, boxWidth: 10 } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';

                                    const revenue = context.parsed.toLocaleString();
                                    const count = context.label === resources[state.lang]['dine_in'] ? dineInCount : takeawayCount;

                                    return `${label} ${revenue} Ks (${count} ${resources[state.lang]['total_orders'] || 'orders'})`;
                                }
                            }
                        }
                    }
                }
            });
        };

        window.renderReportOverview = () => {
            const dateInput = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            let c = 0, t = 0, cancelled = 0;
            let totalCost = 0;
            let totalExpenses = 0;

            let chartLabels = [];
            let chartData = [];
            let categoryStats = {};
            let typeStats = { dine_in: 0, takeaway: 0 };
            let tableStats = {};

            if (range === 'daily') {
                chartLabels = Array.from({ length: 24 }, (_, i) => `${i}:00`);
                chartData = new Array(24).fill(0);
                document.getElementById('rpt-period-label').innerText = new Date(dateInput).toDateString();
            } else if (range === 'weekly') {
                chartLabels = [resources[state.lang]['Mon'] || 'Mon', resources[state.lang]['Tue'] || 'Tue', resources[state.lang]['Wed'] || 'Wed', resources[state.lang]['Thu'] || 'Thu', resources[state.lang]['Fri'] || 'Fri', resources[state.lang]['Sat'] || 'Sat', resources[state.lang]['Sun'] || 'Sun'];
                chartData = new Array(7).fill(0);
                document.getElementById('rpt-period-label').innerText = resources[state.lang]['selected_week'] || "Selected Week";
            } else if (range === 'monthly') {
                const daysInMonth = new Date(new Date(dateInput).getFullYear(), new Date(dateInput).getMonth() + 1, 0).getDate();
                chartLabels = Array.from({ length: daysInMonth }, (_, i) => `${i + 1}`);
                chartData = new Array(daysInMonth).fill(0);
                document.getElementById('rpt-period-label').innerText = new Date(dateInput).toLocaleDateString(state.lang === 'cn' ? 'zh-CN' : 'en-US', { month: 'long', year: 'numeric' });
            } else if (range === 'yearly') {
                chartLabels = [resources[state.lang]['Jan'] || 'Jan', resources[state.lang]['Feb'] || 'Feb', resources[state.lang]['Mar'] || 'Mar', resources[state.lang]['Apr'] || 'Apr', resources[state.lang]['May'] || 'May', resources[state.lang]['Jun'] || 'Jun', resources[state.lang]['Jul'] || 'Jul', resources[state.lang]['Aug'] || 'Aug', resources[state.lang]['Sep'] || 'Sep', resources[state.lang]['Oct'] || 'Oct', resources[state.lang]['Nov'] || 'Nov', resources[state.lang]['Dec'] || 'Dec'];
                chartData = new Array(12).fill(0);
                document.getElementById('rpt-period-label').innerText = new Date(dateInput).getFullYear();
            }

            state.expenses.forEach(e => {
                if (e.timestamp && isDateInRange(new Date(e.timestamp.seconds * 1000), range, dateInput)) {
                    totalExpenses += e.amount;
                }
            });

            state.orders.forEach(o => {
                if (o.timestamp) {
                    const dateObj = new Date(o.timestamp.seconds * 1000);

                    if (isDateInRange(dateObj, range, dateInput)) {
                        if (o.status === 'cancelled') {
                            cancelled++;
                        } else {
                            c++;
                            t += o.totalPrice;
                            if (o.totalCost) totalCost += o.totalCost;

                            if (range === 'daily') chartData[dateObj.getHours()] += o.totalPrice;
                            else if (range === 'weekly') { const day = dateObj.getDay(); const index = day === 0 ? 6 : day - 1; chartData[index] += o.totalPrice; }
                            else if (range === 'monthly') chartData[dateObj.getDate() - 1] += o.totalPrice;
                            else if (range === 'yearly') chartData[dateObj.getMonth()] += o.totalPrice;

                            const tId = o.tableId || 'Unknown';
                            if (!tableStats[tId]) tableStats[tId] = { revenue: 0, count: 0 };
                            tableStats[tId].revenue += o.totalPrice;
                            tableStats[tId].count += 1;

                            if (o.items && Array.isArray(o.items)) {
                                o.items.forEach(item => {
                                    const cat = item.category || 'Other';
                                    categoryStats[cat] = (categoryStats[cat] || { qty: 0, revenue: 0 });
                                    categoryStats[cat].qty += item.qty;
                                    categoryStats[cat].revenue += item.lineTotal;
                                });
                            }
                            if (o.orderType === 'takeaway') typeStats.takeaway += o.totalPrice; else typeStats.dine_in += o.totalPrice;
                        }
                    }
                }
            });

            const netProfit = t - totalCost - totalExpenses;

            document.getElementById('rpt-ov-profit').innerText = netProfit.toLocaleString() + ' Ks';
            document.getElementById('rpt-ov-profit').classList.remove('text-red-300', 'text-white');
            if (netProfit < 0) document.getElementById('rpt-ov-profit').classList.add('text-red-300');

            document.getElementById('rpt-ov-total').innerText = t.toLocaleString() + ' Ks';
            document.getElementById('rpt-ov-cogs').innerText = totalCost.toLocaleString() + ' Ks';
            document.getElementById('rpt-ov-expenses').innerText = totalExpenses.toLocaleString() + ' Ks';
            document.getElementById('rpt-ov-count').innerText = c;
            document.getElementById('rpt-ov-cancelled').innerText = cancelled;

            switch (state.currentOverviewTab) {
                case 'sales':
                    renderSalesChart(chartLabels, chartData);
                    break;
                case 'table':
                    const sortedTables = Object.entries(tableStats).sort((a, b) => b[1].revenue - a[1].revenue);
                    renderTableChart(sortedTables.map(x => "T-" + x[0]), sortedTables.map(x => x[1].revenue), sortedTables.map(x => x[1].count));

                    const tableTbody = document.getElementById('table-data-tbody');
                    if (sortedTables.length > 0) {
                        tableTbody.innerHTML = sortedTables.map(([tId, stat], index) => {
                            const key = `T-${tId}`;
                            return `
                            <tr onclick="window.showDetailList('table', '${key}')" class="cursor-pointer hover:bg-dark-700 transition">
                                <td class="py-2 p-3 text-white font-bold flex items-center gap-2">${key}</td>
                                <td class="py-2 text-right p-3 text-dark-muted">${stat.count}</td>
                                <td class="py-2 text-right p-3 font-mono text-green-400 font-bold">${stat.revenue.toLocaleString()} Ks</td>
                            </tr>
                        `}).join('');
                    } else {
                        tableTbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-dark-700">No data</td></tr>';
                    }
                    break;
                case 'category':
                    const catLabels = Object.keys(categoryStats);
                    const catRevenue = catLabels.map(c => categoryStats[c].revenue);
                    renderCategoryChart(catLabels, catRevenue);

                    const catTbody = document.getElementById('cat-data-tbody');
                    if (catLabels.length > 0) {
                        catTbody.innerHTML = catLabels.map(cat => `
                            <tr onclick="window.showDetailList('category', '${cat}')" class="cursor-pointer hover:bg-dark-700 transition">
                                <td class="py-2 p-3 text-white font-bold">${resources[state.lang][cat] || cat}</td>
                                <td class="py-2 text-right p-3 text-dark-muted">${categoryStats[cat].qty}</td>
                                <td class="py-2 text-right p-3 font-mono text-green-400 font-bold">${categoryStats[cat].revenue.toLocaleString()} Ks</td>
                            </tr>
                        `).join('');
                    } else {
                        catTbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-dark-700">No data</td></tr>';
                    }
                    break;
                case 'type':
                    renderOrderTypeChart(typeStats);

                    const typeTbody = document.getElementById('type-data-tbody');
                    const typeData = [
                        { type: resources[state.lang]['dine_in'], key: 'dine_in', count: state.orders.filter(o => o.orderType !== 'takeaway' && o.status !== 'cancelled' && isDateInRange(new Date(o.timestamp.seconds * 1000), range, dateInput)).length, revenue: typeStats.dine_in },
                        { type: resources[state.lang]['takeaway'], key: 'takeaway', count: state.orders.filter(o => o.orderType === 'takeaway' && o.status !== 'cancelled' && isDateInRange(new Date(o.timestamp.seconds * 1000), range, dateInput)).length, revenue: typeStats.takeaway },
                    ];

                    if (typeData.some(d => d.revenue > 0)) {
                        typeTbody.innerHTML = typeData.map(d => `
                            <tr onclick="window.showDetailList('type', '${d.key}')" class="cursor-pointer hover:bg-dark-700 transition">
                                <td class="py-2 p-3 text-white font-bold">${d.type}</td>
                                <td class="py-2 text-right p-3 text-dark-muted">${d.count}</td>
                                <td class="py-2 text-right p-3 font-mono text-green-400 font-bold">${d.revenue.toLocaleString()} Ks</td>
                            </tr>
                        `).join('');
                    } else {
                        typeTbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-dark-700">No data</td></tr>';
                    }
                    break;
            }
        };


        window.renderSalesHistory = () => {
            const dateInput = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            const search = document.getElementById('history-search-input').value.toLowerCase().trim();
            const b = document.getElementById('rpt-history-body'); b.innerHTML = '';

            const h = state.orders.filter(o => {
                if (!o.timestamp) return false;
                const d = new Date(o.timestamp.seconds * 1000);

                const isDateMatch = ['served', 'cooking', 'pending', 'cancelled'].includes(o.status) && isDateInRange(d, range, dateInput);

                if (search && isDateMatch) {
                    const orderIdMatch = o.id.toLowerCase().includes(search.replace('#', ''));
                    const tableIdMatch = String(o.tableId).toLowerCase().includes(search.replace('t-', ''));
                    return orderIdMatch || tableIdMatch;
                }

                return isDateMatch;
            });

            if (h.length === 0) { b.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-xs text-dark-700">No records found for this period</td></tr>'; return; }

            h.forEach(o => {
                const d = o.timestamp ? new Date(o.timestamp.seconds * 1000) : new Date();
                let dateStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                if (range !== 'daily') dateStr = `${d.getDate()}/${d.getMonth() + 1} ${dateStr}`;

                const isTakeaway = o.orderType === 'takeaway';
                const typeIcon = isTakeaway ? '<i class="fas fa-shopping-bag text-purple-400" title="' + (resources[state.lang]['takeaway'] || 'Takeaway') + '"></i>' : '<i class="fas fa-utensils text-dark-muted" title="' + (resources[state.lang]['dine_in'] || 'Dine In') + '"></i>';
                let rowColor = isTakeaway ? 'bg-purple-900/10' : '';

                const isCancelled = o.status === 'cancelled';
                if (isCancelled) rowColor = 'bg-red-900/10 opacity-75';

                const itemsHtml = o.items.map(i =>
                    `<div class="flex justify-between text-xs py-1 border-b border-dark-700/50 last:border-0">
                        <span class="${isCancelled ? 'line-through' : ''}">${i.qty}x ${i.name} ${i.size ? `(${i.size})` : ''} <span class="text-[10px] text-dark-muted bg-dark-900 px-1 rounded ml-1 border border-dark-700">${resources[state.lang][i.category] || i.category || 'Other'}</span></span>
                        <span class="font-mono text-dark-muted">${i.lineTotal.toLocaleString()}</span>
                     </div>`
                ).join('');

                let mainRowAction;
                if (isCancelled) {
                    mainRowAction = `<span class="text-[10px] text-red-500 font-bold border border-red-500/50 px-1 rounded">${resources[state.lang]['cancel'].toUpperCase()}</span>`;
                } else if (o.status === 'served') {
                    mainRowAction = `<button onclick="event.stopPropagation(); window.printReceipt('${o.id}')" class="text-white hover:text-green-400 bg-green-500/20 px-2 py-1 rounded-lg text-xs font-bold transition"><i class="fas fa-receipt mr-1"></i> ${resources[state.lang]['print'] || 'Print'}</button>`;
                } else {
                    mainRowAction = `<span class="text-[10px] text-yellow-400 font-bold border border-yellow-500/50 px-1 rounded">${o.status.toUpperCase()}</span>`;
                }

                const mainRow = `
                    <tr onclick="toggleHistoryDetail('${o.id}')" class="cursor-pointer hover:bg-dark-700 transition border-b border-dark-700 last:border-0 group ${rowColor}">
                        <td class="p-3 text-xs text-white flex items-center gap-2">
                            <i class="fas fa-chevron-right text-[10px] text-dark-700 transition-transform group-hover:text-dark-muted" id="icon-${o.id}"></i>
                            ${dateStr}
                        </td>
                        <td class="p-3 font-bold text-white text-xs">
                            ${typeIcon} <span class="ml-1 ${isCancelled ? 'line-through decoration-red-500' : ''}">T-${o.tableId}</span>
                        </td>
                        <td class="p-3 font-bold ${isCancelled ? 'text-red-400 line-through' : 'text-primary'} text-right">${o.totalPrice.toLocaleString()}</td>
                        <td class="p-3 text-center">
                            ${mainRowAction}
                        </td>
                    </tr>
                `;

                const detailRow = `
                    <tr id="detail-${o.id}" class="hide bg-dark-900/50">
                        <td colspan="4" class="p-3 pl-8">
                            <div class="bg-dark-900 rounded-lg p-3 border border-dark-700 shadow-inner">
                                <h5 class="text-[10px] font-bold text-dark-muted uppercase mb-2 tracking-wider">${resources[state.lang]['order_items'] || 'Order Items'} ${isCancelled ? '(' + resources[state.lang]['cancel'].toUpperCase() + ')' : ''}</h5>
                                ${itemsHtml}
                                <div class="mt-3 pt-3 border-t border-dark-700 flex justify-between items-center text-xs">
                                     <div class="flex flex-col text-dark-muted">
                                         ${o.subtotal ? `<span>Subtotal: ${o.subtotal.toLocaleString()}</span>` : ''}
                                         ${o.discount ? `<span class="text-green-400">Disc: -${o.discount.toLocaleString()}</span>` : ''}
                                         ${o.tax ? `<span class="text-red-400">Tax: +${o.tax.toLocaleString()}</span>` : ''}
                                     </div>
                                </div>
                                <div class="mt-2 pt-2 border-t border-dark-700 flex justify-between items-center">
                                    ${o.orderType === 'takeaway' ? '<div class="text-[10px] font-bold text-purple-400 uppercase tracking-widest">' + (resources[state.lang]['takeaway'] || 'Takeaway') + ' ' + (resources[state.lang]['order'] || 'Order') + '</div>' : '<div></div>'}
                                    ${!isCancelled ? `<button onclick="event.stopPropagation(); window.printReceipt('${o.id}')" class="text-green-500 hover:text-green-400 bg-green-500/10 px-3 py-1 rounded-lg text-xs font-bold transition"><i class="fas fa-receipt mr-1"></i> ${resources[state.lang]['print_receipt'] || 'Print Receipt'}</button>` : ''}
                                    <button onclick="event.stopPropagation(); deleteOrder('${o.id}')" class="text-red-500 hover:text-red-400 bg-red-500/10 px-3 py-1 rounded-lg text-xs font-bold transition ml-2"><i class="fas fa-trash text-xs"></i> ${resources[state.lang]['delete_order'] || 'Delete Order'}</button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;

                b.innerHTML += mainRow + detailRow;
            });
        };

        window.toggleHistoryDetail = (id) => {
            const row = document.getElementById(`detail-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            if (row.classList.contains('hide')) {
                row.classList.remove('hide');
                icon.style.transform = 'rotate(90deg)';
                icon.classList.add('text-primary');
            } else {
                row.classList.add('hide');
                icon.style.transform = 'rotate(0deg)';
                icon.classList.remove('text-primary');
            }
        };

        window.renderCancelledOrders = () => {
            const dateInput = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            const b = document.getElementById('rpt-cancelled-body'); b.innerHTML = '';

            const h = state.orders.filter(o => {
                if (!o.timestamp) return false;
                const d = new Date(o.timestamp.seconds * 1000);
                return o.status === 'cancelled' && isDateInRange(d, range, dateInput);
            });

            if (h.length === 0) { b.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-xs text-dark-700">No cancelled records found for this period</td></tr>'; return; }

            h.forEach(o => {
                const d = o.timestamp ? new Date(o.timestamp.seconds * 1000) : new Date();
                let dateStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                if (range !== 'daily') dateStr = `${d.getDate()}/${d.getMonth() + 1} ${dateStr}`;

                const isTakeaway = o.orderType === 'takeaway';
                const typeIcon = isTakeaway ? '<i class="fas fa-shopping-bag text-purple-400" title="' + (resources[state.lang]['takeaway'] || 'Takeaway') + '"></i>' : '<i class="fas fa-utensils text-dark-muted" title="' + (resources[state.lang]['dine_in'] || 'Dine In') + '"></i>';

                const itemsHtml = o.items.map(i =>
                    `<div class="flex justify-between text-xs py-1 border-b border-dark-700/50 last:border-0">
                        <span class="line-through">${i.qty}x ${i.name} ${i.size ? `(${i.size})` : ''} <span class="text-[10px] text-dark-muted bg-dark-900 px-1 rounded ml-1 border border-dark-700">${resources[state.lang][i.category] || i.category || 'Other'}</span></span>
                        <span class="font-mono text-dark-muted">${i.lineTotal.toLocaleString()}</span>
                     </div>`
                ).join('');

                const mainRow = `
                    <tr onclick="toggleCancelledDetail('${o.id}')" class="cursor-pointer hover:bg-dark-700 transition border-b border-dark-700 last:border-0 group bg-red-900/10 opacity-80">
                        <td class="p-3 text-xs text-white flex items-center gap-2">
                            <i class="fas fa-chevron-right text-[10px] text-dark-700 transition-transform group-hover:text-dark-muted" id="icon-cancel-${o.id}"></i>
                            ${dateStr}
                        </td>
                        <td class="p-3 font-bold text-white text-xs">
                            ${typeIcon} <span class="ml-1 line-through decoration-red-500">T-${o.tableId}</span>
                        </td>
                        <td class="p-3 font-bold text-red-400 line-through text-right">${o.totalPrice.toLocaleString()}</td>
                        <td class="p-3 text-center">
                            <span class="text-[10px] text-red-500 font-bold border border-red-500/50 px-1 rounded">${resources[state.lang]['cancel'].toUpperCase()}</span>
                        </td>
                    </tr>
                `;

                const detailRow = `
                    <tr id="detail-cancel-${o.id}" class="hide bg-dark-900/50">
                        <td colspan="4" class="p-3 pl-8">
                            <div class="bg-dark-900 rounded-lg p-3 border border-dark-700 shadow-inner">
                                <h5 class="text-[10px] font-bold text-red-400 uppercase mb-2 tracking-wider">${resources[state.lang]['cancelled_items'] || 'CANCELLED ITEMS'}</h5>
                                ${itemsHtml}
                                ${o.orderType === 'takeaway' ? '<div class="mt-2 pt-2 border-t border-dark-700 text-[10px] font-bold text-purple-400 text-center uppercase tracking-widest">' + (resources[state.lang]['takeaway'] || 'Takeaway') + ' ' + (resources[state.lang]['order'] || 'Order') + '</div>' : ''}
                            </div>
                        </td>
                    </tr>
                `;

                b.innerHTML += mainRow + detailRow;
            });
        };

        window.toggleCancelledDetail = (id) => {
            const row = document.getElementById(`detail-cancel-${id}`);
            const icon = document.getElementById(`icon-cancel-${id}`);
            if (row.classList.contains('hide')) {
                row.classList.remove('hide');
                icon.style.transform = 'rotate(90deg)';
                icon.classList.add('text-red-400');
            } else {
                row.classList.add('hide');
                icon.style.transform = 'rotate(0deg)';
                icon.classList.remove('text-red-400');
            }
        };

        window.showDetailList = (type, key) => {
            const modal = document.getElementById('modal-analytics-detail');
            const titleEl = document.getElementById('detail-modal-title');
            const contentEl = document.getElementById('detail-modal-content');
            contentEl.innerHTML = '<div class="flex justify-center py-10"><span class="loader"></span></div>';

            let orders = state.orders.filter(o => o.status !== 'cancelled' && o.timestamp);
            const dateInput = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            orders = orders.filter(o => isDateInRange(new Date(o.timestamp.seconds * 1000), range, dateInput));

            let titleText = `Details for ${key}`;
            let detailHtml = '';

            if (type === 'table') {
                const tableId = key.replace('T-', '');
                const tableOrders = orders.filter(o => String(o.tableId) === tableId);
                titleText = `${resources[state.lang]['orders_for'] || 'Orders for'} Table T-${tableId}`;

                detailHtml = tableOrders.map(o => {
                    const d = new Date(o.timestamp.seconds * 1000);
                    const timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    return `
                        <div class="bg-dark-800 p-3 rounded-xl border border-dark-700">
                            <div class="flex justify-between items-center mb-2 border-b border-dark-700/50 pb-2">
                                <span class="text-xs font-bold text-white">${resources[state.lang]['order'] || 'Order'} #${o.id.slice(0, 4)} (${timeStr})</span>
                                <span class="text-lg font-extrabold text-primary">${o.totalPrice.toLocaleString()} Ks</span>
                            </div>
                            <ul class="space-y-1 text-xs text-dark-muted">
                                ${o.items.map(item =>
                        `<li class="flex justify-between">
                                        <span>${item.qty}x ${item.name} ${item.size ? `(${item.size})` : ''}</span>
                                        <span class="text-[10px] text-right bg-dark-900 px-1 rounded">${resources[state.lang][item.category] || item.category || 'Other'}</span>
                                    </li>`
                    ).join('')}
                            </ul>
                        </div>
                    `;
                }).join('');

            } else if (type === 'category') {
                const category = key;
                titleText = `${resources[state.lang]['items_sold_in'] || 'Items Sold in'} ${resources[state.lang]['category'] || 'Category'}: ${resources[state.lang][category] || category}`;

                let itemAgg = {};
                orders.forEach(o => {
                    o.items.forEach(item => {
                        if ((item.category || 'Other') === category) {
                            const itemKey = item.name + (item.size ? ` (${item.size})` : '');
                            itemAgg[itemKey] = (itemAgg[itemKey] || { qty: 0, revenue: 0 });
                            itemAgg[itemKey].qty += item.qty;
                            itemAgg[itemKey].revenue += item.lineTotal;
                        }
                    });
                });

                const sortedItems = Object.entries(itemAgg).sort((a, b) => b[1].qty - a[1].qty);

                detailHtml = sortedItems.map(([name, data]) => `
                    <div class="flex justify-between items-center bg-dark-800 p-3 rounded-xl border border-dark-700">
                        <span class="text-sm font-bold text-white">${name}</span>
                        <div class="text-right">
                            <span class="text-xs font-bold text-dark-muted block">${data.qty} ${resources[state.lang]['sold'] || 'sold'}</span>
                            <span class="text-sm font-extrabold text-green-400">${data.revenue.toLocaleString()} Ks</span>
                        </div>
                    </div>
                `).join('');

            } else if (type === 'type') {
                const orderType = key;
                titleText = `${resources[state.lang][key] || key} ${resources[state.lang]['orders'] || 'Orders'}`;

                const typeOrders = orders.filter(o => o.orderType === orderType || (orderType === 'dine_in' && o.orderType !== 'takeaway'));

                detailHtml = typeOrders.map(o => {
                    const d = new Date(o.timestamp.seconds * 1000);
                    const timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    return `
                        <div class="bg-dark-800 p-3 rounded-xl border border-dark-700">
                            <div class="flex justify-between items-center mb-2 border-b border-dark-700/50 pb-2">
                                <span class="text-xs font-bold text-white">${resources[state.lang]['order'] || 'Order'} #${o.id.slice(0, 4)} (${timeStr})</span>
                                <span class="text-lg font-extrabold text-primary">${o.totalPrice.toLocaleString()} Ks</span>
                            </div>
                            <ul class="space-y-1 text-xs text-dark-muted">
                                ${o.items.map(item =>
                        `<li class="flex justify-between">
                                        <span>${item.qty}x ${item.name} ${item.size ? `(${item.size})` : ''}</span>
                                        <span class="text-[10px] text-right bg-dark-900 px-1 rounded">${resources[state.lang][item.category] || item.category || 'Other'}</span>
                                    </li>`
                    ).join('')}
                            </ul>
                        </div>
                    `;
                }).join('');
            }

            if (detailHtml === '') detailHtml = `<p class="text-center text-dark-700 p-10">${resources[state.lang]['no_detailed_records'] || 'No detailed records found for this selection.'}</p>`;

            titleEl.innerText = titleText;
            contentEl.innerHTML = detailHtml;
            modal.classList.remove('hide');
        };

        window.renderTopSelling = () => {
            const dateInput = document.getElementById('rpt-date-input').value;
            const range = document.getElementById('rpt-range-select').value;
            const c = {};

            const filteredOrders = state.orders.filter(o => {
                if (!o.timestamp) return false;
                const d = new Date(o.timestamp.seconds * 1000);
                return o.status !== 'cancelled' && isDateInRange(d, range, dateInput);
            });

            filteredOrders.forEach(o => {
                if (o.items) o.items.forEach(i => {
                    const nameKey = i.name + (i.size ? ` (${i.size})` : '');
                    if (!c[nameKey]) c[nameKey] = { qty: 0, revenue: 0, category: i.category || 'Other' };
                    c[nameKey].qty += i.qty;
                    c[nameKey].revenue += i.lineTotal;
                });
            });

            const s = Object.entries(c).sort((a, b) => b[1].qty - a[1].qty);
            const ct = document.getElementById('rpt-top-list'); ct.innerHTML = '';

            if (s.length === 0) ct.innerHTML = '<p class="text-center text-dark-700 p-4 text-xs">' + (resources[state.lang]['no_sales_data'] || 'No sales data for this period') + '</p>';

            const maxVal = s.length > 0 ? s[0][1].qty : 1;

            s.forEach(([n, data], i) => {
                const percent = (data.qty / maxVal) * 100;
                ct.innerHTML += `
                <div class="p-3 bg-dark-800 rounded-xl border border-dark-700 relative overflow-hidden group">
                    <div class="absolute top-0 left-0 bottom-0 bg-gradient-to-r from-primary/20 to-transparent transition-all duration-500" style="width: ${percent}%"></div>
                    <div class="relative flex justify-between items-center z-10">
                        <div class="flex gap-3 items-center">
                            <span class="font-bold text-primary w-5 text-sm">#${i + 1}</span>
                            <div>
                                <p class="font-bold text-white text-sm flex items-center gap-2">
                                    ${n} 
                                    <span class="text-[9px] px-1.5 py-0.5 bg-dark-900 border border-dark-600 rounded text-dark-muted font-normal uppercase tracking-wide">${resources[state.lang][data.category] || data.category}</span>
                                </p>
                                <p class="text-[10px] text-dark-muted mt-0.5">${resources[state.lang]['revenue'] || 'Revenue'}: <span class="text-green-400 font-bold">${data.revenue.toLocaleString()} Ks</span></p>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-white bg-dark-900 px-2 py-1 rounded-lg border border-dark-600 shadow-sm">${data.qty} ${resources[state.lang]['sold'] || 'sold'}</span>
                    </div>
                </div>`;
            });
        };

        window.deleteOrder = (id) => {
            window.showConfirm('delete_confirm', async () => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
                window.showMessage(resources[state.lang]['cleared_success'] || "Record Deleted", 'success');
                renderSalesHistory();
            }, false);
        };

        window.clearAllHistory = () => {
            window.showConfirm('delete_all_confirm', async () => {
                const ordersToDelete = state.orders.map(o => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', o.id)));
                await Promise.all(ordersToDelete);
                window.showMessage(resources[state.lang]['cleared_success'] || "History Cleared", 'success');
                renderSalesHistory();
            }, true);
        };

        window.generateQR = () => {
            const t = document.getElementById('qr-table-num').value;

            const myWebsiteLink = "https://mrping2025-oss.github.io/PingPos/";

            document.getElementById('qr-container').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(myWebsiteLink + '?table=' + t)}">`;
        };

        window.printQR = () => {
            const qrContent = document.getElementById('qr-container').innerHTML;
            const tableNum = document.getElementById('qr-table-num').value;
            const printArea = document.getElementById('receipt-print-area');

            printArea.innerHTML = `
                <div style="text-align:center; padding: 20px; font-family: sans-serif; color: black;">
                    <h1 style="font-size: 28px; font-weight: bold; margin: 0;">PingPOS</h1>
                    <p style="font-size: 14px; margin: 5px 0;">Restaurant & Cafe</p>
                    <div style="border-top: 2px solid black; border-bottom: 2px solid black; margin: 15px 0; padding: 10px 0;">
                        <h2 style="font-size: 22px; margin: 0;">TABLE NUMBER - ${tableNum}</h2>
                    </div>
                    <div style="display: flex; justify-content: center; margin: 20px 0;">${qrContent}</div>
                    <p style="margin-top: 10px; font-size: 14px; font-weight: bold;">Scan to Order</p>
                </div>
            `;
            triggerPrint();
        };

        // UPDATED PRINT TICKET FUNCTION (With Routing)
        window.printTicket = (id, type, filterMode = 'all') => {
            const o = state.orders.find(x => x.id === id);
            if (!o) return;

            // ·ÅÅ. Filter Logic (·Ä°·ÄÖ·Ä¨·Ä∏·Ä°·Äû·Ä±·Ä¨·ÄÄ·Ä∫ ·Äî·Ä≤·Ä∑ ·Ä°·Ä°·Ä±·Ä∏ ·ÄÅ·ÄΩ·Ä≤·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏)
            // Bar ·Äî·Ä≤·Ä∑ ·Äû·ÄÄ·Ä∫·ÄÜ·Ä≠·ÄØ·ÄÑ·Ä∫·Äê·Ä≤·Ä∑ Category ·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ ·Äí·ÄÆ·Äô·Äæ·Ä¨ ·Äû·Äê·Ä∫·Äô·Äæ·Äê·Ä∫·Äï·Ä´
            // printTicket function ·Äë·Ä≤·ÄÄ ·Äí·ÄÆ·Ä°·Äï·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ ·Äõ·Äæ·Ä¨·Äï·Äº·ÄÆ·Ä∏ ·Ä°·ÄÖ·Ä¨·Ä∏·Äë·Ä≠·ÄØ·Ä∏·Äï·Ä´
            // ·ÅÅ. Filter Logic (·Ä°·ÄÖ·Ä¨·Ä∏·Ä°·Äû·Ä±·Ä¨·ÄÄ·Ä∫ ·Äî·Ä≤·Ä∑ ·Ä°·Ä°·Ä±·Ä∏ ·ÄÅ·ÄΩ·Ä≤·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏)
            const barCategories = ['Drink', 'Dessert', 'Beverage'];

            let itemsToPrint = o.items;
            let headerTitle = "";

            if (type === 'kitchen') {
                if (filterMode === 'all') {
                    // Combined Mode: ·Ä°·ÄÄ·ÄØ·Äî·Ä∫·Äö·Ä∞·Äô·Äö·Ä∫ (Filter ·Äô·Äú·ÄØ·Äï·Ä∫·Äò·Ä∞·Ä∏)
                    itemsToPrint = o.items;
                    headerTitle = "KITCHEN TICKET (ALL)";
                }
                else if (filterMode === 'kitchen') {
                    // Split Mode: Food Only (Bar ·Äô·Äï·Ä´)
                    itemsToPrint = o.items.filter(i => !barCategories.includes(i.category));
                    headerTitle = "KITCHEN TICKET (FOOD)";
                }
                else if (filterMode === 'bar') {
                    // Split Mode: Bar Only
                    itemsToPrint = o.items.filter(i => barCategories.includes(i.category));
                    headerTitle = "BAR TICKET (DRINKS)";
                }
            } else {
                headerTitle = "RECEIPT"; // Customer Receipt
            }
            // ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äõ·Äæ·Ä≠·Äõ·ÄÑ·Ä∫ ·Äô·Äë·ÄØ·Äê·Ä∫·Äò·Ä∞·Ä∏ (·Ä•·Äï·Äô·Ä¨ - ·Ä°·Ä°·Ä±·Ä∏·Äô·Äï·Ä´·Äê·Ä≤·Ä∑ Order ·ÄÄ·Ä≠·ÄØ Bar Ticket ·Äî·Äæ·Ä≠·Äï·Ä∫·Äô·Ä≠·Äõ·ÄÑ·Ä∫ ·Äò·Ä¨·Äô·Äæ·Äô·Äú·ÄØ·Äï·Ä∫·Äò·Ä∞·Ä∏)
            if (itemsToPrint.length === 0) {
                window.showMessage("No items for this station", "error");
                return;
            }

            window.showMessage("Printing " + headerTitle + "...", "success");
            const printArea = document.getElementById('receipt-print-area');

            const now = o.timestamp ? new Date(o.timestamp.seconds * 1000) : new Date();
            const dateStr = now.toLocaleDateString('en-GB');
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            let itemsHtml = itemsToPrint.map(i => {
                let mods = i.modifiers && i.modifiers.length ? `<div style="font-size: 10px; color: #444; margin-left: 10px;">+ ${i.modifiers.join(', ')}</div>` : '';
                let remarks = i.remarks ? `<div style="font-size: 11px; font-weight: bold; font-style: italic; margin-left: 10px;">* ${i.remarks}</div>` : '';
                let priceHtml = type === 'kitchen' ? '' : `<td style="text-align: right; vertical-align: top; font-weight: bold;">${(i.effectivePrice * i.qty).toLocaleString()}</td>`;

                return `
            <tr style="border-bottom: 1px dashed #ccc;">
                <td style="padding: 6px 0; vertical-align: top;">
                    <div style="font-weight: bold; font-size: 13px;">${i.qty} x ${i.name} ${i.size ? `(${i.size})` : ''}</div>
                    ${mods} ${remarks}
                </td>
                ${priceHtml}
            </tr>
        `;
            }).join('');

            let footerHtml = '';
            if (type !== 'kitchen') {
                // Receipt Footer Logic (Same as before)
                const subtotal = o.subtotal || 0;
                const discount = o.discount || 0;
                const tax = o.tax || 0;
                const svc = o.serviceCharge || 0;
                footerHtml = `
            <div style="margin-top: 10px; border-top: 1px solid black; padding-top: 5px; font-size: 13px;">
                <div style="display: flex; justify-content: space-between;"><span>Subtotal:</span><span>${subtotal.toLocaleString()} Ks</span></div>
                ${discount > 0 ? `<div style="display: flex; justify-content: space-between;"><span>Discount:</span><span>-${discount.toLocaleString()} Ks</span></div>` : ''}
                ${svc > 0 ? `<div style="display: flex; justify-content: space-between;"><span>Service Chg (${o.scRate || ''}%):</span><span>+${svc.toLocaleString()} Ks</span></div>` : ''}
                ${tax > 0 ? `<div style="display: flex; justify-content: space-between;"><span>Tax (${o.taxRate || ''}%):</span><span>+${tax.toLocaleString()} Ks</span></div>` : ''}
                <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; margin-top: 5px; border-top: 1.5px solid black; padding-top: 5px;">
                    <span>GRAND TOTAL:</span>
                    <span>${o.totalPrice.toLocaleString()} Ks</span>
                </div>
                 <div style="margin-top: 10px; padding: 6px; border: 1px solid black; text-align: center; font-weight: bold; background-color: #f0f0f0; text-transform: uppercase;">
                    Payment: ${o.paymentMethod || 'CASH'}
                </div>
            </div>
        `;
            }

            printArea.innerHTML = `
        <div style="font-family: 'Courier New', Courier, monospace; width: 280px; margin: 0 auto; color: black; padding: 10px; background: white;">
            <div style="text-align: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 10px;">
                <h2 style="margin: 0; font-size: 22px;">PingPOS</h2>
                <div style="margin-top: 5px; font-weight: bold; font-size: 16px; border: 2px solid black; padding: 5px;">${headerTitle}</div>
            </div>
            
            <div style="font-size: 12px; margin-bottom: 10px; line-height: 1.4;">
                <div style="display: flex; justify-content: space-between;"><span>Date: ${dateStr}</span><span>Time: ${timeStr}</span></div>
                <div style="display: flex; justify-content: space-between;"><span>Order: #${o.id.slice(-5).toUpperCase()}</span><span style="font-weight: bold; font-size: 14px;">Table: ${o.tableId}</span></div>
                <div style="text-transform: uppercase; font-weight: bold; margin-top: 2px;">Type: ${o.orderType === 'takeaway' ? 'Takeaway' : 'Dine-in'}</div>
            </div>
            
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <tr style="border-bottom: 1px solid black; text-align: left;">
                    <th style="padding-bottom: 5px;">Item</th>
                    ${type !== 'kitchen' ? '<th style="text-align: right; padding-bottom: 5px;">Price</th>' : ''}
                </tr>
                ${itemsHtml}
            </table>
            ${footerHtml}
        </div>
    `;

            triggerPrint();
        };
        function triggerPrint() {
            const printArea = document.getElementById('receipt-print-area');
            printArea.style.display = 'block';

            setTimeout(() => {
                window.print();
                setTimeout(() => {
                    printArea.style.display = 'none';
                }, 1000);
            }, 500);
        }

        window.printReceipt = (id) => window.printTicket(id, 'customer');

        const getOccupiedTables = () => {
            const busy = new Set();
            state.orders.forEach(o => {
                if (['pending', 'cooking'].includes(o.status)) busy.add(String(o.tableId));
            });
            return busy;
        };

        // 1. View State Variable
        state.tableViewMode = 'map'; // 'map' or 'grid'

        // 2. Toggle Function
        window.toggleTableView = (mode) => {
            state.tableViewMode = mode;
            const btnMap = document.getElementById('btn-view-map');
            const btnGrid = document.getElementById('btn-view-grid');
            const divMap = document.getElementById('table-map-container');
            const divGrid = document.getElementById('table-grid-container');
            const btnEdit = document.getElementById('btn-edit-layout');

            if (mode === 'grid') {
                // Grid Mode UI
                btnGrid.classList.replace('text-dark-muted', 'text-white');
                btnGrid.classList.add('bg-primary', 'shadow');
                btnMap.classList.remove('bg-primary', 'text-white', 'shadow');
                btnMap.classList.add('text-dark-muted');

                divMap.classList.add('hide');
                divGrid.classList.remove('hide');
                btnEdit.classList.add('hide'); // Grid mode ·Äô·Äæ·Ä¨ Edit ·Äï·Ä±·Ä∏·Äô·Äú·ÄØ·Äï·Ä∫·Äò·Ä∞·Ä∏

                window.renderTableGrid(); // Grid ·ÄÄ·Ä≠·ÄØ Render ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
            } else {
                // Map Mode UI
                btnMap.classList.replace('text-dark-muted', 'text-white');
                btnMap.classList.add('bg-primary', 'shadow');
                btnGrid.classList.remove('bg-primary', 'text-white', 'shadow');
                btnGrid.classList.add('text-dark-muted');

                divGrid.classList.add('hide');
                divMap.classList.remove('hide');
                btnEdit.classList.remove('hide');

                window.renderTableMap(); // Map ·ÄÄ·Ä≠·ÄØ Render ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
            }
        };

        // 3. Render Grid Function (New)
        window.renderTableGrid = () => {
            const container = document.getElementById('table-grid-content');
            container.innerHTML = '';
            const busyTables = getOccupiedTables();

            // Sort tables by ID (numeric)
            const sortedTables = [...state.tables].sort((a, b) => {
                return parseInt(a.id) - parseInt(b.id);
            });

            sortedTables.forEach(t => {
                const isBusy = busyTables.has(String(t.id));
                const colorClass = isBusy
                    ? "bg-red-500/10 text-red-500 border-red-500/50 hover:bg-red-500 hover:text-white"
                    : "bg-green-500/10 text-green-500 border-green-500/50 hover:bg-green-500 hover:text-white";

                const statusText = isBusy ? "Occupied" : "Free";

                const div = document.createElement('button');
                div.className = `flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all active:scale-95 ${colorClass}`;
                div.onclick = () => window.startPOSMode(t.id);

                div.innerHTML = `
            <span class="text-xl font-bold mb-1">T-${t.id}</span>
            <span class="text-[10px] uppercase font-bold tracking-wider opacity-80">${statusText}</span>
        `;
                container.appendChild(div);
            });
        };

        // 4. Update navigateTo to respect the view
        const originalNavigateTo = window.navigateTo;
        window.navigateTo = (screenId) => {
            originalNavigateTo(screenId);
            if (screenId === 'screen-tables') {
                // Default to Grid on Mobile, Map on Desktop if first load
                const isMobile = window.innerWidth < 640;
                if (state.tableViewMode === 'map' && isMobile) {
                    toggleTableView('grid'); // Auto switch to grid for mobile
                } else {
                    toggleTableView(state.tableViewMode);
                }
            }
        };
        window.renderTableMap = () => {
            const busyTables = getOccupiedTables(); const container = document.getElementById('table-map-container'); container.innerHTML = '';

            if (state.tables.length === 0) generateDefaultTables();

            if (!state.isLayoutEdit && state.selectedTableId) { state.selectedTableId = null; updatePropertiesPanel(); }

            state.tables.forEach(t => {
                const isBusy = busyTables.has(String(t.id)); const isSelected = state.selectedTableId === String(t.id);
                const shapeClass = t.shape === 'rect' ? 'rounded-lg aspect-square' : 'rounded-full aspect-square';
                const colorClass = isBusy ? "bg-red-500 shadow-red-500/50" : "bg-green-500 shadow-green-500/50";
                let borderClass = "cursor-pointer hover:brightness-110"; if (state.isLayoutEdit) { borderClass = "cursor-move border-2 border-dashed border-white/30"; if (isSelected) borderClass = "selected cursor-move"; }
                const sizeScale = t.size || 1; const baseSize = 80; const sizePx = baseSize * sizeScale;
                const div = document.createElement('div'); div.className = `table-node flex flex-col items-center justify-center text-white font-bold shadow-lg ${shapeClass} ${colorClass} ${borderClass}`; div.style.left = t.x + '%'; div.style.top = t.y + '%'; div.style.width = sizePx + 'px'; div.style.height = sizePx + 'px'; div.style.fontSize = (16 * sizeScale) + 'px'; div.id = `table-${t.id}`;
                div.innerHTML = `<i class="fas ${t.shape === 'rect' ? 'fa-square' : 'fa-circle'} mb-1 opacity-50 pointer-events-none" style="font-size: 1.2em"></i><span class="pointer-events-none">T-${t.id}</span>`;
                if (state.isLayoutEdit) { div.addEventListener('mousedown', (e) => startDrag(e, t.id)); div.addEventListener('touchstart', (e) => startDrag(e, t.id), { passive: false }); div.onclick = (e) => { e.stopPropagation(); selectTable(t.id); }; }
                else { div.onclick = () => window.startPOSMode(t.id); }
                container.appendChild(div);
            });
            updatePropertiesPanel();
        };

        window.selectTable = (id) => { if (!state.isLayoutEdit) return; state.selectedTableId = id; renderTableMap(); };
        window.deselectTable = () => { if (state.selectedTableId) { state.selectedTableId = null; renderTableMap(); } };
        window.updatePropertiesPanel = () => { const panel = document.getElementById('table-properties'); const legend = document.getElementById('map-legend'); if (state.isLayoutEdit && state.selectedTableId) { legend.classList.add('hide'); panel.classList.remove('hide'); const t = state.tables.find(x => x.id === state.selectedTableId); if (t) { document.getElementById('prop-id').innerText = "T-" + t.id; document.getElementById('prop-size').value = t.size || 1; } } else { legend.classList.remove('hide'); panel.classList.add('hide'); } };
        window.updateTableProperty = (key, val) => { if (!state.selectedTableId) return; const t = state.tables.find(x => x.id === state.selectedTableId); if (t) { t[key] = (key === 'size') ? parseFloat(val) : val; renderTableMap(); } };

        window.deleteSelectedTable = () => {
            if (!state.selectedTableId) return;
            window.showConfirm('delete_table_confirm', async () => {
                state.tables = state.tables.filter(t => t.id !== state.selectedTableId);
                state.selectedTableId = null;
                renderTableMap();
                window.showMessage(resources[state.lang]['removed'] || "Table Deleted", 'success');
            }, true);
        };

        window.startDrag = (e, tId) => { };
        window.toggleLayoutEdit = () => { state.isLayoutEdit = !state.isLayoutEdit; const btn = document.getElementById('btn-edit-layout'); const controls = document.getElementById('layout-edit-controls'); state.selectedTableId = null; if (state.isLayoutEdit) { btn.classList.add('bg-dark-700', 'text-white'); controls.classList.remove('hide'); document.getElementById('table-map-subtitle').innerText = (resources[state.lang]['select_table_to_edit'] || "Select table to edit properties."); } else { btn.classList.remove('bg-dark-700', 'text-white'); controls.classList.add('hide'); document.getElementById('table-map-subtitle').innerText = (resources[state.lang]['select_table_msg'] || "Select a table to take order"); } renderTableMap(); };
        window.addNewTable = () => { const maxId = state.tables.reduce((max, t) => Math.max(max, parseInt(t.id) || 0), 0); const newId = String(maxId + 1); const shapeSelect = document.getElementById('new-table-shape'); state.tables.push({ id: newId, x: 45, y: 45, shape: shapeSelect ? shapeSelect.value : 'round', size: 1 }); renderTableMap(); state.selectedTableId = newId; renderTableMap(); };
        window.saveLayout = async () => { const btn = document.getElementById('btn-save-layout'); btn.innerHTML = 'Saving...'; try { const cleanTables = state.tables.map(t => ({ id: String(t.id), x: Number(t.x) || 0, y: Number(t.y) || 0, shape: t.shape || 'round', size: Number(t.size) || 1 })); await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config_tables', 'main_layout'), { tables: cleanTables, updatedAt: serverTimestamp() }); window.showMessage(resources[state.lang]['saved'] || "Saved!", 'success'); if (state.isLayoutEdit) window.toggleLayoutEdit(); } catch (e) { console.error(e); window.showMessage(resources[state.lang]['error'] || "Error", 'error'); } finally { btn.innerHTML = 'Save'; } };

        window.startDrag = (e, tId) => {
            if (!state.isLayoutEdit) return; e.preventDefault();
            if (state.selectedTableId !== tId) { state.selectedTableId = tId; renderTableMap(); }
            const table = state.tables.find(t => t.id === tId); const el = document.getElementById(`table-${tId}`); const container = document.getElementById('table-map-container');
            const startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; const startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            const rect = el.getBoundingClientRect(); const containerRect = container.getBoundingClientRect();
            const offsetX = startX - rect.left; const offsetY = startY - rect.top;
            state.dragItem = { tId, offsetX, offsetY, containerRect };
            const moveHandler = (moveEvent) => {
                const clientX = moveEvent.type.includes('mouse') ? moveEvent.clientX : moveEvent.touches[0].clientX; const clientY = moveEvent.type.includes('mouse') ? moveEvent.clientY : moveEvent.touches[0].clientY;
                let newLeft = clientX - state.dragItem.containerRect.left - state.dragItem.offsetX; let newTop = clientY - state.dragItem.containerRect.top - state.dragItem.offsetY;
                let percentX = (newLeft / state.dragItem.containerRect.width) * 100; let percentY = (newTop / state.dragItem.containerRect.height) * 100;
                percentX = Math.max(0, Math.min(90, percentX)); percentY = Math.max(0, Math.min(90, percentY));
                el.style.left = percentX + '%'; el.style.top = percentY + '%'; table.x = percentX; table.y = percentY;
            };
            const upHandler = () => { document.removeEventListener('mousemove', moveHandler); document.removeEventListener('mouseup', upHandler); document.removeEventListener('touchmove', moveHandler); document.removeEventListener('touchend', upHandler); state.dragItem = null; };
            document.addEventListener('mousemove', moveHandler); document.addEventListener('mouseup', upHandler); document.addEventListener('touchmove', moveHandler, { passive: false }); document.addEventListener('touchend', upHandler);
        };

        // --- UPDATED FEATURE: TRANSFER & MERGE LOGIC ---
        window.openTransferModal = (orderId, currentTableId, currentType) => {
            state.transferOrderId = orderId;
            state.transferTargetId = null;
            state.transferMode = 'transfer';
            window.setUpdateMode('transfer');
            window.renderTransferGrid();
            window.selectTransferType(currentType || 'dine_in');
            document.getElementById('modal-transfer').classList.remove('hide');
        };

        window.setUpdateMode = (mode) => {
            state.transferMode = mode;
            const tBtn = document.getElementById('update-mode-transfer');
            const mBtn = document.getElementById('update-mode-merge');
            if (mode === 'transfer') { tBtn.className = "flex-1 py-2 rounded-lg text-[10px] font-bold bg-dark-700 text-white shadow-sm uppercase transition"; mBtn.className = "flex-1 py-2 rounded-lg text-[10px] font-bold text-dark-muted hover:text-white uppercase transition"; }
            else { tBtn.className = "flex-1 py-2 rounded-lg text-[10px] font-bold text-dark-muted hover:text-white uppercase transition"; mBtn.className = "flex-1 py-2 rounded-lg text-[10px] font-bold bg-dark-700 text-white shadow-sm uppercase transition"; }
            window.renderTransferGrid();
        };

        window.selectTransferType = (type) => {
            state.orderType = type;
            const dine = document.getElementById('tfr-type-dine'); const take = document.getElementById('tfr-type-take');
            if (type === 'dine_in') { dine.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-primary text-white shadow-md transition"; take.className = "flex-1 py-2 rounded-lg text-xs font-bold text-dark-muted hover:text-white transition"; }
            else { dine.className = "flex-1 py-2 rounded-lg text-xs font-bold text-dark-muted hover:text-white transition"; take.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-purple-600 text-white shadow-md transition"; }
        };

        window.renderTransferGrid = () => {
            const grid = document.getElementById('transfer-tables-grid'); grid.innerHTML = '';
            const occupied = new Set(); state.orders.forEach(o => { if (['pending', 'cooking'].includes(o.status)) occupied.add(String(o.tableId)); });
            state.tables.forEach(t => {
                const isOccupied = occupied.has(String(t.id));
                const isSelected = String(t.id) === String(state.transferTargetId);
                // In merge mode, only show occupied tables. In transfer mode, show all.
                if (state.transferMode === 'merge' && !isOccupied) return;
                const btn = document.createElement('button');
                btn.className = `p-3 rounded-xl font-bold text-sm border transition-all ${isSelected ? 'bg-primary text-white border-primary' : 'bg-dark-900 text-dark-muted border-dark-700'}`;
                btn.innerText = t.id;
                btn.onclick = () => { state.transferTargetId = t.id; window.renderTransferGrid(); };
                grid.appendChild(btn);
            });
        };



        window.executeTransfer = async () => {
            if (!state.transferOrderId || !state.transferTargetId) return;
            const orderId = state.transferOrderId;
            const targetTableId = state.transferTargetId;
            try {
                if (state.transferMode === 'transfer') {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId), { tableId: targetTableId, orderType: state.orderType });
                } else {
                    // Merge logic
                    const sourceOrder = state.orders.find(o => o.id === orderId);
                    const targetOrder = state.orders.find(o => String(o.tableId) === String(targetTableId) && ['pending', 'cooking'].includes(o.status));
                    if (targetOrder) {
                        const newItems = [...targetOrder.items, ...sourceOrder.items];
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', targetOrder.id), {
                            items: newItems,
                            totalPrice: targetOrder.totalPrice + sourceOrder.totalPrice,
                            totalCost: (targetOrder.totalCost || 0) + (sourceOrder.totalCost || 0)
                        });
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', sourceOrder.id));
                    }
                }
                closeModal('modal-transfer'); window.showMessage("Success", "success");
            } catch (e) { console.error(e); }
        };

        window.startDrag = (e, tId) => {
            const table = state.tables.find(t => t.id === tId); const el = document.querySelector(`.table-node:nth-child(${state.tables.indexOf(table) + 1})`);
            const moveHandler = (mE) => {
                const rect = document.getElementById('table-map-container').getBoundingClientRect();
                table.x = Math.max(0, Math.min(90, ((mE.clientX - rect.left) / rect.width) * 100));
                table.y = Math.max(0, Math.min(90, ((mE.clientY - rect.top) / rect.height) * 100));
                renderTableMap();
            };
            const upHandler = () => { document.removeEventListener('mousemove', moveHandler); document.removeEventListener('mouseup', upHandler); };
            document.addEventListener('mousemove', moveHandler); document.addEventListener('mouseup', upHandler);
        };

        // --- ADVANCED BILLING LOGIC FUNCTIONS ---

        // Global Variables for Split (·Äí·Ä´·ÄÄ·Ä≠·ÄØ ·Ä°·Äï·Ä±·Ä´·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏·Äî·Ä¨·Ä∏·Äô·Äæ·Ä¨ ·Äë·Ää·Ä∑·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´)
        window.splitState = {
            currentOrder: null,
            pax: 2,
            mode: 'items' // 'items' or 'even'
        };

        // ·Äí·ÄÆ Function ·ÄÄ·Ä≠·ÄØ ·Ä°·Äü·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äî·Ä±·Äõ·Ä¨·Äô·Äæ·Ä¨ ·Ä°·ÄÖ·Ä¨·Ä∏·Äë·Ä≠·ÄØ·Ä∏·Äï·Ä´
        window.openAdvancedBillingModal = (orderId) => {
            const order = state.orders.find(o => o.id === orderId);
            if (!order) return;

            window.splitState.currentOrder = order;
            window.splitState.pax = 2; // Reset pax
            stateSplit.sourceOrderId = orderId;
            stateSplit.selectedItems = [];
            stateSplit.targetTableId = null;

            // Default View: Items
            window.switchSplitTab('items');

            // Setup Items View (Existing Logic)
            const list = document.getElementById('split-items-list');
            list.innerHTML = order.items.map((item, idx) => `
        <div class="flex items-center justify-between bg-dark-900 p-3 rounded-2xl border border-dark-700/50 shadow-sm">
            <div class="flex items-center gap-3">
                <input type="checkbox" onchange="window.toggleSplitItem(${idx})" id="chk-split-${idx}" class="w-5 h-5 accent-primary cursor-pointer">
                <div>
                    <p class="text-sm font-bold text-white">${item.name} ${item.size ? `(${item.size})` : ''}</p>
                    <p class="text-[10px] text-dark-muted">${item.qty} x ${item.effectivePrice.toLocaleString()} Ks</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-[10px] text-dark-muted font-bold uppercase">Qty:</span>
                <input type="number" id="split-qty-${idx}" value="${item.qty}" min="1" max="${item.qty}" 
                    class="w-12 bg-dark-800 border border-dark-700 rounded-lg text-center text-xs p-1.5 text-white focus:border-primary outline-none"
                    onchange="window.updateSplitQty(${idx}, this.value)">
            </div>
        </div>
    `).join('');

            // Setup Tables (Existing Logic)
            const tableGrid = document.getElementById('adv-target-tables');
            tableGrid.innerHTML = state.tables.map(t => `
        <button onclick="window.selectAdvTargetTable('${t.id}')" id="adv-t-${t.id}"
            class="p-2.5 rounded-xl text-xs font-bold border transition-all ${String(t.id) === String(order.tableId) ? 'bg-dark-700 text-dark-500 border-dark-600 opacity-50 pointer-events-none' : 'bg-dark-800 text-dark-muted border-dark-700 hover:border-primary'}">
            ${t.id}
        </button>
    `).join('');

            // Setup Even Split View Data
            document.getElementById('even-split-total').innerText = order.totalPrice.toLocaleString() + ' Ks';
            window.updatePax(0); // Trigger calculation

            document.getElementById('modal-advanced-billing').classList.remove('hide');
        };
        // ·ÅÇ·Åã Checkbox ·Ä°·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Ä°·Äï·Ä≠·Äê·Ä∫ ·Äú·ÄØ·Äï·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        window.toggleSplitItem = (idx) => {
            const qtyInput = document.getElementById(`split-qty-${idx}`);
            const index = stateSplit.selectedItems.findIndex(i => i.index === idx);

            if (index > -1) {
                stateSplit.selectedItems.splice(index, 1); // ·Äõ·ÄΩ·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äê·Ä¨ ·Äï·Äº·Äî·Ä∫·Äñ·Äº·ÄØ·Äê·Ä∫
            } else {
                stateSplit.selectedItems.push({ index: idx, qty: parseInt(qtyInput.value) });
            }
        };

        // ·ÅÉ·Åã ·ÄÅ·ÄΩ·Ä≤·Äë·ÄØ·Äê·Ä∫·Äô·Äö·Ä∑·Ä∫ ·Ä°·Äõ·Ä±·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ (Qty) ·ÄÄ·Ä≠·ÄØ Update ·Äú·ÄØ·Äï·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        window.updateSplitQty = (idx, val) => {
            const item = stateSplit.selectedItems.find(i => i.index === idx);
            if (item) item.qty = parseInt(val);
        };

        // ·ÅÑ·Åã ·Äõ·ÄΩ·Äæ·Ä±·Ä∑·Äô·Äö·Ä∑·Ä∫ ·ÄÖ·Ä¨·Ä∏·Äï·ÄΩ·Ä≤·Äî·Ä∂·Äï·Ä´·Äê·Ä∫·ÄÄ·Ä≠·ÄØ ·Äõ·ÄΩ·Ä±·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        window.selectAdvTargetTable = (tId) => {
            stateSplit.targetTableId = tId;
            document.querySelectorAll('[id^="adv-t-"]').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                btn.classList.add('bg-dark-800', 'text-dark-muted', 'border-dark-700');
            });
            const selectedBtn = document.getElementById(`adv-t-${tId}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('bg-dark-800', 'text-dark-muted', 'border-dark-700');
                selectedBtn.classList.add('bg-primary', 'text-white', 'border-primary');
            }
        };

        // ·ÅÖ·Åã ·Ä°·Äì·Ä≠·ÄÄ ·Ä°·Äú·ÄØ·Äï·Ä∫·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∑·Ä∫ ·Ä°·Äï·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ (Split/Transfer ·Ä°·Äê·Ää·Ä∫·Äï·Äº·ÄØ·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏)
        window.executeSplitBill = async (type) => {
            if (stateSplit.selectedItems.length === 0) return window.showMessage("Please select items to move", "error");
            if (type === 'transfer' && !stateSplit.targetTableId) return window.showMessage("Please select target table", "error");

            const sourceOrder = state.orders.find(o => o.id === stateSplit.sourceOrderId);
            if (!sourceOrder) return;

            const splitItems = [];
            const remainingItems = JSON.parse(JSON.stringify(sourceOrder.items)); // Deep copy ·Äö·Ä∞·Äô·Äö·Ä∫

            // ·Äá·Äö·Ä¨·Ä∏·Äë·Ä≤·ÄÄ·Äî·Ä± item ·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ ·Äñ·Äº·Äê·Ä∫·Äë·ÄØ·Äê·Ä∫·Äê·Ä≤·Ä∑·Ä°·ÄÅ·Ä´ index ·Äô·Äú·ÄΩ·Ä≤·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·Äî·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏·ÄÄ·Äî·Ä± ·ÄÖ·Äñ·Äº·Äê·Ä∫·Äõ·Äô·Äö·Ä∫
            const sortedSelected = [...stateSplit.selectedItems].sort((a, b) => b.index - a.index);

            sortedSelected.forEach(sel => {
                const originalItem = remainingItems[sel.index];
                const moveQty = sel.qty;

                // ·ÄÅ·ÄΩ·Ä≤·Äë·ÄØ·Äê·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äê·Ä≤·Ä∑ Item ·Ä°·Äû·ÄÖ·Ä∫
                const newItem = {
                    ...originalItem,
                    qty: moveQty,
                    lineTotal: moveQty * (originalItem.effectivePrice || originalItem.price),
                    lineCost: moveQty * (originalItem.cost || 0)
                };
                splitItems.push(newItem);

                // ·Äô·Ä∞·Äõ·ÄÑ·Ä∫·Ä∏ Item ·Äë·Ä≤·ÄÄ·Äî·Ä± ·Ä°·Äõ·Ä±·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Äú·Äª·Äæ·Ä±·Ä¨·Ä∑·ÄÅ·Äª·Äô·Äö·Ä∫
                if (moveQty >= originalItem.qty) {
                    remainingItems.splice(sel.index, 1); // ·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏·Äõ·ÄΩ·Äæ·Ä±·Ä∑·Äõ·ÄÑ·Ä∫ ·Ä°·Ä≤·Äí·ÄÆ line ·ÄÄ·Ä≠·ÄØ ·Äñ·Äº·ÄØ·Äê·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äô·Äö·Ä∫
                } else {
                    originalItem.qty -= moveQty;
                    originalItem.lineTotal = originalItem.qty * (originalItem.effectivePrice || originalItem.price);
                    originalItem.lineCost = originalItem.qty * (originalItem.cost || 0);
                }
            });

            try {
                // ·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ ·Äà·Ä±·Ä∏·Äî·Äæ·ÄØ·Äî·Ä∫·Ä∏·Äê·ÄΩ·Ä± ·Äï·Äº·Äî·Ä∫·Äê·ÄΩ·ÄÄ·Ä∫·Äô·Äö·Ä∫
                const calcTotals = (items) => ({
                    totalPrice: items.reduce((a, b) => a + b.lineTotal, 0),
                    totalCost: items.reduce((a, b) => a + (b.lineCost || 0), 0),
                    subtotal: items.reduce((a, b) => a + (b.price * b.qty), 0),
                    discount: items.reduce((a, b) => a + ((b.discount || 0) * b.qty), 0),
                    tax: items.reduce((a, b) => a + ((b.taxAmount || 0) * b.qty), 0)
                });

                const newT = calcTotals(splitItems);
                const remT = calcTotals(remainingItems);

                // Firebase ·Äô·Äæ·Ä¨ ·Äê·ÄÖ·Ä∫·Äï·Äº·Ä≠·ÄØ·ÄÑ·Ä∫·Äê·Ää·Ä∫·Ä∏ Update ·Äú·ÄØ·Äï·Ä∫·Äñ·Ä≠·ÄØ·Ä∑ Batch ·Äû·ÄØ·Ä∂·Ä∏·Äô·Äö·Ä∫
                const { writeBatch, doc, collection } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const batch = writeBatch(db);

                // ·ÅÅ·Åã ·Äô·Ä∞·Äõ·ÄÑ·Ä∫·Ä∏ Bill ·ÄÄ·Ä≠·ÄØ Update ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫ (·Äû·Ä≠·ÄØ·Ä∑·Äô·Äü·ÄØ·Äê·Ä∫ ·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äû·ÄΩ·Ä¨·Ä∏·Äõ·ÄÑ·Ä∫ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äö·Ä∫)
                const sourceRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', sourceOrder.id);
                if (remainingItems.length === 0) {
                    batch.delete(sourceRef);
                } else {
                    batch.update(sourceRef, {
                        items: remainingItems,
                        ...remT
                    });
                }

                // ·ÅÇ·Åã Bill ·Ä°·Äû·ÄÖ·Ä∫·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ ·Äñ·Äî·Ä∫·Äê·ÄÆ·Ä∏·Äô·Äö·Ä∫
                const newOrderRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'));
                const newOrderData = {
                    ...sourceOrder,
                    tableId: type === 'transfer' ? stateSplit.targetTableId : sourceOrder.tableId,
                    items: splitItems,
                    ...newT,
                    timestamp: new Date(),
                    status: 'pending', // Bill ·Ä°·Äû·ÄÖ·Ä∫·ÄÄ·Ä≠·ÄØ pending ·Ä°·Äñ·Äº·ÄÖ·Ä∫·Äë·Ä¨·Ä∏·Äô·Äö·Ä∫
                    isSplitOrder: true
                };
                delete newOrderData.id; // ID ·Ä°·Äü·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äö·Ä∫

                batch.set(newOrderRef, newOrderData);

                await batch.commit();
                window.closeModal('modal-advanced-billing');
                window.showMessage("Bill Processed Successfully", "success");

            } catch (e) {
                console.error("Advanced Billing Error:", e);
                window.showMessage("Failed to process bill", "error");
            }
        };
        // Tab Switching Logic (·Ä°·Äû·ÄÖ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫)
        window.switchSplitTab = (tab) => {
            window.splitState.mode = tab;
            const btnItems = document.getElementById('tab-split-items');
            const btnEven = document.getElementById('tab-split-even');
            const viewItems = document.getElementById('view-split-items');
            const viewEven = document.getElementById('view-split-even');

            if (tab === 'items') {
                btnItems.classList.replace('text-dark-muted', 'text-white');
                btnItems.classList.replace('bg-transparent', 'bg-dark-700');
                btnItems.classList.add('bg-dark-700', 'shadow-sm');

                btnEven.classList.remove('bg-dark-700', 'text-white', 'shadow-sm');
                btnEven.classList.add('text-dark-muted');

                viewItems.classList.remove('hide');
                viewEven.classList.add('hide');
            } else {
                btnEven.classList.replace('text-dark-muted', 'text-white');
                btnEven.classList.add('bg-dark-700', 'shadow-sm');

                btnItems.classList.remove('bg-dark-700', 'text-white', 'shadow-sm');
                btnItems.classList.add('text-dark-muted');

                viewItems.classList.add('hide');
                viewEven.classList.remove('hide');
            }
        };

        // Even Split Calculation Logic (·Ä°·Äû·ÄÖ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫)
        window.updatePax = (change) => {
            let newPax = window.splitState.pax + change;
            if (newPax < 2) newPax = 2;
            if (newPax > 20) newPax = 20;

            window.splitState.pax = newPax;
            document.getElementById('even-split-pax').innerText = newPax;

            if (window.splitState.currentOrder) {
                const total = window.splitState.currentOrder.totalPrice;
                const perPerson = Math.ceil(total / newPax);
                document.getElementById('even-split-per-person').innerText = perPerson.toLocaleString() + ' Ks';
            }
        };

        // Execute Even Split (Database Logic) - FIXED Z-INDEX ISSUE
        window.executeEvenSplit = async () => {
            // ·ÅÅ. Order ·Äõ·Äæ·Ä≠·Äô·Äõ·Äæ·Ä≠ ·ÄÖ·ÄÖ·Ä∫·Äô·Äö·Ä∫
            if (!window.splitState.currentOrder) return;

            const order = window.splitState.currentOrder;
            const pax = window.splitState.pax;
            const amountPerPerson = Math.ceil(order.totalPrice / pax);

            // üî• ·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫ - Confirmation ·Äô·Äê·ÄÄ·Ä∫·ÄÅ·ÄÑ·Ä∫ Split Bill Box ·ÄÄ·Ä≠·ÄØ ·Ä°·Äõ·ÄÑ·Ä∫·Äï·Ä≠·Äê·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äô·Äö·Ä∫
            // ·Äí·Ä´·Äô·Äæ Confirmation Box ·ÄÄ·Ä≠·ÄØ ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏ ·Äô·Äº·ÄÑ·Ä∫·Äõ·Äô·Äæ·Ä¨·Äï·Ä´
            window.closeModal('modal-advanced-billing');

            // ·Äï·Äº·ÄÆ·Ä∏·Äô·Äæ Confirmation Box ·ÄÄ·Ä≠·ÄØ ·ÄÅ·Ä±·Ä´·Ä∫·Äô·Äö·Ä∫
            window.showConfirm('confirmation', async () => {
                try {
                    // Firebase Batch ·ÄÖ·Äô·Äö·Ä∫
                    const batch = writeBatch(db);

                    // ·ÅÅ. ·Äô·Ä∞·Äõ·ÄÑ·Ä∫·Ä∏ Order ·ÄÄ·Ä≠·ÄØ Status ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏
                    const originalRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', order.id);
                    batch.update(originalRef, {
                        status: 'served',
                        paymentMethod: 'Split Bill',
                        note: `Split evenly into ${pax} bills`,
                        isSplitParent: true
                    });

                    // ·ÅÇ. Order ·Ä°·Äû·ÄÖ·Ä∫·Äê·ÄΩ·Ä± ·ÄÜ·Ä±·Ä¨·ÄÄ·Ä∫
                    for (let i = 1; i <= pax; i++) {
                        const newOrderRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'));
                        const splitItem = {
                            name: `Split Share (${i}/${pax})`,
                            qty: 1,
                            price: amountPerPerson,
                            effectivePrice: amountPerPerson,
                            category: 'Other',
                            modifiers: [`Orig Order: #${order.id.slice(0, 4)}`],
                            lineTotal: amountPerPerson,
                            lineCost: 0
                        };

                        batch.set(newOrderRef, {
                            tableId: order.tableId,
                            items: [splitItem],
                            subtotal: amountPerPerson,
                            discount: 0,
                            serviceCharge: 0,
                            tax: 0,
                            totalPrice: amountPerPerson,
                            totalCost: 0,
                            status: 'pending',
                            timestamp: serverTimestamp(),
                            userId: state.user?.uid || 'system',
                            orderType: order.orderType,
                            isSplitOrder: true,
                            originalOrderId: order.id
                        });
                    }

                    await batch.commit();
                    window.showMessage("Bill Split Successfully!", "success");

                } catch (e) {
                    console.error("Even Split Error:", e);
                    window.showMessage("Failed to split bill", "error");

                    // Error ·Äê·ÄÄ·Ä∫·ÄÅ·Ä≤·Ä∑·Äõ·ÄÑ·Ä∫ ·Äô·Ä∞·Äú Modal ·ÄÄ·Ä≠·ÄØ ·Äï·Äº·Äî·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äï·Ä±·Ä∏·ÄÅ·Äª·ÄÑ·Ä∫·Äõ·ÄÑ·Ä∫ ·Äí·ÄÆ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·ÄÄ ·ÄÄ·ÄØ·Äí·Ä∫·ÄÄ·Ä≠·ÄØ ·Äû·ÄØ·Ä∂·Ä∏·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫ (Optional)
                    // document.getElementById('modal-advanced-billing').classList.remove('hide');
                }
            }, false);
        };

        // ==========================================
        // SHIFT MANAGEMENT SYSTEM (Z-READING) LOGIC
        // ==========================================

        // 1. Shift ·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äë·Ä¨·Ä∏·Äê·Ä¨ ·Äõ·Äæ·Ä≠·Äô·Äõ·Äæ·Ä≠ ·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        window.checkActiveShift = async () => {
            try {
                const { collection, query, where, getDocs, limit } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                // Firebase ·Äë·Ä≤·Äô·Äæ·Ä¨ status: 'open' ·Äñ·Äº·ÄÖ·Ä∫·Äî·Ä±·Äê·Ä≤·Ä∑ Shift ·Äõ·Äæ·Ä≠·Äú·Ä¨·Ä∏ ·Äõ·Äæ·Ä¨·Äô·Äö·Ä∫
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'shifts'),
                    where('status', '==', 'open'),
                    limit(1)
                );

                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    const docData = snapshot.docs[0];
                    state.currentShift = { id: docData.id, ...docData.data() };
                    window.updateShiftUI(true); // ·Äõ·Äæ·Ä≠·Äõ·ÄÑ·Ä∫ ·ÄÅ·Äú·ÄØ·Äê·Ä∫·ÄÄ·Ä≠·ÄØ ·Ä°·ÄÖ·Ä≠·Äô·Ä∫·Ä∏·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Äï·Äº·Äô·Äö·Ä∫
                } else {
                    state.currentShift = null;
                    window.updateShiftUI(false); // ·Äô·Äõ·Äæ·Ä≠·Äõ·ÄÑ·Ä∫ ·Äô·ÄÆ·Ä∏·ÄÅ·Ä≠·ÄØ·Ä∏·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Äï·Äº·Äô·Äö·Ä∫
                }
            } catch (e) {
                console.error("Shift Check Error:", e);
            }
        };

        // 2. ·ÄÅ·Äú·ÄØ·Äê·Ä∫ ·Ä°·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ (UI Update)
        window.updateShiftUI = (isOpen) => {
            const btn = document.getElementById('btn-shift-control');
            const txt = document.getElementById('shift-status-text');
            if (!btn) return;

            if (isOpen) {
                btn.className = "px-3 py-1 bg-green-900/30 text-green-400 border border-green-500/30 rounded-full text-xs font-bold hover:bg-green-900/50 shadow-lg flex items-center gap-1 transition animate-pulse";
                txt.innerText = "Shift Open";
            } else {
                btn.className = "px-3 py-1 bg-gray-700/50 text-gray-400 border border-gray-600 rounded-full text-xs font-bold hover:bg-gray-600 shadow-lg flex items-center gap-1 transition";
                txt.innerText = "Open Shift";
            }
        };

        // 3. Shift ·ÄÅ·Äú·ÄØ·Äê·Ä∫·Äî·Äæ·Ä≠·Äï·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äõ·ÄÑ·Ä∫ ·Äò·Ä¨·Äú·ÄØ·Äï·Ä∫·Äô·Äú·Ä≤
        window.handleShiftClick = () => {
            if (state.currentShift) {
                // Shift ·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äë·Ä¨·Ä∏·Äõ·ÄÑ·Ä∫ ·Äï·Ä≠·Äê·Ä∫·Äô·Äö·Ä∑·Ä∫ Modal (Z-Report) ·ÄÄ·Ä≠·ÄØ ·ÄÅ·Ä±·Ä´·Ä∫·Äô·Äö·Ä∫
                window.prepareCloseShift();
            } else {
                // Shift ·Äï·Ä≠·Äê·Ä∫·Äë·Ä¨·Ä∏·Äõ·ÄÑ·Ä∫ ·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äô·Äö·Ä∑·Ä∫ Modal ·ÄÄ·Ä≠·ÄØ ·ÄÅ·Ä±·Ä´·Ä∫·Äô·Äö·Ä∫
                document.getElementById('shift-start-cash').value = '';
                document.getElementById('modal-shift-open').classList.remove('hide');
            }
        };

        // 4. Shift ·ÄÖ·Äê·ÄÑ·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äú·Äæ·ÄÖ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ (Start Shift)
        window.startShift = async () => {
            const startCash = parseFloat(document.getElementById('shift-start-cash').value) || 0;

            try {
                const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                const shiftData = {
                    openedAt: serverTimestamp(),
                    openedBy: state.user?.uid || 'staff',
                    startCash: startCash,
                    status: 'open',
                    tableId: state.tableId
                };

                const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'shifts'), shiftData);
                state.currentShift = { id: docRef.id, ...shiftData };

                window.updateShiftUI(true);
                window.closeModal('modal-shift-open');
                window.showMessage("Shift Started Successfully", "success");

            } catch (e) {
                console.error(e);
                window.showMessage("Failed to start shift", "error");
            }
        };

        window.prepareCloseShift = () => {
            if (!state.currentShift) return;

            // Shift ·ÄÖ·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äê·Ä≤·Ä∑ ·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫
            const startTime = state.currentShift.openedAt ? new Date(state.currentShift.openedAt.seconds * 1000) : new Date();

            // ·ÅÅ·Åã Order ·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            const shiftOrders = state.orders.filter(o => {
                // ·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫ - timestamp ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äõ·ÄÑ·Ä∫ (null ·Äñ·Äº·ÄÖ·Ä∫·Äî·Ä±·Äõ·ÄÑ·Ä∫) ·Äú·ÄÄ·Ä∫·Äõ·Äæ·Ä≠·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫ (new Date()) ·ÄÄ·Ä≠·ÄØ ·Äö·Ä∞·Äô·Ää·Ä∫·Åã
                // ·Äí·Ä´·Äô·Äæ ·ÅÅ·Åâ·Åá·ÅÄ ·ÄÅ·ÄØ·Äî·Äæ·ÄÖ·Ä∫ ·Äô·Äñ·Äº·ÄÖ·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äò·Ä≤ ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äë·Ä≤ ·Äù·ÄÑ·Ä∫·Äú·Ä¨·Äô·Äæ·Ä¨ ·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã
                const t = o.timestamp ? new Date(o.timestamp.seconds * 1000) : new Date();

                // Cancelled ·Äô·Äñ·Äº·ÄÖ·Ä∫·Äõ·Åä Shift ·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·ÄÅ·Äª·Ä≠·Äî·Ä∫·Äë·ÄÄ·Ä∫ ·Äî·Ä±·Ä¨·ÄÄ·Ä∫·ÄÄ·Äª·Äô·Äæ ·Äê·ÄÑ·Ä∫·Äê·Ä≤·Ä∑ Order ·Äñ·Äº·ÄÖ·Ä∫·Äõ·Äô·Ää·Ä∫
                return t >= startTime && o.status !== 'cancelled';
            });

            // ·ÅÇ·Åã Expenses ·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            const shiftExpenses = state.expenses.filter(e => {
                // ·Äí·ÄÆ·Äô·Äæ·Ä¨·Äú·Ää·Ä∫·Ä∏ timestamp null ·Äñ·Äº·ÄÖ·Ä∫·Äõ·ÄÑ·Ä∫ ·Äú·ÄÄ·Ä∫·Äõ·Äæ·Ä≠·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫·ÄÄ·Ä≠·ÄØ ·Äö·Ä∞·Äô·Ää·Ä∫
                const t = e.timestamp ? new Date(e.timestamp.seconds * 1000) : new Date();
                return t >= startTime;
            });

            // ·ÅÉ·Åã ·Äï·Ä≠·ÄØ·ÄÄ·Ä∫·ÄÜ·Ä∂ ·Äê·ÄΩ·ÄÄ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            let cashSales = 0;
            let cardSales = 0;
            let totalSales = 0;

            shiftOrders.forEach(o => {
                totalSales += (o.totalPrice || 0);

                // Payment Method ·Äô·Äõ·ÄΩ·Ä±·Ä∏·Äõ·Äû·Ä±·Ä∏·Äõ·ÄÑ·Ä∫ (·Äû·Ä≠·ÄØ·Ä∑) Cash ·ÄÜ·Ä≠·ÄØ·Äõ·ÄÑ·Ä∫ ·ÄÑ·ÄΩ·Ä±·Äû·Ä¨·Ä∏·Ä°·Äñ·Äº·ÄÖ·Ä∫ ·Äû·Äê·Ä∫·Äô·Äæ·Äê·Ä∫
                if (!o.paymentMethod || o.paymentMethod === 'Cash') {
                    cashSales += (o.totalPrice || 0);
                } else {
                    cardSales += (o.totalPrice || 0);
                }
            });

            const totalExpenses = shiftExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const startCash = state.currentShift.startCash || 0;

            // ·Äô·Äª·Äæ·Ä±·Ä¨·Ä∫·Äô·Äæ·Äî·Ä∫·Ä∏·ÄÑ·ÄΩ·Ä± = ·Ä°·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·ÄÑ·ÄΩ·Ä± + ·ÄÑ·ÄΩ·Ä±·Äû·Ä¨·Ä∏·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·ÄÑ·ÄΩ·Ä± - ·Ä°·Äû·ÄØ·Ä∂·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫
            const expectedCash = startCash + cashSales - totalExpenses;

            // ·Äê·ÄΩ·ÄÄ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫·Äë·Ä¨·Ä∏·Äê·Ä¨·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ ·Äö·Ä¨·Äö·ÄÆ·Äô·Äæ·Äê·Ä∫·Äë·Ä¨·Ä∏·Äô·Äö·Ä∫
            state.tempShiftData = {
                startCash, cashSales, cardSales, totalSales, totalExpenses, expectedCash, startTime
            };

            // UI ·Äï·Ä±·Ä´·Ä∫·Äô·Äæ·Ä¨ ·Äï·Äº·Äû·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            document.getElementById('z-start-cash').innerText = startCash.toLocaleString() + ' Ks';
            document.getElementById('z-cash-sales').innerText = cashSales.toLocaleString() + ' Ks';
            document.getElementById('z-card-sales').innerText = cardSales.toLocaleString() + ' Ks';
            document.getElementById('z-expenses').innerText = '-' + totalExpenses.toLocaleString() + ' Ks';

            // ·Ä°·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äª·Ä¨·Ä∏ ·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ (·Ä°·ÄÖ·Ä≠·Äô·Ä∫·Ä∏/·Ä°·Äî·ÄÆ)
            const salesEl = document.getElementById('z-cash-sales');
            salesEl.innerText = cashSales.toLocaleString() + ' Ks';
            salesEl.className = cashSales > 0 ? "text-green-400 font-bold" : "text-white font-bold";

            document.getElementById('z-expected-cash').innerText = expectedCash.toLocaleString() + ' Ks';

            document.getElementById('z-actual-cash').value = '';
            document.getElementById('z-variance-display').innerText = "Difference: 0 Ks";
            document.getElementById('z-variance-display').className = "text-center text-xs font-bold text-dark-muted mb-4";

            document.getElementById('modal-shift-close').classList.remove('hide');
        };
        // 6. ·ÄÑ·ÄΩ·Ä±·ÄÄ·ÄΩ·Ä¨·ÄÅ·Äº·Ä¨·Ä∏·ÄÅ·Äª·ÄÄ·Ä∫ ·Äê·ÄΩ·ÄÄ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ (Live Calculation)
        window.calcShiftVariance = () => {
            const actual = parseFloat(document.getElementById('z-actual-cash').value) || 0;
            const expected = state.tempShiftData.expectedCash;
            const diff = actual - expected;

            const el = document.getElementById('z-variance-display');
            el.innerText = `Difference: ${diff > 0 ? '+' : ''}${diff.toLocaleString()} Ks`;

            // ·Ä°·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ (·Ä°·Äî·ÄÆ/·Ä°·ÄÖ·Ä≠·Äô·Ä∫·Ä∏)
            if (diff === 0) el.className = "text-center text-xs font-bold text-green-400 mb-4";
            else if (diff > 0) el.className = "text-center text-xs font-bold text-blue-400 mb-4"; // ·Äï·Ä≠·ÄØ·Äî·Ä±·Äõ·ÄÑ·Ä∫
            else el.className = "text-center text-xs font-bold text-red-400 mb-4"; // ·Äú·Ä≠·ÄØ·Äî·Ä±·Äõ·ÄÑ·Ä∫
        };

        // 7. Shift ·Ä°·Äï·Äº·ÄÆ·Ä∏·Äû·Äê·Ä∫ ·Äï·Ä≠·Äê·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ (Execute Close) - FIXED Z-INDEX ISSUE
        window.executeCloseShift = async () => {
            const actualCash = parseFloat(document.getElementById('z-actual-cash').value);

            // ·ÄÑ·ÄΩ·Ä±·Äï·Äô·Ä¨·Äè ·Äë·Ää·Ä∑·Ä∫·Äô·Äë·Ä¨·Ä∏·Äõ·ÄÑ·Ä∫ ·Ä°·Äú·ÄØ·Äï·Ä∫·Äô·Äú·ÄØ·Äï·Ä∫·Äò·Ä∞·Ä∏
            if (isNaN(actualCash)) {
                window.showMessage("Please enter actual cash amount", "error");
                return;
            }

            const { updateDoc, doc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

            // üî• ·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫ - Confirmation ·Äô·Äê·ÄÄ·Ä∫·ÄÅ·ÄÑ·Ä∫ Shift Close Box ·ÄÄ·Ä≠·ÄØ ·Ä°·Äõ·ÄÑ·Ä∫·Äï·Ä≠·Äê·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äô·Äö·Ä∫
            window.closeModal('modal-shift-close');

            window.showConfirm('confirmation', async () => {
                try {
                    const shiftId = state.currentShift.id;
                    const data = state.tempShiftData;
                    const variance = actualCash - data.expectedCash;

                    // Firebase ·Äô·Äæ·Ä¨ Update ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'shifts', shiftId), {
                        closedAt: serverTimestamp(),
                        closedBy: state.user?.uid || 'staff',
                        endCash: actualCash,
                        expectedCash: data.expectedCash,
                        totalSales: data.totalSales,
                        cashSales: data.cashSales,
                        cardSales: data.cardSales,
                        totalExpenses: data.totalExpenses,
                        variance: variance,
                        status: 'closed'
                    });

                    // Z-Report ·Äï·ÄØ·Ä∂·Äî·Äæ·Ä≠·Äï·Ä∫·Äô·Äö·Ä∫
                    window.printZReport({ ...data, endCash: actualCash, variance, id: shiftId });

                    // State Reset ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
                    state.currentShift = null;
                    window.updateShiftUI(false);

                    // Success Message ·Äï·Äº·Äô·Äö·Ä∫
                    window.showMessage("Shift Closed & Z-Report Printed", "success");

                } catch (e) {
                    console.error("Close Shift Error:", e);
                    window.showMessage("Failed to close shift", "error");

                    // Error ·Äê·ÄÄ·Ä∫·Äõ·ÄÑ·Ä∫ Modal ·Äï·Äº·Äî·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·ÄÅ·Äª·ÄÑ·Ä∫·Äõ·ÄÑ·Ä∫ ·Äí·ÄÆ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·ÄÄ ·Äü·Ä¨·ÄÄ·Ä≠·ÄØ ·Äû·ÄØ·Ä∂·Ä∏·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫
                    // document.getElementById('modal-shift-close').classList.remove('hide');
                }
            }, true); // PIN ·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äô·Äö·Ä∫
        };
        // 8. Z-Report ·Äï·ÄØ·Ä∂·Äî·Äæ·Ä≠·Äï·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        window.printZReport = (data) => {
            const printArea = document.getElementById('receipt-print-area');
            const now = new Date();
            const startStr = data.startTime.toLocaleString();
            const endStr = now.toLocaleString();

            printArea.innerHTML = `
        <div style="font-family: 'Courier New', monospace; width: 280px; margin: 0 auto; padding: 10px; text-align: center; color: black; background: white;">
            <h2 style="margin:0; font-size: 24px;">PingPOS</h2>
            <h3 style="margin:5px 0; border: 2px solid black; padding: 5px;">Z-REPORT</h3>
            <div style="font-size: 11px; text-align: left; margin-bottom: 10px; border-bottom: 1px dashed black; padding-bottom: 5px;">
                Shift ID: #${data.id.slice(-6).toUpperCase()}<br>
                Open: ${startStr}<br>
                Close: ${endStr}
            </div>
            
            <table style="width: 100%; font-size: 13px; margin-bottom: 10px;">
                <tr><td style="text-align:left;">Opening Cash:</td><td style="text-align:right;">${data.startCash.toLocaleString()}</td></tr>
                <tr><td style="text-align:left;">+ Cash Sales:</td><td style="text-align:right;">${data.cashSales.toLocaleString()}</td></tr>
                <tr><td style="text-align:left;">- Expenses:</td><td style="text-align:right;">${data.totalExpenses.toLocaleString()}</td></tr>
                <tr style="border-top: 1px solid black; font-weight:bold;"><td style="text-align:left; padding-top:5px;">Expected Cash:</td><td style="text-align:right; padding-top:5px;">${data.expectedCash.toLocaleString()}</td></tr>
                <tr style="font-weight:bold;"><td style="text-align:left;">Actual Cash:</td><td style="text-align:right;">${data.endCash.toLocaleString()}</td></tr>
                <tr><td style="text-align:left;">Variance:</td><td style="text-align:right;">${data.variance.toLocaleString()}</td></tr>
            </table>

            <div style="border-top: 1px dashed black; padding-top: 5px; margin-top: 5px;">
                <div style="display:flex; justify-content:space-between; font-weight:bold;"><span>Total Sales:</span><span>${data.totalSales.toLocaleString()}</span></div>
                <div style="display:flex; justify-content:space-between; font-size:11px;"><span>(Card/Other: ${data.cardSales.toLocaleString()})</span></div>
            </div>
            <div style="margin-top: 15px; font-size: 10px;">-- END OF SHIFT REPORT --</div>
        </div>
    `;

            // ·Äú·ÄÄ·Ä∫·Äõ·Äæ·Ä≠·ÄÄ·ÄØ·Äí·Ä∫·Äë·Ä≤·Äô·Äæ·Ä¨ triggerPrint ·Äõ·Äæ·Ä≠·Äï·Äº·ÄÆ·Ä∏·Äû·Ä¨·Ä∏·Äô·Ä≠·ÄØ·Ä∑ ·Äï·Äº·Äî·Ä∫·ÄÅ·Ä±·Ä´·Ä∫·Äû·ÄØ·Ä∂·Ä∏·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´
            if (window.triggerPrint) window.triggerPrint();
            else {
                // triggerPrint ·Äô·Äõ·Äæ·Ä≠·Äõ·ÄÑ·Ä∫ (Backup)
                printArea.style.display = 'block';
                setTimeout(() => {
                    window.print();
                    setTimeout(() => { printArea.style.display = 'none'; }, 1000);
                }, 500);
            }
        };
        // --- BILL DISCOUNT LOGIC ---
        window.setBillDiscType = (type) => {
            state.billDiscount.type = type;
            const btnP = document.getElementById('btn-bd-percent');
            const btnF = document.getElementById('btn-bd-fixed');

            if (type === 'percent') {
                btnP.className = "px-3 py-1.5 rounded-md text-[10px] font-bold transition bg-primary text-white shadow";
                btnF.className = "px-3 py-1.5 rounded-md text-[10px] font-bold transition text-dark-muted hover:text-white";
            } else {
                btnP.className = "px-3 py-1.5 rounded-md text-[10px] font-bold transition text-dark-muted hover:text-white";
                btnF.className = "px-3 py-1.5 rounded-md text-[10px] font-bold transition bg-primary text-white shadow";
            }
            window.updateCheckoutTotals();
        };

        window.renderShiftHistory = async () => {
            const { collection, getDocs, query, orderBy, limit } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

            const b = document.getElementById('rpt-shifts-body');
            b.innerHTML = '<tr><td colspan="6" class="p-8 text-center"><span class="loader"></span></td></tr>';

            try {
                // ·Äï·Ä≠·Äê·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äû·Ä¨·Ä∏ Shift ·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ ·Äî·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏·Äï·Ä≠·Äê·Ä∫·Äê·Ä¨ ·Ä°·Äõ·ÄÑ·Ä∫·Äï·Ä±·Ä´·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·ÄÖ·ÄÆ·Äï·Äº·ÄÆ·Ä∏ ·Äö·Ä∞·Äô·Äö·Ä∫ (·Ä°·ÄÅ·ÄØ ·ÅÖ·ÅÄ)
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'shifts'),
                    orderBy('closedAt', 'desc'),
                    limit(50)
                );

                const snapshot = await getDocs(q);
                b.innerHTML = '';

                if (snapshot.empty) {
                    b.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-xs text-dark-700">No shift records found.</td></tr>';
                    return;
                }

                snapshot.forEach(doc => {
                    const s = doc.data();
                    if (s.status !== 'closed') return; // ·Äô·Äï·Ä≠·Äê·Ä∫·Äõ·Äû·Ä±·Ä∏·Äõ·ÄÑ·Ä∫ ·Äô·Äï·Äº·Äò·Ä∞·Ä∏

                    const closedDate = s.closedAt ? new Date(s.closedAt.seconds * 1000) : new Date();
                    const dateStr = closedDate.toLocaleDateString() + ' ' + closedDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    // Variance (·ÄÄ·ÄΩ·Ä¨·Äü·ÄÅ·Äª·ÄÄ·Ä∫) ·Ä°·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÅ·ÄΩ·Ä≤·Äô·Äö·Ä∫
                    let diffColor = "text-white";
                    let diffIcon = "";
                    if (s.variance < 0) {
                        diffColor = "text-red-500 font-bold"; // ·ÄÑ·ÄΩ·Ä±·Äú·Ä≠·ÄØ·Äî·Ä±·Äõ·ÄÑ·Ä∫ ·Ä°·Äî·ÄÆ
                        diffIcon = "‚ö†Ô∏è";
                    } else if (s.variance > 0) {
                        diffColor = "text-blue-400 font-bold"; // ·ÄÑ·ÄΩ·Ä±·Äï·Ä≠·ÄØ·Äî·Ä±·Äõ·ÄÑ·Ä∫ ·Ä°·Äï·Äº·Ä¨
                    } else {
                        diffColor = "text-green-400 font-bold"; // ·ÄÄ·ÄΩ·ÄÄ·Ä∫·Äê·Ä≠·ÄÜ·Ä≠·ÄØ ·Ä°·ÄÖ·Ä≠·Äô·Ä∫·Ä∏
                    }

                    b.innerHTML += `
                <tr class="border-b border-dark-700 hover:bg-dark-700/50 transition">
                    <td class="p-3 text-xs text-white">
                        <div class="font-bold">${dateStr}</div>
                        <div class="text-[10px] text-dark-muted">ID: #${doc.id.slice(-4).toUpperCase()}</div>
                    </td>
                    <td class="p-3 text-xs text-dark-muted">${s.closedBy || 'Staff'}</td>
                    <td class="p-3 text-xs text-right font-mono">${(s.expectedCash || 0).toLocaleString()}</td>
                    <td class="p-3 text-xs text-right font-mono text-white">${(s.endCash || 0).toLocaleString()}</td>
                    <td class="p-3 text-xs text-right font-mono ${diffColor}">
                        ${s.variance > 0 ? '+' : ''}${(s.variance || 0).toLocaleString()} ${diffIcon}
                    </td>
                    <td class="p-3 text-center">
                        <button onclick="window.printZReport({id:'${doc.id}', startTime: new Date(${s.openedAt.seconds * 1000}), startCash:${s.startCash}, cashSales:${s.cashSales}, totalExpenses:${s.totalExpenses}, expectedCash:${s.expectedCash}, endCash:${s.endCash}, variance:${s.variance}, totalSales:${s.totalSales}, cardSales:${s.cardSales}})" 
                        class="text-xs bg-dark-900 border border-dark-600 text-white px-2 py-1 rounded hover:bg-dark-600 transition">
                            <i class="fas fa-print"></i>
                        </button>
                    </td>
                </tr>
            `;
                });

            } catch (e) {
                console.error(e);
                b.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-red-400">Failed to load history</td></tr>';
            }
        };

        // --- CRM / MEMBER SYSTEM LOGIC ---

        // Global Variable (State ·Äë·Ä≤·Äô·Äæ·Ä¨ member ·Äû·Ä≠·Äô·Ä∫·Ä∏·Äñ·Ä≠·ÄØ·Ä∑)
        // state = { ..., currentMember: null }; (·Äõ·Äæ·Ä≠·Äï·Äº·ÄÆ·Ä∏·Äû·Ä¨·Ä∏ state ·Äë·Ä≤·Äô·Äæ·Ä¨ auto ·Äù·ÄÑ·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äï·Ä´·Äô·Äö·Ä∫)

        window.openMemberModal = () => {
            const modal = document.getElementById('modal-member');
            modal.classList.remove('hide');

            // UI Reset
            document.getElementById('mem-search-phone').value = '';
            document.getElementById('mem-result-area').classList.add('hide');
            document.getElementById('mem-register-form').classList.add('hide');

            // --- ·Äí·ÄÆ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·ÄÄ ·Ä°·Äï·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ ·Ä°·Äû·ÄÖ·Ä∫·Äê·Ä≠·ÄØ·Ä∏·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äê·Ä¨·Äï·Ä´ ---
            const titleEl = modal.querySelector('h3');
            const subEl = modal.querySelector('p');

            if (state.isPOSMode) {
                // ·Äù·Äî·Ä∫·Äë·Äô·Ä∫·Ä∏ (POS Mode) ·ÄÜ·Ä≠·ÄØ·Äõ·ÄÑ·Ä∫ ·Äí·ÄÆ·Äú·Ä≠·ÄØ·Äï·Äº·Äô·Äö·Ä∫
                titleEl.innerText = "Member Lookup";
                subEl.innerText = "Search or Register Customer";
            } else {
                // QR Customer ·ÄÜ·Ä≠·ÄØ·Äõ·ÄÑ·Ä∫ ·Äí·ÄÆ·Äú·Ä≠·ÄØ·Äï·Äº·Äô·Äö·Ä∫
                titleEl.innerText = "Membership Login";
                subEl.innerText = "Enter phone number to earn points";
            }
            // ----------------------------------------

            document.getElementById('mem-search-phone').focus();
        };
        // 2. Member ·Äõ·Äæ·Ä¨·Äñ·ÄΩ·Ä±·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        window.searchMember = async () => {
            const phone = document.getElementById('mem-search-phone').value.trim();
            if (!phone) return window.showMessage("Please enter phone number", "error");

            // Loading ·Äï·Äº·Äô·Äö·Ä∫
            const btn = document.querySelector('#modal-member button i.fa-search').parentNode;
            const oldHtml = btn.innerHTML;
            btn.innerHTML = '<span class="loader w-4 h-4 border-2"></span>';

            try {
                const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'customers'), where('phone', '==', phone));
                const snapshot = await getDocs(q);

                btn.innerHTML = oldHtml; // Reset Button

                if (!snapshot.empty) {
                    // Member ·Äê·ÄΩ·Ä±·Ä∑·Äõ·ÄÑ·Ä∫
                    const data = snapshot.docs[0].data();
                    state.tempMember = { id: snapshot.docs[0].id, ...data };

                    document.getElementById('mem-res-name').innerText = data.name;
                    document.getElementById('mem-res-phone').innerText = data.phone;
                    document.getElementById('mem-res-points').innerText = (data.points || 0).toLocaleString();
                    document.getElementById('mem-res-visits').innerText = (data.visits || 0);

                    document.getElementById('mem-result-area').classList.remove('hide');
                    document.getElementById('mem-register-form').classList.add('hide');
                } else {
                    // Member ·Äô·Äê·ÄΩ·Ä±·Ä∑·Äõ·ÄÑ·Ä∫
                    state.tempMember = null;
                    document.getElementById('mem-result-area').classList.add('hide');
                    document.getElementById('mem-register-form').classList.remove('hide');
                    document.getElementById('new-mem-name').focus();
                }
            } catch (e) {
                btn.innerHTML = oldHtml;
                console.error(e);
                window.showMessage("Connection Error", "error");
            }
        };

        // 3. Member ·Ä°·Äû·ÄÖ·Ä∫ ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        window.registerMember = async () => {
            const phone = document.getElementById('mem-search-phone').value.trim();
            const name = document.getElementById('new-mem-name').value.trim();

            if (!name || !phone) return window.showMessage("Name & Phone required", "error");

            try {
                const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                const newCus = {
                    name: name,
                    phone: phone,
                    points: 0,
                    visits: 0,
                    joinedAt: serverTimestamp()
                };

                const ref = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'customers'), newCus);
                state.tempMember = { id: ref.id, ...newCus };

                window.showMessage("New Member Registered!", "success");
                window.selectMemberForOrder(); // ·Äê·Äî·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏ Select ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫

            } catch (e) {
                console.error(e);
                window.showMessage("Registration Failed", "error");
            }
        };

        // 1. SELECT MEMBER FOR ORDER (Updated for new UI)
        window.selectMemberForOrder = () => {
            if (!state.tempMember) return;

            state.currentMember = state.tempMember;

            // Header ·ÄÄ Subtitle ·Äî·Ä±·Äõ·Ä¨·Äô·Äæ·Ä¨ Member ·Äî·Ä¨·Äô·Ää·Ä∫ ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äô·Äö·Ä∫
            const subtitle = document.getElementById('checkout-subtitle');
            subtitle.innerHTML = `<span class="text-green-400 font-bold"><i class="fas fa-user-check mr-1"></i> ${state.currentMember.name}</span> <span class="text-dark-muted text-[10px]">(${state.currentMember.points} Pts)</span>`;

            // Button ·Äô·Äæ·Ä¨ ·Ä°·ÄÖ·ÄÄ·Ä∫·ÄÖ·Ä≠·Äô·Ä∫·Ä∏·Äú·Ä±·Ä∏ ·Äï·Äº·Äô·Äö·Ä∫ (Active ·Äñ·Äº·ÄÖ·Ä∫·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏)
            document.getElementById('mem-active-dot').classList.remove('hide');
            const btn = document.getElementById('btn-member-toggle');
            btn.classList.add('border-green-500', 'text-green-400');
            btn.classList.remove('border-dark-700', 'text-dark-muted');

            window.closeModal('modal-member');
            window.showMessage("Member Linked", "success");
        };

        // 2. OPEN CHECKOUT MODAL (Reset UI logic)
        window.openCheckoutModal = () => {
            if (state.cart.length === 0) return;

            state.billDiscount = { type: 'percent', value: 0 };
            document.getElementById('input-bill-disc').value = '';
            window.setBillDiscType('percent');

            // Reset Member UI if no member selected
            if (!state.currentMember) {
                document.getElementById('checkout-subtitle').innerText = "Check your items";
                document.getElementById('mem-active-dot').classList.add('hide');
                const btn = document.getElementById('btn-member-toggle');
                btn.classList.remove('border-green-500', 'text-green-400');
                btn.classList.add('border-dark-700', 'text-dark-muted');
            }

            const discContainer = document.getElementById('checkout-discount-container');
            if (state.isPOSMode) discContainer.classList.remove('hide');
            else discContainer.classList.add('hide');

            window.setOrderType('dine_in');

            // Render Items (Same as before)
            document.getElementById('checkout-items').innerHTML = state.cart.map((item, i) => `
        <div class="flex justify-between items-center bg-dark-800/50 p-2 rounded-xl border border-dark-700 mb-2 last:mb-0 group">
            <div class="flex gap-3 items-center overflow-hidden">
                <div class="font-bold bg-dark-900 w-8 h-8 rounded-lg flex items-center justify-center text-primary text-xs border border-dark-700 shrink-0 shadow-inner">
                    ${item.qty}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="font-bold text-sm text-white truncate">${item.name}</p>
                    <p class="text-[10px] text-dark-muted truncate">
                        ${item.size ? `<span class="text-primary">${item.size}</span>` : ''} 
                        ${item.modifiers.length > 0 ? `‚Ä¢ ${item.modifiers.join(', ')}` : ''}
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-3 pl-2 shrink-0">
                <span class="font-bold text-sm text-white font-mono">${item.lineTotal.toLocaleString()}</span>
                <button onclick="window.removeFromCart(${i})" class="w-7 h-7 rounded-full bg-dark-900 text-dark-muted hover:text-red-400 hover:bg-red-900/20 transition flex items-center justify-center">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>
        </div>`).join('');

            updateCheckoutTotals();
            document.getElementById('modal-checkout').classList.remove('hide');
            window.triggerAIUpsell(); // Call AI
        };

        window.triggerAIUpsell = async () => {
            const container = document.getElementById('ai-upsell-container');

            container.style.top = '';
            container.style.left = '';
            container.style.bottom = '260px'; // ·Äô·Ä∞·Äú·Äû·Äê·Ä∫·Äô·Äæ·Äê·Ä∫·Äë·Ä¨·Ä∏·Äê·Ä≤·Ä∑ ·Äî·Ä±·Äõ·Ä¨
            container.style.right = '1rem';
            container.style.position = 'absolute';
            container.classList.add('hide'); // Reset animation

            if (!aiState.apiKey || state.cart.length === 0) return;

            const textEl = document.getElementById('ai-upsell-text');
            const btn = document.getElementById('btn-add-upsell');
            const icon = container.querySelector('.fa-sparkles');

            // Show Loading State
            container.classList.remove('hide');
            textEl.innerText = "Analyzing...";
            btn.classList.add('hidden'); // ·ÄÅ·Äè·Äñ·Äª·Ä±·Ä¨·ÄÄ·Ä∫·Äë·Ä¨·Ä∏·Äô·Äö·Ä∫
            icon.classList.add('animate-spin'); // ·Äú·Ää·Ä∫·Äî·Ä±·Äê·Ä≤·Ä∑ effect ·Äë·Ää·Ä∑·Ä∫·Äô·Äö·Ä∫

            const cartItems = state.cart.map(i => i.name).join(', ');
            const menuItems = state.products.filter(p => !p.isSoldOut).map(p => `${p.name} (ID:${p.id})`).join(', ');

            const prompt = `Context: Restaurant POS. Cart: [${cartItems}]. Menu: [${menuItems}]. Recommend ONE item. Output JSON: { "id": "PRODUCT_ID", "name": "PRODUCT_NAME" }`;

            try {
                const result = await callGeminiAPI(prompt);
                const jsonMatch = result.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("No JSON");

                const data = JSON.parse(jsonMatch[0]);
                const product = state.products.find(p => p.id === data.id);

                if (product) {
                    // Success State
                    icon.classList.remove('animate-spin');
                    icon.classList.add('animate-pulse');

                    textEl.innerText = data.name; // ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äî·Ä¨·Äô·Ää·Ä∫·Äï·Ä≤ ·Äï·Äº·Äô·Äö·Ä∫
                    btn.classList.remove('hidden'); // Add ·ÄÅ·Äú·ÄØ·Äê·Ä∫ ·Äï·Äº·Äî·Ä∫·Äñ·Ä±·Ä¨·Ä∫·Äô·Äö·Ä∫

                    btn.onclick = () => {
                        state.selectedProduct = { ...product, qty: 1 };
                        window.addToCart();

                        // Success Effect
                        textEl.innerText = "Added!";
                        btn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            container.classList.add('hide');
                            btn.innerHTML = '<i class="fas fa-plus"></i>'; // Reset icon
                            window.openCheckoutModal(); // Refresh list
                        }, 800);
                    };
                } else {
                    container.classList.add('hide');
                }
            } catch (e) {
                console.error(e);
                container.classList.add('hide');
            }
        };


        // ·Äí·Ä´·ÄÄ·Äê·Ä±·Ä¨·Ä∑ navigateTo ·Äë·Ä≤·Äô·Äæ·Ä¨ ·Äô·Äü·ÄØ·Äê·Ä∫·Äò·Ä≤ ·Äû·ÄÆ·Ä∏·Äû·Äî·Ä∑·Ä∫ Function ·Ä°·Äû·ÄÖ·Ä∫·Ä°·Äî·Ä±·Äî·Ä≤·Ä∑ ·Äë·Ää·Ä∑·Ä∫·Äõ·Äô·Äæ·Ä¨·Äï·Ä´
        window.renderMemberList = async () => {
            const { collection, getDocs, query, orderBy, deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

            const tbody = document.getElementById('members-table-body');
            const searchVal = document.getElementById('member-manager-search').value.toLowerCase();

            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center"><span class="loader"></span></td></tr>';

            try {
                // Firebase ·ÄÄ·Äî·Ä± Customer ·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ ·ÄÜ·ÄΩ·Ä≤·Äë·ÄØ·Äê·Ä∫·Äô·Äö·Ä∫
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'customers'), orderBy('joinedAt', 'desc'));
                const snapshot = await getDocs(q);

                let members = [];
                snapshot.forEach(doc => members.push({ id: doc.id, ...doc.data() }));

                // Filter (Search ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫)
                if (searchVal) {
                    members = members.filter(m =>
                        (m.name && m.name.toLowerCase().includes(searchVal)) ||
                        (m.phone && m.phone.includes(searchVal))
                    );
                }

                document.getElementById('total-members-count').innerText = `${members.length} Members`;

                if (members.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-dark-700">No members found</td></tr>';
                    return;
                }

                tbody.innerHTML = members.map(m => `
            <tr class="hover:bg-dark-800 transition">
                <td class="p-3 font-bold text-white">${m.name}</td>
                <td class="p-3 font-mono text-primary">${m.phone}</td>
                <td class="p-3 text-right font-bold text-yellow-400">${(m.points || 0).toLocaleString()}</td>
                <td class="p-3 text-right text-dark-muted">${m.visits || 0}</td>
                <td class="p-3 text-center">
                    <button onclick="window.deleteMember('${m.id}')" class="text-red-400 hover:text-white hover:bg-red-500/80 bg-red-900/20 w-8 h-8 rounded-full transition flex items-center justify-center">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </td>
            </tr>
        `).join('');

            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-400">Failed to load members</td></tr>';
            }
        };

        // Member ·Äñ·Äª·ÄÄ·Ä∫·Äê·Ä≤·Ä∑ Function
        window.deleteMember = (id) => {
            window.showConfirm('delete_confirm', async () => {
                const { deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'customers', id));
                    window.showMessage("Member Deleted", "success");
                    window.renderMemberList(); // Refresh list
                } catch (e) {
                    window.showMessage("Failed to delete", "error");
                }
            }, true); // PIN ·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫·Äû·Ää·Ä∫
        };
        // ==========================================
        // PING POS AI SYSTEM (GEMINI INTEGRATION)
        // ==========================================

        let aiState = {
            apiKey: localStorage.getItem('pingpos_ai_key') || '',
            isThinking: false,
            suggestedProductId: null
        };

        // 1. Settings
        window.saveAiSettings = () => {
            const key = document.getElementById('setting-ai-key').value.trim();
            if (key) {
                aiState.apiKey = key;
                localStorage.setItem('pingpos_ai_key', key);
                window.showMessage("AI Key Saved", "success");
            }
        };

        // Load Key on Init
        setTimeout(() => {
            const savedKey = localStorage.getItem('pingpos_ai_key');
            if (savedKey && document.getElementById('setting-ai-key')) {
                document.getElementById('setting-ai-key').value = savedKey;
            }
        }, 1000);

        // ==========================================
        // FEATURE 1: AI RECOMMENDER (SMART UPSELL)
        // ==========================================

        // Call this function inside openCheckoutModal()
        window.triggerAIUpsell = async () => {
            if (!aiState.apiKey || state.cart.length === 0) {
                document.getElementById('ai-upsell-container').classList.add('hide');
                return;
            }

            const container = document.getElementById('ai-upsell-container');
            const textEl = document.getElementById('ai-upsell-text');
            const reasonEl = document.getElementById('ai-upsell-reason');
            const btn = document.getElementById('btn-add-upsell');

            // Show Loading State
            container.classList.remove('hide');
            textEl.innerText = "Thinking...";
            reasonEl.innerText = "Looking for best match...";
            btn.classList.add('hide');

            // Prepare Data
            const cartItems = state.cart.map(i => i.name).join(', ');
            const menuItems = state.products.filter(p => !p.isSoldOut).map(p => `${p.name} (ID:${p.id})`).join(', ');

            const prompt = `
        Context: Restaurant POS. 
        Cart: [${cartItems}]. 
        Menu: [${menuItems}].
        Task: Recommend ONE item from Menu that complements the Cart. Do not suggest items already in Cart.
        Output Format: JSON only { "id": "PRODUCT_ID", "name": "PRODUCT_NAME", "reason": "Short reason why (max 5 words)" }
    `;

            try {
                const result = await callGeminiAPI(prompt);
                const jsonMatch = result.match(/\{[\s\S]*\}/); // Extract JSON
                if (!jsonMatch) throw new Error("No JSON found");

                const data = JSON.parse(jsonMatch[0]);
                const product = state.products.find(p => p.id === data.id);

                if (product) {
                    textEl.innerText = `Try: ${data.name}`;
                    reasonEl.innerText = data.reason;
                    aiState.suggestedProductId = data.id;

                    // Setup Button
                    btn.onclick = () => {
                        state.selectedProduct = { ...product, qty: 1 }; // Prepare for addToCart
                        window.addToCart(); // Use existing function
                        window.showMessage(`Added ${data.name}!`, "success");
                        container.classList.add('hide'); // Hide after adding
                    };
                    btn.classList.remove('hide');
                } else {
                    container.classList.add('hide'); // Hide if product not found
                }
            } catch (e) {
                console.error("AI Upsell Error:", e);
                container.classList.add('hide');
            }
        };

        // ==========================================
        // FEATURE 2: AI BUSINESS ANALYST
        // ==========================================

        window.openAIAnalyst = () => {
            if (!aiState.apiKey) return window.showMessage("Please set API Key in Settings first", "error");
            document.getElementById('modal-ai-analyst').classList.remove('hide');
        };

        window.handleAiEnter = (e) => { if (e.key === 'Enter') window.sendToAI(); };

        // ==========================================
        // FEATURE 2: AI BUSINESS ANALYST (FULL DETAIL UPGRADE)
        // ==========================================

        window.handleAiEnter = (e) => { if (e.key === 'Enter') window.sendToAI(); };

        window.sendToAI = async () => {
            const input = document.getElementById('ai-user-input');
            const history = document.getElementById('ai-chat-history');
            const question = input.value.trim();

            if (!aiState.apiKey) return window.showMessage("Please set API Key in Settings first", "error");
            if (!question) return;

            // 1. User Message Display
            history.innerHTML += `
        <div class="flex gap-3 flex-row-reverse animate-slide-up">
            <div class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center shrink-0"><i class="fas fa-user text-xs text-white"></i></div>
            <div class="bg-indigo-600 p-3 rounded-2xl rounded-tr-none text-sm text-white shadow-lg">
                ${question}
            </div>
        </div>
    `;
            input.value = '';
            history.scrollTop = history.scrollHeight;

            // 2. Loading Display
            const loadingId = 'ai-loading-' + Date.now();
            history.innerHTML += `
        <div id="${loadingId}" class="flex gap-3 animate-pulse">
            <div class="w-8 h-8 rounded-full bg-indigo-900/50 flex items-center justify-center shrink-0 border border-indigo-500/30"><i class="fas fa-robot text-xs text-indigo-300"></i></div>
            <div class="bg-dark-800 p-3 rounded-2xl rounded-tl-none border border-dark-700 text-sm text-gray-400">
                Analyzing COGS, Items, Categories & Order Types...
            </div>
        </div>
    `;
            history.scrollTop = history.scrollHeight;

            try {
                // --- HELPER FUNCTIONS ---
                const getWeekNumber = (d) => {
                    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                    var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                    var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                    return d.getUTCFullYear() + "-W" + weekNo;
                };

                // Object ·Äë·Ä≤·ÄÄ Value ·Ä°·Äô·Äª·Ä¨·Ä∏·ÄÜ·ÄØ·Ä∂·Ä∏ Key ·ÄÄ·Ä≠·ÄØ ·Äõ·Äæ·Ä¨·Äï·Ä±·Ä∏·Äô·Äö·Ä∑·Ä∫ Function (Top Item/Category ·Äõ·Äæ·Ä¨·Äõ·Äî·Ä∫)
                const getTopKey = (obj) => {
                    const arr = Object.entries(obj).sort((a, b) => b[1] - a[1]);
                    return arr.length > 0 ? `${arr[0][0]} (${arr[0][1]})` : "None";
                };

                // --- DATA GATHERING START ---

                // 1. Shifts Data
                const { collection, getDocs, query, orderBy, limit, getCountFromServer } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                let recentShiftsText = "No Shift Data";
                try {
                    const shiftQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'shifts'), orderBy('closedAt', 'desc'), limit(5));
                    const shiftSnap = await getDocs(shiftQ);
                    if (!shiftSnap.empty) {
                        recentShiftsText = shiftSnap.docs.map(d => {
                            const s = d.data();
                            const dObj = s.closedAt ? new Date(s.closedAt.seconds * 1000) : null;
                            const dStr = dObj ? dObj.toLocaleDateString('en-CA') : 'N/A';
                            return `[${dStr}] Cash: ${s.endCash}, Variance: ${s.variance}, Staff: ${s.closedBy}`;
                        }).join('\n');
                    }
                } catch (e) { console.log("Shift fetch error", e); }

                // 2. Member Count
                let memberCount = 0;
                try {
                    const coll = collection(db, 'artifacts', appId, 'public', 'data', 'customers');
                    const snapshot = await getCountFromServer(coll);
                    memberCount = snapshot.data().count;
                } catch (e) { console.log("Member count error", e); }

                // 3. AGGREGATION LOGIC (DETAILED)
                let dailyData = {};
                let weeklyData = {};
                let monthlyData = {};

                // Init Structure (·Ä°·Äû·Ä±·Ä∏·ÄÖ·Ä≠·Äê·Ä∫ ·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫·Äô·Äª·Ä¨·Ä∏ ·Äï·Ä´·Äù·ÄÑ·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·Äï·Äº·ÄÑ·Ä∫·Äë·Ä¨·Ä∏·Äû·Ää·Ä∫)
                const initStats = () => ({
                    revenue: 0,
                    cogs: 0,            // Cost of Goods Sold
                    expenses: 0,
                    profit: 0,
                    orders: 0,
                    cancel: 0,          // Cancelled Orders
                    items: {},          // Item Name -> Qty
                    cats: {},           // Category -> Revenue
                    dineIn: 0,          // Dine-in Count
                    takeaway: 0         // Takeaway Count
                });

                // --- A. Process Expenses ---
                state.expenses.forEach(e => {
                    if (!e.timestamp) return;
                    const d = new Date(e.timestamp.seconds * 1000);
                    const amt = e.amount || 0;

                    const dayKey = d.toLocaleDateString('en-CA');
                    const weekKey = getWeekNumber(d);
                    const monthKey = dayKey.slice(0, 7);

                    if (!dailyData[dayKey]) dailyData[dayKey] = initStats();
                    if (!weeklyData[weekKey]) weeklyData[weekKey] = initStats();
                    if (!monthlyData[monthKey]) monthlyData[monthKey] = initStats();

                    dailyData[dayKey].expenses += amt;
                    weeklyData[weekKey].expenses += amt;
                    monthlyData[monthKey].expenses += amt;
                });

                // --- B. Process Orders (Full Detail) ---
                let allTimeTopItems = {}; // Overall top items

                state.orders.forEach(o => {
                    if (!o.timestamp) return;
                    const d = new Date(o.timestamp.seconds * 1000);

                    const dayKey = d.toLocaleDateString('en-CA');
                    const weekKey = getWeekNumber(d);
                    const monthKey = dayKey.slice(0, 7);

                    if (!dailyData[dayKey]) dailyData[dayKey] = initStats();
                    if (!weeklyData[weekKey]) weeklyData[weekKey] = initStats();
                    if (!monthlyData[monthKey]) monthlyData[monthKey] = initStats();

                    const targetStats = [dailyData[dayKey], weeklyData[weekKey], monthlyData[monthKey]];

                    if (o.status === 'cancelled') {
                        targetStats.forEach(s => s.cancel++);
                    } else {
                        const price = o.totalPrice || 0;
                        const cost = o.totalCost || 0;

                        targetStats.forEach(s => {
                            s.revenue += price;
                            s.cogs += cost; // Adding COGS
                            s.orders++;

                            // Order Type Counting
                            if (o.orderType === 'takeaway') s.takeaway++;
                            else s.dineIn++;
                        });

                        // Items & Category Breakdown
                        if (o.items && Array.isArray(o.items)) {
                            o.items.forEach(i => {
                                const iName = i.name;
                                const iCat = i.category || 'Other';
                                const iTotal = i.lineTotal || 0;

                                // All Time Tracking
                                allTimeTopItems[iName] = (allTimeTopItems[iName] || 0) + i.qty;

                                targetStats.forEach(s => {
                                    // Track Item Qty
                                    s.items[iName] = (s.items[iName] || 0) + i.qty;
                                    // Track Category Revenue
                                    s.cats[iCat] = (s.cats[iCat] || 0) + iTotal;
                                });
                            });
                        }
                    }
                });

                // --- C. Format Output ---

                const formatLog = (obj, label) => {
                    return Object.keys(obj).sort().map(k => {
                        const d = obj[k];
                        const grossProfit = d.revenue - d.expenses - d.cogs; // Profit Formula

                        return `${label}: ${k} | Rev: ${d.revenue} | COGS: ${d.cogs} | Exp: ${d.expenses} | NetProfit: ${grossProfit} | Ord: ${d.orders} | Cancel: ${d.cancel} | Dine: ${d.dineIn} | Take: ${d.takeaway} | TopItem: ${getTopKey(d.items)} | TopCat: ${getTopKey(d.cats)}`;
                    }).join('\n');
                };

                const dailyLog = formatLog(dailyData, "Date");
                const weeklyLog = formatLog(weeklyData, "Week");
                const monthlyLog = formatLog(monthlyData, "Month");

                // Top 5 All Time Items
                const top5AllTime = Object.entries(allTimeTopItems)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(x => `${x[0]} (${x[1]})`)
                    .join(', ');

                // --- PROMPT ENGINEERING ---
                const todayStr = new Date().toLocaleDateString('en-CA');

                const prompt = `
        Role: Restaurant Business Analyst AI.
        Current Date: ${todayStr} (YYYY-MM-DD).
        
        You have access to detailed financial and operational data broken down by Daily, Weekly, and Monthly logs.
        
        *** DATA LEGEND ***
        Rev = Revenue (Sales)
        COGS = Cost of Goods Sold (Product Cost)
        Exp = Operational Expenses
        NetProfit = Revenue - COGS - Exp
        Ord = Total Orders
        Cancel = Cancelled Orders count
        Dine = Dine-in count
        Take = Takeaway count
        TopItem = Best selling item name (qty sold)
        TopCat = Best performing category (revenue generated)

        === MONTHLY REPORT ===
        ${monthlyLog || "No Data"}
        
        === WEEKLY REPORT ===
        ${weeklyLog || "No Data"}
        
        === DAILY REPORT ===
        ${dailyLog || "No Data"}

        [OVERALL STATS]
        - All-Time Top 5 Items: ${top5AllTime}
        - Total Members: ${memberCount}
        
        [SHIFT HISTORY]
        ${recentShiftsText}
        
        User Question: "${question}"
        
        INSTRUCTIONS:
        1. Identify the time period (Today, Yesterday, Last Month, etc.).
        2. Look for the specific metrics asked (e.g., if asked for "Product Cost", look at 'COGS').
        3. If asked for "Top Item" or "Category Sales", use the 'TopItem' and 'TopCat' fields.
        4. If asked about "Order Types", compare 'Dine' vs 'Take'.
        5. If asked about "Cancelled", look at 'Cancel'.
        6. Provide specific numbers. Answer in the user's language (Burmese/English).
        `;

                // 4. Send to Gemini
                const response = await callGeminiAPI(prompt);

                // Show Answer
                document.getElementById(loadingId).remove();
                history.innerHTML += `
            <div class="flex gap-3 animate-slide-up">
                <div class="w-8 h-8 rounded-full bg-indigo-900/50 flex items-center justify-center shrink-0 border border-indigo-500/30"><i class="fas fa-robot text-xs text-indigo-300"></i></div>
                <div class="bg-dark-800 p-3 rounded-2xl rounded-tl-none border border-dark-700 text-sm text-gray-200 shadow-md">
                    ${response.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;

            } catch (e) {
                console.error("AI Error:", e);
                document.getElementById(loadingId).innerHTML = `<span class="text-red-400">Error analyzing data: ${e.message}</span>`;
            }
            history.scrollTop = history.scrollHeight;
        };
        // ==========================================
        // SHARED: API CALLER (Google Gemini) - 2025 FIXED VERSION
        // ==========================================
        async function callGeminiAPI(promptText) {
            // 2025 ·Äí·ÄÆ·Äá·ÄÑ·Ä∫·Äò·Ä¨·Äú·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Äî·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏·Äë·ÄΩ·ÄÄ·Ä∫ Model ·Äî·Ä¨·Äô·Ää·Ä∫·Ä°·Äû·ÄÖ·Ä∫·ÄÄ·Ä≠·ÄØ ·Äû·ÄØ·Ä∂·Ä∏·Äï·Ä´·Äô·Äö·Ä∫
            const modelName = "gemini-2.5-flash";

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${aiState.apiKey}`;

            console.log("Calling AI URL using model:", modelName);

            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: promptText }] }]
                })
            });

            if (!response.ok) {
                const errText = await response.text();
                console.error("Gemini API Error Details:", errText);
                throw new Error(`API Error: ${response.status}`);
            }

            const data = await response.json();

            if (!data.candidates || data.candidates.length === 0) {
                throw new Error("No response from AI");
            }

            return data.candidates[0].content.parts[0].text;
        }
        // DRAG FUNCTION FOR AI BUBBLE
        window.makeElementDraggable = (el) => {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            const startDrag = (e) => {
                // Prevent clicking buttons inside when dragging starts
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;

                isDragging = true;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                // Convert current position to absolute left/top to avoid jumping
                const rect = el.getBoundingClientRect();

                // Remove bottom/right classes logic effectively by setting explicit pixel values
                el.style.bottom = 'auto';
                el.style.right = 'auto';
                el.style.left = rect.left + 'px';
                el.style.top = rect.top + 'px';
                el.style.position = 'fixed'; // Use fixed to stick to screen

                startX = clientX - rect.left;
                startY = clientY - rect.top;

                el.style.cursor = 'grabbing';
            };

            const doDrag = (e) => {
                if (!isDragging) return;
                e.preventDefault(); // Stop scrolling on mobile

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                const x = clientX - startX;
                const y = clientY - startY;

                el.style.left = `${x}px`;
                el.style.top = `${y}px`;
            };

            const stopDrag = () => {
                isDragging = false;
                el.style.cursor = 'move';
            };

            // Mouse Events
            el.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);

            // Touch Events (Mobile)
            el.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', doDrag, { passive: false });
            document.addEventListener('touchend', stopDrag);
        };

        // Initialize Dragging on Startup
        setTimeout(() => {
            const bubble = document.getElementById('ai-upsell-container');
            if (bubble) window.makeElementDraggable(bubble);
        }, 2000);

        init();
    </script>
</body>

</html>
